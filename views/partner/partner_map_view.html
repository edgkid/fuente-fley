<% include partner_header.html %> 


<div class="page-content-wrap">
<div class="row">
    <!-- Map and Side Panel -->
    <div class="panel panel-default">
    <div class="panel-body panel-body-map">
        <!-- Google Map -->
        <div class="row">                      
                <div class="panel panel-default">

                  <div class="panel-body panel-body-map">
                      <div id="map" style="width: 100%; min-height: 778px;"></div>
                  </div>
              </div>
             
        </div>

    </div>
    </div>
</div>
<% include colorbar.html %>
<% include web_advertise.html %>

</div>
</div>
</div>
</body>
       <!-- END PRELOADS -->

    
    <!-- Google Maps API -->
<script src="<%=map_url%>"></script>
<script>
  
google.maps.event.addDomListener(window, 'load', initialize);

let latitude = "<%=latitude%>"
let longitude = "<%=longitude%>"

function initialize() {
  var iconBase = '/map_pin/icons/';
  var markers = [];
    var map_view = {
        center: new google.maps.LatLng(latitude, longitude),
        zoom:9,
        mapTypeId:google.maps.MapTypeId.ROADMAP,
        streetViewControl: false, // Disable Street View control
        zoomControlOptions: {
              position: google.maps.ControlPosition.RIGHT_CENTER
          }
    };


    var map = new google.maps.Map(document.getElementById("map"), map_view);

    let running_trips = <%-JSON.stringify(trip_list)%>
    var locations = [];
    running_trips.forEach(function (data) {

        let lat = data.providerLocation[0];
        let lon = data.providerLocation[1];
        let provider_name = data.assigned_provider_details.name
        let provider_phone = data.assigned_provider_details.phone
        let plate_no = data.assigned_vehicle_details.vehicle_plate_no
            var contentString =
            '<p><b><%= __('title_provider_name') %></b>: ' + provider_name +
            '<br><b><%= __('title_provider_phone') %></b>: ' + provider_phone +
            '<br><b><%= __('title_plate_no') %></b>: ' + plate_no            
            '</p>';

        locations.push({
            latlon: new google.maps.LatLng(lat, lon),
            message: new google.maps.InfoWindow({
              content: contentString,
              maxWidth: 320
            }),
            type_image: "<%= setting_detail.image_base_url %>" + data.type_image[0]
        });
    });
    truck_markers = []
    locations.forEach(function (loc_data, i) {
      const trip = running_trips[i]
      const maxHeight = 30;
      // Create a new image object to get the original dimensions
      const img = new Image();
      img.src = loc_data.type_image;
      img.onload = function() {
        const aspectRatio = img.width / img.height;
        const scaledWidth = maxHeight * aspectRatio;
        var marker_avail_act = new google.maps.Marker({

            position: loc_data.latlon,
            map: map,
            icon: {
                url: loc_data.type_image,
                scaledSize: new google.maps.Size(scaledWidth, maxHeight) // Adjust the size as per your requirement
            },
        });
        truck_markers.push(marker_avail_act);
        google.maps.event.addListener(marker_avail_act, 'click', function (e) {
          $.ajax({
          type: 'POST',
          url: '/partner_map_get_provider_data',
          data: {
            provider_id: trip.provider_id,
            trip_id: trip._id
          } ,
          dataType: "json",
          success: function (res) {
            if(res.success){
              const name = res.provider ? res.provider.first_name + ' ' + res.provider.last_name : ""
              const phone = res.provider ? res.provider.country_phone_code + res.provider.phone : ""
              const plate = trip?.assigned_vehicle_details?.vehicle_plate_no ?trip?.assigned_vehicle_details?.vehicle_plate_no : "" 
              let status = res?.trip?.is_provider_status ? res.trip.is_provider_status  : "" 
              let status_text = ""  
              if(status == 1) {
                status_text = '<%= __('title_accepted_request')%>'
              } else if(status == 2) {
                status_text = '<%= __('title_trip_status_coming')%>'
              } else if(status == 4) {
                status_text = '<%= __('title_trip_status_arrived')%>'
              } else if(status == 6) {
                status_text = '<%= __('title_trip_status_trip_started')%>'
              } else if(status == 7) {
                status_text = '<%= __('title_trip_status_arrived_at_destination')%>'
              } else if(status == 9) {
                status_text = '<%= __('title_trip_status_completed')%>'
              } 
              const speed = res?.trip?.speed ? (res.trip.speed).toFixed(0) + " km" : "" 
              var contentString =
              '<p><b><%= __('title_provider_name') %></b>: ' + name +
              '<br><b><%= __('title_provider_phone') %></b>: ' + phone +
              '<br><b><%= __('title_plate_no') %></b>: ' + plate +
              '<br><b><%= __('title_status') %></b>: ' + status_text +
              '<br><b><%= __('title_current_speed') %></b>: ' + speed +
              '</p>';

              // When clicked, open the selected marker's message
              currentSelectedMarker = loc_data;
              loc_data.message =  new google.maps.InfoWindow({
                                    content: contentString,
                                    maxWidth: 320, disableAutoPan: true
                                  })

              loc_data.message.open(map, marker_avail_act);
              setTimeout(function () { loc_data.message.close(); }, 5000);
            }
            
          }
        })

        });
      };            

    });


}





</script>
<script type="text/javascript">
  function ClearFields() {
      document.getElementById("pac-input1").value = "";
  }
</script>

<% include footer_list.html %>
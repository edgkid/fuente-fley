<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>           
    <meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link href="https://fonts.googleapis.com/css?family=Maven+Pro:400,500,700,900" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="new_design/css/font-awesome.min.css" />
	<link rel="stylesheet" type="text/css" href="new_design/css/magnific-popup.css" />
	<link rel="stylesheet" type="text/css" href="new_design/css/style.css" />
	<title><%= setting_detail.app_name %></title>
	<script type="text/javascript" src="new_design/js/jquery.min.js"></script>
	<script type="text/javascript" src="new_design/js/jquery-ui.js"></script>
	<script type="text/javascript" src="new_design/js/jquery.magnific-popup.min.js"></script>
        <link rel="icon" href="web_images/title_image.png" type="image/x-icon" />
	
	<script src="new_design/js/owl.carousel.js"></script>
	<script type='text/javascript' src='js/plugins/jquery-validation/jquery.validate.js'></script>

	<!-- <script type="text/javascript" src="http://localhost:5000//new_design/js/guest-token-load.js" data-token="tMlYPh2gkrVKaEbqDgP2" defer></script> -->
	<script type="text/javascript" src="https://flety.io//new_design/js/guest-token-load.js" data-token="tMlYPh2gkrVKaEbqDgP2" defer></script>

</head>
<div class="page-content-wrap">
  <div class="row">
  <div class="col-md-12">
      <!-- Map and Side Panel -->
      <div class="panel panel-default">
      <div class="panel-body panel-body-map" ng-app="meanMapApp">
          <!-- Google Map -->
          <div>
              <div id="map" style="width:100%; height:700px;"></div>
              <div id="legend"></div>
          </div> 
      </div>
      </div>
  </div> 
  </div>
  </div>
  </body>
          <!-- END PRELOADS -->
  
      
      <!-- Google Maps API -->
      <script src="<%=url%>" async defer"></script>
      <script src="socket.io/socket.io.js"></script>
  
  <script>
    function initialize() {
      var lat = "<%= data.destinationLocation[0] %>"
      var lng = "<%= data.destinationLocation[1] %>"
      var iconBase = '/map_pin/'
      var map_view = {
        center: new google.maps.LatLng(lat, lng),
        zoom: 15,
        streetViewControl: false,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };

      var map = new google.maps.Map(document.getElementById("map"), map_view);
      var legend = document.getElementById('legend');
      legend.innerHTML = '<img src="/map_pin/truck_pin.png " style="height:25px; "/><%= __("title_provider_location") %><br />' +
        '<img src="/map_pin/pickup.png " style="height:25px; "/><%= __("title_pickup_location") %><br />' +
        '<img src="/map_pin/destination.png " style="height:25px; "/><%= __("title_destination_location") %><br />';
      map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend);
  
      <% if(data.is_trip_cancelled != 1 &&  data.is_provider_status >= 1){ %>
      var bounds = new google.maps.LatLngBounds();
      <% if(data.providerLocation.length != 0){ %>
      var providerStartLocation = {
        lat: <%= data.providerLocation[0] %>,
        lng: <%= data.providerLocation[1] %>
      };
  
      var providerStartLocation_initialLocation = new google.maps.LatLng(providerStartLocation);
      var driver_marker = new google.maps.Marker({
        position: providerStartLocation_initialLocation,
        map: map,
        icon: {
          url: iconBase + 'truck_pin.png',
          scaledSize: new google.maps.Size(50, 75) // Adjust the size as per your requirement
        }
      });
      bounds.extend(providerStartLocation_initialLocation);
      
      var URL = window.location.protocol + '//'+ window.location.hostname;
    //   var URL = 'http://localhost:5000';
      var socket = io.connect(URL);
      
      socket.on('connect',function() {
      });
      
      socket.on("'<%= data._id %>'",function(data) {
          console.log(data)
        if(data.is_trip_updated){
          return;
        }
        let location = data.location
        var new_latlng = new google.maps.LatLng(location[0], location[1]);
        driver_marker.setPosition(new_latlng);
        if(typeof trip_path_array == "undefined"){
          return;        
        }
        
        var trip_path = {'lat':location[0],'lng':location[1] };
        trip_path_array.push(trip_path);
        let trippath = new google.maps.Polyline({
            path: trip_path_array,
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });
        trippath.setMap(map);
      });
  
  
        socket.on('disconnect',function() {
      });
  
      <% } %>
  
      <% if(data.sourceLocation.length != 0){ %>
      var startTripLocation = {
        lat: <%= data.sourceLocation[0] %>,
        lng: <%= data.sourceLocation[1] %>
      };
  
      var startTripLocation_initialLocation = new google.maps.LatLng(startTripLocation);
      var marker = new google.maps.Marker({
        position: startTripLocation_initialLocation,
        map: map,
        icon: {
        url: iconBase + 'pickup.png',
        scaledSize: new google.maps.Size(50, 75) // Adjust the size as per your requirement
      }
      });
      bounds.extend(startTripLocation_initialLocation);
      <% } %>
  
      <% if(data.destinationLocation.length != 0){ %>
        var endTripLocation = {
            lat: <%= data.destinationLocation[0] %>,
            lng: <%= data.destinationLocation[1] %>
        };
    
        var endTripLocation_initialLocation = new google.maps.LatLng(endTripLocation);
    
        var marker = new google.maps.Marker({
            position: endTripLocation_initialLocation,
            map: map,
            icon: {
                url: iconBase + 'destination.png',
                scaledSize: new google.maps.Size(50, 75) // Adjust the size as per your requirement
            }
        });
        bounds.extend(endTripLocation_initialLocation);
        <% } %>
    
        map.fitBounds(bounds);
  
      <% } %>
  
  
  

  
        map.fitBounds(bounds);
        var trip_data = <%- JSON.stringify(data) %>
      trip_data.destination_addresses.forEach(stops => {
        var endTripLocation_initialLocation = new google.maps.LatLng({ lat: Number(stops.location[0]), lng: Number(stops.location[1]) });
        var marker = new google.maps.Marker({
          position: endTripLocation_initialLocation,
          map: map,
          icon: iconBase + 'external_stop.png'
        });
        bounds.extend(endTripLocation_initialLocation);
      });
  
      var startToTripStartLocations = []
      <% trip_path_data.providerStartToStartTripLocations.forEach(function(location){ %>
      var lat = <%= location[0] %>;
      var lng = <%= location[1] %>;
      var trip_path = {'lat':lat,'lng':lng };
      startToTripStartLocations.push(trip_path);
      <% }) %>

      var trip_path_array = [];

      <% trip_path_data.startTripToEndTripLocations.forEach(function(location){ %>
      var lat = <%= location[0] %>;
      var lng = <%= location[1] %>;
      var trip_path = {'lat':lat,'lng':lng };
      trip_path_array.push(trip_path);
      <% }) %>

    var trippath = new google.maps.Polyline({
            path: trip_path_array,
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
    });
    trippath.setMap(map);
  
    }
    google.maps.event.addDomListener(window, 'load', initialize);
  </script>

</html>
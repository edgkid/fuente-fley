<% include corporate_header.html %>
<link
    rel="stylesheet"
    href="dispatcher_new_design/css/font-awesome.min.css"
    type="text/css"
/>
<link
    rel="stylesheet"
    href="dispatcher_new_design/css/style.css"
    type="text/css"
/>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    font-family: 'Open Sans', sans-serif;
    background-color: #fff;
  }

  #dynamic-iframe {
    height: 100vh;
    border: none;
    display: block;
    transition: all 0.3s ease-in-out;
  }
</style>

<body class="gray_bg">
  <iframe
    id="dynamic-iframe"
    src="<%= new_trip_url %>"
    title="Login Flety"
    onerror="handleIframeError()"
  ></iframe>

  <script>
    function adjustIframeToSidebar() {
      const sidebar = document.getElementById('x-navigation');
      const iframe = document.getElementById('dynamic-iframe');

      if (!sidebar || !iframe) return;

      const sidebarWidth = sidebar.offsetWidth;

      iframe.style.marginLeft = `${sidebarWidth}px`;
      iframe.style.width = `calc(100% - ${sidebarWidth}px)`;
    }

    function handleIframeError() {
      const iframe = document.getElementById('dynamic-iframe');
      if (iframe) {
        iframe.style.display = 'none';
        const errorDiv = document.createElement('div');
        errorDiv.innerHTML = `
          <div style="padding: 20px; text-align: center; font-family: Arial, sans-serif;">
            <h3>Error loading trip creation form</h3>
            <p>There was an issue loading the trip creation interface. Please try refreshing the page or contact support.</p>
            <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh Page</button>
          </div>
        `;
        document.body.appendChild(errorDiv);
      }
    }

    window.addEventListener('load', adjustIframeToSidebar);
    window.addEventListener('resize', adjustIframeToSidebar);
    
    // Enviar token al iframe
    const iframe = document.getElementById('dynamic-iframe');
    const authToken = sessionStorage.getItem('auth-storage');
    console.log('üîë Token en sessionStorage:', authToken);
    
    if (iframe && authToken) {
      const sendToken = () => {
        console.log('üì§ Enviando token al iframe...');
        iframe.contentWindow.postMessage({ type: 'auth-token', token: authToken }, '*');
      };
      
      iframe.addEventListener('load', function() {
        console.log('‚úÖ Iframe cargado, enviando token');
        sendToken();
        setTimeout(sendToken, 500);
        setTimeout(sendToken, 1000);
        setTimeout(sendToken, 2000);
      });
    } else {
      console.log('‚ö†Ô∏è No hay token o iframe:', { iframe: !!iframe, authToken: !!authToken });
    }
    
    // Add error handling for iframe
    window.addEventListener('load', function() {
      const iframe = document.getElementById('dynamic-iframe');
      if (iframe) {
        iframe.addEventListener('error', handleIframeError);
        
        // Listen for messages from iframe to detect errors
        window.addEventListener('message', function(event) {
          if (event.data && event.data.type === 'iframe-error') {
            console.error('Iframe error:', event.data.error);
            handleIframeError();
          }
        });
        
        // Set a timeout to check if iframe loaded successfully
        setTimeout(function() {
          try {
            if (iframe.contentDocument && iframe.contentDocument.readyState !== 'complete') {
              handleIframeError();
            }
          } catch (e) {
            // Cross-origin iframe, can't access contentDocument
            console.log('Cross-origin iframe detected');
          }
        }, 10000); // 10 second timeout
      }
    });
    
    const observer = new MutationObserver(adjustIframeToSidebar);
    const target = document.getElementById('x-navigation');
    if (target) {
      observer.observe(target, { attributes: true, attributeFilter: ['class', 'style'] });
    }
  </script>
</body>
<% include footer_form.html %>
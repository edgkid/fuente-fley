<% include corporate_header.html %>
<style>

.right_btns{
  width: 250px;
  height: 50px;
}

.left_btns{
  width: 200px;
  height: 50px;
}

#left_btn_group{
  float:left; 
  margin-left:5%;
}
.container .confirm_cancel_trip_btn #row_confirm_btn{
  display: block;
}

#right_btn_group{
  float:right; 
  margin-right:5%;
}

#stops-tab{
  height:auto;
}

#textButton {
  background: none;
  border: none;
  font-family: 'Open Sans', sans-serif;
  width: 100%;
  text-align: left;
  color: deepskyblue;
  font-weight: bolder;
  font-size: 12px;
  padding-left: 15px;
  margin-bottom: 1%;
}

.customt{
    text-align: left;
    font-size: 15px;
    color: #250e62;
    font-weight: bolder;
    margin-top: 5%;
    margin-bottom: 5%;
}

.form-group, .form-control {width : 100%;}
.row-buffer{
  margin-top: 2em !important;
}

.wing-wrap{
  padding: 10px;
}

#title-alas{
  font-size: 18px;
  padding: 10px 0px;
  height: 40px;
  display:inline-block;
}

.wing-wrap-title{
    font-size: 20px;
  }

.values-summary{
  text-align: right;
  opacity: 0.5;
  color: black;
}

/* Style the bottom border for the summary*/
.label-summary{
  font-weight: bold;
  color: black;
}

.bb-custom{
  margin: auto !important;
  border-bottom: ridge;
  border-bottom-style: inset;
  margin-top: 1% !important;
  margin-bottom: 1% !important;
}

/* Style the tab */
* {box-sizing: border-box}
body {font-family: "Lato", sans-serif;}
.tab {
  float: left;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
  width: 25%;
  height: auto;
  padding-left: 0px;
  padding-right: 0px;
}

.tab .tablinks{
  height:auto;
  font-size: 20px;
}

.tab .tab-bborder{
  border-bottom: solid;
  border-bottom-width: 0.5px;
  border-bottom-color: lightgray;
  overflow-wrap: anywhere;
}

/* Style the buttons inside the tab */
.tab button {
  display: block;
  background-color: inherit;
  color: black;
  padding: 22px 16px;
  width: 100%;
  border: none;
  outline: none;
  text-align: left;
  cursor: pointer;
  transition: 0.3s;
  font-size: 20px;
  font-family: 'Open Sans';
  display: flex;
  align-items: center;
  height:auto;

}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current "tab button" class */
.tab button.active {
  background-color: #250e62;
  color: white;
}

/* Style the tab content */
.tabcontent {
  float: left;
  padding: 0px 12px;
  width: 70%;
  border-left: none;
  height: 300px;
}

/*              */
  .switchp {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

/* Hide default HTML checkbox */
.switchp input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.sliderp {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.sliderp:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .sliderp {
  background-color: #2196F3;
}

input:focus + .sliderp {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .sliderp:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.sliderp.roundp {
  border-radius: 34px;
}

.sliderp.roundp:before {
  border-radius: 50%;
}
/**/

  body, input, span{
    font-family: 'Open Sans', sans-serif !important;
  }

  .modal-body {
    max-height: 70vh; 
    overflow-y: auto;
  }
  .modal-header {
    background-color: #f8f9fa;
    border-bottom: none;
    border-radius: 12px;
  }
  .modal-header h4{
    font-family: inherit !important;
  }

  .modal-header .close{
    height: 0px;
    width: 44px;
  }
  .modal-content{
    border-radius: 12px;
    border-width: 1px;
  }
  .modal-title {
    font-size: 19px;
    font-weight: 700;
    color: rgb(37, 14, 98);
    text-align: center;
    margin: 1rem 0;
  }

  .modal-footer {
    border-top: none;
    text-align: center;  
    border-radius: 12px;
  }


  .modal-footer .btn-primary {
    border-radius: 19px;
    line-height: 20px;
    font-size: 12px;
    font-family: inherit;
    height: 30px;
    width: 77px;
  }

  .modal-footer .btn, .modal-footer .btn:hover {
    background: rgb(37, 14, 98);
    color: #f8f9fa;
    border-radius: 16px;
  }

  img{
    cursor: pointer;
  }
  .selectpicker{
    border: 0 !important;
    border-bottom: 1px solid #a59d9d !important;
    border-radius: 0 !important;
    background-color: unset !important;
  }
  .form-control{
    height: 40px !important;
  }
  .tag_button{
    background: gray;
    height: 25px;
    width: unset;
    color: #fff;
    letter-spacing: 0.5px;
    font-size: 10px;
    padding: 5px;
  }
  .selected_tag_button{
    background-color: #43A422;
  }

  #provider_filter_distance + .select{
    height: 25px !important;
  }
  #provider_filter_distance + .select .dropdown-toggle{
    height: 25px !important;
  }
  #provider_filter_distance + .select .filter-option{
    line-height: 27px !important;
  }
  #current_location_service_type_id + .select{
    height: 25px !important;
  }
  #current_location_service_type_id + .select .dropdown-toggle{
    height: 25px !important;
  }
  #current_location_service_type_id + .select .filter-option{
    line-height: 27px !important;
  }
  h6{
    margin-bottom: 0 !important;
  }
  .get_provider_info{
    margin-top: 55px !important;
    padding-top: 0 !important;
  }
  .pickup_info{
    padding-top: 0 !important;
  }

  h6 span {
    font-size: 12px;
  }

  .map_height{
    min-height: 400px; 
  }

  .bootstrap-select{
    background-color: #fff !important;
  }

  .fix_height_div{
    height: 100vh;
    overflow-y: auto;
  }
  .fix_height_div h5{
    margin-top: 0;
  }

  .left_panel{
    top: 0px !important;
    position: absolute !important
  }

  .name{
    white-space: nowrap;
    /* overflow: hidden; */
    text-overflow: ellipsis;
  }

  .name:hover{
    overflow: visible; 
    white-space: normal; 
  }
  
  .select_any_req_text{
    font-size: 21px;
    color: rgb(81 77 93);
    padding-top: 37px;
  }

  .req_selection_btn {
    height: 245px;
    width: 248px;
    border: 1px solid rgb(224 224 224);
    font-size: 17px;
    background: rgb(255 255 255);
    padding: 20px;
    border-radius: 3px;
    margin: 37px 0px;
    color: rgb(101 55 253);
    box-shadow: rgb(0 0 0 / 24%) 0px 3px 8px;
    vertical-align: top;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
  }
  .circle-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('/corporate_images/circle.png');
    background-size: cover;
    pointer-events: none;

  }

  .int_stop_btn {
    border-radius: 30px;
    margin-left: 10px;
    width: 32% !important;
    padding: 0% 1% 0% 1% !important; 
    display: inline-block; 
    position: absolute; 
    background: rgb(0 191 179);
    /* background: rgb(37 14 98); */
    font-size: 10px;
  }

  .int_stop_btn_delete {
    border-radius: 30px;
    margin-left: 10px;
    width: 20% !important;
    padding: 0% 1% 0% 1% !important; 
    display: inline-block; 
    position: absolute; 
    background: rgb(255, 0, 0);
    /* background: rgb(37 14 98); */
    font-size: 10px;
  }

  .image-selector {
      width: 100px;
      height: 100px;
      border: 2px dashed #a9a2a2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: #a9a2a2;
      cursor: pointer;
  }

  .image-selector:hover {
    border-color: #250e62;
    color: #250e62;
  }
  .req_selection_btn img {
    /* max-width: 103%;
    max-height: 122%;
    margin-top: -18px; */
    
  }

.success_message{
  font-weight: 600;
  color: rgb(255 255 255);
  background: rgb(41 22 90);
  border: 1px solid rgb(41 22 90);
  font-size: 20px;
  padding: 20px;
  border-radius: 39px;
  margin-top: 40%;
  box-shadow: rgb(0 0 0 / 24%) 0px 3px 8px;
  vertical-align: top;
}
  .page_chng_btns{
    border-radius: 14px;
    height: 38px;
    width: 267px;
    font-size: 12px;
    background: rgb(0 191 179);
    color: rgb(255 255 255);
  }
  .confirm_trip_btn {
    border-radius: 75px;
    height: 50px;
    width: 169px;
    font-size: 12px;
    background: rgb(0 191 179);
    margin: 0px 5px 0px 0px;
    color: rgb(255 255 255);
    margin: 19px 5px 0px 0px;
  }

  #add_internal_stop_message, #add_stop_message{
    display: none;
  }
  .right-span{
    right: 16px !important;
    left: unset !important;
    color: #d91a22 !important;
    background: transparent !important;
  }

  .vehicle_selection .col_4{
    padding-top: 84px;
  }
  .vehicle_selection .col_2{
    padding-top: 84px;
  }
  
  .text_center {
    text-align:center;
  }

  .field_style{
    padding: 24px 0px;
    height: 28px;
    border: 0;
    border-bottom: 1px solid #a59d9d;
  }
  .pick_dest_details h6{
    padding: 33px 0px;
  }
  
  .pick_dest_details .pick{
    padding-right: 0%;
  }

  .pick_dest_details .dest{
    padding-left: 0%;
  }


  .order_details_pickup_div{
    margin: 0px 0px 0px 3%;
  }
  .order_details_pickup_box{
    border-radius: 8px;
    box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
    font-size: 12px;
  }

  .overflow_text{
    white-space: nowrap; 
    width: 50px; 
    overflow: hidden;
    text-overflow: ellipsis; 
    border: 1px solid #000000; 
  }
  .order_details_pickup_box , h6{
    padding: 8px 0px;
  } 
  .h5{
    font-size: 18px;
    line-height: 20px;
    font-weight: 600;
    color: rgb(0 191 179);
    margin: 21px 0px 0px 32px;
  }

  .prevent_overflow{
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }

  .error{
    float: inherit;
  }

  .content {
    position: relative;
    min-height: 100vh; /* set minimum height to ensure the footer stays at the bottom */
  }

  .logo {
    /* position: absolute; */
    bottom: 30px;
    left: 55%;
    /* transform: translateX(-60%); */
    width: 92%;
  }

  .logo img{
    width: 63%; 
    margin-left: 5%;
  }

  .place_holder_stop::placeholder {
    font-size: 12px;
    font-weight: bold;
    text-align: center;
  }

  
  .place_holder_city_pickup::placeholder {
    font-size: 12px;
    font-weight: bold;
    text-align: center;
  }

  .place_holder_city::placeholder {
    font-size: 12px;
    font-weight: bold;
    text-align: center;
  }

  .tab_class_for_logo{
    height: 72vh;
    overflow-y: scroll;
    background-color: rgb(37 14 98);
  }
  .stop_addresses {
    height: 130px; 
    overflow: hidden;
    /* Set the maximum height of the div */
     /* Enable vertical scrolling overflow-y: auto;*/
     /* Hide horizontal scrollingoverflow-x: hidden; */
  }
  .pac-container {
    z-index: 10000; /* or any value higher than the modal's z-index */
  }

  .base-image {
  display: block;
  width: 100%;
  height: auto;
  margin-top: 20px;
  }

  .overlay-image1,.overlay-image2 {
    position: absolute;
    top: 0;
    left: 0;
  }

  .overlay-image1 {
    height: auto;
    width: 80%;
    margin-left: 25px;
    margin-top: -15px;
  }

  .overlay-image2 {
    height: auto;
    width: 80%;
    margin-left: 29px;
    margin-top: -24px;
  }

  .btn_title{
    font-size: 16px;
    width: 70%;
    display: block;
    margin-top: -105px;
    margin-left: 16%;
    color: #250E62;
  }

  .c-pointer{
    float: right; 
    color:rgb(22 0 77 / 88%);
  }
  .datepicker-dropdown{
    top: 127px  !important;
  }

  .error-message {
    color: red;
    margin-top: 10px;
  }

  /* .set_location {
    float: right;
  } */

  #legend {
    box-sizing: border-box;
    background: #fff;
    padding: 5px;
    margin: 10px;
  }

  #legend h3 {
    margin-top: 0;
  }

  #legend img {
    vertical-align: middle;
    width: 25px;
    height: 25px;
  }

  .item-legend {
    margin-bottom: 10px;
  }

  .item-legend span {
    margin-left: 5px;
  }

  .button_contact {
    height: 26px;
    width: 122px;
    color: #fff;
    letter-spacing: 0.5px;
    font-size: 13.5px;
    border-radius: 4px;
    font-family: inherit;
}
  .fa-whatsapp:before {
    font-size: 17px;
  }

  .close-toast{background:0 0;border:0;color:#fff;cursor:pointer;font-family:inherit;font-size:1em;opacity:.4;padding:0 5px}

@media only screen and (max-width: 1600px) {
  /* For mobile phones: */
  .mso-responsive{
    left: 4% !important;
  }
  .offset-auto-stops{
    padding-left: 7% !important;
    padding-right: 8% !important;
  }
  .tab .tablinks{
    font-size: 12px;
  }
  .wing-wrap{
    margin-bottom: 0px;
    padding:10px;
  }
  #title-alas{
    padding: 9px 0px;
    font-size: 16px;
    margin-bottom: 0px;
  }
  .right_btns{
  width: 200px;
  height: 50px;
}

.left_btns{
  width: 150px;
  height: 50px;
}
}

@media only screen and (max-width:1400px){
  .right_btns{
  width: 150px;
  height: 50px;
}

.left_btns{
  width: 100px;
  height: 50px;
}
}

@media only screen and (max-width: 1200px) {
  /* For mobile phones: */
  .mso-responsive{
    left: 4% !important;
  }
  .offset-auto-stops{
      padding-left: 7% !important;
  }
  .tab .tablinks{
    font-size: 12px;
  }
  .wing-wrap{
    margin-bottom: 0px;
    padding:10px;
    width:20%;
  }
  #title-alas{
    width:80%;
    padding: 12px 0px;
    font-size: 12px;
    margin-bottom: 0px;
  }
  .h6{
    font-size: 12px;
  }
}

@media only screen and (max-width: 1024px) {
  /* For mobile phones: */
  .mso-responsive{
    left: 4% !important;
  }
  .offset-auto-stops{
      padding-left: 7% !important;
  }
  .tab .tablinks{
    font-size: 12px;
  }
  .wing-wrap{
    margin-bottom: 0px;
    padding:4px;
    width:25%;
  }
  #title-alas{
    width:75%;
    padding: 6px 0px;
    font-size: 11px;
    margin-bottom: 0px;
    height: 20px;
  }
  .customt{
    font-size: 11px !important;
  }
  .right_btns{
  width: 120px;
  height: 35px;
}

.left_btns{
  width: 80px;
  height: 35px;
}

}

@media only screen and (max-width: 768px){
  .wing-wrap{
    width:25%;
  }
  #title-alas{
    padding: 7px 0px;
  }

}

@media only screen and (max-width: 720px){
  .pad-dest-form{
    padding-left: 5%;
    padding-right: 5%;
  }
  .wing-wrap{
    width:25%;
  }
}


  @media only screen and (max-width: 620px) {
  /* For mobile phones: */
  .row-buffer {
    margin-top: 0 !important;
  }
  .mso-responsive {
      left: 10% !important;
    }
  .offset-auto-stops{
      padding-left: 7% !important;
  }
}

@media only screen and (max-width: 474px){
  .container .confirm_cancel_trip_btn #row_confirm_btn{
    display: flex;
  }
  #left_btn_group{
      float:none; 
      margin-left:0;
  }
  #right_btn_group{
    float:none; 
    margin-right:0;
  }
}

@media only screen and (max-width: 430px) {
  /* For mobile phones: */
  .tab .tablinks{
    font-size: 12px;
  }
  .wing-wrap{
    width: 36%;
    margin-bottom: 0px;
    padding:4px;
  }
  #title-alas{
    padding: 0px 0px;
    font-size: 8px;
    margin-bottom: 0px;
    width:63%;
    height:20px;
  }
}

@media only screen and (max-width: 414px) {
  /* For mobile phones: */
  .tab .tablinks{
    font-size: 12px;
  }
  .wing-wrap{
    width: 36%;
    margin-bottom: 0px;
    padding:10px;
  }
  #title-alas {
    padding: 6px 0px;
    font-size: 10px;
    margin-bottom: 0px;
    width: 63%;
    height: 20px;
    }
}

@media only screen and (max-width: 375px) {
  /* For mobile phones: */
  .mso-responsive{
    left: 4% !important;
  }
  .offset-auto-stops{
      padding-left: 7% !important;
  }
  .tab .tablinks{
    font-size: 12px;
  }
  .wing-wrap{
    width: 33%;
    margin-bottom: 0px;
    padding:4px;
  }
  #title-alas{
    padding: 0px 0px;
    font-size: 8px;
    margin-bottom: 0px;
    width:67%;
    height:20px;
  }
}

@media only screen and (max-width: 320px) {
  /* For mobile phones: */
  .mso-responsive{
    left: 4% !important;
  }
  .offset-auto-stops{
      padding-left: 7% !important;
  }
  .tab .tablinks{
    font-size: 12px;
  }
  .wing-wrap{
    width: 33%;
  }
  .wing-wrap-title{
    font-size: 8px;
  }
}




</style>

<% if(typeof message != 'undefined'){ %>
    <div class="alert alert-success" role="alert">
      <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only"><%= __('button_close') %></span></button>
      <p align="center"> <strong><%= __(message) %></strong></p>
    </div>
 <% } %>  

    <script type='text/javascript' src='js/jquery.serializejson.js'></script>
    <script type='text/javascript' src='js/plugins/bootstrap/bootstrap-timepicker.min.js'></script>
    <script type='text/javascript' src='js/plugins/toastify/toastify.min.js'></script>
    
    

    <link rel="stylesheet" href="dispatcher_new_design/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="dispatcher_new_design/css/style.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="js/plugins/toastify/toastify.min.css" />

  <body class="gray_bg" style="background-color: #fff; font-family: 'Open Sans', sans-serif;">
    <div class="top" style="display: none;">
      <div class="top_left clr">
        <div class="menu_icon"><a href="javascript:void(0)" class="line"><span></span></a></div>
        <div class="hide_btn"><a href="javascript:void(0)"><i class="fa fa-chevron-left"></i></a></div>
      </div>
    </div>

    <div class="container" style="background-color: #fff;padding-left: 0;    padding-right: 0;position: absolute; min-height: 100vh;">
      <div  class="left_panel" style="background: #000;d-color: #fff;    box-shadow: 0px 0px 3px 1px gray;">
        <div class="main_info" style="background-color: #333952; height: 100%;">
          
          <div class="content fix_height_div" style="height: 100%; background-color: rgb(37 14 98);">
            <div class="panel panel-default tabs">
              <ul class="nav nav-tabs" role="tablist">
                <li class="active"><a href="#tab-one" role="tab" data-toggle="tab"><%= __('button_new_request') %></a></li>
                <li><a href="#tab-two" role="tab" data-toggle="tab"><%= __('button_accepted_request') %></a></li>
                <li><a href="#tab-three" role="tab" data-toggle="tab"><%= __('button_arrived_request') %></a></li>
                <li><a href="#tab-four" role="tab" data-toggle="tab"><%= __('button_started_request') %></a></li>
              </ul>

              <div class="tab-content tab-validate tab_class_for_logo" >
                <div class="tab-pane active" id="tab-one">
                  <div id="new_request">
                  </div>
                </div>
                <div class="tab-pane" id="tab-two">
                  <div id="accepted_request">
                  </div>
                </div>
                <div class="tab-pane" id="tab-three">
                  <div id="arrived_request">
                  </div>
                </div>
                <div class="tab-pane" id="tab-four">
                  <div id="started_request">
                  </div>
                </div>
              </div>

            </div>
            <div class="logo" style="text-align: center;">

              <img src="logo_corporate.png"  alt="" >
            </div>

          </div>
          <!-- <div class="content fix_height_div">
            <h5>New Request</h5>
            <div id="new_request">
            </div>
          </div>
          <div class="content fix_height_div">
            <h5>Accepted</h5>
            <div id="accepted_request">
            </div>
          </div>
          <div class="content fix_height_div">
            <h5>Arrived</h5>
            <div id="arrived_request">
            </div>
          </div>
          <div class="content fix_height_div">
            <h5>Started</h5>
            <div id="started_request">
            </div>
          </div> -->
        </div>

      </div>

      <div class="overflowdiv">
        <!--mainpage start -->
        <div class="main_page">

          <input type="hidden" id="src_lat_lng" name="src_lat_lng" />
          <input type="hidden" id="dest_lat_lng" name="dest_lat_lng" />
          <input type="hidden"  name="server_time" id="server_time"  />
          <input type="hidden" id="surge_start_time" name="surge_start_time" />
          <input type="hidden" id="surge_end_time" name="surge_end_time" />
          <input type="hidden" id="current_latitude" name="latitude" />
          <input type="hidden" id="current_longitude" name="longitude" />
          <input type="hidden"  name="rich_area_surge_multiplier" id="rich_area_surge_multiplier"  />
          <input type="hidden"  name="model_type" id="model_type"  />

          <div id="dest_stops_lat_lng_div"></div>
          <div id="int_stops_lat_lng_div"></div>

          <form id="signupForm" class= "form-horizontal" method="post" enctype="multipart/form-data">
            <div id="dest_stops_location_div"></div>
            <input type="hidden" id="optimize_field" name="optimize_field" />
            <input type="hidden"  name="created_by" id="created_by" value="<%= constant_json.CREATED_BY_CORPORATE_PANEL %>" />
            <input type="hidden" id="lat" name="latitude" />
            <input type="hidden" id="lng" name="longitude" />
            <input type="hidden" id="dlat" name="d_latitude" />
            <input type="hidden" id="dlng" name="d_longitude" />
            <input type="hidden"  name="timezone" id="timezone"  />
            <input type="hidden"  name="city_id" id="city_id"  />
            <input type="hidden"  name="payment_id" id="payment_id" value="0" />
            <input type="hidden" name="is_ride_later" id="is_ride_later" value="0">
            <input type="hidden" name="start_time" id="start_time">
            <input type="hidden"  name="country" value="<%= corporates.country %>" />
            <input type="hidden"  name="country_phone_code" value="<%= corporates.country_phone_code %>" />
            <input type="hidden" name="payment_mode" value="7">
            <input type="hidden"  name="is_surge_hours" id="is_surge_hours"  />
            <input type="hidden"  name="surge_multiplier" id="surge_multiplier"  />
            <input type="hidden" name="user_type" value="2">
            <input type="hidden"  name="user_type_id" id="user_type_id" value="<%= corporates._id %>"  />
            <input type="hidden"  name="trip_type"  value="<%= constant_json.TRIP_TYPE_CORPORATE %>"  />
            <input type="hidden" name="device" value="web">
            <input type="hidden"  name="token" id="token"  />
            <input type="hidden"  name="city" id="city" />
            <input type="hidden"  name="user_id" id="user_id" />
            <input type="hidden" name="phone" id="phone">
            <input type="hidden"  name="service_type_id" id="selected_service_type_id" />
            <input type="hidden"  name="selected_capacity_id" id="selected_capacity_id" />
            <input type="hidden"  name="selected_model_id" id="selected_model_id" />
            <input type="hidden"  name="selected_service_id" id="selected_service_id" />
            <input type="hidden"  name="selected_procedure" id="selected_procedure" />
            <input type="hidden"  name="selected_transit_service" id="selected_transit_service" />
            <input type="hidden"  name="selected_transit_type_number" id="selected_transit_type_number" />
            <input type="hidden"  name="is_use_capacity" id="is_use_capacity" />
            <input type="hidden"  name="is_use_model" id="is_use_model" />
            <input type="hidden"  name="is_fixed_fare" id="is_fixed_fare" value="true" />
            <input type="hidden"  name="fixed_price" id="fixed_price" />
            <input type="hidden"  name="is_use_service" id="is_use_service" />
            <input type="hidden"  name="courier_type" id="courier_type" value="0" />
            <input type="hidden" id="pickup_address" name="source_address">

            <input type="hidden" id="night_shifts_value" name="night_shifts_value" />
            <input type="hidden" id="ferry_ticket_value" name="ferry_ticket_value" />
            <input type="file" id="load_images" id="load_images" multiple style="display: none;">
            <data id="stops_data" value="[]" hidden></data>
            <!-- <input type="hidden" id="destination_addresses" name="destination_addresses[]" > -->
            <!-- <input type="hidden" id="inside_city_stops" name="inside_city_stops[]"> -->
            <!-- <input type="hidden" id="total_stops_inside_city" name="total_stops_inside_city" value="0"> -->
            
            <!-- <input type="hidden" id="d_stop_lat" name="d_stop_lat[]" />
            <input type="hidden" id="d_stop_lng" name="d_stop_lng[]" /> -->

            <input type="hidden" id="destination_address" name="destination_address">
            <!-- <input type="hidden" id="destination_stop" name="destination_stop"> -->
            <input type="hidden" id="number_of_trips" name="number_of_trips"  value="1"  />
            <input type="hidden" id="estimated_distance" name="estimated_distance">
            <input type="hidden" id="estimated_time" name="estimated_time">

            <div class="panel panel-default" id="provider_search_button" style="padding-top: 10px;box-shadow: 0 0 3px 0px gray;border-radius: 0;margin-bottom: 2px;" id="provider_filter">
              <div class="panel-body" style="padding: 0;">
              <!--<div class="col-md-2">-->
                <!--<select class="select form-control" id="provider_type_filter" >-->
                  <!--<option value="1">All</option>-->
                  <!--<option value="2">Online</option>-->
                  <!--<option value="3">Offline</option>-->
                  <!--&lt;!&ndash;<option value="4">In Trip</option>&ndash;&gt;-->
                  <!--<option value="5">Request <%= __('title_accepted_request') %></option>-->
                  <!--<option value="6">Arrived at Destination</option>-->
                  <!--<option value="7">Request Started</option>-->
                <!--</select>-->
              <!--</div>-->
                <div class="col-md-2">
                  <select class="select form-control" id="provider_filter_distance" onchange="get_all_provider()">
                    <option>1</option>
                    <option>2</option>
                    <option>5</option>
                    <option>10</option>
                    <option>50</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <button type="button" onclick="provider_filter(1)" id="tag_button1" class="tag_button selected_tag_button"><%= __('title_all') %></button>
                  <button type="button" onclick="provider_filter(2)" id="tag_button2" class="tag_button"><%= __('title_online') %></button>
                  <button type="button" onclick="provider_filter(3)" id="tag_button3" class="tag_button"><%= __('title_offline') %></button>
                  <button type="button" onclick="provider_filter(4)" id="tag_button4" class="tag_button"><%= __('title_active') %></button>
                  <button type="button" onclick="provider_filter(5)" id="tag_button5" class="tag_button"><%= __('title_trip_status_arrived') %></button>
                  <button type="button" onclick="provider_filter(6)" id="tag_button6" class="tag_button"><%= __('title_trip_status_trip_started') %></button>
                  <span id="all_provider_marker_length"></span>
                </div>
                <div class="col-md-2">
                  <input type="text" id="current_location_address" style="height: 25px;border: 0;border-bottom: 1px solid #a59d9d;border-radius: 0;" placeholder="<%= __('email_title_location') %>">
                </div>
                <div class="col-md-2">
                  <select id="current_location_service_type_id" onchange="get_all_provider()" name="service_type_id1" class="form-control select">
                    <option style="display: none" value="" selected><%= __('title_all') %></option>
                  </select>
                </div>
              </div>
            </div>

            <div class="map_div" id="wrapper" style="box-shadow: 0 0 3px 0px gray;">
              <div class="fr" id="new_request_div"><span onclick="new_request_creat(true)" class="new_req_btn" style="top: 95px;"><img src="map_pin/new_request.png"  style="float: right;"/></span></div>
              <div class="fr" id="mapview_div"><span onclick="go_to_mapview()" class="new_req_btn1"><img src="map_pin/home.png" style="float: right;" /></span></div>

              <div id="map" style="width:100%; height: 100%;"></div>
              <div class="hide" id="legend"><!--<h3><%= __("title_legend") %></h3>--></div>

            </div>
            
            <div class="get_provider_info" style="display: none;margin-top: 70px;box-shadow: -3px -5px 2px -5px #333;">
              <div class="row clr">
                <div class="col_2">
                  <h6><%= __('title_provider_id') %></h6>
                  <span id="provider_info_unique_id"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('title_name') %></h6>
                  <span id="provider_info_name"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('email_title_email') %></h6>
                  <span id="provider_info_email"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('title_phone') %></h6>
                  <span id="provider_info_phone"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('title_status') %></h6>
                  <span id="provider_info_status"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('title_rating') %></h6>
                  <span id="provider_info_rating"></span>
                </div>
              </div>
              <div class="row clr" style="margin-top: 20px;margin-left: 15px;" id="provider_info_trip">
                <div class="col_3">
                  <div class="select_div">
                    <input type="hidden" name="select_trip_provider" id="select_trip_provider">
                    <select id="select_trip" name="trip_id" class="form-control">
                    </select>
                  </div>
                </div>
                <div class="col_3">
                  <button type="button" onclick="assign_request()" class="btn-block" id="send_request1"><%= __('title_send_request') %></button>
                </div>
              </div>
            </div>
            <div class="pickup_info" style="display: none;box-shadow: 0 0 3px 0px gray;">
              <div class="row clr">
                <div class="col_2">
                  <h6><%= __('title_trip') %></h6>
                  <span id="show_unique_id"></span> <br><span id="show_created_date"></span>
                </div>
                <!--<div class="col_2">-->
                  <!--<h6>Pickup Time</h6>-->
                  <!--<span>ASAP</span>-->
                <!--</div>-->
                <div class="col_2">
                  <h6><%= __('title_provider') %></h6>
                  <span id="show_provider_name"></span> <br><span id="show_provider_phone"></span>
                </div>

                <div class="col_2">
                  <h6><%= __('title_user') %></h6>
                  <span id="show_user_name"></span> <br><span id="show_user_phone"></span>
                </div>

                <div class="col_2">
                  <h6><%= __('pickup') %></h6>
                  <span id="show_source_address"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('destination') %></h6>
                  <span id="show_destination_address"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('title_truck_model') %></h6>
                  <span id="show_trip_type"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('title_truck_type') %></h6>
                  <span id="show_truck_type"></span>
                </div>
                <div class="col_2">
                  <h6><%= __('title_plate_no') %></h6>
                  <span id="show_plate_no"></span>
                </div>

              </div>
            </div>

            <div class="new_req_info"  >
              <div class="select_old_new_req" style="text-align: center;">
              <div class="row">
                <p class="select_any_req_text"> <%= __('title_choose_option') %><br><%= __('title_and_start') %></p>
              </div>
              
              
              <div class="row"> 
                <button id="create_new_req_btn" class="req_selection_btn" type="button">
                  <!-- <span class="circle-background"></span> -->
                  <img src="/corporate_images/circle.png" alt="" class="base-image">
                  <img src="/corporate_images/corporate_truck.png" alt="Create Trip" class="overlay-image1">
                  <span class="btn_title"><%= __('button_create_a') %> <br> <%= __('button_new_req') %></span>
                </button>
                <button id="repeat_order_btn" class="req_selection_btn" type="button">
                  <!-- <span class="circle-background"></span> -->
                  <img src="/corporate_images/circle.png" alt="" class="base-image">
                  <img src="/corporate_images/corporate_repeat_order.png" alt="Repeat Order" class="overlay-image2">
                  <span class="btn_title"><%= __('button_repeat_order') %></span>
                </button>
                <!--<button id="bulk_orders_btn" class="req_selection_btn" type="button">
                  <img src="/corporate_images/circle.png" alt="" class="base-image">
                  <img src="/corporate_images/corporate_repeat_order.png" alt="Repeat Order" class="overlay-image2">
                  <span class="btn_title"><%= __('title_bulk_orders') %></span>
                </button>-->
              </div>
              
            </div>
            
            <!-- <div class="set_location" > -->
              <div class="set_location" style="display: none; " >
                <form id="set_location_form" >
                  <div class="container">
                    <div class="row clr">
                      <div class="col-sm-6 green_bg pickup_field">
                        <input type="text" class="pickup_field place_holder_city_pickup" id="pickup" name="source_address" placeholder="<%= __('title_enter_pickup_address') %>" required/>
                        <span class="pickup_field" style="left: 10px !important;"><i class="fa fa-map-marker pickup_field"></i></span>
                      </div>
                      <div class="destination_field col-sm-6 red_bg" hidden>
                        <input type="text" class="destination_field place_holder_city"  id="destination" name="destination_address" style="display: inline-block;" alt="<%= __('tooltip_destination_address') %>"  title="<%= __('tooltip_destination_address') %>"  placeholder="<%= __('title_enter_dest_address') %>"/>
                        <input type="hidden" id="destination_stops" name="destination_stops[]" />
                        <span class="destination_field"><i class="fa fa-map-marker destination_field"></i></span>
                        <!--<button type="button" onclick="show_internal_stop_modal(0)" class="destination_field int_stop_btn addstop" alt="<%= __('tooltip_stops_address') %>"  title="<%= __('tooltip_stops_address') %>"  ><%= __('title_add_internal_stops') %> <i class="fa fa-plus-circle" aria-hidden="true"></i></button>-->
                      </div>
                      <div class="col-sm-6">
                        <!-- <span class="right-span" onclick="show_internal_stop_modal(0)"><i class="fa fa-plus-circle" aria-hidden="true"></i></span> -->
                        <% if(setting_detail.is_allow_multiple_stop){%>
                          <div class="addstop">
                            <button type="button" class="addstop" onclick="addStop()"><%= __('title_add_stop') %></label>
                            <label id="add_stop_message" class="error" style = "margin-bottom: 1em;"><%= __('validation_max_stops') %></label>
                          </div>
                          <% } %>
                      </div>
                      <div class="row clr" style="text-align: center;">
                        <div class="col-sm-12" id="multiple_stops"></div>
                        <div style="margin-bottom: 1%;border: inset;" class="col-sm-5"id="multiple_stops_optimized" hidden>
                      </div>
                    </div>
                      </div>
                      <div class="row clr pickup_field">
                        <div class="col-sm-6">
                          <span style="display: inline-block; width: fit-content ">Distancia aproximada: </span >
                          <input id="show_distance" style="display: inline-block; width: 40%;" type="text" value="0" readonly>
                        </div>
                        <div class="col-sm-6">
                          <span style="display: inline-block; width: fit-content">Optimizar ruta: </span >
                          <label style="display: inline-block; vertical-align: -webkit-baseline-middle;" class="switchp">
                            <input id="b_optimize" onclick="optimalPanel()" type="checkbox">
                            <span class="sliderp roundp"></span>
                          </label>
                        </div>
                      </div>
                      <div class="row clr">
                        <div class="col_6 red_bg">
                          <div class=" text-right addstop">
                            <label  class="c-pointer" onclick=""></label>
                            
                          </div>
                        </div>
                      </div>
                    </div>
                  </form>
                <!-- </form> -->
                
              </div>
              
              <div class="vehicle_selection" style="display: none; ">
                <form id="vehicle_selection_form">
                  <div class="container">
                  <div class="row clr">
                    <% if(country == 'Panama'){%>
                    <div class="col-sm-4">
                      <input type="hidden" name="city_types_list[]" id="city_types_list">
                      <select id="select_procedure"  name="select_procedure" class="form-control select" data-none-selected-text="<%= __('title_nothing_selected') %>" data-live-search="true">
                        <option selected disabled hidden style='display: none'><%= __('title_select_type_of_procedure') %></option>
                        <option value="<%= PROCEDURE_TYPE.GENERAL_MERCHANDISE %>"><%= __('title_general_mechandise') %></option>
                        <option value="<%= PROCEDURE_TYPE.FISCAL_TI_MERCHANDISE %>"><%= __('title_fiscal_ti_merchandise') %></option>
                        <option value="<%= PROCEDURE_TYPE.LIQUIDAR_MERCHANDISE %>"><%= __('title_merchandise_liquidar') %></option>
                      </select>
                    </div>
                    <div class="col-sm-4 transit_service_div" style="display: none;">
                      <select id="select_transit_service"  title="<%= __('title_no_value') %>" name="select_transit_service" class="form-control select">
                        <option selected disabled hidden style='display: none'><%= __('title_need_internal_transit_service') %></option>
                        <option value="1"><%= __('title_yes') %></option>
                        <option value="0"><%= __('title_no') %></option>
                      </select>
                    </div>
                    <div class="col-sm-4 type_number_div" style="display: none;">
                      <select id="select_type_number" title="<%= __('title_no_value') %>" name="select_type_number" class="form-control select">
                        <option selected disabled hidden style='display: none'><%= __('title_select_type_number') %></option>
                        <% for(i = 1; i <= 10; i ++){%>
                          <option value="<%=i%>"><%=i%></option>
                        <% }%>
                      </select>
                    </div>
                    <% }%>
                  </div>
                  <div class="row clr row-buffer">
                    <div class="col-sm-4">
                      <input type="hidden" name="city_types_list[]" id="city_types_list">
                      <select id="service_type_id"  name="service_type_id" class="form-control select" data-none-selected-text="<%= __('title_nothing_selected') %>" data-live-search="true">
                        <option selected disabled hidden style='display: none'><%= __('title_select_type_of_truck') %></option>
                      </select>
                      <!--<lable id="message" style="color:red;" ></lable>-->
                    </div>
                    <div class="col-sm-4 select_model_hide">
                      <select id="selected_model"  title="<%= __('title_no_value') %>" name="selected_model_id" class="form-control select">
                        <option style="display: none" selected><%= __('title_corporate_select_model') %></option>
                      </select>
                    </div>
                    <div class="col-sm-4">
                      <select id="selected_capacity" title="<%= __('title_no_value') %>" name="selected_capacity_id" class="form-control select">
                        <option style="display: none" selected><%= __('title_select_capacity') %></option>
                      </select>
                    </div>
                  </div>
                  <div class="row clr row-buffer">

                    <div class="col-sm-4 select_services_hide">
                      <select id="selected_services" title="<%= __('title_no_value') %>" name="selected_services_id" class="form-control select">
                        <option style="display: none" selected><%= __('title_select_service') %></option>
                      </select>
                    </div>
        
                    <div class="col-sm-4">
                        <div class="select_div" style="margin-bottom: 10px;">
                          <select id="select_user" name="select_user" data-live-search="true" class="form-control select">
                            <option selected disabled hidden style='display: none'><%= __('title_user') %></option>
                            <% user_list.forEach(function(user){ %>
                              <option id="<%= user._id %>" data-phone="<%= user.phone %>" data-first_name="<%= user.first_name %>" data-last_name="<%= user.last_name %>" data-email="<%= user.email %>" value="<%= user._id %>"><%= user.first_name %> <%= user.last_name %> (<%= user.phone %>)</option>
                            <% }) %>
                          </select>
                        </div>
                    </div>
                    
                    <div class="col-sm-4">
                      <select class="form-control select" name="create_number_of_trips" id="create_number_of_trips">
                        <option disabled selected><%= __('title_num_of_trips') %></option>
                        <% for(let i=1; i<=10; i++ ) { %>
                          <option value="<%=i%>"><%=i%></option>
                        <% } %>
                      </select>
                    </div>
                  </div>

                  <div class="row clr selection_row3_hide row-buffer" style="margin-bottom: 20px;">

                    <div class="col-sm-4">
                      <select class="form-control select" name="select_helpers_for_load" id="select_helpers_for_load">
                        <option value="0" selected><%= __('title_number_of_helpers_for_load') %></option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                    </div>

                    <div class="col-sm-4">
                      <select class="form-control select" name="select_helpers_for_download" id="select_helpers_for_download">
                        <option value="0" selected><%= __('title_number_of_helpers_for_download') %></option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                    </div>
                    <div class="col-sm-4 night_shift">
                      <select class="form-control select" name="night_shift" id="night_shift">
                        <option disabled value="0" selected><%= __('title_night_shift') %></option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                    </div>
                  </div>
                </div>
                
          </form>
        </div>

              <!-- <div class="pick_dest_details"> -->
          <div class="pick_dest_details" style="display: none;">

            <form id="pick_dest_details_form">
              <div class="container">
                <div class="d-flex justify-content-center" >
                  <div class="col-md-6 pad-dest-form" >
                    <h6 class="text_center"><%= __("title_pickup_details") %></h6>
                    <div class="form_group col-md-12 pad-dest-form">
                      <input type="text" class="field_style" name="pickup_company_name" id="pickup_company_name" placeholder="<%= __('title_company_name') %>" >
                    </div>

                    <div class="form_group col-md-12 pad-dest-form">
                      <input type="text" class="field_style" name="pickup_username" id="pickup_username" placeholder="<%= __('title_name') %>">
                    </div>

                    <div class="form-group col-md-6 pad-dest-form">
                      <div class="row" style="width: -webkit-fill-available; display: inline-flex;">
                        <div class="col-md-3" style="padding-left: 15px; width: 30%;display: inline-flex;">
                          <input type="text" class="field_style" name="pickup_phone_code" value="<%= corporates.country_phone_code %>" id="pickup_phone_code" readonly />
                        </div><div class="col-md-9" style="padding-right: 14px; width: 100%;display: inline-flex;">
                          <input type="text" onkeypress="return isNumberKey(event);" class="field_style" id="pickup_phone" name="pickup_phone" minlength="<%= setting_detail.minimum_phone_number_length%>" maxlength="<%= setting_detail.maximum_phone_number_length%>" placeholder="<%= __('title_phone') %>" />
                        </div>
                      </div>
                    </div>
                    <div class="form_group weight_load col-md-12 pad-dest-form">
                      <input type="text" onkeypress="return isNumberKey(event);"
                      class="field_style" name="pickup_weight_of_load"
                        id="pickup_weight_of_load"
                        placeholder="<%= __('title_weight_of_load') %> (Kg)" >
                    </div>
                    <div class="form_group volume_load col-md-12 pad-dest-form">
                      <input type="text" onkeypress="return isNumberKey(event);"
                      class="field_style" name="pickup_volume_of_load"
                        id="pickup_volume_of_load"
                        placeholder="<%= __('title_volume_of_load') %> (M3)" >
                    </div>
                    <div class="form_group col-md-12 pad-dest-form">
                      <input type="text" class="field_style" 
                        name="pickup_description" id="pickup_description"
                        placeholder="<%= __('title_description') %>">
                    </div>
                  </div>
                  <div class="col-md-6 pad-dest-form" >
                    <h6 class="text_center"><%= __("title_delivery_details") %></h6>

                    <div class="form_group col-md-12 pad-dest-form">
                      <input type="text" class="field_style" name="delivery_company_name" id="delivery_company_name" placeholder="<%= __('title_company_name') %>" >
                    </div>

                    <div class="form_group col-md-12 pad-dest-form">
                      <input type="text" class="field_style" name="delivery_username" id="delivery_username" placeholder="<%= __('title_name_of_delivery_receiver') %>" >
                    </div>

                    <div class="form-group col-md-12 pad-dest-form">
                      <div class="row" style = "width: -webkit-fill-available; display: inline-flex;">
                        <div class="col-md-3" style="padding-left: 15px; width: 30%;display: inline-flex;">
                          <input type="text" class="field_style" name="delivery_phone_code"  id="delivery_phone_code"  value="<%= corporates.country_phone_code %>" readonly />
                        </div>
                        <div class="col-md-9" style="width: 100%;padding-right: 14px;display: inline-flex;">
                          <input type="text" onkeypress="return isNumberKey(event);" class="field_style" id="delivery_phone" name="delivery_phone" minlength="<%= setting_detail.minimum_phone_number_length%>" maxlength="<%= setting_detail.maximum_phone_number_length%>" placeholder="<%= __('title_phone') %>" />
                        </div>
                      </div>
                    </div>

                    <div class="form_group col-md-12 pad-dest-form">
                      <input type="text" class="field_style" name="delivery_description" id="delivery_description" placeholder="<%= __('title_note_singular') %>">
                    </div>

                    <div class="form-group col-md-12 pad-dest-form">
                      <div class="col-4" style="display: none;"
                      id="show_boat_ticket">

                        <span class="radio_label">
                          <b>
                            <%= __('title_boat_ticket')%>
                          </b>
                        </span>
                        <label style="margin-left: 5px;">
                          <input class="icheckbox" type="radio" name="ticket_boat" value="1" /> 
                          <span class="radio_label">
                            <%= __('title_yes')%>
                          </span>
                        </label>
                        <label style="margin-left: 5px;">
                        <input class="icheckbox" 
                          type="radio" name="ticket_boat" value="0" /> 
                          <span class="radio_label">
                            <%= __('title_no')%>
                          </span>
                        </label>
                      </div>
                    </div>

                  </div>

                  <div class="form group col-md-12 pad-dest-form" style="text-align: -webkit-center;">
                    <p style="padding: 33px 0px; font-weight: 500;"><%= __('title_select_load_images') %></p>

                    <div class="image-selector">
                      <span>+</span>
                    </div>
                    <p id="fileCount" style="font-size: 10px;"></p>
                  
                  </div>
                </div>
              </div>
            </form>

          </div>

            <!-- heretabs > -->
          <div class="order_summary" style="display: none;"  >
              <!-- <div class="order_summary"  > -->

            <form id="order_summary_form">
                <div class="container" style="margin-top: 0;">
                  <div class="row">
                    <div class="tab col-md-3" style="display: inline-block">
                      <div class="row" style="
                      background-color: #00bbb4;
                      color: white;
                      margin: auto;
                      text-align: center;
                      font-weight: bold;
                      ">
                        <div class="col-sm-2 wing-wrap" style = "text-align: center; background-color: #250e62; float: left;">
                          <img src="./FLETY_ALAS.png">
                        </div>
                        <div id="title-alas" class="col-sm-10">
                          <%= __("title_shipping_details") %>
                        </div>
                      </div>
                      <button type ="button" class="tab-bborder tablinks " onclick="openTab(event, 'oridest-tab')" id="defaultOpen">Origen / Destino</button>
                      <button type ="button" class="tab-bborder tablinks " onclick="openTab(event, 'stops-tab')">Paradas</button>
                      <button type ="button" class="tab-bborder tablinks " onclick="openTab(event, 'vehicle-tab')">Datos Camin</button>
                      <button type ="button" class="tab-bborder tablinks " onclick="openTab(event, 'trippayment-tab')">Detalles Viaje / Pago</button> 
                    </div>

                  <div class="row tabcontent" id="oridest-tab" style="position: relative; height:auto;">
                    <div class="col-md-5 order_details_pickup_div">
                      <div class="customt"><%= __('title_pickup_details') %></div>
                      <div class="order_details_pickup_box">
                        <div class="container-fluid">
                          <div class="row">
                            <div class="col-md-12">
                              <label class="label-summary"><%= __('title_name') %></label>
                            </div>
                            <div class="col-md-12" style="text-align: right;">
                              <div class="values-summary" id="order_pickup_name" ></div>
                            </div>
                          </div>
                          <div class="row bb-custom"></div>
                        </div>
                        <div class="container-fluid">
                          <div class="row">
                            <div class="col-md-12">
                            <label class="label-summary"><%= __('title_address') %></label>
                            </div>
                            <div class="col-md-12"  style="text-align: right;">
                              <div id="order_pickup_address" class="prevent_overflow values-summary"></div>
                            </div>
                          </div>
                          <div class="row bb-custom"></div>
                        </div>
                        <div class="container-fluid">
                          <div class="row">
                            <div class="col-md-12">
                              <label class="label-summary"><%= __('title_phone') %></label>
                            </div>
                            <div class="col-md-12" style="text-align: right;">
                              <div id="order_pickup_phone" class="values-summary" ></div>
                            </div>
                          </div>
                          <div class="row bb-custom"></div>
                        </div>
                        <div class="container-fluid">
                          <div class="row">
                            <div class="col-md-12">
                            <label class="label-summary"><%= __('title_pickup_description') %></label>
                            </div>
                            <div class="col-md-12"  style="text-align: right;">
                              <div id="order_pickup_description" class="prevent_overflow values-summary"></div>
                            </div>
                          </div>
                        </div>
                    </div>
                  </div>

                  <div class="col-md-6 order_details_pickup_div">
                    <div class="customt"><%= __('title_delivery_details') %></div>
                    <div class="order_details_pickup_box">
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                            <label class="label-summary"><%= __('title_address') %></label>
                          </div>
                          <div class="col-md-12"  style="text-align: right;">
                            <div id="order_delivery_address" class="prevent_overflow values-summary"></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row" style="margin: 13px -15px 0px -15px;">
                          <div class="col-md-12">
                            <label class="label-summary"><%= __('title_number_of_helpers_for_load') %></label>
                          </div>
                          <div class="col-md-12" style="text-align: right;">
                            <div id="order_helpers_load" class="values-summary" ></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row" style="margin: 13px -15px 0px -15px;">
                          <div class="col-md-12">
                            <label class="label-summary"><%= __('title_number_of_helpers_for_download') %></label>
                          </div>
                          <div class="col-md-12" style="text-align: right;">
                            <div id="order_helpers_download" class="values-summary" ></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row" style="margin: 13px -15px 0px -15px;">
                          <div class="col-md-12">
                            <label class="label-summary"><%= __('title_count_night_shift') %></label>
                          </div>
                          <div class="col-md-12" style="text-align: right;">
                            <div id="order_night_shifts" class="values-summary" ></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                          <label class="label-summary"><%= __('title_pickup_description') %></label>
                          </div>
                          <div class="col-md-12"  style="text-align: right;">
                            <div id="order_delivery_description" class="values-summary" class="prevent_overflow"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>

                
                
                </div>

                <div class="row tabcontent" id="stops-tab" style="position: relative;">
                  <div class="col-md-10 order_details_pickup_div" class="other_city_stops">
                    <div class = "customt"><%= __('title_stops_details') %></div>
                    <div class="order_details_pickup_box">
                      <div id = "summary_stops_see" class="stop_addresses"></div>
                      <button type="button" id="textButton" class="see_more" onclick="seeMoreLess();">Ver ms paradas adicionales &#8853;</button>
                    </div>
                  </div>
                </div>

                <div class ="row tabcontent" id="vehicle-tab" style="position: relative;height:auto;">
                  <div class="col-md-6 order_details_pickup_div">
                    <div class="customt"><%= __('title_vehicle_details') %></div>
                    <div class="order_details_pickup_box">
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                          <label style="font-weight: bold;color: black;"><%= __('title_type_of_truck') %></label>
                          </div>
                          <div class="col-md-12" style="text-align: right;">
                            <div style="text-align: right;" id="order_truck_type" class="values-summary"></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                          <label style="font-weight: bold;color: black;"><%= __('title_capacity') %></label>
                          </div>
                          <div class="col-md-12"  style="text-align: right;">
                            <div style="text-align: right;" class="values-summary" id="order_truck_size"></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                          <label style="font-weight: bold;color: black;"><%= __('title_truck_model') %></label>
                          </div>
                          <div class="col-md-12" style="text-align: right;">
                            <div style="text-align: right;" class="values-summary" id="order_truck_model" ></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                          <label style="font-weight: bold;color: black;"><%= __('title_type_of_services') %></label>
                          </div>
                          <div class="col-md-12" style="text-align: right;">
                            <div style="text-align: right;" class="values-summary" id="order_truck_service" ></div>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
                </div>

                <div class="row tabcontent" id="trippayment-tab" style="position: relative;height:auto;">
                  <div class="col-md-5 order_details_pickup_div">
                    <div class = "customt"><%= __('title_trip_fare_details') %></div>
                    <div class="order_details_pickup_box">
                        <div class="container-fluid">
                          <div class="row">
                            <div id ="total_distance_title_div" style="display: none" class="col-md-12">
                              <label class="label-summary"><%= __("title_invoice_total_distance") %></label>
                            </div>
                            <div id="total_distance_div" class="col-md-12" style="text-align: right; display: none;">
                              <div style="color:rgb(0 191 179);"><span id="total_distance">N/A</span>km</div>
                            </div>
                            <div id ="total_distance_fixed_title_div" style="display: none" class="col-md-12">
                              <label class="label-summary"><%= __("title_invoice_total_distance_fixed") %></label>
                            </div>
                            <div id="total_distance_fixed_div"  class="col-md-12" style="text-align: right; display: none;">
                              <div style="color:rgb(0 191 179);"><span id="total_distance_fixed">N/A</span> km</div>
                            </div>
                          </div>
                          <div class="row bb-custom"></div>
                        </div>
                        <div class="container-fluid">
                          <div class="row"  id="row_price_per_km">
                            <div class="col-md-12">
                              <label class="label-summary"><%= __("title_distance_fare") %></label>
                            </div>
                            <div class="col-md-12" style="text-align: right;">
                              <div style="color:rgb(0 191 179);">$<span id="price_per_km">N/A </span><%= __("unit_by_km") %></div>
                            </div>
                          </div>
                          <div class="row bb-custom"></div>
                        </div>
                        <div class="container-fluid">
                          <div class="row">
                            <div class="col-md-12">
                              <label class="label-summary"><%= __("title_estimated_time") %></label>
                            </div>
                            <div class="col-md-12" style="text-align: right;">
                              <div style="color:rgb(0 191 179);"><span id="estimate_hours">N/A </span>&nbsp;<%= __("hours_unit") %></div>
                            </div>
                          </div>
                          <div class="row bb-custom"></div>
                        </div>
                        <div class="container-fluid">
                          <div class="row">
                            <div class="col-md-12">
                            <label class="label-summary"><%= __("title_cancellation_fee") %></label>
                            </div>
                            <div class="col-md-12" style="text-align: right;">
                              <div style="color:rgb(0 191 179);">$<span id="cancellation_fee">XX</span></div>
                            </div>
                          </div>
                        </div>
                        <div class="container-fluid">
                          <div class="row" id="ferry_message_div" style="display: none;">
                            <div class="col-md-12">
                            <label class="label-summary"><%= __("title_ferry_ticket") %></label>
                            </div>
                            <div class="col-md-12" style="text-align: right;">
                              <div style="color:rgb(0 191 179);">$<span id="ferry_ticket">XX</span></div>
                            </div>
                          </div>
                        </div>
                        <div class="container-fluid">
                          <div class="row" id="fare_message_div" style="display: none;">
                            <div class="col-md-12">
                            <p style="text-align: center;"> <strong id="min_fixed_fare_message" ></strong></p>
                          </div>
                          
                        </div>
                      </div>
                    </div>

                  </div>

                  <div class="col-md-5 order_details_pickup_div">
                    <div class = "customt"><%= __("title_payment_details") %></div>
                    <div class="order_details_pickup_box">
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                          <label class="label-summary"><%= __("title_trip_amount") %></label>
                          </div>
                          <div class="col-md-12" style="text-align: right;">
                            <div style="color:rgb(0 191 179);">$<span id="order_amount">XX</span></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                          <label class="label-summary"><%= __("title_requested_trips") %></label>
                          </div>
                          <div class="col-md-12"  style="text-align: right;">
                            <div class="values-summary" id="order_trips" ></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-6">
                          <label class="label-summary"><%= __("title_total_amount") %></label>
                          </div>
                          <div class="col-md-6">
                            <a id="promoApplyButton" href="#" style="color: deepskyblue; text-decoration: none; float: right;" onclick="open_promo_modal()"><%= __("title_promo") %></a>
                            <span id="promoAppliedText" style="color: #43A422; display: none; float: right;"><%= __("success_promo_apply") %>!!</span>
                          </div>

                          <div class="col-md-12" style="text-align: right;">
                            <div style="color:rgb(0 191 179);">$<span id="order_total_amount">XX</span></div>
                          </div>
                        </div>
                        <div class="row bb-custom"></div>
                      </div>
                      <div class="container-fluid">
                        <div class="row">
                          <div class="col-md-12">
                          <label class="label-summary"><%= __("title_pay_with") %></label>
                          </div>
                          <div class="col-md-12"  style="text-align: right;">
                            <div class="values-summary" id="order_pay_type"><%= __("title_credit") %></div>
                          </div>
                          <span id="message" style="color:red;"></span>
                        </div>
                      </div>
                      </div>
                  </div>

                </div>

                
                  </div>

                    <div class="confirm_cancel_trip_btn" style="text-align: center; margin-bottom: 5%;">
                      <div id ="row_confirm_btn" class="row">
                        <div id="left_btn_group">
                          <button id="cancel_trip_btn" style="background-color: #f5f5f5; color: #25215f; font-weight: bolder;" class="confirm_trip_btn left_btns" type="button"> <%= __("button_cancel") %> </button>
                          <button id="main_back_btn" style="background-color: #f5f5f5; color: #25215f; font-weight: bolder;"  class="confirm_trip_btn left_btns" type="button"> <%= __("button_back") %> </button>
                        </div>
                        <div id="right_btn_group">
                          <button id="confirm_trip_btn" class="confirm_trip_btn right_btns" type="button"> <%= __("button_request_courier_service") %> </button>
                          <button id="scheduled_trip_btn" class="confirm_trip_btn right_btns" type="button"> <%= __("button_schedule_request") %> </button>
                        </div>
                      </div>
                    </div>
                  </div>
            </form>
          </div>
        <div class="trip_success_page"  style="display: none" >
          <!-- <div class="trip_success_page"  > -->
            <div class="row"> 
            </div>
              <div class="row"> 
                <div class="col-md-4 col-md-offset-4"   >
                  <% if(corporates.is_trip_approve == 1){ %>
                    <div class="success_message"><%= __('success_create_trip_sub_corporate') %></div>
                  <% }else{%> 
                    <div class="success_message"><%= __('success_create_trip') %></div>
                  <% }%>
            </div>
        </div>
      </div>

            <!-- <div class="select_info" >
              <div class="row clr">
                <div class="col_4" style="display: none;">
                  <div class="time_info clr" id="min_fare_div" style="display: none;">
                    <div class="col_4">
                      <h6><%= __("title_schedule_request") %></h6><span id="total_distance"></span> km
                    </div>
                    <div class="col_4">
                      <h6><%= __("title_invoice_total_time") %></h6><span id="total_time"></span> min
                    </div>
                    <div class="col_4">
                      <h6><%= __("title_invoice_fare") %></h6><span id="min_fare_lable"></span>
                    </div>
                  </div> -->
                  <!--<div class="price">-->
                    <!--<label><%= __("title_invoice_fare") %></label> : <span id="min_fare_lable"></span>-->
                  <!--</div>-->
                  <!-- <div class="book_btn">
                    <div class="row clr">
                      <div class="col_6"><button id="ridenow" type="submit"><%= __('button_ride_now') %></button></div>
                      <div class="col_6"><button type="button" id="ridelater" class="btn"><%= __('button_ride_later') %></button></div>
                    </div>
                  </div>
                </div>
              </div>
            </div> -->
            <div class="forward_backward_btn" style="text-align: center; display: none;">
              <div class="row" style="padding: 16px; display: flex; justify-content: space-around;"> 
                <button id="back_btn"  class="page_chng_btns" type="button"> <%= __('button_back') %> </button>
                <button id="next_btn" class="page_chng_btns" type="button"  ><%= __('button_next') %></button>
              </div>
            </div>
          </div>
          <form id="send_request_form">
            <div class="no_provider_found_div" style="display: none;margin-top: 10px;">
                <input type="hidden" name="trip_id" id="send_trip_id">
                <div class="select_info">
                  <div class="clr">
                    <div class="col_3">
                        <div class="select_div">
                          <select id="provider_type1" name="provider_type" data-live-search="true" class="form-control select">
                            <option selected value="1"><%= __('nearest') %></option>
                            <option value="2"><%= __('manual') %></option>
                          </select>
                        </div>
                    </div>
                    <div class="col_9" id="provider_div1" style="display: none;">
                      <div class="col_4">
                        <select id="select_provider1" name="provider_id" data-live-search="true" class="form-control">
                          <option selected style="display: none;"><%= __('title_select_provider') %></option>
                        </select>
                      </div>
                      <div class="col_8">
                        <div class="col_6">
                          <input type="text" class="form-control" name="provider_full_name" id="provider_full_name1" placeholder="<%= __('title_name') %>">
                        </div>
                        <div class="col_6">
                          <input type="tel" class="form-control" name="provider_phone" id="provider_phone1" placeholder="<%= __('title_phone') %>">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <div class="text_center">
                <button id="send_request"><%= __('title_send_request') %></button>
              </div>
            </div>
          </form>
          
        </div>

      </div>
    </div>


    <div class="modal animated fadeIn" data-backdrop="static" data-keyboard="false" id="ridelater_modal" tabindex="-1" role="dialog" aria-labelledby="smallModalHead" aria-hidden="true">
      <div class="modal-dialog modal-sm" style="    top: 127px;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only"><%= __('button_close') %></span></button>
            <label><%= __('title_select_date_time') %></label>
          </div>
          <div class="modal-body">
            <div class="form-group col-md-12">
              <div class="col-md-12">
                <lable><%= __('title_please_select_date') %></lable>
              </div>

              <div class="col-md-12">
                <input type="text" class="form-control datepicker" placeholder="<%= __('title_please_select_date') %>" name="date" id="date" readonly/>
              </div>
            </div>
            <div class="form-group col-md-12">
              <div class="col-md-12">
                <lable><%= __('title_select_time') %></lable>
              </div>
              <div class="col-md-12">
                <input type="text" class="form-control timepicker" name="<%= __('title_select_date') %>" id="time" readonly />
              </div>
            </div>
            <lable id="date_time_error" class="error"></lable>

          </div>
          <div class="modal-footer" style="text-align: center;">
            <input type="button" class="btn btn-primary" id="ride_laters" value="<%= __('button_apply') %>">

          </div>
        </div>
      </div>
    </div>
    <div class="modal animated fadeIn" id="internal_stop_modal" tabindex="-1" role="dialog" aria-labelledby="smallModalHead" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" >
        <div class="modal-content" style="width: 524px; border-width: 3px;">
          <div class="modal-header" data-dismiss="modal">
            <button type="button" class="close" style="margin-right: -19px; margin-top: -5px;" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only"><%= __('button_close') %></span></button>
            <h5 class="modal-title" style="color: rgb(37 14 98); text-align: center; margin-left: 82px;"><%= __('title_inside_stops') %></h5>
          </div>
          <div class="modal-body" style="overflow-y: auto; max-height: 60vh;">
            <form id="internal_stops_form">
             <div id="internal_stops"></div>
           </form>
            <% if(setting_detail.is_allow_multiple_stop){%>
              <div class=" text-right">
                <label  class="c-pointer" onclick="addInternalStop()">+ <%= __('title_add_internal_stops') %></label>
                <label id="add_internal_stop_message" class="error"><%= __('validation_stop_limit_internal_stop') %></label>
              </div>
              <% } %>
            </div>
            <div class="error-message" style="display: none;" id="valid_add_msg">
              <%= __('title_valid_address_city') %>
            </div>
          
            <div class="modal-footer" style="text-align: center;">
              <input type="button" id="confirm_int_stop" style="background: rgb(0 191 179); width: 23%; border-radius: 22px; color: white;
              font-weight: 600;"  value="<%= __('button_confirm') %>">
            </div>    
        </div>
      </div>
    </div>
    <div class="modal animated fadeIn" id="stop_user_data_modal" tabindex="-1" role="dialog" aria-labelledby="smallModalHead" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" >
        <div class="modal-content" style="width: 524px; border-width: 3px;">
          <div class="modal-header" data-dismiss="modal">
            <button type="button" class="close" style="margin-right: -19px; margin-top: -5px;" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only"><%= __('button_close') %></span></button>
            <h5 class="modal-title" style="color: rgb(37 14 98); text-align: center;">User Detail</h5>
          </div>
          <div class="modal-body" style="overflow-y: auto; max-height: 60vh;">
            <form id="stops_user_data_form">
             <div id="stops_user_data">
              <div class="col_12">
                <input type="text" id="stop_username_field" name="stop_username_field" class="place_holder_stop" placeholder="Name"/>
                <input type="number" id="stop_user_phone1_field" name="stop_user_phone1_field" class="place_holder_stop" placeholder="Phone 1"  />
                <input type="number" id="stop_user_phone2_field" name="stop_user_phone2_field" class="place_holder_stop" placeholder="Phone 2"/>
                <input type="hidden" id="main_stop_user_data_id" name="main_stop_user_data_id" >
              </div>
             </div>
           </form>
            </div>          
            <div class="modal-footer" style="text-align: center;">
              <input type="button" id="confirm_stop_user_data" style="background: rgb(0 191 179); width: 23%; border-radius: 22px; color: white;
              font-weight: 600;"  value="<%= __('button_confirm') %>">
            </div>    
        </div>
      </div>
    </div>
    <div class="modal fade" id="cancellationReasonModal" tabindex="-1" role="dialog" aria-labelledby="cancellationReasonModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form id="cancellationReasonForm" enctype="multipart/form-data" method="post">
    
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="cancellationReasonModalLabel"><%= __('title_cancel_trip') %></h4>
          </div>
          <div class="modal-body">
          <div class="form-group">
            <label class="col-md-2 col-xs-5 control-label"><%= __('title_cancellation_reason') %>:</label>
              <div class="col-md-10 col-xs-7">
                  <textarea class="form-control" name="cancel_reason" id="cancellation_reason" cols="50" rows="4" required></textarea>
              </div>
            </div>                                   
            <input type="hidden" name="trip_id" id="cancellation_trip_id" />
            <input type="hidden" name="user_id" id="cancellation_user_id" />
            <input type="hidden" name="token" id="cancellation_user_token" />
            <input type="hidden" name="type" value="<%= constant_json.TRIP_TYPE_CORPORATE %>" />
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" id="submitReason"><%= __('button_submit') %></button>
          </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="promoCodeModal" tabindex="-1" role="dialog" aria-labelledby="promoCodeModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form id="promoCodeForm" enctype="multipart/form-data" method="post">
    
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="promoCodeModalLabel"><%= __('title_promo') %></h4>
          </div>
          <div class="modal-body">
          <div class="form-group">
            <label class="col-md-2 col-xs-5 control-label"><%= __('title_promo') %>:</label>
            <div class="col-md-10 col-xs-7">
                <textarea class="form-control" name="promocode" id="promocode" cols="50" rows="4" required></textarea>
            </div>
            </div>                                   
            <input type="hidden" name="user_id" id="promo_user_id" />
            <input type="hidden" name="token" id="promo_token" />
            <input type="hidden" name="country_id" id="promo_country_id" />
            <input type="hidden" name="city_id" id="promo_city_id" />
            <input type="hidden" name="promo_id" id="promo_id" />
            <input type="hidden" name="promo_trips" id="promo_trips" />
            <input type="hidden" name="promo_serviceid" id="promo_serviceid" />
            <span id="promo_message" style="display: none; color: red; display: block; font-size: 13px;"> </span>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" id="submitReason"><%= __('button_submit') %></button>
          </div>
        </form>
        </div>
      </div>
    </div>

    
    <script type='text/javascript' src='dispatcher_new_design/js/moment.min.js'></script>
    <script src="<%=map_key%>"></script>
    <script>
      console.log('Google Maps API Key URL:', '<%=map_key%>');
      var currentStopidx = null;
      let types = []
      var interval;
      var provider_array = [];
      var surge_time = [];
      var selected_surge_time = [];
      var providers = [];
      var provider_markers = [];
      var map;
      var pickup_marker;
      var destination_marker;
      var iconBase = '/map_pin/icons/';
      var directionsDisplay = new google.maps.DirectionsRenderer({    
        draggable: true,
      });;
      var directionsService = new google.maps.DirectionsService();
      var request_list = [];
      var accepted_request_list = [];
      var arrived_request_list = [];
      var started_request_list = [];
  
      var all_provider = [];
      var all_provider_marker = [];
      var all_provider_interval;
      var providers1 = [];
      var show_provider_info_interval;
      var near_by_driver_interval;
      var selected_filter_type = [1];
      var stop_idx = 0;
      let i_stop_idx = 0;
      var destination_addresses_markers = [];
      let internal_stops_markers = [];
      let rich_area_surge_multiplier = 0;
  
      let page_num = 0;
      let distance_meter = 0;
      var boatCheck = 0;
      var margarita = false;
      let optimizedStops = [];
      let optimizedDestination = {};
      let stopsUserDetails = [];
      let optimizedStopsUserDetails = [];
      const validateCapacity = [
        Number("<%= MODEL_TRUCK_TYPE.CAMION450 %>"),
        Number("<%= MODEL_TRUCK_TYPE.CAMION750 %>"),
        Number("<%= MODEL_TRUCK_TYPE.GANDOLA %>"),
        Number("<%= MODEL_TRUCK_TYPE.CABEZAL %>")
      ];
      const validateTruckType = [
        Number("<%= MODEL_TRUCK_TYPE.CAMION750 %>"),
        Number("<%= MODEL_TRUCK_TYPE.CAMION450 %>"),
        Number("<%= MODEL_TRUCK_TYPE.CAMION350 %>"),
        Number("<%= MODEL_TRUCK_TYPE.TORONTO %>"),
        Number("<%= MODEL_TRUCK_TYPE.GANDOLA %>"),
        Number("<%= MODEL_TRUCK_TYPE.CABEZAL %>")
      ];

      google.maps.event.addDomListener(window, 'load', initialize);

      function createToast(
          text, duration = 3000, gravity = "bottom", 
          position = "right", actionClick = () => {}, color = "#e60000") {
        Toastify({
          text,
          duration,
          newWindow: true,
          close: true,
          gravity, // `top` or `bottom`
          position, // `left`, `center` or `right`
          stopOnFocus: true, // Prevents dismissing of toast on hover
          style: {
            background: color
          }, 
          onClick: actionClick // Callback after click
        }).showToast();
      }
  
      function createToastWithContactUs(
          text, duration = 3000, gravity = "bottom",
          position = "right", actionClick = () => {}, color = "#e60000",
      ) {
          const buttonMarkup = `<button type="button" aria-label="Close" class="close-toast" onclick="closetoast()" ></button> <button class="btn-success button_contact" onclick="openWhatsApp('584120159876')"><i class="fa fa-whatsapp" aria-hidden="true"></i>
            Contctanos</button>`;

          const toast = Toastify({
              text,
              duration,
              newWindow: true,
              close: true,
              gravity, 
              position, 
              stopOnFocus: true, 
              style: {
                  background: color
              },
              onClick: actionClick 
          });

          toast.showToast();
            const hidebutton = document.querySelector('.toast-close');
            hidebutton.style.display = 'none';
            const toastElement = document.querySelector('.toastify');
            toastElement.innerHTML += buttonMarkup;


      }
      function closetoast(){
        $('.toastify').hide()
      }
      function openWhatsApp(contact) {
          window.open(`https://wa.me/${contact}`, '_blank');
      }
      
      function initialize() {
        var mapProp = {
          center: new google.maps.LatLng(<%- latitude %>, <%- longitude %>),
          zoom:18,
          streetViewControl: false,
          mapTypeId:google.maps.MapTypeId.ROADMAP,
            zoomControlOptions: {
                position: google.maps.ControlPosition.RIGHT_CENTER
            },
        };

        const icons = {
        exit: {
          name: "<%= __('title_origin') %>",
          icon: iconBase + "FLETY_ICONO_SALIDA.svg",
        },
        arrival: {
          name: "<%= __('title_destination') %>",
          icon: iconBase + "FLETY_ICONO_LLEGADA.svg",
        },
        external_stop: {
          name: "<%= __('title_external_stop') %>",
          icon: iconBase + "FLETY_ICONO_PARADA_EXTERNA.svg",
        },
      };

      const legend = document.getElementById("legend");

      for (const key in icons) {
        const type = icons[key];
        const name = type.name;
        const icon = type.icon;
        const div = document.createElement("div");
        div.className = "item-legend";

        div.innerHTML = `<img src="${icon}"><span>${name}</span>`;
        legend.appendChild(div);
      }

      get_service_type_list()

      map = new google.maps.Map(document.getElementById("map"), mapProp);
      map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);

      directionsDisplay.addListener("directions_changed", () => {
          const directions = directionsDisplay.getDirections();
          let distance = 0;
          //console.log(directions)
          if(directions!==null){
          if (directions.status == google.maps.DirectionsStatus.OK) {
  
              var array = directions.routes[0].legs;
              distance = 0;
              var time = 0;
              array.forEach((data) => {
                distance = distance + data.distance.value;
              });
          }
          distance_meter = distance
        }
          // console.log(distance_meter)
        });
            <% if( trip_data ){ %>
            let trip_details = <%-JSON.stringify(trip_data)%>

            if(trip_details.sourceLocation.length > 0){
              let initialLocation = new google.maps.LatLng(trip_details.sourceLocation[0], trip_details.sourceLocation[1]);
  
              if(pickup_marker){
                pickup_marker.setPosition(initialLocation);
              } else {
            
              pickup_marker = new google.maps.Marker({
                map: map,
                icon: {
                  url: iconBase + 'FLETY_ICONO_SALIDA.svg',
                  scaledSize: new google.maps.Size(45, 45) // Adjust the size as per your requirement
                },
                position: initialLocation,
                draggable:true
              });

              }
              map.setCenter(initialLocation);
  
            }else{
              if(pickup_marker){
                pickup_marker.setMap(null);
              }
            }
            if(trip_details.initialDestinationLocation.length > 0){
  
              let initialLocation = new google.maps.LatLng(trip_details.initialDestinationLocation[0], trip_details.initialDestinationLocation[1]);
  
              /*if(!destination_marker){
                destination_marker = new google.maps.Marker({
                  map: map,
                  icon: {
                    url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
                    scaledSize: new google.maps.Size(45, 45) // Adjust the size as per your requirement
                  },
                  position: initialLocation,
                  draggable:true
                });

              } else {
                destination_marker.setPosition(initialLocation);
              }*/
            }else{
                if(destination_marker){
                  destination_marker.setMap(null);
                }
              }
  

              if(trip_details.destination_addresses.length > 0){
              
              trip_details.destination_addresses.forEach((stop)=> {
                addStopRepeatOrder(stop)
              })
              //fix stop from history
            }else{
              if(pickup_marker && destination_marker){
               draw_path()
              }
            }
            if(trip_details.destination_address != "" && trip_details.selected_courier_type != "<%= constant_json.COURIER_CISTERNA_FLOW %>"){
              <%let dest_history = {address: trip_data.initial_destination_address, location: [trip_data.initialDestinationLocation[0], trip_data.initialDestinationLocation[1]],
                stops_inside: []
              }%>
              <% trip_data.destination_addresses.push(dest_history) %>
              let savedestlocal = {address: trip_details.initial_destination_address, location: [trip_details.initialDestinationLocation[0], trip_details.initialDestinationLocation[1]],
                stops_inside: []
              }
              
              addStopRepeatOrder(savedestlocal)
            }
            <% } else{ %>
        
          // var initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
          var initialLocation = new google.maps.LatLng(<%- latitude %>, <%- longitude %>);
  
          pickup_marker = new google.maps.Marker({
            map: map,
            icon: {
              url: iconBase + 'FLETY_ICONO_SALIDA.svg',
              scaledSize: new google.maps.Size(45, 45) // Adjust the size as per your requirement
            },
            position: initialLocation,
            draggable:true
          });

          google.maps.event.addListener(pickup_marker,'dragend', function(event) {
            pickup_marker_drag(event)
            // get_service_type_list();
          });
          map.setCenter(initialLocation);
          <% } %>
        navigator.geolocation.getCurrentPosition(function(position) {

          $('#current_latitude').val(position.coords.latitude);
          $('#current_longitude').val(position.coords.longitude);
          $('#current_location_address').val('');
            // get_all_service_type();
        });
  
        var pickup = document.getElementById('pickup');
        var options = {
            componentRestrictions: {country: '<%= address_restrict %>'}
        };
        var searchBoxpickup = new google.maps.places.Autocomplete(pickup , options);
        searchBoxpickup.bindTo('bounds', map);
        searchBoxpickup.addListener('place_changed', function() {
          var bounds = new google.maps.LatLngBounds();
          var place = searchBoxpickup.getPlace();
          if(pickup_marker){
            pickup_marker.setPosition(place.geometry.location);
          } else {
  
            pickup_marker = new google.maps.Marker({
            map: map,
            icon: {
              url: iconBase + 'FLETY_ICONO_SALIDA.svg',
              scaledSize: new google.maps.Size(45, 45) // Adjust the size as per your requirement
            },
            position: place.geometry.location,
            draggable:true
          });

          }
  
          document.getElementById('src_lat_lng').value = place.geometry.location;
          document.getElementById('lat').value=place.geometry.location.lat();
          document.getElementById('lng').value=place.geometry.location.lng();
          get_surge_hours_on_pickup()
          if(destination_marker){
           draw_path();
          } else {
            if (place.geometry.viewport) {
              map.fitBounds(place.geometry.viewport);
            } else {
              map.setCenter(place.geometry.location);
            }
          }
          // get_service_type_list();
  
        });
  
          var current_location_address = document.getElementById('current_location_address');
          var options1 = {
              componentRestrictions: {country: '<%= address_restrict %>'}
          };
          var searchBoxpickup1 = new google.maps.places.Autocomplete(current_location_address , options1);
          searchBoxpickup1.bindTo('bounds', map);
          searchBoxpickup1.addListener('place_changed', function() {
              var bounds = new google.maps.LatLngBounds();
              var place = searchBoxpickup1.getPlace();
              pickup_marker.setPosition(place.geometry.location);
  
              document.getElementById('current_latitude').value=place.geometry.location.lat();
              document.getElementById('current_longitude').value=place.geometry.location.lng();
              if (place.geometry.viewport) {
                  map.fitBounds(place.geometry.viewport);
              } else {
                  map.setCenter(place.geometry.location);
              }
              get_all_service_type();
          });
  
        var destination = document.getElementById('destination');
        var options = {
            componentRestrictions: {country: '<%= address_restrict %>'}
        };
        var searchBoxdestination = new google.maps.places.Autocomplete(destination , options);
        searchBoxdestination.bindTo('bounds', map);
        searchBoxdestination.addListener('place_changed', function() {
          var place = searchBoxdestination.getPlace();
          var bounds = new google.maps.LatLngBounds();
          if(!destination_marker){
            destination_marker = new google.maps.Marker({
              map: map,
              icon: {
                url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
                scaledSize: new google.maps.Size(45, 45), // Adjust the size as per your requirement,
              },
              position: place.geometry.location,
              draggable:true
            });

            google.maps.event.addListener(destination_marker,'dragend', function(event) {
              destination_marker_drag(event)
            });
          } else {
            destination_marker.setPosition(place.geometry.location);
          }
          document.getElementById('dest_lat_lng').value = place.geometry.location;
          document.getElementById('dlat').value=place.geometry.location.lat();
          document.getElementById('dlng').value=place.geometry.location.lng();
         draw_path();
          // get_fare_estimate();
        });
      }

      function openTab(evt, tabname) {
        // Declare all variables
        var i, tabcontent, tablinks;
        
        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the link that opened the tab
        document.getElementById(tabname).style.display = "block";
        evt.currentTarget.className += " active";
      }
  
      function show_truck_loc(){
        let running_trips = <%-JSON.stringify(trip_list)%>
  
        var locations = [];
        running_trips.forEach(function (data) {
  
          let lat = data.providerLocation[0];
          let lon = data.providerLocation[1];
          let provider_name = data.assigned_provider_details.name
          let provider_phone = data.assigned_provider_details.phone
          let plate_no = data.assigned_vehicle_details.vehicle_plate_no
            var contentString =
            '<p><b><%= __('title_provider_name') %></b>: ' + provider_name +
            '<br><b><%= __('title_provider_phone') %></b>: ' + provider_phone +
            '<br><b><%= __('title_plate_no') %></b>: ' + plate_no            
            '</p>';
  
          locations.push({
            latlon: new google.maps.LatLng(lat, lon),
            message: new google.maps.InfoWindow({
              content: contentString,
              maxWidth: 320
            })
          });
        });
        truck_markers = []
        locations.forEach(function (loc_data, i) {
          
          var marker_avail_act = new google.maps.Marker({
            position: loc_data.latlon,
            map: map,
            icon: {
              url: iconBase + 'FLETY_ICONO_350_450_oriente.svg',
              scaledSize: new google.maps.Size(45, 45) // Adjust the size as per your requirement
            },
          });

          truck_markers.push(marker_avail_act);
          google.maps.event.addListener(marker_avail_act, 'click', function (e) {
  
            // When clicked, open the selected marker's message
            currentSelectedMarker = loc_data;
            loc_data.message.open(map, marker_avail_act);
            setTimeout(function () { loc_data.message.close(); }, 5000);
          });
  
        });
        var pt = new google.maps.LatLng(9.706107, -67.290812);
        map.setCenter(pt);
        map.setZoom(9);
      }
      function pickup_marker_drag(event)
      {
        var initialLocation = new google.maps.LatLng(event.latLng.lat(),event.latLng.lng());
        var geocoder = new google.maps.Geocoder();
        document.getElementById('src_lat_lng').value = initialLocation;
        document.getElementById('lat').value=event.latLng.lat();
        document.getElementById('lng').value=event.latLng.lng();
        geocoder.geocode({'latLng': initialLocation}, function(results, status) {
            if(status == google.maps.GeocoderStatus.OK) {
                var address = results[0].formatted_address;
                document.getElementById('pickup').value=address;
            }
        });
        if(destination_marker){
           draw_path();
            // get_fare_estimate();
        }
      }
  
      function destination_marker_drag(event)
      {
        var initialLocation = new google.maps.LatLng(event.latLng.lat(),event.latLng.lng());
        var geocoder = new google.maps.Geocoder();
        document.getElementById('dest_lat_lng').value = initialLocation;
        document.getElementById('dlat').value=event.latLng.lat();
        document.getElementById('dlng').value=event.latLng.lng();
        geocoder.geocode({'latLng': initialLocation}, function(results, status) {
            if(status == google.maps.GeocoderStatus.OK) {
                var address = results[0].formatted_address;
                document.getElementById('destination').value=address;
            }
        });
       draw_path();
        // get_fare_estimate();
      }
      // get destination depending if optimization enabled
      function get_destination_stop(optimize){
        let val_html = document.getElementById("multiple_stops");
        let values = val_html.childNodes.length;
        if(values > 0){
            let dest_idx = 0
            let i = 0
            let label = 1
            let forms_data = $("#signupForm").serializeJSON();
            $('#multiple_stops').children('div').each(function(){
                  dest_idx = Number($(this).attr("id").substring(8));
                  $("#stoplabel"+dest_idx).html("Parada #: "+ label);
                  $("#stop_user_data_btn" + dest_idx).css("display", "inline").show();
                  i++;
                  label++;
              });
            
            //draw_path();
            // get_fare_estimate();
            
            $("#stop_user_data_btn"+dest_idx).hide()
            $("#stoplabel"+dest_idx).html("Destino");
            

        var bounds = new google.maps.LatLngBounds();
        
        if(optimize === true){
          let op_stops = []
          let aux = {}
          let origin_op = {address: "Origin", location:[$('#lat').val() , $('#lng').val()]}
          let destination_op = []
          let clean_stops = []
          $('#multiple_stops').children('div').each(function(){
                  dest_idx = Number($(this).attr("id").substring(8));
                  aux = {address: $('#stops-pac-input'+dest_idx).val(), location:[$("#d_stop_lat"+dest_idx).val(), $("#d_stop_lng"+dest_idx).val()], index: dest_idx}
                  op_stops.push(aux)
              });
          let order = op_stops.slice().sort((a,b) => getDistanceFromTwoLocation(a.location,origin_op.location) -  getDistanceFromTwoLocation(b.location,origin_op.location))
          let errores = [];
          for (let i = 0; i < op_stops.length; i++) {
            const stop = op_stops[i];
            if (
              !stop || !stop.address || stop.address.trim() === "" ||
              !stop.location || !stop.location[0] || stop.location[0].trim() === "" ||
              !stop.location[1] || stop.location[1].trim() === ""
            ) {
              errores.push(i + 1);
            }
          }
                    if (errores.length > 0) {
            alert(` Destino o Paradas sin direccin asignada`);
            return; // Detener ejecucin de la funcin
          }

          
          let dest_stop = op_stops.indexOf(order[order.length-1])
        
          destination_op = op_stops[dest_stop];
          clean_stops = op_stops.slice(dest_stop, dest_stop+1)
          
          // document.getElementById('dest_lat_lng').value = destination_op.location;
          // document.getElementById('dlat').value = destination_op.location[0];
          // document.getElementById('dlng').value = destination_op.location[1];
          // document.getElementById('destination').value = destination_op.address
        
          var latitude = $('#lat').val();
          var longitude = $('#lng').val();
          var dest_latitude = $('#dlat').val();
          var dest_longitude = $('#dlng').val();
          if(op_stops.length > 0 && document.getElementById('destination').value!=="" && document.getElementById('destination').value){
            if(currentStopidx===null){
            //setear entonces el dest_idx marker to destino
            var initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + destination_op.index).value, document.getElementById('d_stop_lng' + destination_op.index).value);
            var change_icon = {
                url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
                scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
              }
            if (destination_addresses_markers[destination_op.index] != undefined){
                destination_addresses_markers[destination_op.index].setIcon(change_icon);
            }
            currentStopidx = destination_op.index
          }else{
            //setear el currentanterior a parada
            var initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + currentStopidx).value, document.getElementById('d_stop_lng' + currentStopidx).value);
            
            var change_icon = {
              url: iconBase + 'FLETY_ICONO_PARADA_EXTERNA.svg',
              scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
            }
            if (destination_addresses_markers[currentStopidx] != undefined) {
              destination_addresses_markers[currentStopidx].setIcon(change_icon);
            }
            //setear el marcador en dest_idx a destino
            initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + destination_op.index).value, document.getElementById('d_stop_lng' + destination_op.index).value);
            change_icon = {
                url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
                scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
              }
            if (destination_addresses_markers[destination_op.index] != undefined) {
              destination_addresses_markers[destination_op.index].setIcon(change_icon);
            }
            currentStopidx = destination_op.index
          }
           /*   ///
          
          if(currentStopidx===null){
            //setear entonces el dest_idx marker to destino
            var initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + destination_op.index).value, document.getElementById('d_stop_lng' + destination_op.index).value);
            if (destination_addresses_markers[destination_op.index] != undefined) {
              destination_addresses_markers[destination_op.index] = new google.maps.Marker({
              map: map,
              icon: {
                url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
                scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
              },
              position: initialLocation,
              draggable: false,
            });
            }
            currentStopidx = destination_op.index
          }else{
            //setear el currentanterior a parada
            var initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + currentStopidx).value, document.getElementById('d_stop_lng' + currentStopidx).value);
            if (destination_addresses_markers[currentStopidx] != undefined) {
              destination_addresses_markers[currentStopidx] = new google.maps.Marker({
              map: map,
              icon: {
                url: iconBase + 'FLETY_ICONO_PARADA_EXTERNA.svg',
                scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
              },
              position: initialLocation,
              draggable: false,
            });
            }
            //setear el marcador en dest_idx a destino
            initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + destination_op.index).value, document.getElementById('d_stop_lng' + destination_op.index).value);
            if (destination_addresses_markers[destination_op.index] != undefined) {
              destination_addresses_markers[destination_op.index] = new google.maps.Marker({
              map: map,
              icon: {
                url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
                scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
              },
              position: initialLocation,
              draggable: false,
            });
            }
            currentStopidx = destination_op.index
          }
          */
          ///
          stopsUserDetails = []
          $('input[name="stop_username[]"]').each(function(index) {
            var username = $(this).val();
            var phone = $('input[name="stop_user_phone[]"]').eq(index).val();
            stopsUserDetails.push({
                stop_username: username,
                stop_user_phone: phone
            });
          });

          $.ajax({
                  type: 'POST',
                  dataType: 'json',
                  data: {
                      pickup_latitude : latitude,
                      pickup_longitude : longitude, 
                      destination_latitude : dest_latitude , 
                      destination_longitude: dest_longitude , 
                      'stops_address': op_stops,

                  },
                  url: "/optimizedorder",
                  success:function(response) {
                    optimizedStops = response.optimized_stops.map(stop => ({
                        address: stop.address || 'Direccin no disponible',
                        location: stop.location || null
                    }));
                    optimizedDestination = optimizedStops.at(-1);
                    var html = ""
                    $('#multiple_stops_optimized').empty()
                    html = html + `<h6 style="text-decoration: underline;text-decoration-thickness: 2px;">Paradas Optimizadas: </h6>`
                    html = html + `<p style = "border-bottom: ridge;font-weight: bold; color: black;">Origen:</p>`
                    html = html + `<p style = "margin-bottom: 5%;display: list-item;list-style-position: inside;color: black;">${document.getElementById('pickup').value}</p>`;
                    html = html + `<p style = "border-bottom: ridge;font-weight: bold; color: black;">Paradas:</p>`
                    html = html + `<ol>`
                    // mapeo aca las paradas optimizadas y estraigo la ultima
                    for(let i = 0; i < response.optimized_stops.length - 1; i++){
                      html = html + `<li style = "margin-bottom: 1%;list-style-position: inside !important;color: black; list-style: auto;">  ${response.optimized_stops[i]?.address || 'Direccin no disponible'}</li>`;
                    }
                    html = html + `</ol style="margin-bottom: 5%;">`
                    html = html + `<p style = "border-bottom: ridge;font-weight: bold; color: black;">Destino:</p>`
                    html = html + `<p style = "margin-bottom: 5%;display: list-item;list-style-position: inside;color: black;">${response.optimized_stops[response.optimized_stops.length - 1]?.address || document.getElementById('destination').value}</p>`;
                    $('#multiple_stops_optimized').append(html)
                    
                    // Update markers to reflect optimized order
                    optimizedStopsUserDetails = []
                    response.order.forEach((originalIndex, newPosition) => {
                      let new_username = ""
                      let new_phone = ""
                      new_username = stopsUserDetails[originalIndex].stop_username
                      new_userphone = stopsUserDetails[originalIndex].stop_user_phone
                      
                      optimizedStopsUserDetails.push({
                        stop_username : new_username,
                        stop_user_phone : new_userphone
                      })
                      const stopIndex = op_stops[originalIndex].index;
                      if (destination_addresses_markers[stopIndex]) {
                        // Update marker icon based on new position
                        const isLastStop = newPosition === response.order.length - 1;
                        const iconUrl = isLastStop ? 
                          iconBase + 'FLETY_ICONO_LLEGADA.svg' : 
                          iconBase + 'FLETY_ICONO_PARADA_EXTERNA.svg';
                        
                        destination_addresses_markers[stopIndex].setIcon({
                          url: iconUrl,
                          scaledSize: new google.maps.Size(30, 30)
                        });
                      }
                    });

                    if(document.getElementById('destination').value !== ""){
                      draw_path(bounds);
                    } 
                  }
              });
          }else{
                    var html = ""
                    html = html + `<h6 style="text-decoration: underline;text-decoration-thickness: 2px;">No se puede calcular la ruta ptima por carretera</h6>`
                    $('#multiple_stops_optimized').empty()
                    $('#multiple_stops_optimized').append(html)
                    if(document.getElementById('destination').value !== ""){
                      draw_path(bounds);
        }
          }
          
        }else{
          
          if(currentStopidx===null){
            //setear entonces el dest_idx marker to destino
            var initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + dest_idx).value, document.getElementById('d_stop_lng' + dest_idx).value);
            var change_icon = {
                url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
                scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
              }
            if (destination_addresses_markers[dest_idx] != undefined){
                destination_addresses_markers[dest_idx].setIcon(change_icon);
            }
            currentStopidx = dest_idx
          }else{
            //setear el currentanterior a parada
            var initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + currentStopidx)?.value, document.getElementById('d_stop_lng' + currentStopidx)?.value);
            
            var change_icon = {
              url: iconBase + 'FLETY_ICONO_PARADA_EXTERNA.svg',
              scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
            }
            if (destination_addresses_markers[currentStopidx] != undefined) {
              destination_addresses_markers[currentStopidx].setIcon(change_icon);
            }
            //setear el marcador en dest_idx a destino
            initialLocation = new google.maps.LatLng(document.getElementById('d_stop_lat' + dest_idx).value, document.getElementById('d_stop_lng' + dest_idx).value);
            change_icon = {
                url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
                scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
              }
            if (destination_addresses_markers[dest_idx] != undefined) {
              destination_addresses_markers[dest_idx].setIcon(change_icon);
            }
            currentStopidx = dest_idx
          }
            
          document.getElementById('dest_lat_lng').value = document.getElementById('dest_stops_lat_lng'+dest_idx).value;
          document.getElementById('dlat').value =  document.getElementById('d_stop_lat' + dest_idx).value;
          document.getElementById('dlng').value = document.getElementById('d_stop_lng' + dest_idx).value;
          document.getElementById('destination').value = document.getElementById("stops-pac-input"+ dest_idx).value;
          if(document.getElementById('destination').value !== ""){
            draw_path(bounds);
        }
        }
      }
      }

      //Get Distance from Two location

      function getDistanceFromTwoLocation (fromLocation, toLocation) {
          var lat1 = fromLocation[0]
          var lat2 = toLocation[0]
          var lon1 = fromLocation[1]
          var lon2 = toLocation[1]

          ///////  TOTAL DISTANCE ////

          var R = 6371 // km (change this constant to get miles)
          var dLat = ((lat2 - lat1) * Math.PI) / 180
          var dLon = ((lon2 - lon1) * Math.PI) / 180
          var a =
              Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos((lat1 * Math.PI) / 180) *
                  Math.cos((lat2 * Math.PI) / 180) *
                  Math.sin(dLon / 2) *
                  Math.sin(dLon / 2)
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
          return R * c
      }

      //here3
      function optimalPanel(){
        let val_html = document.getElementById("multiple_stops");
        let values = val_html.childNodes.length;
         if($('#b_optimize').is(':checked') && values >0){
          $('#multiple_stops').removeClass('col-sm-12')
          $('#multiple_stops').addClass('col-sm-6')
          $('#multiple_stops').children('div').each(function(){
              $(this).removeClass('col-sm-6')
              $(this).addClass('col-sm-12')
              });
          $('#multiple_stops_optimized').css("display", "inline-block");
          //$('#multiple_stops_optimized').attr("hidden",false)
        }else{
          $('#multiple_stops').removeClass('col-sm-6')
          $('#multiple_stops').addClass('col-sm-12')
          $('#multiple_stops').children('div').each(function(){
              $(this).removeClass('col-sm-12')
              $(this).addClass('col-sm-6')
              });
            $('#multiple_stops_optimized').css("display", "none");
          //$('#multiple_stops_optimized').attr("hidden",true)
          //$(".class").css("display", "none");

        }
        if(document.getElementById('destination').value !== "" && document.getElementById('pickup').value !== ""){
          //var bounds = new google.maps.LatLngBounds();
          get_destination_stop($('#b_optimize').is(':checked'));
          //draw_path(bounds);
        }
      }

      function draw_path()
      {
        let optm = $('#b_optimize').is(':checked')
        //redraw_markers()
        // Set destination stop, change value for dlat and dlon, if not optimize last value is always the new destination.
        // if optimize = true, get order from backend and save order to draw along with lat, long and address
        //get_destination_stop(optm);
        // Get current distance for route
        var bounds = new google.maps.LatLngBounds();
        var pick_up = new google.maps.LatLng($('#lat').val() , $('#lng').val());
        var destination = new google.maps.LatLng($('#dlat').val() , $('#dlng').val());
        let is_destination_stop = 0
        bounds.extend(pick_up);
        bounds.extend(destination);
        var waypoints = []
        let internal_stops = []
        var form_data = $("#signupForm").serializeJSON()
        <% if( trip_data ){ %>
          trip_data = <%-JSON.stringify(trip_data)%>
          //form_data.destination_addresses = trip_data.destination_addresses
          if(form_data.destination_addresses){
            form_data.destination_addresses.forEach((element, index) => {
              
              let internal_stops = element.stops_inside
              if(internal_stops && internal_stops.length > 0 ){
                internal_stops.forEach((iStop)=>{
                  if(iStop.location.length == 2){
                    const i_point = new google.maps.LatLng(Number(iStop.location[0]), Number(iStop.location[1]));
                    bounds.extend(i_point);
                    waypoints.push({
                      location: i_point,
                      stopover: true
                    });
                    internal_stops_markers.push(new google.maps.Marker({
                      map: map,
                      icon: {
                        url: iconBase + 'FLETY_ICONO_PARADA_INTERNA.svg',
                        scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                      },
                      position: i_point,
                      draggable: false,
                    }))
                  }
                })
              }else{
                const stopLat = Number(form_data.d_stop_lat[index])
                const stopLng = Number(form_data.d_stop_lng[index])
                const point = new google.maps.LatLng(stopLat, stopLng);
                bounds.extend(point);
                waypoints.push({
                  location: point,
                  stopover: true
                });
              }
                
            })
          }

        <% } else{ %>

          //here waypoints are loaded
          if(form_data.destination_addresses){
            form_data.destination_addresses.forEach((element, index) => {
              if (form_data.d_stop_lat[index] && form_data.d_stop_lng[index]) {
                if(form_data.internal_stop_addresses[index] != "" ){
                  const internal_stops = JSON.parse(form_data.internal_stop_addresses[index])
                  internal_stops.forEach((iStop)=>{
                    // console.log(iStop)
                    if(iStop.location.length == 2){
                      const i_point = new google.maps.LatLng(Number(iStop.location[0]), Number(iStop.location[1]));
                      bounds.extend(i_point);
                      waypoints.push({
                        location: i_point,
                        stopover: true
                      });
                    internal_stops_markers.push(new google.maps.Marker({
                      map: map,
                      icon: {
                        url: iconBase + 'FLETY_ICONO_PARADA_INTERNA.svg',
                        scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                      },  
                      position: i_point,
                      draggable: false,
                      scaledSize: new google.maps.Size(30, 30)
                     }))

                    }
                  })
                }else{
                  if(form_data.destination_addresses[index] !== document.getElementById('destination').value){
                  const stopLat = Number(form_data.d_stop_lat[index])
                  const stopLng = Number(form_data.d_stop_lng[index])
                  const point = new google.maps.LatLng(stopLat, stopLng);
                  bounds.extend(point);
                  waypoints.push({
                    location: point,
                    stopover: true
                  });
                }
                }
              }
            })
            
          }
        <% } %>
  
        map.fitBounds(bounds);

        var request = {
            origin: pick_up,
            waypoints: waypoints,
            optimizeWaypoints: optm,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING
        };

        directionsService.route(request, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              let distance = 0
                for (let index = 0; index < response.routes[0].legs.length; index++) {
                    distance += response.routes[0].legs[index].distance.value;                
                };

                let dist = (distance / 1000).toFixed(2)
                
                if (optm === true) {
                    
                    let forms_data = $("#signupForm").serializeJSON();
                    let stops_for_optimization = [];
                    
                    if(forms_data.destination_addresses){
                        forms_data.destination_addresses.forEach((element, index) => {
                            if(forms_data.d_stop_lat[index] && forms_data.d_stop_lng[index]){
                                stops_for_optimization.push({
                                    address: forms_data.destination_addresses[index],
                                    location: [
                                        Number(forms_data.d_stop_lat[index]),
                                        Number(forms_data.d_stop_lng[index])
                                    ]
                                });
                            }
                        });
                    }
                    
                    $.ajax({
                        url: '/new-optimizedorder',
                        method: 'POST',
                        data: {
                            pickup_latitude: $('#lat').val(),
                            pickup_longitude: $('#lng').val(),
                            stops_address: stops_for_optimization
                        },
                        success: function(result) {
                            if (result.success) {
                                $('#show_distance').val(result.approximate_distance);
                            }
                        },
                    });
                } else {
                    $('#show_distance').val(dist + " Km");
                }
                
                directionsDisplay.setDirections(response);
                directionsDisplay.setMap(map);
                directionsDisplay.setOptions( { suppressMarkers: true } );
  
                let duration = 0;
  
                response.routes[0].legs.forEach(function(route) {
                  duration += route.duration.value / 60; 
                });
  
                $('#estimated_time').val(Math.ceil((Number(duration).toFixed(2) / 60) * 2));
                $("#estimate_hours").html(Math.ceil((Number(duration).toFixed(2) / 60) * 2));
            }
        });
      }
      function add_google_place_auto_complete(input_ids) {
        var input = document.getElementById("stops-pac-input" + input_ids);
        var searchBox = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: '<%= address_restrict %>' } });
        var bounds = new google.maps.LatLngBounds();
        var form_data = $("#signupForm").serializeJSON()
  
        if($('#stops-pac-input'+ input_ids).val() !== ""){
          <% if( trip_data){ %>
            
            
            let trip_details = <%-JSON.stringify(trip_data)%>
            let fix_loc_array = trip_details.destination_addresses[input_ids].location
            let loc_array = $('#dest_stops_lat_lng' + input_ids).val();//trip_details.destination_addresses[input_ids].location
            var initialLocation = new google.maps.LatLng($('#d_stop_lat' + input_ids).val(), $('#d_stop_lng' + input_ids).val());//loc_array[0],loc_array[1]);

              if(destination_addresses_markers[input_ids]) {
                destination_addresses_markers[input_ids] = new google.maps.Marker({
                map: map,
                icon: {
                  url: iconBase + 'FLETY_ICONO_PARADA_EXTERNA.svg',
                  scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                },
                position: initialLocation,
                draggable: false,
              });

              } else {
                destination_addresses_markers.push(new google.maps.Marker({
                map: map,
                icon: {
                  url: iconBase + 'FLETY_ICONO_PARADA_EXTERNA.svg',
                  scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                },
                position: initialLocation,
                draggable: false,
              }))

              }
    
              dlatlng = String(loc_array);
              dlatlng = dlatlng.replace(/[{( )}]/g, '');
              dlatlng = dlatlng.split(',');
              $('#dest_stops_lat_lng' + input_ids).val(loc_array);
              
              document.getElementById('d_stop_lat' + input_ids).value = dlatlng[0];
              document.getElementById('d_stop_lng' + input_ids).value = dlatlng[1];
              get_destination_stop($('#b_optimize').is(':checked'));
              if(destination_marker){
                draw_path(bounds);
              }
          <% }  %>
            }

        searchBox.addListener('place_changed', function () {
          var place = searchBox.getPlace();
          var bounds = new google.maps.LatLngBounds();
            if (!place.geometry) {
              console.log("Returned place contains no geometry");
              return;
            }
  
            if (destination_addresses_markers[input_ids] != undefined) {
              destination_addresses_markers[input_ids].setMap(null);
            }
  
            if(destination_addresses_markers[input_ids]) {
  
              destination_addresses_markers[input_ids] = new google.maps.Marker({
                map: map,
                icon: {
                  url: iconBase + 'FLETY_ICONO_PARADA_EXTERNA.svg',
                  scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                },
                position: place.geometry.location,
                draggable: false,
              });

            } else {
              destination_addresses_markers.push(new google.maps.Marker({
                map: map,
                icon: {
                  url: iconBase + 'FLETY_ICONO_PARADA_EXTERNA.svg',
                  scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                },
                position: place.geometry.location,
                draggable: false,
                scaledSize: new google.maps.Size(25, 25),
                origin: new google.maps.Point(0,0),
                anchor: new google.maps.Point(0, 0),
              }))

            }
  
            var dlatlng = place.geometry.location;
            dlatlng = String(dlatlng);
            dlatlng = dlatlng.replace(/[{( )}]/g, '');
            dlatlng = dlatlng.split(',');
  
            $('#dest_stops_lat_lng' + input_ids).val(place.geometry.location);
            document.getElementById('d_stop_lat' + input_ids).value = dlatlng[0];
            document.getElementById('d_stop_lng' + input_ids).value = dlatlng[1];
            get_destination_stop($('#b_optimize').is(':checked'));
            /*if(destination_marker){
               draw_path(bounds);
  
            }*/  
        });
      }
  
      function add_google_place_auto_complete_stops(input_ids) {
        var input = document.getElementById("i-stops-pac-input" + input_ids);
        var searchBox = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: '<%= address_restrict %>' } });
        searchBox.addListener('place_changed', function () {
          var bounds = new google.maps.LatLngBounds();
          var place = searchBox.getPlace();
          var bounds = new google.maps.LatLngBounds();
          if (!place.geometry) {
            console.log("Returned place contains no geometry");
            return;
          }
  
          var ilatlng = place.geometry.location;
          ilatlng = String(ilatlng);
          ilatlng = ilatlng.replace(/[{( )}]/g, '');
          ilatlng = ilatlng.split(',');
          $('#int_stops_lat_lng' + input_ids).val(place.geometry.location);
          document.getElementById('i_stop_lat' + input_ids).value = ilatlng[0];
          document.getElementById('i_stop_lng' + input_ids).value = ilatlng[1];
          
        });
      }
      function get_surge_hours_on_pickup(){
          var latitude = $('#lat').val();
          var longitude = $('#lng').val();
          var id = $('#user_type_id').val();
  
          $.ajax({
            type: 'POST',
            url: '/typelist_for_dispatcher',
            data: {'subAdminCountry': 'Venezuela','latitude':latitude,'longitude':longitude, 'id':id},
            dataType: "json",
            success:function(response){
              if(response.success){
                surge_time = []
                response.citytypes.forEach(function (city_type) {
                    var service_type_name = city_type.type_details.typename;
                    var service_type_id = city_type._id;
  
                    $("#service_type_id").append("<option value="+service_type_id + ">"+ service_type_name+ "</option>");
                    
                    surge_time.push({
                      'type_id' : service_type_id,
                      'surge_hours': city_type.surge_hours,
                      'is_surge_hours' : city_type.is_surge_hours,
                      'rich_area_surge_multiplier': city_type.rich_area_surge_multiplier
                    });
                  });
  
                  var type = document.getElementById('service_type_id').value;
                  for(var index in surge_time)
                  {
                    if( surge_time[index].type_id == type)
                    {
                      selected_surge_time = surge_time[index].surge_hours;
                      rich_area_surge_multiplier = surge_time[index].rich_area_surge_multiplier;
                    }
                  }
              }
            }
          });
        }
      function get_service_type_list(){ // API for  create trip data.
          $('#select_provider').empty();
          $("#select_provider").append("<option selected style='display: none;'>Select Provider</option>");
          $('#select_provider').selectpicker('refresh');
          provider_array = [];
          $('#provider_full_name').val('');
          $('#provider_phone').val('');
          // var latitude = $('#lat').val();
          // var longitude = $('#lng').val();
          var latitude = <%- latitude %>;
          var longitude = <%- longitude %>;
          let is_repeat_order = false
          var id = $('#user_type_id').val();
          let trip_data  = null
          <% if( trip_data ){ %>
            trip_data = <%-JSON.stringify(trip_data)%>
  
            is_repeat_order = true
            var repeat_type_id = trip_data.type_id
            if(trip_data.model_details){
              var repeat_selected_model_id = trip_data.model_details._id
            }
            if(trip_data.capacity_details){
              var repeat_selected_capacity_id = trip_data.capacity_details._id
            }
            if(trip_data.service_details){
              var repeat_selected_service_id = trip_data.service_details._id
            }
  
          <% } %>
  
          $.ajax({
            type: 'POST',
            url: '/typelist_for_dispatcher',
            data: {'subAdminCountry': '<%= country %>','latitude':latitude,'longitude':longitude, 'id':id},
            dataType: "json",
            success:function(response){
              clearInterval(near_by_driver_interval);
              $("#service_type_id").empty();
              if(response.success){
                $("#message").text("");
                $('#ridenow').attr('disabled', true);
                types = response.citytypes ;
                if(!is_repeat_order){
                  $("#service_type_id").append("<option selected disabled hidden style='display: none'><%= __('title_select_type_of_truck') %></option>");
                }
                response.citytypes.forEach(function (city_type) {
                  var service_type_name = city_type.type_details.typename;
                  var service_type_id = city_type._id;
                  if(is_repeat_order && repeat_type_id.toString() == city_type.typeid.toString()){
                    $("#service_type_id").append("<option selected value="+service_type_id + ">"+ service_type_name+ "</option>");
                  }else{
                    $("#service_type_id").append("<option value="+service_type_id + ">"+ service_type_name+ "</option>");
                  }
                  
                  surge_time.push({
                    'type_id' : service_type_id,
                    'surge_hours': city_type.surge_hours,
                    'is_surge_hours' : city_type.is_surge_hours,
                    'rich_area_surge_multiplier': city_type.rich_area_surge_multiplier
                  });
                });
              
                if(is_repeat_order){
                  let models = []
                  let services = []
                  let capacites = []
                
                  let type_index = types.findIndex((x)=>(x.typeid).toString() == (trip_data.type_id).toString());
                  if(type_index != -1){
                    var is_use_model = types[type_index].type_details.is_use_model
                    var is_use_service = types[type_index].type_details.is_use_services
                    var is_use_capacity = types[type_index].type_details.is_use_capacity
                  }else{
                    type_index = 0
                    var is_use_model = types[type_index].type_details.is_use_model
                    var is_use_service = types[type_index].type_details.is_use_services
                    var is_use_capacity = types[type_index].type_details.is_use_capacity
                  }
                  const model_type = types[type_index].type_details?.model_type
                  $("#model_type").val(model_type != undefined ? model_type : "")

                  if(is_use_model == 1 || model_type  == '<%= MODEL_TRUCK_TYPE.MOTO %>' || model_type  == '<%= MODEL_TRUCK_TYPE.VAN %>' || model_type == "<%= MODEL_TRUCK_TYPE.VOLTEO %>" || model_type == "<%= MODEL_TRUCK_TYPE.PANEL_DE_CARGA %>"){
                    models = types[type_index].type_model_details
                    $('#selected_model').empty();
                    if(models.length){
                      services = models[0].type_service_details
                    }
                    for(let i=0; i < models.length; i ++){
                      if(repeat_selected_model_id && repeat_selected_model_id.toString() == models[i]._id.toString()  ){
                        if(model_type  == '<%= MODEL_TRUCK_TYPE.MOTO %>' || model_type  == '<%= MODEL_TRUCK_TYPE.VAN %>' || model_type == "<%= MODEL_TRUCK_TYPE.VOLTEO %>" || model_type == "<%= MODEL_TRUCK_TYPE.PANEL_DE_CARGA %>"){
                          $("#selected_model").append("<option selected style='display: none;' value="+ models[i]._id +"></option>");
                        }else{
                          $("#selected_model").append("<option selected value="+ models[i]._id +">"+models[i].model_name+"</option>");
                        }
                      services = models[i].type_service_details
                      }else{
                        $("#selected_model").append("<option value="+ models[i]._id +">"+models[i].model_name+"</option>");
                      }
                    }
                    $('#selected_model').selectpicker('refresh');
                    if(is_use_service == 1 && models.length > 0){
                      $('#selected_services').empty();
                      $('#selected_services').selectpicker('refresh');
                      $("#courier_type").val(0)
                      for(let i=0; i < services.length; i ++){
                        if(repeat_selected_service_id && repeat_selected_service_id.toString() == services[i]._id.toString()  ){
                          $("#selected_services").append("<option selected value="+ services[i]._id +">"+services[i].service_name+"</option>");
                          $("#promo_serviceid").val(services[i]._id);
                          if(services[i].courier_type != undefined){
                            $("#courier_type").val(services[i].courier_type)
                            if(services[i].courier_type == "<%= constant_json.COURIER_CISTERNA_FLOW %>"){
                              cisternaFlow()
                            }else if(services[i].courier_type == "<%= constant_json.COURIER_ESCOMBRO_FLOW %>"){
                              escombroFlow()
                            }else{
                              $(".pickup_field").show()
                              $(".destination_field").hide()
                              $(".addstop").show()
                            }
                          }
                        }else{
                          $("#selected_services").append("<option value="+ services[i]._id +">"+services[i].service_name+"</option>");
                        }
                      }
                      $('#selected_services').selectpicker('refresh');

                    }else{
                      $('#selected_services').empty();
                      $('#selected_services').selectpicker('refresh');
                    }       

                  }else{
                    $('#selected_services').empty();
                    $('#selected_services').selectpicker('refresh');
                    $('#selected_model').empty();
                    $('#selected_model').selectpicker('refresh');
                  }

                  if(model_type == "<%= MODEL_TRUCK_TYPE.CISTERNA %>"){
                    cisternaModelChanges()
                  }
                  if(model_type == "<%= MODEL_TRUCK_TYPE.VOLTEO %>"){
                    volteoModelChanges()
                  }
                  if (validateCapacity.includes(model_type)) {
                    removeSelectedCapacityValidation();
                  }

                  if (validateTruckType.includes(model_type)) {
                    addSelectedTruckTypeValidation();
                  }

                  if(is_use_capacity == 1){
                    
                    capacites = types[type_index].type_capacity_details
                    
                    $('#selected_capacity').empty();
                    for(let i=0; i < capacites.length; i ++){
                      var capacity_name = capacites[i].capacity_name;
                      var capacity_id = capacites[i]._id;
                      let unit = capacites[i].unit;
                      let capacity_unit = ""
                      if(unit == 0 ){capacity_unit = 'Kilos' }else if(unit == 1){capacity_unit =  'Litre' }else if(unit == 2){capacity_unit = 'm3' }
                      
                      if(repeat_selected_capacity_id && repeat_selected_capacity_id.toString() == capacites[i]._id.toString()  ){
                        $("#selected_capacity").append("<option  selected value="+ capacity_id +">"+capacity_name+" "+capacity_unit+ "</option>");
                      }else{
                        $("#selected_capacity").append("<option  value="+ capacity_id +">"+capacity_name+" "+capacity_unit+ "</option>");
                      }
                    }
                    $('#selected_capacity').selectpicker('refresh');
                  }else{
                    $('#selected_capacity').empty();
                    $('#selected_capacity').selectpicker('refresh');
                  }    
              
                  $('#is_use_model').val(is_use_model);
                  $('#is_use_service').val(is_use_service);
                  $('#is_use_capacity').val(is_use_capacity);
                  let user_list =  <%-JSON.stringify(user_list)%>
                  user_list.forEach(function(user){ 
                    if(user._id.toString() == trip_data.user_id.toString()){
                      $('#select_user').val(trip_data.user_id);
                      $('#select_user').selectpicker('refresh');
                      var user=$('#select_user').val();
                      $('#first_name').val($('#'+user).attr('data-first_name'));
                      $('#last_name').val($('#'+user).attr('data-last_name'));
                      $('#last_name').attr('readonly', true)
                      $('#email').val($('#'+user).attr('data-email'));
                      $('#phone').val($('#'+user).attr('data-phone'));
                      $('#first_name').attr('readonly', true)
                      $('#last_name').attr('readonly', true)
                      $('#email').attr('readonly', true)
                      $('#phone').attr('readonly', true)
                    }
                  }) 
                  $('#create_number_of_trips').val(1);
                  $('#create_number_of_trips').selectpicker('refresh');
                }

                $('#server_time').val(response.server_time);
                $('#timezone').val(response.city_detail.timezone);
                $('#city_id').val(response.city_detail._id);
              
              } else {
                $("#service_type_id").append("<option selected style='display: none;'>Select Service Type</option>");
                $("#message").text("Service Type Not Available");
                
                if(response.error_code == <%= error_message.ERROR_CODE_OUR_BUSINESS_NOT_IN_YOUR_COUNTRY %>) {
                  $("#message").text("<%= __('error_message_business_not_in_your_country') %>");
                } else if(response.error_code == <%= error_message.ERROR_CODE_OUR_BUSINESS_NOT_IN_YOUR_CITY %>) {
                  $("#message").text("<%= __('error_message_business_not_in_your_city') %>");
                } else if(response.error_code == <%= error_message.ERROR_CODE_OUR_BUSINESS_NOT_IN_YOUR_AREA %>) {
                  $("#message").text("<%= __('error_message_business_not_in_your_area') %>");
                }
                
                $('#ridenow').attr('disabled', true);
                for (var i = 0; i < provider_markers.length; i++) {
                  provider_markers[i].setMap(null);
                }
              }
              $('#service_type_id').selectpicker('refresh');
            }
          });
      }
      
      $('#select_user').change(function(){
  
        var user=$('#select_user').val();
        if(user == "Select User")
        {
          $('#first_name').val('');
          $('#last_name').val('');
          $('#email').val('');
          $('#phone').val('');
  
          $('#first_name').attr('readonly', false)
          $('#last_name').attr('readonly', false)
          $('#email').attr('readonly', false)
              $('#phone').attr('readonly', false)
              
          }
          else
          {
              $('#first_name').val($('#'+user).attr('data-first_name'));
              $('#last_name').val($('#'+user).attr('data-last_name'));
              $('#last_name').attr('readonly', true)
              $('#email').val($('#'+user).attr('data-email'));
              $('#phone').val($('#'+user).attr('data-phone'));
  
              $('#first_name').attr('readonly', true)
              $('#last_name').attr('readonly', true)
              $('#email').attr('readonly', true)
              $('#phone').attr('readonly', true)
          }
  
      });
  
      $("#service_type_id").change(function () {
        let index1 = types.findIndex(x => (x._id).toString() == this.value);
        let citytype_id = types[index1]._id
        courierFlow()
        $('#citytype_id').val(citytype_id);
  
        let is_use_model = types[index1].type_details.is_use_model
        let is_use_service = types[index1].type_details.is_use_services
        let is_use_capacity = types[index1].type_details.is_use_capacity
        let models = []
        let services = []
        let capacites = []
        const model_type = types[index1].type_details?.model_type
        $("#model_type").val(model_type != undefined ? model_type : "")

        $('#is_use_model').val(is_use_model);
        $('#is_use_service').val(is_use_service);
        $('#is_use_capacity').val(is_use_capacity);
        if(is_use_model == 1 || model_type  == '<%= MODEL_TRUCK_TYPE.MOTO %>' || model_type  == '<%= MODEL_TRUCK_TYPE.VAN %>' || model_type == "<%= MODEL_TRUCK_TYPE.VOLTEO %>" || model_type == "<%= MODEL_TRUCK_TYPE.PANEL_DE_CARGA %>"){
          models = types[index1].type_model_details
          $('#selected_model').empty();
          if(models.length == 1){
            $("#selected_model").append("<option style='display: none;' value="+ models[0]._id +"></option>");
          }else{
            $("#selected_model").append("<option selected disabled hidden style='display: none'><%= __('title_select_model') %></option>");
            for(let i=0; i < models.length; i ++){
              $("#selected_model").append("<option value="+ models[i]._id +">"+models[i].model_name+"</option>");
            }
          }
          $('#selected_model').selectpicker('refresh');
          if(is_use_service == 1){
            $('#selected_services').empty();
            $("#selected_services").append("<option selected disabled hidden style='display: none'><%= __('title_select_service') %></option>");
            $('#selected_services').selectpicker('refresh');
            $("#courier_type").val(0)
            if(model_type == '<%= MODEL_TRUCK_TYPE.MOTO %>' || model_type == '<%= MODEL_TRUCK_TYPE.VAN %>' || model_type == '<%= MODEL_TRUCK_TYPE.VOLTEO %>' || model_type == '<%= MODEL_TRUCK_TYPE.PANEL_DE_CARGA %>'){
              if(models.length > 0){
                services = models[0].type_service_details
                for(let i=0; i < services.length; i ++){
                  $("#selected_services").append("<option value="+ services[i]._id +">"+services[i].service_name+"</option>");
                if(i == 0 && services[i].courier_type != undefined){
                    $("#courier_type").val(services[0].courier_type)
                    if(services[i].courier_type == "<%= constant_json.COURIER_CISTERNA_FLOW %>"){
                      cisternaFlow()
                    }else if(services[i].courier_type == "<%= constant_json.COURIER_ESCOMBRO_FLOW %>"){
                      escombroFlow()
                    }else{
                      $(".pickup_field").show()
                      $(".destination_field").hide()
                      $(".addstop").show()
                    }
                  }
                }
                $('#selected_services').selectpicker('refresh');
              }
            }
          }else{
            $('#selected_services').empty();
            $('#selected_services').selectpicker('refresh');
          }       
        }else{
          $('#selected_services').empty();
          $('#selected_services').selectpicker('refresh');
          $('#selected_model').empty();
          $('#selected_model').selectpicker('refresh');
        }
        if(model_type == "<%= MODEL_TRUCK_TYPE.CISTERNA %>"){
          cisternaModelChanges()
        }
        if(model_type == "<%= MODEL_TRUCK_TYPE.VOLTEO %>"){
          volteoModelChanges()
        }

        if (validateCapacity.includes(model_type)) {
          removeSelectedCapacityValidation();
        }

        if (validateTruckType.includes(model_type)) {
          addSelectedTruckTypeValidation();
        }

        if(is_use_capacity == 1){
          capacites = types[index1].type_capacity_details
  
          $('#selected_capacity').empty();
          $("#selected_capacity").append("<option selected disabled hidden style='display: none'><%= __('title_select_capacity') %></option>");
  
          for(let i=0; i < capacites.length; i ++){
            var capacity_name = capacites[i].capacity_name;
            if(model_type == "<%= MODEL_TRUCK_TYPE.TORONTO %>" && capacity_name == "7.500"){
              continue;
            }
            var capacity_id = capacites[i]._id;
            let unit = capacites[i].unit;
            let capacity_unit = ""
            if(unit == 0 ){capacity_unit = 'Kilos' }else if(unit == 1){capacity_unit =  'Litre' }else if(unit == 2){capacity_unit = 'm3' }
            $("#selected_capacity").append("<option  value="+ capacity_id +">"+capacity_name+" "+capacity_unit+ "</option>");
          }
          $('#selected_capacity').selectpicker('refresh');
        }else{
          $('#selected_capacity').empty();
          $('#selected_capacity').selectpicker('refresh');
        }    

          var type = document.getElementById('service_type_id').value;
  
          for(var index in surge_time)
          {
            if( surge_time[index].type_id == type)
            {
              selected_surge_time = surge_time[index].surge_hours;
              rich_area_surge_multiplier = surge_time[index].rich_area_surge_multiplier;
            }
          }
  
          clearInterval(near_by_driver_interval);
          // get_near_by_driver(this.value);
          // var abc = this.value;
          // near_by_driver_interval = setInterval(function () {
          //     get_near_by_driver(abc);
          // },5000)
  
          // get_fare_estimate();
      })
  
   $("#selected_model").change(function () {
   let service_type_id = $("#service_type_id").val()
   let index = types.findIndex(x => (x._id).toString() == service_type_id.toString());
   let is_use_service = types[index].type_details.is_use_services
   if(is_use_service == 1){
     let models = types[index].type_model_details
    
     let index1 = models.findIndex(x => (x._id).toString() == this.value);
          const model_name = models[index1].model_name
          capacitiesAppend(types[index], model_name)
     let services = models[index1].type_service_details
          $('#selected_services').empty();
          $("#selected_services").append("<option selected disabled hidden style='display: none'><%= __('title_select_service') %></option>");
          $('#selected_services').selectpicker('refresh');
          $("#courier_type").val(0)
          
          for(let i=0; i < services.length; i ++){
            $("#selected_services").append("<option value="+ services[i]._id +">"+services[i].service_name+"</option>");
            if(i == 0 && services[i].courier_type != undefined){
              $("#courier_type").val(services[0].courier_type)
              
              if(services[i].courier_type == "<%= constant_json.COURIER_CISTERNA_FLOW %>"){
                cisternaFlow()
              }else if(services[i].courier_type == "<%= constant_json.COURIER_ESCOMBRO_FLOW %>"){
                escombroFlow()
              }else{
                $(".pickup_field").show()
                $(".destination_field").hide()
                $(".addstop").show()
              }
            }
          }
          $('#selected_services').selectpicker('refresh');
  
        }else{
          $('#selected_services').empty();
          $('#selected_services').selectpicker('refresh');
        }       
      })
      
      $("#select_procedure").change(function () {
        if(this.value == "<%= PROCEDURE_TYPE.FISCAL_TI_MERCHANDISE %>"){         
          $(".transit_service_div").show()
          $("#vehicle_selection_form").validate().settings.rules.select_transit_service = "required";
        }else{
          $('#select_transit_service').prop('selectedIndex', 0);
          $('#select_transit_service').selectpicker('refresh');
          $("#vehicle_selection_form").validate().settings.rules.select_transit_service = {};
          $("#vehicle_selection_form").validate().settings.rules.select_type_number = {};
          $('#select_type_number').val("")
          $('#select_type_number').selectpicker('refresh');
          $(".transit_service_div").hide()
          $(".type_number_div").hide()
          
        }
      })
      
      $("#select_transit_service").change(function () {
        if(this.value == 1){         
          $(".type_number_div").show()
          $("#vehicle_selection_form").validate().settings.rules.select_type_number = "required";
        }else{
          $('#select_type_number').prop('selectedIndex', 0);
          $('#select_type_number').selectpicker('refresh');
          $("#vehicle_selection_form").validate().settings.rules.select_type_number = {};
          $(".type_number_div").hide()
        }
      })

      function get_near_by_driver(service_type_id) {
          var latitude = $('#lat').val();
          var longitude = $('#lng').val();
          $.ajax({
              type: 'POST',
              url: '/get_nearby_provider',
              data: {'service_type_id': service_type_id, 'latitude':latitude,'longitude':longitude},
              dataType: "json",
              success: function (response) {
  
                  $('#select_provider').empty();
                  $("#select_provider").append("<option selected style='display: none;'>Select Provider</option>");
  
                  provider_array = [];
                  //$('#provider_full_name').val('');
                  //$('#provider_phone').val('');
                  for (var i = 0; i < provider_markers.length; i++) {
                      provider_markers[i].setMap(null);
                  }
                  provider_markers = [];
                  providers = [];
                  if(response.success){
                      $("#message").text("");
                      $('#ridenow').attr('disabled', false);
                      response.providers.forEach(function (provider_data) {
                          provider_array.push({
                              _id: provider_data._id,
                              full_name: provider_data.first_name + ' ' + provider_data.last_name,
                              phone: provider_data.phone
                          })
                          var providerLocation = provider_data.providerLocation;
                          var  contentString;
                          var lat = providerLocation[0];
                          var lon = providerLocation[1];
                          var  contentString =
                              '<p><b>Username</b>: ' +provider_data.first_name + ' ' + provider_data.last_name +
                              '<br><b>Rating</b>: ' + provider_data.rate +
                              '</p>';
  
                          providers.push({
                              picture: provider_data.picture,
                              latlon: new google.maps.LatLng(lat, lon),
                              message: new google.maps.InfoWindow({
                                  content: contentString,
                                  maxWidth: 320
                              })
                          });
                          $('#select_provider').append("<option value="+provider_data._id + ">"+ provider_data.first_name + ' ' + provider_data.last_name + "</option>");
                      });
                      $('#select_provider').selectpicker('refresh');
                      providers.forEach(function(loc_data, i){
                        var marker = new google.maps.Marker({
                            position: loc_data.latlon,
                            map: map,
                            icon: icon,
                            icon: {
                              url: iconBase + 'FLETY_ICONO_350_450_oriente.svg',
                              scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                            },
                            scaledSize: new google.maps.Size(30, 30)
                        });

                          provider_markers.push(marker);
  
                          google.maps.event.addListener(marker, 'click', function(e){
                              loc_data.message.open(map, marker);
                              setTimeout(function () { loc_data.message.close(); }, 5000);
                          });
                      });
                      if(provider_markers.length == 0){
                          $('#provider_length').text('<%= __("title_no_provider_found") %>')
                      } else {
                          $('#provider_length').text(provider_markers.length + ' Provider Available')
                      }
                  } else {
                      // $("#message").text("Provider not found");
                      // $('#ridenow').attr('disabled', true);
                  }
              }
          });
      }
  
      function get_near_by_driver_running_request(service_type_id, latitude, longitude) {
          $.ajax({
              type: 'POST',
              url: '/get_nearby_provider',
              data: {'service_type_id': service_type_id, 'latitude':latitude,'longitude':longitude},
              dataType: "json",
              success: function (response) {
                  $('#select_provider1').empty();
                  $("#select_provider1").append("<option selected style='display: none;'>Select Provider</option>");
                  provider_array = [];
                  $('#provider_full_name1').val('');
                  $('#provider_phone1').val('');
                  for (var i = 0; i < provider_markers.length; i++) {
                      provider_markers[i].setMap(null);
                  }
                  provider_markers = [];
                  if(response.success){
                      $("#message1").text("");
                      $('#send_request').attr('disabled', false);
                      response.providers.forEach(function (provider_data) {
                          provider_array.push({
                              _id: provider_data._id,
                              full_name: provider_data.first_name + ' ' + provider_data.last_name,
                              phone: provider_data.phone
                          })
                          var providerLocation = provider_data.providerLocation;
                          var  contentString;
                          var lat = providerLocation[0];
                          var lon = providerLocation[1];
                          var  contentString =
                              '<p><b>Username</b>: ' +provider_data.first_name + ' ' + provider_data.last_name +
                              '<br><b>Rating</b>: ' + provider_data.rate +
                              '</p>';
  
                          providers.push({
                              latlon: new google.maps.LatLng(lat, lon),
                              message: new google.maps.InfoWindow({
                                  content: contentString,
                                  maxWidth: 320
                              })
                          });
                          $('#select_provider1').append("<option value="+provider_data._id + ">"+ provider_data.first_name + ' ' + provider_data.last_name + "</option>");
                      });
                      $('#select_provider1').selectpicker('refresh');
                      providers.forEach(function(loc_data, i){
                        var marker = new google.maps.Marker({
                            position: loc_data.latlon,
                            map: map,
                            icon: icon,
                            icon: {
                              url: iconBase + 'FLETY_ICONO_350_450_oriente.svg',
                              scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                            },
                            scaledSize: new google.maps.Size(30, 30)
                        });

                          provider_markers.push(marker);
                          google.maps.event.addListener(marker, 'click', function(e){
                              loc_data.message.open(map, marker);
                              setTimeout(function () { loc_data.message.close(); }, 5000);
                          });
                      });
                  } else {
                      // $("#message1").text("Provider not found");
                      $('#send_request').attr('disabled', true);
                  }
              }
          });
      }
      
      $('#selected_services').change(function () {     
        let service_type_id = $('#service_type_id').val()
        let type_index = types.findIndex((x)=>x._id.toString() == service_type_id.toString());
        let courier_type = "<%= constant_json.COURIER_FLOW %>"
        $("#courier_type").val(courier_type)
        if(type_index != -1){
          let service_type_details = types[type_index]
          let model_id = $('#selected_model').val()
          let model_index = service_type_details.type_model_details.findIndex((x)=>x._id == model_id);
          if(model_index != -1){
            let type_model_details = service_type_details.type_model_details[model_index]  
            let service_id = $('#selected_services').val()
            let service_index = type_model_details.type_service_details.findIndex((x)=>x._id == service_id);
            if(service_index != -1){
              let service_details = type_model_details.type_service_details[service_index]
              if(service_details.courier_type){
                courier_type = service_details.courier_type
                $("#courier_type").val(courier_type)
                if(courier_type == "<%= constant_json.COURIER_CISTERNA_FLOW %>"){
                  cisternaFlow()
                }else if(courier_type == "<%= constant_json.COURIER_ESCOMBRO_FLOW %>"){
                  escombroFlow()
                }else{
                  $(".pickup_field").show()
                  $(".destination_field").hide()
                  $(".addstop").show()
                }
              }else{
                $(".pickup_field").show()
                $(".destination_field").hide()
                $(".addstop").show()
              }
            }
          }
        }
      })
      
      $('#select_provider').change(function () {
          var index = provider_array.findIndex((x)=>x._id == this.value);
          $("#select_provider").append("<option value="+this.value+" selected style='display: none;'>Select Provider</option>");
          $('#select_provider').selectpicker('refresh');
          $('#provider_full_name').val(provider_array[index].full_name)
          $('#provider_phone').val(provider_array[index].phone)
          $('#provider_full_name').attr('readonly', false)
          $('#provider_phone').attr('readonly', false)
      })
  
      $('#select_provider1').change(function () {
          var index = provider_array.findIndex((x)=>x._id == this.value);
          $("#select_provider1").append("<option value="+this.value+" selected style='display: none;'>Select Provider</option>");
          $('#select_provider1').selectpicker('refresh');
          $('#provider_full_name1').val(provider_array[index].full_name)
          $('#provider_phone1').val(provider_array[index].phone)
          $('#provider_full_name1').attr('readonly', false)
          $('#provider_phone1').attr('readonly', false)
      })
  
      $('#provider_type').change(function () {
          if(this.value == 2){
              $('#provider_div').show();
              $('#provider_full_name').attr('required', true);
              $('#provider_phone').attr('required', true);
          } else {
              $('#provider_div').hide();
              //$('#provider_full_name').val('');
              //$('#provider_phone').val('');
              $('#provider_full_name').attr('required', false);
              $('#provider_phone').attr('required', false);
          }
      })
  
      $('#provider_type1').change(function () {
          if(this.value == 2){
              $('#provider_div1').show();
              $('#provider_full_name1').attr('required', true);
              $('#provider_phone1').attr('required', true);
          } else {
              $('#provider_div1').hide();
              //$('#provider_full_name1').val('');
              //$('#provider_phone1').val('');
              $('#provider_full_name1').attr('required', false);
              $('#provider_phone1').attr('required', false);
          }
      })

      function get_current_distance(optimize=false){
        var latitude = $('#lat').val();
        var longitude = $('#lng').val();
        var dest_latitude = $('#dlat').val();
        var dest_longitude = $('#dlng').val();
        let destination_address_list = []
        let destination_stop = []
        var waypoints = []
        let forms_data = $("#signupForm").serializeJSON()
        
        if(forms_data.destination_addresses){
            forms_data.destination_addresses.forEach((element, index) => {
              if(forms_data.internal_stop_addresses[index] != "" ){
                var internal_stop = JSON.parse(forms_data.internal_stop_addresses[index])
              }
              destination_address_list.push({
                address: forms_data?.destination_addresses[index],
                location: [
                  Number(forms_data.d_stop_lat[index]),
                  Number(forms_data.d_stop_lng[index])
                ],
                stops_inside: internal_stop || []
              })
            });
          }

          $.ajax({
                type: 'POST',
                dataType: 'json',
                data: {
                    pickup_latitude : latitude,
                    pickup_longitude : longitude, 
                    destination_latitude : dest_latitude , 
                    destination_longitude: dest_longitude , 
                    'distance' : distance_meter,
                    'stops_address': destination_address_list,
                    val: 1,
                    optimize : optimize,
                },
                url: "/aproxdistance",
                success:function(response) {
                  let dist = (response.distance / 1000).toFixed(2)
                  $('#show_distance').val(dist+" Km")
                }
            });


      }
  
      function get_fare_estimate(){
        let optm = $('#b_optimize').is(':checked')
        var latitude = $('#lat').val();
        var longitude = $('#lng').val();
        var dest_latitude = $('#dlat').val();
        var dest_longitude = $('#dlng').val();
        let couriers_flow = $('#courier_type').val();
          if(couriers_flow == "<%= constant_json.COURIER_CISTERNA_FLOW %>" && dest_latitude && dest_longitude){
            var destination = {lat: parseFloat(dest_latitude), lng: parseFloat(dest_longitude)};
          }else if(couriers_flow == "<%= constant_json.COURIER_ESCOMBRO_FLOW %>" && latitude && longitude){
            var origin = {lat: parseFloat(latitude), lng: parseFloat(longitude)};
          }else if(couriers_flow == "<%= constant_json.COURIER_FLOW %>" && dest_latitude && dest_longitude && latitude && longitude){
            var origin = {lat: parseFloat(latitude), lng: parseFloat(longitude)};
            var destination = {lat: parseFloat(dest_latitude), lng: parseFloat(dest_longitude)};
          }else{
            return;
          }
  
          var waypoints = []
          for (let index = 0; index < $('#dest_stops_lat_lng_div')[0].childElementCount; index++) {
            const element = $('#dest_stops_lat_lng_div')[0].children[index]
            var dlatlng = String(element.value);
            dlatlng = dlatlng.replace(/[{( )}]/g, '');
            dlatlng = dlatlng.split(',');
            if (dlatlng.length == 2) {
              var point = new google.maps.LatLng(Number(dlatlng[0]), Number(dlatlng[1]));
              waypoints.push({
                location: point,
                stopover: true
              });
            }
          }
  
          if(couriers_flow == "<%= constant_json.COURIER_FLOW %>"){
              // directionsService.route({
              //   origin: origin,
              //   waypoints: waypoints,
              //   optimizeWaypoints: false,
              //   destination: destination,
              //   travelMode: google.maps.TravelMode.DRIVING
              // }, function(response, status) {
                  // var distance = 0;
                  // var time = 0;
                  // if (status == google.maps.DirectionsStatus.OK) {
                  //     var array = response.routes[0].legs;
                  //     var distance = 0;
                  //     var time = 0;
                  //     array.forEach((data) => {
                  //       distance = distance + data.distance.value;
                  //       time = time + data.duration.value
                  //     });
                  // }
                  // distance_meter = distance
                  // console.log(distance_meter)
                  var zone = $('#timezone').val();
                  var server_time = $('#server_time').val();
                  // $.ajax({
                      // type : 'POST',
                      // url : '/get_server_time',
                      // data : {},
                      // datatype :"json",
                      //   success:function(response) {
      
                          // var type = document.getElementById('service_type_id').value;                        
                          // for(var index in surge_time)
                          // {
                          //   if( surge_time[index].type_id == type)
                          //   {
                          //     selected_surge_time = surge_time[index].surge_hours;
                          //   }
                          // }
      
                          // var now = response.server_date;
                          // var now1 = new Date(now).toLocaleString("en-US", {timeZone: $('#timezone').val()})
                          // now1 = new Date(now1)
                          // var week_day = now1.getDay();
                          var is_surge_hours = 0;
                          var multiplier = 1;
      
                          // if(selected_surge_time[  week_day].is_surge){
                          //   var current_date = response.server_date;
                          //   current_date = new Date(current_date).toLocaleString("en-US", {timeZone: $('#timezone').val()})
                          //   current_date = new Date(current_date)
      
                          //   selected_surge_time[week_day].day_time.forEach(function(day_time){
                          //     var day_time_multiplier = day_time.multiplier;
                          //     var start_time = day_time.start_time;
                          //     var end_time = day_time.end_time;
                          //     start_time = start_time.split(':');
                          //     end_time = end_time.split(':');
                          //     var start_date_time = current_date.setHours(start_time[0], start_time[1], 0, 0);
                          //     start_date_time = new Date(start_date_time);
                          //     var end_date_time = current_date.setHours(end_time[0], end_time[1], 0, 0);
                          //     end_date_time = new Date(end_date_time);
                          //     if(now1.getTime() > start_date_time.getTime() && now1.getTime() < end_date_time.getTime()){
                          //       is_surge_hours = 1;
                          //       multiplier = day_time_multiplier;
                          //     }
                          //   })
                          // }
                          if(multiplier < rich_area_surge_multiplier){
                              is_surge_hours = 1;
                              multiplier = rich_area_surge_multiplier;
                          }

                          var ticketBoatSelection = $('input[name=ticket_boat]:radio:checked');
                          boatCheck = ticketBoatSelection.val();

                          let service_type_id = $('#service_type_id').val();
                          let selected_model_id = $('#selected_model').val();
                          let selected_service_id = $('#selected_services').val();
                          let selected_capacity_id = $('#selected_capacity').val();
                          let number_of_helpers_load = $('#select_helpers_for_load').val()
                          let number_of_helpers_download = $('#select_helpers_for_download').val()
                          let courier_type = $('#courier_type').val()
                          let night_shift = $('#night_shift').val()
                          let boat_ticket_check = boatCheck;
                          let forms_data = $("#signupForm").serializeJSON()
                          let destination_address_list = []
                          let destination_stop = []
                          let promo_id = $('#promo_id').val() || ""
                          let selected_transit_type_number = $('#selected_transit_type_number').val();

                          if(optm){
                            optimizedStops.forEach((element, index) => {
                                if($('#destination').val() !== element.address){
                                destination_address_list.push({
                                  address: element.address,
                                  location: [
                                    Number(element.location[0]),
                                    Number(element.location[1])
                                  ],
                                  stops_inside: []
                                })}
                                
                              });
                          }else{
                            if(forms_data.destination_addresses){
                              forms_data.destination_addresses.forEach((element, index) => {
                                if(forms_data.internal_stop_addresses[index] != "" ){
                                  var internal_stop = JSON.parse(forms_data.internal_stop_addresses[index])
                                }
                                if($('#destination').val() !== forms_data.destination_addresses[index]){
                                destination_address_list.push({
                                  address: forms_data.destination_addresses[index],
                                  location: [
                                    Number(forms_data.d_stop_lat[index]),
                                    Number(forms_data.d_stop_lng[index])
                                  ],
                                  stops_inside: []
                                })}
                              });
                            }
                          }
                            let dist = (distance_meter / 1000).toFixed(2);
                          $.ajax({
                              type: 'POST',
                              dataType: 'json',
                              data: {
                                  'service_type_id': service_type_id,
                                  selected_model_id: selected_model_id, 
                                  selected_service_id: selected_service_id, 
                                  selected_capacity_id: selected_capacity_id, 
                                  number_of_helpers_load: number_of_helpers_load, 
                                  number_of_helpers_download: number_of_helpers_download, 
                                  pickup_latitude : latitude ,
                                  pickup_longitude : longitude , 
                                  destination_latitude : dest_latitude , 
                                  destination_longitude: dest_longitude , 
                                  is_multiple_stop: (waypoints.length != 0 ? 1 : 0), 
                                  surge_multiplier: multiplier, 
                                  courier_flow_type:courier_type,
                                  'is_surge_hours': is_surge_hours, 
                                  'time' : time, 
                                  'distance' : distance_meter,
                                  'stops_address': destination_address_list, 
                                  night_shift: night_shift,
                                  boat_ticket_check,
                                  optimize: optm,
                                  promo_id,
                                  selected_transit_type_number
                              },
                              url: "/getfareestimate",
                              success:function(response) {
                                if(response.error_code == <%= error_message.ERROR_CODE_NO_SERVICE_TYPE_FOUND %>){
                                  createToastWithContactUs("<%= __('error_message_pricing_not_available_for_selected')%>")
                                  return
                                }
                                //console.log(JSON.stringify(response))
                                
                                let cancellation_fee = ((response.estimated_fare)?.toFixed(2) * response.cancellation_fees * 0.01).toFixed(2)
                                let order_trips = 0
                                let promo_bonus = response.promo_payment || 0
                                $('#cancellation_fee').text(cancellation_fee);
                                $("#order_night_shifts").text(response.night_shift_count);
  
                                if(
                                    response.is_margarita && 
                                    Number(response.boat_ticket_check) == 1
                                ) {
                                  $("#ferry_message_div").show();
                                  $("#ferry_ticket").text(response.boat_ticket_price);
                                } else {
                                  $("#ferry_message_div").hide();
                                }
  
                                $("#night_shifts_value").val(response.night_shift_count);
                                $("#ferry_ticket_value").val(response.boat_ticket_price);
  
                                if(response.is_fixed_fees_used){
                                  $('#fare_message_div').show()
                                  $('#min_fixed_fare_message').text("*Tarifa fija utilizada");
                                  $('#distance_fare_div').show();
                                }else if(response.is_min_fare_used){
                                  $('#fare_message_div').show()
                                  $('#distance_fare_div').show();
                                  let message = "<%= __('minimum_tariff') %>";
                                  $('#min_fixed_fare_message').text(message);
                                  $("#row_price_per_km").hide();
                                }else{
                                  $('#fare_message_div').hide()
  
                                  $('#distance_fare_div').show();
  
                                  $('#price_per_km').text((response.price_per_unit_distance || 0).toFixed(2));
                                }
                                if( $('#create_number_of_trips').val() > 0 ){
                                  order_trips = $('#create_number_of_trips').val()
                                }
                                $('#order_trips').text(order_trips)
                                
                                $('#order_amount').text((response.estimated_fare - promo_bonus).toFixed(2));
                                $('#order_total_amount').text(((response.estimated_fare * order_trips) - promo_bonus).toFixed(2));
  
                                $('#fixed_price').val((response.estimated_fare).toFixed(2));
                                
                                if(response.distanceFixed == 0){
                                    $('#total_distance').text(response.distance);
                                    $('#total_distance_fixed_title_div').hide()
                                    $('#total_distance_fixed_div').hide()
                                    $('#total_distance_title_div').show()
                                    $('#total_distance_div').show()
                              
                                }else{
                                  $('#total_distance').text(response.distance);
                                  $('#total_distance_fixed').text(response.distanceFixed);
                                  $('#total_distance_title_div').show()
                                  $('#total_distance_div').show()
                                  $('#total_distance_fixed_title_div').show()
                                  $('#total_distance_fixed_div').show()
                                  
                                }
                                $('#estimated_distance').val(response.distance);
                                //response.stops_address.pop()
                                let aux = JSON.stringify(response.stops_address)
                                
                                $('#stops_data').val(aux)
                                
                                fill_order_summary()
                                $(".order_summary").show();
                                $(".pick_dest_details").hide();
                                $(".forward_backward_btn").hide();
                                page_num = 4
                                // $('#min_fare_div').show();
                              }
                          });
                      // }
                  // });
              // });
            }else{
              var distance = 0;
              var time = 0;
              var zone = $('#timezone').val();
              var server_time = $('#server_time').val();
              var is_surge_hours = 0;
              var multiplier = 1; 

              if(multiplier < rich_area_surge_multiplier){
                  is_surge_hours = 1;
                  multiplier = rich_area_surge_multiplier;
              }

              var ticketBoatSelection = $('input[name=ticket_boat]:radio:checked');
              boatCheck = ticketBoatSelection.val();

              let service_type_id = $('#service_type_id').val();
              let selected_model_id = $('#selected_model').val();
              let selected_service_id = $('#selected_services').val();
              let selected_capacity_id = $('#selected_capacity').val();
              let number_of_helpers_load = $('#select_helpers_for_load').val()
              let number_of_helpers_download = $('#select_helpers_for_download').val()
              let courier_type = $('#courier_type').val();
              let night_shift = $('#night_shift').val();
              let boat_ticket_check = boatCheck;
              let forms_data = $("#signupForm").serializeJSON();
              let destination_address_list = []
              let destination_stop = []
              let promo_id = $('#promo_id').val() || ""
              let selected_transit_type_number = $('#selected_transit_type_number').val();
              
              if(optm){
                optimizedStops.forEach((element, index) => {
                    if($('#destination').val() !== element.address){
                    destination_address_list.push({
                      address: element.address,
                      location: [
                        Number(element.location[0]),
                        Number(element.location[1])
                      ],
                      stops_inside: []
                    })}
                    
                  });

              }else{
                if(forms_data.destination_addresses){
                  forms_data.destination_addresses.forEach((element, index) => {
                    if(forms_data.internal_stop_addresses[index] != "" ){
                      var internal_stop = JSON.parse(forms_data.internal_stop_addresses[index])
                    }
                    if($('#destination').val() !== forms_data.destination_addresses[index]){
                    destination_address_list.push({
                      address: forms_data.destination_addresses[index],
                      location: [
                        Number(forms_data.d_stop_lat[index]),
                        Number(forms_data.d_stop_lng[index])
                      ],
                      stops_inside: []
                    })}
                    
                  });
                }
              }
                if(couriers_flow == "<%= constant_json.COURIER_CISTERNA_FLOW %>"){
                  latitude = 0
                  longitude = 0
                }
                if(couriers_flow == "<%= constant_json.COURIER_ESCOMBRO_FLOW %>"){
                  dest_latitude = 0
                  dest_longitude = 0
                }

                $.ajax({
                  type: 'POST',
                  dataType: 'json',
                  data: {
                    'service_type_id': service_type_id,
                    selected_model_id:selected_model_id, 
                    selected_service_id:selected_service_id, 
                    selected_capacity_id:selected_capacity_id, 
                    number_of_helpers_load:number_of_helpers_load, 
                    number_of_helpers_download: number_of_helpers_download,
                    pickup_latitude : latitude ,
                    pickup_longitude : longitude , 
                    destination_latitude : dest_latitude , 
                    destination_longitude: dest_longitude , 
                    is_multiple_stop: (waypoints.length != 0 ? 1 : 0), 
                    surge_multiplier: multiplier, 
                    courier_flow_type:courier_type,
                    'is_surge_hours': is_surge_hours, 
                    'time' : time , 
                    'distance' : distance_meter,
                    'stops_address':destination_address_list, 
                    night_shift: night_shift,
                    boat_ticket_check,
                    optimize: optm,
                    promo_id,
                    selected_transit_type_number
                  },
                  url: "/getfareestimate",
                  success:function(response) {
                    if(response.error_code == <%= error_message.ERROR_CODE_NO_SERVICE_TYPE_FOUND %>){
                      createToastWithContactUs("<%= __('error_message_pricing_not_available_for_selected') %>")
                      return
                    }
                    //console.log(JSON.stringify(response))
                    let cancellation_fee = ((response.estimated_fare).toFixed(2) * response.cancellation_fees * 0.01).toFixed(2)
                    let promo_bonus = response.promo_payment || 0

                    if(
                      response.is_margarita && 
                      Number(response.boat_ticket_check) === 1
                    ) {
                      $("#ferry_message_div").show();
                      $("#ferry_ticket").text(response.boat_ticket_price);
                    } else {
                      $("#ferry_message_div").hide();
                    }
  
                    let order_trips = 0
                    $('#cancellation_fee').text(cancellation_fee);
                    if(response.is_fixed_fees_used){
                      $('#fare_message_div').show()
                      $('#min_fixed_fare_message').text("*Tarifa fija utilizada");
                      $('#distance_fare_div').show();
                    }else if(response.is_fixed_fees_used){
                      $('#fare_message_div').show()
                      $('#distance_fare_div').show();
                      $("#row_price_per_km").hide();
                      $('#min_fixed_fare_message').text("*Min fare used");
                    }else{
                      $('#fare_message_div').hide()
  
                      $('#distance_fare_div').show();
  
                      $('#price_per_km').text((response.price_per_unit_distance).toFixed(2));
                    }
  
                    if( $('#create_number_of_trips').val() > 0 ){
                      order_trips = $('#create_number_of_trips').val()
                    }
                    $('#order_trips').text(order_trips)
                    
                    $('#order_amount').text((response.estimated_fare - promo_bonus).toFixed(2));
                    $('#order_total_amount').text(((response.estimated_fare * order_trips) - promo_bonus).toFixed(2));
                    $('#fixed_price').val((response.estimated_fare).toFixed(2));
                    
                    if(response.distanceFixed == 0){
                        $('#total_distance').text(response.distance);
                        $('#total_distance_fixed_title_div').hide()
                        $('#total_distance_fixed_div').hide()
                        $('#total_distance_title_div').show()
                        $('#total_distance_div').show()
                  
                    }else{
                      $('#total_distance_fixed').text(response.distanceFixed);
                      $('#total_distance_title_div').hide()
                      $('#total_distance_div').hide()
                      $('#total_distance_fixed_title_div').show()
                      $('#total_distance_fixed_div').show()
                      
                    }
                    let aux = JSON.stringify(response.stops_address)
                    $('#stops_data').val(aux)
  
                    fill_order_summary()
                      $(".order_summary").show();
                      $(".pick_dest_details").hide();
                      $(".forward_backward_btn").hide();
                      page_num = 4
                      
                  }
              });
          }
      }
  
      $(document).ready(function(){
  
          $("#signupForm").validate({
              rules: {
                  service_type_id: "required",
                  select_user: {
                      required: false
                  },
                  ticket_boat: {
                    required: true
                  },
                  phone: {
                      required: true,
                      minlength : <%= setting_detail.minimum_phone_number_length %>,
                      maxlength : <%= setting_detail.maximum_phone_number_length %>,
                      phone_regex: /^\(?([1-9]{1})\)?([0-9]*)$/
                  },
                  pickup_weight_of_load: {
                    required: true
                  },
                  pickup_description: {
                    required: true
                  }
              },
              submitHandler: function(form) {
                var form_data = $("#signupForm").serializeJSON()
  
                if (form_data.destination_addresses) {
                   if (form_data.destination_addresses.length != 0) {
                    var type = 1;
                    if (type != 1) {
                      $('#message').text("<%= __('error_not_supported_multiple_stop') %>")
                      return;
                    }
                  }
                }
                // if(form_data.destination_address.length == 0){
                //   $('#message').text("<%= __('error_not_supported_multiple_stop') %>")
                //   return;
                // }
  
                   if ($('#provider_type').val() == 1) {
                      $('#select_provider').val('');
                  }
                  $('#ridenow').attr('disabled', true);
                  $.ajax({
                      type: 'POST',
                      url: '/checkuser',
                      data: $("#signupForm").serialize(),
                      dataType: "json",
                      success: function (response) {
                          if (response.success == false) {
                              $('#message').text("<%= __('error_trip_already_running') %>")
                              // trip_error("<%= __('error_trip_already_running') %>")
                              $('#ridenow').attr('disabled', false);
                          }else{
                              var token = response.user.token;
                              $('#user_id').val(response.user._id);
                              $('#token').val(response.user.token);
                              var trip_type = $('#is_ride_later').val()
                              if (trip_type == 1) {
                                var form_data = $("#signupForm").serializeJSON()
                                var destination_addresses = []
                                form_data.optimize_field = $('#b_optimize').is(':checked');

                                if(form_data.optimize_field){
                                  optimizedStops.forEach((element, index) => {
                                      let stop_username = optimizedStopsUserDetails[index].stop_username
                                      let stop_user_phone = optimizedStopsUserDetails[index].stop_user_phone
                                      stop_user_phone = (stop_user_phone || "").split(',').filter(Boolean);
                                      if(element.address !== optimizedDestination.address){

                                        destination_addresses.push({
                                          address: element.address,
                                          location: [
                                            Number(element.location[0]),
                                            Number(element.location[1])
                                          ],
                                          stops_inside: [],
                                          stop_username: element.stop_username,
                                          stop_user_phone: element.stop_user_phone
                                        })
                                      }
                                  });
                                  form_data.d_latitude = +optimizedDestination.location[0]
                                  form_data.d_longitude = +optimizedDestination.location[1]
                                  form_data.destination_address = optimizedDestination.address || ""

                                }else{
                                  if(form_data.destination_addresses){
                                    form_data.destination_addresses.forEach((element, index) => {
                                      let stop_username = form_data.stop_username[index]
                                      let stop_user_phone = form_data.stop_user_phone[index]
                                      if(stop_user_phone != ""){
                                        stop_user_phone = stop_user_phone.split(',');
                                      }else{
                                        stop_user_phone = []
                                      }
                                      destination_addresses.push({
                                        address: form_data.destination_addresses[index],
                                        location: [
                                          Number(form_data.d_stop_lat[index]),
                                          Number(form_data.d_stop_lng[index])
                                        ],
                                        stops_inside: [],
                                        stop_username: stop_username,
                                        stop_user_phone: stop_user_phone
                                      })
                                    });
                                    
                                  }
                                  
                                }
                                delete form_data.d_stop_lat;
                                delete form_data.d_stop_lng;
                                delete form_data.destination_addresses;
                                delete form_data.internal_stop_addresses;
                                if(form_data.destination_address.length != 0){
                                  form_data.destination_addresses = destination_addresses;
                                }
  
                                let pickup_details = []
                                let pickup_user_details = {}
                                let delivery_details = []
                                let delivery_user_details = {}
                                let totalHelpers = 0;

                                let number_of_helpers_load = $('#select_helpers_for_load').val() ? $('#select_helpers_for_load').val() : 0;
                                let number_of_helpers_download = $('#select_helpers_for_download').val() ? $('#select_helpers_for_download').val() : 0;

                                totalHelpers = Number(number_of_helpers_load) + Number(number_of_helpers_download);

                                pickup_user_details = {
                                  company_name: $('#pickup_company_name').val(),
                                  country_phone_code: $('#pickup_phone_code').val(),
                                  name: $('#pickup_username').val(),
                                  no_of_helpers: totalHelpers,
                                  number_of_helpers_download: number_of_helpers_download,
                                  number_of_helpers_load: number_of_helpers_load,
                                  phone: $('#pickup_phone').val()
                                }

                                pickup_details = [{
                                  address: $('#pickup_address').val(),
                                  address_type: "pickup",
                                  city: '',
                                  note: $('#pickup_description').val(),
                                  weight_of_load: $('#pickup_weight_of_load').val(), 
                                  volume_of_load: $('#pickup_volume_of_load').val() ? $('#pickup_volume_of_load').val() : "", 
                                  user_details: pickup_user_details
                                }]

                                delivery_user_details = {
                                  company_name: $('#delivery_company_name').val(),
                                  country_phone_code: $('#delivery_phone_code').val(),
                                  name: $('#delivery_username').val(),
                                  phone: $('#delivery_phone').val()
                                }
  
                                delivery_details = [{
                                  address: form_data.destination_address,
                                  address_type: "destination",
                                  city: '',
                                  note: $('#delivery_description').val(),
                                  user_details: delivery_user_details
                                }]
                                
                                form_data.pickup_details = pickup_details
                                form_data.delivery_details = delivery_details
                            
                                form_data.promo_id = $('#promo_id').val() || ""
                                // console.log(JSON.stringify(form_data));

                                $.ajax({
                                  type: 'POST', // define the type of HTTP verb we want to use (POST for our form)
                                  url: '/createtrip', // the url where we want to POST
                                  data: form_data, // our data object
                                  datatype: "json",
                                  success: function (response) {
                                    
                                    $('#ridenow').attr('disabled', false);
                                      if (response.success == false) {
                                        if(response.error_code == '464'){
                                          $('#message').text("<%= __('error_payment_is_pending') %>")
                                        } else if(response.error_code == '435') {
                                          $('#message').text("<%= __('error_please_add_card_first') %>");
                                        } else {
                                          $('#message').text("<%= __('error_create_trip_failed') %>");
                                        }
                                      }
                                      else {
                                        const trip_id = response?.trip._id != undefined ? 
                                              response.trip._id : ""; 
                                        if(trip_id != undefined) {
                                          upload_trip_images(trip_id)
                                        }
                                        trip_success()
                                        window.location.href = 'corporate_create_trip';
                                        //location.reload()
                                      }
                                    }
                                });
                              } else {

                                var zone = $('#timezone').val();
                                  var server_time = $('#server_time').val();
                                  $.ajax({
                                      type : 'POST',
                                      url : '/get_server_time',
                                      data : {},
                                      datatype :"json",
                                        success:function(response) {
                                          var now = response.server_date;
                                          var now1 = new Date(now).toLocaleString("en-US", {timeZone: $('#timezone').val()})
                                          now1 = new Date(now1)
                                          var week_day = now1.getDay();
                                          var is_surge_hours = 0;
                                          var multiplier = 1;
  
                                          // if(selected_surge_time[week_day].is_surge){
                                          //   var current_date = response.server_date;
                                          //   current_date = new Date(current_date).toLocaleString("en-US", {timeZone: $('#timezone').val()})
                                          //   current_date = new Date(current_date)
  
                                          //   selected_surge_time[week_day].day_time.forEach(function(day_time){
                                          //     var day_time_multiplier = day_time.multiplier;
                                          //     var start_time = day_time.start_time;
                                          //     var end_time = day_time.end_time;
                                          //     start_time = start_time.split(':');
                                          //     end_time = end_time.split(':');
                                          //     var start_date_time = current_date.setHours(start_time[0], start_time[1], 0, 0);
                                          //     start_date_time = new Date(start_date_time);
                                          //     var end_date_time = current_date.setHours(end_time[0], end_time[1], 0, 0);
                                          //     end_date_time = new Date(end_date_time);
                                          //     if(now1.getTime() > start_date_time.getTime() && now1.getTime() < end_date_time.getTime()){
                                          //       is_surge_hours = 1;
                                          //       multiplier = day_time_multiplier;
                                          //     }
                                          //   })
                                          // }
  
                                          document.getElementById('is_surge_hours').value = is_surge_hours;
                                          document.getElementById('surge_multiplier').value = multiplier;
                                          
                                          var form_data = $("#signupForm").serializeJSON()

                                          var destination_addresses = []
                                          form_data.optimize_field = $('#b_optimize').is(':checked');

                                          if(form_data.optimize_field){
                                            optimizedStops.forEach((element, index) => {
                                              let stop_username = optimizedStopsUserDetails[index].stop_username
                                              let stop_user_phone = optimizedStopsUserDetails[index].stop_user_phone
                                              stop_user_phone = (stop_user_phone || "").split(',').filter(Boolean);
                                              if(element.address !== optimizedDestination.address){

                                                  destination_addresses.push({
                                                    address: element.address,
                                                    location: [
                                                      Number(element.location[0]),
                                                      Number(element.location[1])
                                                    ],
                                                    stops_inside: [],
                                                    stop_username: stop_username,
                                                    stop_user_phone: stop_user_phone
                                                  })
                                                }
                                              form_data.d_latitude = +optimizedDestination.location[0]
                                              form_data.d_longitude = +optimizedDestination.location[1]
                                              form_data.destination_address = optimizedDestination.address || ""
                                            });

                                          }else{
                                            if(form_data.destination_addresses){
                                              form_data.destination_addresses.forEach((element, index) => {
                                                let stop_username = form_data?.stop_username?.[index] ||  ""
                                                let stop_user_phone = form_data?.stop_user_phone?.[index] || []
                                                if(stop_user_phone != "" && stop_user_phone != []){
                                                  stop_user_phone = stop_user_phone.split(',');
                                                }
                                                destination_addresses.push({
                                                  address: form_data.destination_addresses[index],
                                                  location: [
                                                    Number(form_data.d_stop_lat[index]),
                                                    Number(form_data.d_stop_lng[index])
                                                  ],
                                                  stops_inside: [],
                                                  stop_username: stop_username,
                                                  stop_user_phone: stop_user_phone
                                                })
                                              });
                                              
                                            }
                                            
                                          }
                                          if(form_data.destination_address.length != 0){
                                            form_data.destination_addresses = destination_addresses;
                                          }
                                          let pickup_details = []
                                          let pickup_user_details = {}
                                          let delivery_details = []
                                          let delivery_user_details = {}
                                          let totalHelpers = 0;

                                          let number_of_helpers_load = $('#select_helpers_for_load').val() ? $('#select_helpers_for_load').val() : 0;
                                          let number_of_helpers_download = $('#select_helpers_for_download').val() ? $('#select_helpers_for_download').val() : 0;

                                          totalHelpers = Number(number_of_helpers_load) + Number(number_of_helpers_download);

                                          pickup_user_details = {
                                            company_name: $('#pickup_company_name').val(),
                                            country_phone_code: $('#pickup_phone_code').val(),
                                            name: $('#pickup_username').val(),
                                            no_of_helpers: totalHelpers,
                                            number_of_helpers_load: number_of_helpers_load,
                                            number_of_helpers_download: number_of_helpers_download,
                                            phone: $('#pickup_phone').val()
                                          }
          
                                          pickup_details = [{
                                            address: $('#pickup_address').val(),
                                            address_type: "pickup",
                                            city: '',
                                            note: $('#pickup_description').val(),
                                            weight_of_load: $('#pickup_weight_of_load').val(), 
                                            volume_of_load: $('#pickup_volume_of_load').val() ? $('#pickup_volume_of_load').val() : "", 
                                            user_details: pickup_user_details
                                          }]
          
                                        
                                          delivery_user_details = {
                                            company_name: $('#delivery_company_name').val(),
                                            country_phone_code: $('#delivery_phone_code').val(),
                                            name: $('#delivery_username').val(),
                                            phone: $('#delivery_phone').val()
                                          }
          
                                          delivery_details = [{
                                            address: form_data.destination_address,
                                            address_type: "destination",
                                            city: '',
                                            note: $('#delivery_description').val(),
                                            user_details: delivery_user_details
                                          }]

                                          
                                          form_data.pickup_details = pickup_details
                                          form_data.delivery_details = delivery_details
                                          form_data.promo_id = $('#promo_id').val() || ""

                                          // console.log(JSON.stringify(form_data));
                                          $.ajax({
                                              type: 'POST', // define the type of HTTP verb we want to use (POST for our form)
                                              url: '/createtrip', // the url where we want to POST
                                              data: form_data, // our data object
                                              datatype: "json",
                                              success: function (trip_response) {
                                                $('#ridenow').attr('disabled', false);
                                                  if (trip_response.success == false) {
                                                      if(trip_response.error_code == '464'){
                                                        $('#message').text("<%= __('error_payment_is_pending') %>")
                                                      } else if(trip_response.error_code == '435') {
                                                        $('#message').text("<%= __('error_please_add_card_first') %>");
                                                      } else {
                                                        $('#message').text("<%= __('error_create_trip_failed') %>");
                                                        var type = $('#service_type_id').val();
                                                        // clearInterval(near_by_driver_interval)
                                                        // get_near_by_driver(type);
                                                      }
                                                  } else {
                                                    const trip_id = trip_response.trip_id
                                                    upload_trip_images(trip_id)
                                                    trip_success()
                                                    window.location.href = 'corporate_create_trip';
                                                    //location.reload();
                                                  }
                                              }
                                          });
                                      }
                                  });
                              }
                          }
                      }
                  });
              }
          })
          
          $("#set_location_form").validate({
            ignore: [],
          rules: {
          pickup: "required",
          destination: "required"
          }
          })

          let fileInput = $("#load_images");
          $(".image-selector").click(function() {
            $("#load_images").click();
          });
          let fileCount = $("#fileCount");

          fileInput.on("change", function() {
            const files = Array.from(this.files); 
            
            let count = files.length;
            const maxFiles = 8; 

            if (files.length > maxFiles) {

              $(this).val('');
              count = 0;
              fileCount.text("");
              alert('You can only select up to ' + maxFiles + ' images.');
              return;
            }

            var maxSizeInBytes = 7 * 1024 * 1024; 
            var validImageTypes =  ["image/jpeg", "image/png", "application/pdf"]; 
            var fileInput = $('#file-input'); 
            let valid = validateFiles(files, maxSizeInBytes, validImageTypes, fileInput);
            if (!valid) {
              fileCount.text("");
              return
            } 
              fileCount.text(count + " files selected");
          });

          $("#vehicle_selection_form").validate({
            ignore: [],
            rules: {
              service_type_id: "required",
              selected_services_id: "required",
              selected_capacity_id: "required",
              select_user: "required",
              create_number_of_trips: "required",
              select_procedure: "required",
            }
          })
  
          $('#confirm_trip_btn').on('click' , function(){
            $("#signupForm").submit();
          })
          
          $('#cancel_trip_btn').on('click' , function(){
            location.reload();
          })
          $('#create_number_of_trips, #selected_services').on('change', function() {
            $('#promo_id').val("")
            $('#promoAppliedText').hide();
            $('#promoApplyButton').show();
          });

          $('#send_request_form').submit(function (e) {
              e.preventDefault();
  
              if($('#provider_type1').val() == 1){
                $('#select_provider1').val('');
              }
              $.ajax({
                  type: 'POST',
                  url: '/send_request',
                  data: $("#send_request_form").serialize(),
                  dataType: "json",
                  success: function (response) {
                      if (response.success == false)
                      {
                          show_trip_data($('#send_trip_id').val(), 'accepted_request');
                          if (trip_response.error_code == 464)
                          {
                              trip_error("<%= __('error_payment_is_pending') %>")
                          }
                          else
                          {
                              trip_error("<%= __('error_provider_not_found') %>")
                          }
                      } else {
                          location.reload();
                      }
                  }
              });
          })
  
          $('#date').datepicker({
              format: 'yyyy-mm-dd',
              startDate: new Date(Date.now())
          }).on("input change", function (e) {
  
              $('.datepicker-dropdown').hide()
          });
  
          $('#time').timepicker({
              format: 'hh-ii-ss',
              showSeconds: true,
              showMeridian: false,
              minuteStep: 5,
              secondStep: 5
          });
      });
      $('#scheduled_trip_btn').on('click' , function(){
          if($('#server_time').val() && $('#timezone').val()){
            var now = $('#server_time').val();
            var new_time = new Date(now).toLocaleString("en-US", {timeZone: $('#timezone').val()})
            new_time = new Date(new_time)
            new_time = new_time.getTime() + (<%= scheduled_request_pre_start_minute %>*60000);
            new_time = new Date(new_time)
            $('#date').datepicker("setStartDate", new_time );
  
            $("#date").datepicker().datepicker("setDate", new_time);
  
            $('#time').timepicker('setTime', new_time);
  
            $('#ridelater_modal').modal('show');
            $("html, body").animate({ scrollTop: 0 }, "slow");
          }
      })
  
      $('#ride_laters').click(function(){
          if($('#date').val()=="" || $('#time').val() ==""){
              $('#date_time_error').text("<%= __('title_select_data_time') %>")
          }else{
  
              $.ajax({
                  type       : 'POST', // define the type of HTTP verb we want to use (POST for our form)
                  url         : '/get_server_time', /// the url where we want to POST
                  data        : {}, // our data object
                  datatype    :"json",
                  success:function(response){
                      var now = response.server_date;
                      var now1 = new Date(now).toLocaleString("en-US", {timeZone: $('#timezone').val()})
                      now1 = new Date(now1)
  
                      var time = $('#time').val()
                      time = time.split(':');
                      var date_time = $('#date').val()
  
                      date_time = date_time.split('-');
  
  
                      var new_date_time1 = new Date(Date.now())
                      var new_date_time = new Date(new_date_time1).toLocaleString("en-US", {timeZone: $('#timezone').val()})
                      new_date_time = new Date(new_date_time)
                      new_date_time.setDate(date_time[2])
                      new_date_time.setMonth(date_time[1]-1)
                      new_date_time.setYear(date_time[0])
                      new_date_time.setHours(time[0])
                      new_date_time.setMinutes(time[1])
                      new_date_time.setSeconds(time[2])
  
                      var cur_date = new Date();
                      if (new_date_time.getTime() < cur_date.getTime()) {
                        $('#date_time_error').text("<%= __('title_select_prpper_time') %>")
                        return;
                      }
  
                      var timeDiff = Math.round(new_date_time.getTime() - now1.getTime());
  
                      var week_day = new_date_time.getDay();
                      var is_surge_hours = 0;
                      var multiplier = 1;
  
                      // if(selected_surge_time[week_day].is_surge){
                      //   var current_date = new_date_time;
                      //   current_date = new Date(current_date).toLocaleString("en-US", {timeZone: $('#timezone').val()})
                      //   current_date = new Date(current_date)
  
                      //   selected_surge_time[week_day].day_time.forEach(function(day_time){
                      //     var day_time_multiplier = day_time.multiplier;
                      //     var start_time = day_time.start_time;
                      //     var end_time = day_time.end_time;
                      //     start_time = start_time.split(':');
                      //     end_time = end_time.split(':');
                      //     var start_date_time = current_date.setHours(start_time[0], start_time[1], 0, 0);
                      //     start_date_time = new Date(start_date_time);
                      //     var end_date_time = current_date.setHours(end_time[0], end_time[1], 0, 0);
                      //     end_date_time = new Date(end_date_time);
                      //     if(new_date_time.getTime() > start_date_time.getTime() && new_date_time.getTime() < end_date_time.getTime()){
                      //       is_surge_hours = 1;
                      //       multiplier = day_time_multiplier;
                      //     }
                      //   })
                      // }
  
                      document.getElementById('is_surge_hours').value = is_surge_hours;
                      document.getElementById('surge_multiplier').value = multiplier;
  
                      if(timeDiff/60000 >= <%= scheduled_request_pre_start_minute %>)
                      {
                          $('#ridelater_modal').modal('hide');
                          $('#date_time_error').text("");
                          $('#is_ride_later').val(1);
                          $('#start_time').val(timeDiff);
                          // $('#ridenow').click();
                          $("#signupForm").submit();
                      }
                      else
                      {
                          $('#date_time_error').text("<%= __('title_select_prpper_time') %>");
                      }
                  }
              });
  
          }
      });
      $('#create_new_req_btn').click(function(){
        $(".select_old_new_req").hide();
        $(".vehicle_selection").show();
        // $(".set_location").show();
        $(".forward_backward_btn").show();
        page_num = 1
      })
  
      $('#next_btn').click(function(){
        if(page_num == 1){
          if($('#vehicle_selection_form').valid()){
            $('#selected_service_type_id').val($('#service_type_id').val())
            $('#selected_capacity_id').val($('#selected_capacity').val())
            $('#selected_model_id').val($('#selected_model').val())
            $('#selected_service_id').val($('#selected_services').val())
            $('#promo_serviceid').val($('#selected_services').val())
            $('#number_of_trips').val($('#create_number_of_trips').val())
            $('#selected_procedure').val($('#select_procedure').val())
            $('#selected_transit_service').val($('#select_transit_service').val())
            $('#selected_transit_type_number').val($('#select_type_number').val())
            $(".vehicle_selection").hide();
            $(".set_location").show();
            page_num = 2
          }

        }else if(page_num == 2){
            var form_data = $("#signupForm").serializeJSON();
            let destination_addresses = form_data.destination_addresses || [];
            let d_stop_lat = form_data.d_stop_lat || [];
            let d_stop_lng = form_data.d_stop_lng || [];

            let errores = [];

            for (let i = 0; i < destination_addresses.length; i++) {
              if (
                !destination_addresses[i] || destination_addresses[i].trim() === "" ||
                !d_stop_lat[i] || d_stop_lat[i].trim() === "" ||
                !d_stop_lng[i] || d_stop_lng[i].trim() === ""
              ) {
                errores.push(i + 1);
              }
            }

            if (errores.length > 0) {
              alert(`  Destino o Paradas sin direccin asignada`);
              return;
            }

          if(
            (
              $("#courier_type").val() == 0 && 
              $('#pickup').val() !== "" && 
              $('#destination').val() !== ""
            ) || 
            (
              $("#courier_type").val() == "<%= constant_json.COURIER_CISTERNA_FLOW %>" &&
              $('#destination').val() !== ""
            ) ||  
            (
              $("#courier_type").val() == "<%= constant_json.COURIER_ESCOMBRO_FLOW %>" &&
               $('#pickup').val() !== ""
            ) 
          ){
            var form_data = $("#signupForm").serializeJSON()
            let destination_addresses = [];
            let d_stop_lat = [];
            let d_stop_lng = [];
            if (form_data.destination_addresses) {
              destination_addresses = form_data.destination_addresses
              d_stop_lat = form_data.d_stop_lat
              d_stop_lng = form_data.d_stop_lng
            }
            let inside_city_stops_list = []
            
            $('#pickup_address').val($('#pickup').val())
            $('#destination_address').val($('#destination').val())
            $(".set_location").hide();
            $(".pick_dest_details").show();

            let origin = $("#pickup").val();
            let destination = $("#destination").val();

            if(origin && destination) {
                var latitude = $('#lat').val();
                var longitude = $('#lng').val();
                var dest_latitude = $('#dlat').val();
                var dest_longitude = $('#dlng').val();

              $.ajax({
                type: 'POST',
                url: '/need-ferry',
                headers: {
                    "Authorization": `Bearer <%= corporates.token %>`,
                },
                data: {
                  "origin": {
                    "latitude":  latitude,
                    "longitude": longitude
                  },
                  "destination": {
                      "latitude":  dest_latitude,
                      "longitude": dest_longitude
                  }
                },
                dataType: "json",
                success: function(response) {
                  if(response.success) {
                    if(response.isMargarita && response.needFerry) {
                      $("#show_boat_ticket").show();
                      margarita = true;
                    } else {
                      $("#show_boat_ticket").hide();
                      margarita = false;
                    }
                  }
                },
                error: function(err) {
                  console.log(err);
                }
              });
            }
  
            page_num = 3
           }
  
        }else if(page_num == 3){     
            let ticketBoatSelection = $('input[name=ticket_boat]:radio:checked');
            let boatCheck = ticketBoatSelection.val();

            if(!boatCheck && margarita) {
              createToast("<%= __('title_boat_ticket_required') %>");
              return
            }

            if(
              $("#pickup_description").val() === "" && $("#model_type").val() != '<%= MODEL_TRUCK_TYPE.VOLTEO %>' && $("#model_type").val() != '<%= MODEL_TRUCK_TYPE.CISTERNA %>') {
              createToast("<%= __('title_pickup_description_required') %>");
              return
            }

            if($("#pickup_weight_of_load").val() === "" && $("#model_type").val() != '<%= MODEL_TRUCK_TYPE.VOLTEO %>' && $("#model_type").val() != '<%= MODEL_TRUCK_TYPE.CISTERNA %>') {
              createToast("<%= __('title_pickup_weight_required') %>");
              return
            }

          if($('#pick_dest_details_form').valid()){
            if(pickup_marker){
              pickup_marker.setDraggable(false);
  
            }
            if(destination_marker){
              destination_marker.setDraggable(false);
            }
  
            get_fare_estimate();
          }
        }
  
      })
      //heresum
      function seeMoreLess(){
        if($("#textButton").hasClass("see_more")){
          
          $('#textButton').addClass('see_less').removeClass('see_more');
          $("#summary_stops_see").css('height', "auto");
        }else{
          if($("#textButton").hasClass("see_less"))
        
          $('#textButton').addClass('see_more').removeClass('see_less');
          $("#summary_stops_see").css('height', '130px');
        }
      }

      function fill_order_summary(){
        var form_data = $("#signupForm").serializeJSON()
        let destination_stops = 0;

        let number_of_helpers_load = $('#select_helpers_for_load').val() 
                ? $('#select_helpers_for_load').val() : 0;
        let number_of_helpers_download = $('#select_helpers_for_download').val() 
                ? $('#select_helpers_for_download').val() : 0;

        // order_stops = Number(form_data.total_stops_inside_city)
        if(form_data.destination_addresses){
           $('.stop_addresses').empty()
          let all_stops = form_data.internal_stop_addresses.map(str => {
            if (str === "") {
              return [];
            } else {
              return JSON.parse(str);
            }
          });
          let list_stops = JSON.parse($('#stops_data').val());
          let addresremove = $('#destination').val();
          let stop_address = ""
          list_stops.forEach((element, index) => {
            let stop = all_stops[index].length

            if(addresremove!==list_stops[index].address){
            stop_address = '<div class="row" style="text-align: left; color: #250e62; margin-bottom: 10px;margin-left:15px !important; font-weight: bold;"><%= __("title_stop") %> '+(Number(index)+1)+
              '</div><div class="row" style="margin-left:15px;">'+
               '<div class="col-md-12" style="text-align: left;">'+
                '<div class="values-summary" style="text-align: left; padding-left:0px">'+list_stops[index].address+'</div>'+
                '</div>';
            $('.stop_addresses').append(stop_address);
               }
          })
          if(stop_address===""){
            $('.stop_addresses').empty()
  
            $('.stop_addresses').append('<div class="row" style="text-align: center; color: rgb(0 191 179);"><%= __('title_no_stops_between_cities') %></div>')
          }
        }else{
          $('.stop_addresses').empty()
  
          $('.stop_addresses').append('<div class="row" style="text-align: center; color: rgb(0 191 179);"><%= __('title_no_stops_between_cities') %></div>')
        }
  
  
        $('#order_stops').text(destination_stops)
        $('#order_helpers_load').text(number_of_helpers_load)
        $('#order_helpers_download').text(number_of_helpers_download)
        
        $('#order_pickup_address').text($('#pickup_address').val())
        $('#order_pickup_description').text($('#pickup_description').val())
        $('#order_pickup_name').text($('#pickup_username').val())
        $('#order_pickup_phone').text("<%= country_phone_code %>"+$('#pickup_phone').val())
        $('#order_delivery_address').text($('#destination_address').val())
        $('#order_delivery_description').text($('#delivery_description').val())
  
  
        let service_type_id = $('#selected_service_type_id').val()
  
        let type_index = types.findIndex((x)=>x._id.toString() == service_type_id.toString());
        if(type_index != -1){
          let service_type_details = types[type_index]
          let service_type_name = service_type_details.typename
  
          let capacity_id  = $('#selected_capacity').val()
          let service_id = $('#selected_services').val()
          let model_id = $('#selected_model').val()
  
          let capacity_index = service_type_details.type_capacity_details.findIndex((x)=>x._id == capacity_id);
          let model_index = service_type_details.type_model_details.findIndex((x)=>x._id == model_id);
          
          let capacity_name = "" 
          let model_name = ""
          let service_name = ""
          
          if(capacity_index != -1){
            capacity_name = service_type_details.type_capacity_details[capacity_index].capacity_name
          }
          if(model_index != -1){
            model_name = service_type_details.type_model_details[model_index].model_name
            let service_index = service_type_details.type_model_details[model_index].type_service_details.findIndex((x)=>x._id == service_id);
            if(service_index != -1){
              service_name = service_type_details.type_model_details[model_index].type_service_details[service_index].service_name
            }
          }
  
          $('#order_truck_type').text(service_type_name)
          $('#order_truck_size').text(capacity_name)
          $('#order_truck_model').text(model_name)
          $('#order_truck_service').text(service_name)
        }
        document.getElementById("defaultOpen").click();
        let elem = document.getElementsByClassName("new_req_info")[0];
        elem.style.padding = "0px 0px"
      }
      
      function upload_trip_images(trip_id){
        const imageInput = $('#load_images')[0]; 
        const images = imageInput.files;
        const formData = new FormData();
        const user_id = $('#user_id').val()
        for (var i = 0; i < images.length; i++) {
          formData.append('images[]', images[i]);
        }        
        formData.append('trip_id', trip_id);
        formData.append('user_id', user_id);
        formData.append('user_type', '<%= constant_json.CORPORATE_UNIQUE_NUMBER %>');
        $.ajax({
            type       : 'POST', 
            url         : '/upload_trip_images',
            data        : formData, 
            contentType: false,
            processData: false,
            success:function(response){
            }
        });
      }
      
      $('#main_back_btn').click(function(){
        $(".order_summary").hide();
        $(".pick_dest_details").show();
        $(".forward_backward_btn").show();
        let elem = document.getElementsByClassName("new_req_info")[0];
        elem.style.padding = "0 20px"
        if(pickup_marker){
          pickup_marker.setDraggable(true);
        }
        if(destination_marker){
          destination_marker.setDraggable(true);
        }
        page_num = 3
      })
        $('#back_btn').click(function(){
        if(page_num == 1){
          $(".select_old_new_req").show();
          $(".vehicle_selection").hide();
          // $(".set_location").hide();
          $(".forward_backward_btn").hide();
          page_num = 0
        }else if(page_num == 2){
          $(".set_location").hide();
          $(".vehicle_selection").show();
          // $(".set_location").show();
          // $(".vehicle_selection").hide();
          page_num = 1
        }else if(page_num == 3){
          $(".set_location").show();
          // $(".vehicle_selection").show();
          $(".pick_dest_details").hide();

          page_num = 2
        }else if(page_num == 4){
          $(".order_summary").hide();
          $(".pick_dest_details").show();
          $(".forward_backward_btn").show();
          $("#next_btn").show();
          page_num = 3
        }
      })
  
  
      function trip_error(message){
          $('#request_error').show();
          $('#request_message').text(message);
          setTimeout(function () {
              $('#request_error').hide();
          }, 3000);
      }
      function isNumberKeyOnly(evt){
          var charCode = (evt.which) ? evt.which : event.keyCode
          if (charCode > 31 && (charCode < 48 || charCode > 57))
          {
              return false;
          }
          return true;
      }
  
      $(document).ready(function(){
          get_trips();
          interval = setInterval(function () {
              get_trips();
          },5000);
          // go_to_mapview();
          $('#provider_type_filter').change(function () {
              // get_all_provider();
          })
      });
  
      function get_trips() {
          $.ajax({
              type: 'POST',
              url: '/dispatcher_new_request',
              data: {dispatcher_id: '<%= corporates._id %>'},
              dataType: "json",
              success: function (response) {
                  $('#new_request').empty();
                  $('#accepted_request').empty();
                  $('#started_request').empty();
                  $('#arrived_request').empty();
                  request_list = response.request_list;
                  started_request_list = response.started_request_list;
                  accepted_request_list = response.accepted_request_list;
                  arrived_request_list = response.arrived_request_list;
  
                  response.accepted_request_list.forEach(function (request) {
                      $('#accepted_request').append('<a class="content_in" id="trip' + request._id + '"><div class="details blue clr" onclick="show_trip_data(\'' + request._id + '\',\'' + 'accepted_request' + '\')">' +
                          '<div class="name"><h6>' + request.unique_id + '</h6><span id="status' + request._id + '"></span></div>\n' +
                          '               <div class="time"><%= __('title_pick_up_at') %><br />' + moment(request.is_schedule_trip ? request.server_start_time_for_schedule : request.created_at).format("DD MMM 'YY hh:mm:a") + '</div>\n' +
                          '                <div class="req_btn"><span onclick="cancel_trip(\'' + request._id + '\',\'' + request.user_id + '\')"><i class="fa fa-close"></i></span></div>\n' +
                          '              </div>\n' +
                          '            </a>');
                      if(request.is_provider_status == 2){
                          $('#status'+request._id).text(request?.provider_detail?.first_name+ ' ' +request?.provider_detail?.last_name+ ' <%= __('title_start_for_pickup') %>');
                      } else {
                          $('#status'+request._id).text(request?.provider_detail?.first_name+ ' ' +request?.provider_detail?.last_name+ ' <%= __('title_accepted_request') %>');
                      }
                  });
                  response.arrived_request_list.forEach(function (request) {
                      $('#arrived_request').append('<a class="content_in" id="trip' + request._id + '"><div class="details blue clr" onclick="show_trip_data(\'' + request._id + '\',\'' + 'arrived_request' + '\')">' +
                          '<div class="name"><h6>' + request.unique_id + '</h6><span id="status' + request._id + '"></span></div>\n' +
                          '               <div class="time"><%= __('title_pick_up_at') %><br />' + moment(request.is_schedule_trip ? request.server_start_time_for_schedule : request.created_at).format("DD MMM 'YY hh:mm:a") + '</div>\n' +
                          '                <div class="req_btn"><span onclick="cancel_trip(\'' + request._id + '\',\'' + request.user_id + '\')"><i class="fa fa-close"></i></span></div>\n' +
                          '              </div>\n' +
                          '            </a>');
  
                      $('#status'+request._id).text(request?.provider_detail?.first_name+ ' ' +request?.provider_detail?.last_name+ ' <%= __('title_trip_status_arrived') %>');
  
                  });
  
                  response.started_request_list.forEach(function (request) {
                      $('#started_request').append('<a class="content_in" id="trip' + request._id + '"><div class="details blue clr" onclick="show_trip_data(\'' + request._id + '\',\'' + 'started_request' + '\')">' +
                          '<div class="name" style="width: unset;"><h6>' + request.unique_id + '</h6><span id="status' + request._id + '"></span></div>\n' +
                          '              </div>\n' +
                          '            </a>');
                      $('#status'+request._id).text(request?.provider_detail?.first_name+ ' ' +request?.provider_detail?.last_name+ ' <%= __('title_trip_status_trip_started') %>');
                  });
  
                  response.request_list.forEach(function (request) {
                      if(request.is_provider_accepted == 2) {
                          var time_left_to_responds_trip = request.time_left_to_responds_trip;
                          if(time_left_to_responds_trip >0) {
                            let status_string = "<%= __('title_trip_status_waiting') %></div>"
                            if(request.assigned_provider_id){
                              status_string = "<%= __('title_trip_status_waiting_to_start_journey') %></div>"
                            }
                              $('#new_request').append('<a class="content_in" id="trip' + request._id + '"><div class="details blue clr" onclick="show_trip_data(\'' + request._id + '\',\'' + 'request' + '\')">' +
                                  '<div class="name"><h6>' + request.unique_id + '</h6>'+status_string+'\n' +
                                  '               <div class="time"><%= __('title_pick_up_at') %><br />' + moment(request.is_schedule_trip ? request.server_start_time_for_schedule : request.created_at).format("DD MMM 'YY hh:mm:a") + '</div>\n' +
                                  '                 <div class="req_btn"><span onclick="cancel_trip(\'' + request._id + '\',\'' + request.user_id + '\')"><i class="fa fa-close"></i></span></div>\n' +
                                  '               <div class="time_loader"><div class="green"  id="' + request._id + '">' + request.time_left_to_responds_trip + 'sec</div></div>' +
                                  '              </div>\n' +
                                  '            </a>');
  
                              var count = 1;
                              var count_interval = setInterval(function () {
                                  if (time_left_to_responds_trip - count <= 0) {
                                      $('#trip' + request._id).hide();
                                  }
                                  $('#' + request._id).text(time_left_to_responds_trip - count + 'sec');
                                  count++;
                                  if (count == 5) {
                                      clearInterval(count_interval);
                                  }
                              }, 1000);
                          }
                      } else {
                        let status_string = "<%= __('title_trip_status_waiting') %></div>"
                            if(request.assigned_provider_id){
                              status_string = "<%= __('title_trip_status_waiting_to_start_journey') %></div>"
                            }
  
                          $('#new_request').append('<a class="content_in"><div class="details red clr" onclick="show_trip_data(\'' + request._id + '\',\'' + 'request' + '\')">' +
                              '<div class="name"><h6>' + request.unique_id + '</h6>'+status_string+'\n' +
                              '               <div class="time"><%= __('title_pick_up_at') %><br />'+moment(request.is_schedule_trip ? request.server_start_time_for_schedule : request.created_at).format("DD MMM 'YY hh:mm:a")+'</div>\n' +
                              '               <div class="req_btn"><span onclick="cancel_trip(\'' + request._id + '\',\'' + request.user_id + '\')"><i class="fa fa-close"></i></span></div>\n' +
                              '              </div>\n' +
                              '            </a>');
                      }
                  })
              }
          });
      }
      
      $('#repeat_order_btn').click(function(){
        window.location.href="corporate_history";
      })

      $('#bulk_orders_btn').click(function(){
        window.location.href="corporate_bulk_trips";
      })

      function open_promo_modal() {
        const user_list = <%-JSON.stringify(user_list)%>
        const selectedUser = $('#select_user').val()
        const user = user_list.find(u => u._id === selectedUser);
        const token = user.token
        const countryId = '<%= corporates.country_id %>'
        const cityId = $('#city_id').val()
        $("#promo_user_id").val(selectedUser)
        $("#promo_token").val(token)
        $("#promo_country_id").val(countryId)
        $('#promo_city_id').val(cityId)
        $('#promo_trips').val( $('#create_number_of_trips').val())
        $('#promoCodeModal').modal('show');
      }
      
      var $form = $('#promoCodeForm');
      $form.submit(function(event) {
        event.preventDefault();
        let code = $('#promocode').val()

        if(code == ""){
          return;
        }
        $.ajax({
          type: 'POST',
          url: '/apply_promo_code',
          data: $('#promoCodeForm').serialize(),
          dataType: "json",
          success: function(res) {
            if (res.success) {  
              $('#promo_id').val(res.promo_id)
              get_fare_estimate()
              $('#promoAppliedText').show();
              $('#promoApplyButton').hide();
              $('#promoCodeModal').modal('hide');

            }else{
              if(res.error_code == "<%= error_message.ERROR_CODE_PROMOTIONAL_CODE_ALREADY_USED %>"){
                $('#promo_message').text('Cdigo promocional ya utilizado!');
              }else if(res.error_code == "<%= error_message.ERROR_CODE_PROMO_CODE_SELECTED_SERVICE_NOT_VALID %>"){
                $('#promo_message').text("<%= __('error_message_service_not_valid_for_promocode') %>");
              }else{
                $('#promo_message').text('Cdigo de promocin no vlido!');
              }
              $('#promo_message').show();
              setTimeout(function() {
                $('#promo_message').hide();
              }, 3000);
            }
          }
        });
      });
      $("#promoCodeForm").validate({
        rules: {
          promocode: "required",
        }
      });
      $("#pick_dest_details_form").validate({
              rules: {
                pickup_weight_of_load: "required",
              pickup_description: "required"
              }
            })


      function cancel_trip(trip_id, user_id) {
        if (!window.confirm("<%= __('confirm_delete_trip_message')%>")) {
          return false;
            }
            $("#cancellationReasonForm").trigger("reset");
            $('#cancellation_user_id').val(user_id); 
            $('#cancellation_user_token').val(token); 
            $('#cancellation_trip_id').val(trip_id); 
            $('#cancellationReasonModal').modal('show');
          }
          $("#cancellationReasonForm").validate({
        rules: {
          cancel_reason: "required",
        }
      });

      var $form = $('#cancellationReasonForm');
      $form.submit(function(event) {
        event.preventDefault();
        let reason = $('#cancellation_reason').val()

        if(reason == ""){
          return;
        }
        $('#cancellationReasonForm input[type="submit"]').attr('disabled','disabled');         
        $.ajax({
          type: 'POST',
          url: '/canceltrip',
          data: $('#cancellationReasonForm').serialize(),
          dataType: "json",
          success: function(res) {
            if (res.success) {  
              $('#cancellationReasonModal').modal('hide');
              location.reload();
            }
          }
        });
      });

      function new_request_creat(a = null) {
          clearInterval(show_provider_info_interval);
          $('.get_provider_info').hide();
          clearInterval(all_provider_interval);
          for (var i = 0; i < all_provider_marker.length; i++) {
              all_provider_marker[i].setMap(null);
          }
          all_provider_marker = [];
          if(a){
            initialize();
          }
          $('#lat').val('');
          $('#lng').val('');
          $('#dlat').val('');
          $('#dlng').val('');
          $('#src_lat_lng').val('');
          $('#dest_lat_lng').val('');
          $('#pickup').val('');
          $('#destination').val('');
          $('#service_type_id').val('');
          $('#first_name').val('');
          $('#last_name').val('');
          $('#email').val('');
          $('#phone').val('');
          $('#provider_full_name').val('');
          $('#provider_phone').val('');
          $('#min_fare_div').hide();
  
          $('#select_user').val('Select User')
          $('#select_user').selectpicker('refresh');
  
          $('#provider_type').val(1)
          provider_array = [];
  
          for (var i = 0; i < provider_markers.length; i++) {
              provider_markers[i].setMap(null);
          }
          provider_markers = [];
          $('#provider_filter').hide();
          $('#provider_search_button').hide();
          $('#new_request_div').hide();
          $('#mapview_div').show();
          $('.pickup_info').hide();
          $('.no_provider_found_div').hide();
          if(pickup_marker){
            pickup_marker.setOptions({draggable: false});
          }
      }
  
      function show_trip_data(request_id, type){
          $('#provider_search_button').hide();
          $('#provider_filter').hide();
          clearInterval(show_provider_info_interval);
          $('.get_provider_info').hide();
          for (var i = 0; i < all_provider_marker.length; i++) {
              all_provider_marker[i].setMap(null);
          }
          all_provider_marker = [];
          clearInterval(all_provider_interval);
  
          provider_array = [];
          for (var i = 0; i < provider_markers.length; i++) {
              provider_markers[i].setMap(null);
          }
          provider_markers = [];
  
          var index;
          var request_data;
          if(type == 'started_request'){
              index = started_request_list.findIndex((x)=>x._id == request_id);
              request_data = started_request_list[index];
              $('.no_provider_found_div').hide();
          } else if(type == 'accepted_request'){
              index = accepted_request_list.findIndex((x)=>x._id == request_id);
              request_data = accepted_request_list[index];
              $('.no_provider_found_div').hide();
          } else {
              index = request_list.findIndex((x)=>x._id == request_id);
              request_data = request_list[index];
              if(request_list[index].is_provider_accepted == 3){
                  $('.no_provider_found_div').show();
                  // get_near_by_driver_running_request(request_data.service_type_id, request_data.sourceLocation[0], request_data.sourceLocation[1])
                  $('#send_trip_id').val(request_list[index]._id);
              } 
              else {
                  $('.no_provider_found_div').hide();
              }
          }
          if(request_data.provider_detail){
              $('#show_provider_name').text(request_data.provider_detail.first_name+ ' ' +request_data.provider_detail.last_name);
              if(request_data?.assigned_vehicle_details?.vehicle_plate_no){
                    $('#show_plate_no').text(request_data?.assigned_vehicle_details?.vehicle_plate_no) 
              }
              $('#show_provider_phone').text(request_data.provider_detail.phone);
              var sourceLocation = new google.maps.LatLng(request_data.provider_detail.providerLocation[0], request_data.provider_detail.providerLocation[1]);
              var marker = new google.maps.Marker({
                map: map,
                icon: {
                  url: iconBase + 'FLETY_ICONO_350_450_oriente.svg',
                  scaledSize: new google.maps.Size(30, 30) // Adjust the size as per your requirement
                },
                position: sourceLocation,
                draggable:false
              });

              provider_markers.push(marker)
          } else {
              $('#show_provider_name').text('');
              $('#show_provider_phone').text('');
          }
          if(request_data.user_detail){
              $('#show_user_name').text(request_data.user_detail.first_name+ ' ' +request_data.user_detail.last_name);
              $('#show_user_phone').text(request_data.user_detail.phone);
          } else {
              $('#show_user_name').text('');
              $('#show_user_phone').text('');
          }
          $('#show_unique_id').text(request_data.unique_id);
          $('#show_source_address').text(request_data.source_address);
          $('#show_destination_address').text(request_data.destination_address);
          $('#show_trip_type').text(request_data.typename);
          if(request_data.model_details){
            $('#show_truck_type').text(request_data.model_details.model_name);        
          } 
          $('#show_created_date').text(moment(request_data.is_schedule_trip ? request_data.server_start_time_for_schedule : request_data.created_at).format("DD MMM 'YY hh:mm:a"))
          $('.pickup_info').show();
          $('.new_req_info').hide();
          $('.main_page .map_div').addClass('map_height');
  
          pickup_marker.setMap(null);
  
          if(destination_marker){
              destination_marker.setMap(null);
              destination_marker = undefined;
          }
  
          if(directionsDisplay){
              directionsDisplay.setMap(null);
          }
  
          var sourceLocation = new google.maps.LatLng(request_data.sourceLocation[0], request_data.sourceLocation[1]);
          pickup_marker = new google.maps.Marker({
            map: map,
            icon: {
              url: iconBase + 'FLETY_ICONO_SALIDA.svg',
              scaledSize: new google.maps.Size(45, 45) // Adjust the size as per your requirement
            },
            position: sourceLocation,
            draggable:true
          });

          var destinationLocation = new google.maps.LatLng(request_data.destinationLocation[0], request_data.destinationLocation[1]);
          destination_marker = new google.maps.Marker({
            map: map,
            icon: {
              url: iconBase + 'FLETY_ICONO_LLEGADA.svg',
              scaledSize: new google.maps.Size(45, 45) // Adjust the size as per your requirement
            },
            position: destinationLocation,
            draggable:true
          });

          var bounds = new google.maps.LatLngBounds();
          bounds.extend(sourceLocation);
          bounds.extend(destinationLocation);
          map.fitBounds(bounds);
          $('#new_request_div').show();
          $('#mapview_div').show();
          $('#add_stop_message').hide();
          $('#add_internal_stop_message').hide();
      }
  
      function go_to_mapview() {
          $('#loading').show();
          $('#new_request_div').show();
          $('#mapview_div').hide();
          $('#dest_stops_lat_lng_div').empty();
          $('#dest_stops_location_div').empty();
          $('#multiple_stops').empty();
          $('#internal_stops').empty();
          $('#add_stop_message').hide();
          $('#add_internal_stop_message').hide();
          $('#provider_filter').show();
          $('#provider_search_button').show();
          $('.new_req_info').hide();
          $('.pickup_info').hide();
          $('.no_provider_found_div').hide();
          $('.map_div').removeClass('map_height');
          clearInterval(all_provider_interval);
  
          // get_all_provider();
          all_provider_interval = setInterval(function () {
              // get_all_provider();
          },5000);
          if(destination_marker){
              destination_marker.setMap(null);
              destination_marker = undefined;
          }
          if(directionsDisplay)
          {
              directionsDisplay.setMap(null);
          }
          for (var i = 0; i < provider_markers.length; i++) {
              provider_markers[i].setMap(null);
          }
          provider_markers = [];
          if(pickup_marker){
              navigator.geolocation.getCurrentPosition(function(position) {
                  var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                  pickup_marker.setPosition(initialLocation);
              });
              pickup_marker.setOptions({draggable: false});
          }
          show_truck_loc()
      }
  
      function get_all_service_type() {
          var latitude = $('#current_latitude').val();
          var longitude = $('#current_longitude').val();
          let id = $('#user_type_id').val();
  
          $.ajax({
              type: 'POST',
              url: '/typelist_for_dispatcher',
              data: {'subAdminCountry': '<%= country %>', 'latitude': latitude, 'longitude': longitude, 'id':id},
              dataType: "json",
              success: function (response) {
                  $("#current_location_service_type_id").empty();
                  $("#current_location_service_type_id").append("<option value='' selected><%=__('title_all')%></option>");
                  if(response.success){
                      response.citytypes.forEach(function (city_type) {
                          var service_type_name = city_type.type_details.typename;
                          var service_type_id = city_type._id;
                          $("#current_location_service_type_id").append("<option value="+service_type_id + ">"+ service_type_name+ "</option>");
                      });
                  } else {
  
                  }
                  $('#current_location_service_type_id').selectpicker('refresh');
              }
          });
      }
      function trip_success(){
        $(".order_summary").hide();
        $(".trip_success_page").show();
          setTimeout(function () {
              location.reload();
          }, 10000);
      }
      function removeSelectedServicesValidation() {
        $("#vehicle_selection_form").validate().settings.rules.selected_services_id = {};
        $('.select_model_hide').hide()
        $('.select_services_hide').hide()
        $('.selection_row3_hide').hide()
      }

      function courierFlow() {
        $("#vehicle_selection_form").validate().settings.rules.selected_services_id = "required";
        $("#vehicle_selection_form").validate().settings.rules.selected_capacity_id = "required";
        removeSelectedTruckTypeValidation()
        $("#courier_type").val("<%= constant_json.COURIER_CISTERNA_FLOW %>")
        $('.select_model_hide').show()
        $('.select_services_hide').show()
        $('.selection_row3_hide').show()
        $(".destination_field").show()
        $(".pickup_field").show()
        $(".addstop").show()
        $(".weight_load").show()
        $(".volume_load").show()
        $(".night_shift").show()
      }

      function cisternaModelChanges() {
        $("#vehicle_selection_form").validate().settings.rules.selected_services_id = {};
        $("#courier_type").val("<%= constant_json.COURIER_CISTERNA_FLOW %>")
        $(".destination_field").show()
        $('.select_model_hide').hide()
        $('.select_services_hide').hide()
        $('.selection_row3_hide').hide()
        $(".pickup_field").hide()
        $(".addstop").hide()
        $(".weight_load").hide()
        $(".volume_load").hide()
      }
      function volteoModelChanges() {
        $(".night_shift").hide()
      }
      function cisternaFlow() {
        $(".destination_field").show()
        $(".pickup_field").hide()                      
        $(".addstop").hide()
      }

      function escombroFlow() {
        $(".destination_field").hide()
        $(".pickup_field").show()
        $(".addstop").hide()
      }

      function removeSelectedCapacityValidation() {
        $("#vehicle_selection_form").validate().settings.rules.selected_capacity_id = {};
      }

      function addSelectedTruckTypeValidation() {
        $("#vehicle_selection_form").validate().settings.rules.selected_model_id = "required";
      }

      function removeSelectedTruckTypeValidation() {
        $("#vehicle_selection_form").validate().settings.rules.selected_model_id = {};
      }
      function capacitiesAppend(type_detail, model_name) {
        const model_type = type_detail?.model_type
        const capacites = type_detail.type_capacity_details

        $('#selected_capacity').empty();
        $("#selected_capacity").append("<option selected disabled hidden style='display: none'><%= __('title_select_capacity') %></option>");

        for(let i=0; i < capacites.length; i ++){
          const capacity_name = capacites[i].capacity_name;
          if((model_type == "<%= MODEL_TRUCK_TYPE.TORONTO %>" && capacity_name == "7.500") ||
            ((model_name == "TORONTO - Cava de Fibra" || model_name == "TORONTO - Refrigerado/Congelado") && (capacity_name == "7.500" || capacity_name == "14.000" | capacity_name == "18.000"))
          ){
            continue;
          }
          const capacity_id = capacites[i]._id;
          const unit = capacites[i].unit;
          let capacity_unit = ""
          if(unit == 0 ){capacity_unit = 'Kilos' }else if(unit == 1){capacity_unit =  'Litre' }else if(unit == 2){capacity_unit = 'm3' }
          $("#selected_capacity").append("<option  value="+ capacity_id +">"+capacity_name+" "+capacity_unit+ "</option>");
        }
        $('#selected_capacity').selectpicker('refresh');
      }


      function provider_filter(type) {
          if($('#tag_button'+type).hasClass('selected_tag_button')){
              var index = selected_filter_type.indexOf(type)
              selected_filter_type.splice(index, 1)
              $('#tag_button'+type).removeClass('selected_tag_button')
          } else {
              selected_filter_type.push(type)
              $('#tag_button'+type).addClass('selected_tag_button')
          }
          if(type == 1){
            if($('#tag_button1').hasClass('selected_tag_button')){
              if($('#tag_button2').hasClass('selected_tag_button')){
                var index = selected_filter_type.indexOf(2)
                selected_filter_type.splice(index, 1)
                $('#tag_button'+2).removeClass('selected_tag_button')
              }
              if($('#tag_button3').hasClass('selected_tag_button')){
                var index = selected_filter_type.indexOf(3)
                selected_filter_type.splice(index, 1)
                $('#tag_button'+3).removeClass('selected_tag_button')
              }
              if($('#tag_button4').hasClass('selected_tag_button')){
                var index = selected_filter_type.indexOf(4)
                selected_filter_type.splice(index, 1)
                $('#tag_button'+4).removeClass('selected_tag_button')
              }
              if($('#tag_button5').hasClass('selected_tag_button')){
                var index = selected_filter_type.indexOf(5)
                selected_filter_type.splice(index, 1)
                $('#tag_button'+5).removeClass('selected_tag_button')
              }
              if($('#tag_button6').hasClass('selected_tag_button')){
                var index = selected_filter_type.indexOf(6)
                selected_filter_type.splice(index, 1)
                $('#tag_button'+6).removeClass('selected_tag_button')
              }
            }
          }else{
            if($('#tag_button1').hasClass('selected_tag_button') && $('#tag_button'+type).hasClass('selected_tag_button')){
              var index = selected_filter_type.indexOf(1)
              selected_filter_type.splice(index, 1)
              $('#tag_button'+1).removeClass('selected_tag_button')
            }
          }
          // get_all_provider();
      }
  
      function get_all_provider() {
          var current_location_service_type_id = $('#current_location_service_type_id').val();
          var latitude = $('#current_latitude').val();
          var longitude = $('#current_longitude').val();
          $.ajax({
              type: 'POST', // define the type of HTTP verb we want to use (POST for our form)
              url: '/get_all_provider', /// the url where we want to POST
              data: {"default_Search_radious": $('#provider_filter_distance').val(), current_location_service_type_id: current_location_service_type_id,  country: '<%= corporates.country %>', latitude: latitude, longitude: longitude}, // our data object
              datatype: "json",
              success: function (response) {
                  $('#loading').hide();
                  for (var i = 0; i < all_provider_marker.length; i++) {
                      all_provider_marker[i].setMap(null);
                  }
                  all_provider_marker = [];
                  if(response.success) {
                      all_provider = response.providers;
                      providers1 = [];
                      all_provider.forEach(function (provider_data) {
  
                          var providerLocation = provider_data.providerLocation;
                          var contentString;
                          var lat = providerLocation[0];
                          var lon = providerLocation[1];
                          var contentString =
                              '<p><b>Username</b>: ' + provider_data.first_name + ' ' + provider_data.last_name +
                              '<br><b>Rating</b>: ' + provider_data.rate +
                              '</p>';
                          var status = '';
                          if(provider_data.is_available == 0){
                              status = 4;
                              if(provider_data.trip_detail.is_provider_status == 4){
                                  status = 6;
                              } else if(provider_data.trip_detail.is_provider_status == 6){
                                  status = 7;
                              } else {
                                  status = 5;
                              }
                          } else if(provider_data.is_available == 1 && provider_data.is_active == 1){
                              status = 2;
                          } else if(provider_data.is_available == 1 && provider_data.is_active == 0){
                              status = 3;
                          }
                          provider_data.status = status;
                          providers1.push({
                              latlon: new google.maps.LatLng(lat, lon),
                              status: status,
                              bearing: provider_data.bearing,
                              typeimage: provider_data.type_detail.map_pin_image_url,
                              _id: provider_data._id,
                              message: new google.maps.InfoWindow({
                                  content: contentString,
                                  maxWidth: 320
                              })
                          });
                      })
                      
                      providers1.forEach(function (loc_data, i) {
                          var icon = iconBase + "FLETY_ICONO_350_450_oriente.svg";
                          if(loc_data.status == 2){
                            icon = iconBase + "FLETY_ICONO_350_450_oriente.svg";
                          } else if(loc_data.status == 3){
                            icon = iconBase + "FLETY_ICONO_350_450_oriente.svg";
                          } else {
                            icon = iconBase + "FLETY_ICONO_350_450_oriente.svg";
                          }
                          // var provider_type_filter = $('#provider_type_filter').val();
                          var index = selected_filter_type.indexOf(loc_data.status);
                          var all_index = selected_filter_type.indexOf(1);
                          if(all_index !== -1 || index !== -1) {
                              var marker = new google.maps.Marker({
                                position: loc_data.latlon,
                                map: map,
                                icon: {
                                  url: icon,
                                  scaledSize: new google.maps.Size(45, 45) // Adjust the size as per your requirement
                                },
                                draggable:false,
                                scaledSize: new google.maps.Size(30, 30)
                            });


                              all_provider_marker.push(marker);
  
                              google.maps.event.addListener(marker, 'click', function (e) {
                                  show_provider_info(loc_data._id);
                                  loc_data.message.open(map, marker);
                                  setTimeout(function () {
                                      loc_data.message.close();
                                  }, 5000);
                              });
                          }
                      });
                     
                      if(all_provider_marker.length == 0){
                          $('#all_provider_marker_length').text('<%= __("title_no_provider_found") %>')
                      } else {
                          $('#all_provider_marker_length').text(all_provider_marker.length+' Provider Available')
                      }
                  } else {
                      all_provider = [];
                      $('#all_provider_marker_length').text('<%= __("title_no_provider_found") %>')
                  }
              }
          });
      }
  
      function show_provider_info(id) {
          show_provider_info1(id)
          clearInterval(show_provider_info_interval);
          show_provider_info_interval = setInterval(function () {
              show_provider_info1(id)
          },5000);
      }
      function show_provider_info1(id) {
          var index = all_provider.findIndex((x)=>x._id == id);
          if(index !== -1){
              $('.get_provider_info').show();
              $('.map_div').addClass('map_height');
              $('#provider_info_unique_id').text(all_provider[index].unique_id);
              $('#provider_info_name').text(all_provider[index].first_name + ' ' + all_provider[index].last_name);
              $('#provider_info_email').text(all_provider[index].email);
              $('#provider_info_phone').text(all_provider[index].phone);
              $('#provider_info_rating').text(all_provider[index].rate + ' ('+all_provider[index].rate_count +')');
  
              if(all_provider[index].status == 3){
                  $('#provider_info_trip').hide();
                  $('.pickup_info').hide();
                  all_provider[index].status = all_provider[index].status + ' ('+moment(all_provider[index].location_updated_time).format("DD MMM 'YY hh:mm:ss:a") +')'
              } else if(all_provider[index].status == 4 || all_provider[index].status == 5 || all_provider[index].status == 6 ||all_provider[index].status == 7){
                  $('#provider_info_trip').hide();
                  $.ajax({
                      type: 'POST',
                      url: '/get_trip_info',
                      data: {
                          "trip_id": all_provider[index].is_trip[0]
                      },
                      datatype: "json",
                      success: function (response) {
                          if(response.success){
                              $('#show_unique_id').text(response.request_data.unique_id);
                              $('#show_provider_phone').text(response.request_data.provider_detail.phone);
                              $('#show_user_phone').text(response.request_data.user_detail.phone);
                              $('#show_source_address').text(response.request_data.source_address);
                              $('#show_destination_address').text(response.request_data.destination_address);
                              show_trip_type(response.request_data.trip_type)
                              $('#show_created_date').text(moment(response.request_data.created_at).format("DD MMM 'YY hh:mm:a"))
                              $('#show_provider_name').text(response.request_data.provider_detail.first_name+ ' ' +response.request_data.provider_detail.last_name);
                              $('#show_user_name').text(response.request_data.user_detail.first_name + ' ' + response.request_data.user_detail.last_name);
                              $('.pickup_info').show();
                          } else {
                              $('.pickup_info').hide();
                          }
                      }
                  });
              } else if(all_provider[index].status == 2){
  
                  $('#select_trip').empty();
                  $('.pickup_info').hide();
                  if(all_provider[index].is_trip.length>0){
                      $('#provider_info_trip').hide();
                  } else {
                      $('#provider_info_trip').show();
                  }
                  if(request_list.length > 0){
                      $('#select_trip_provider').val(all_provider[index]._id);
                      request_list.forEach(function (request) {
                          if(request.is_provider_accepted == 3 && all_provider[index].service_type == request.service_type_id && all_provider[index].is_approved == 1){
                              $('#select_trip').append("<option value="+request._id + ">"+request.unique_id + "</option>")
                          }
                      })
                      $('#select_trip').selectpicker('refresh');
                  }
              }
              if(all_provider[index].status == 2){
                  $('#provider_info_status').text('Online');
              } else if(all_provider[index].status == 4 || all_provider[index].status == 5 || all_provider[index].status == 6 ) {
                  $('#provider_info_status').text('In Trip');
              } else {
                  $('#provider_info_status').text('Offline' + all_provider[index].status.slice(1));
              }
  
          } else {
              $('.get_provider_info').show();
          }
      }
      //herestop

      function addStop() {
        $('#add_stop_message').hide()
        if ($('#dest_stops_lat_lng_div')[0].childElementCount == "<%= setting_detail.multiple_stop_count %>") {
          $('#add_stop_message').show()
          return;
        }

        //here1
        var html =
        `<div class="col-sm-6 red_bg" id="picu_lft${stop_idx}" style="margin-bottom: 15px; text-align: left;">`+
        `<div id="containerlabel${stop_idx}">`+
          `<label id="stoplabel${stop_idx}" style="padding-left: 13% !important;font-family: 'Open Sans', sans-serif !important;font-size: 14px !important; font-weight: 600 !important; color:black;" for="stops-pac-input${stop_idx}">Agregando Parada</label>`+
          `</div>`+
        `<div id="containerstop${stop_idx}">`+
          //`<input type="text" id="stops-pac-input${stop_idx}" name="destination_addresses[]" class="place_holder_city" style="margin-bottom: 0; width: 60%;  display: inline-block;" placeholder="<%= __('title_stop') %> ${stop_idx + 1} (<%= __('title_indicate_city') %>)"/>`+
          `<span style="position:relative ;display: inline-block;background: rgb(37 14 98);"><i class="fa fa-map-marker"></i></span>`+
          `<input type="text" id="stops-pac-input${stop_idx}" name="destination_addresses[]" class="place_holder_city offset-auto-stops" style="padding-left:5%; margin-bottom: 0; width: 60%; display: inline-block;" placeholder="<%= __('title_stop_new') %>"/>`+
          `<input type="hidden" id="stop_username${stop_idx}" name="stop_username[]" />`+
          `<input type="hidden" id="stop_user_phone${stop_idx}" name="stop_user_phone[]" />`+
          `<input type="hidden" id="internal_stop_addresses${stop_idx}" name="internal_stop_addresses[]" />`+
          `<span style="display: inline-block;background: transparent !important; position: absolute !important; left: 60%; top: 37%; color: black" onclick="removeStop('${stop_idx}')"><i class="fa fa-close"></i></span>`+
          `<button type="button" id="stop_user_data_btn${stop_idx}" onclick="show_stop_user_data_modal(${stop_idx + 1})" class="int_stop_btn" alt="<%= __('tooltip_stops_address') %>"  title="<%= __('tooltip_stops_address') %>" > Add User Data <i class="fa fa-plus-circle" aria-hidden="true"></i></button>`+
          `<div id="error_add_address_first${stop_idx}" style="color: red; display: none; font-size: 14px; margin-left: 15px;">Debe seleccionar una direccin primero</div>`+
          // `<button type="button" onclick="show_internal_stop_modal(${stop_idx + 1})" class="destination_field int_stop_btn" alt="<%= __('tooltip_stops_address') %>"  title="<%= __('tooltip_stops_address') %>" > <%= __('title_add_internal_stops') %> <i class="fa fa-plus-circle" aria-hidden="true"></i></button>`+
          //`<button type="button" onclick="removeStop('${stop_idx}')" class="destination_field int_stop_btn_delete" alt="<%= __('tooltip_stops_address') %>" title="<%= __('tooltip_stops_address') %>" > <%= __('remove_stop') %> <i class="fa fa-times"></i></button>`+
          `</div>`+
          `</div>`
        
        $('#multiple_stops').append(html);

        if($('#b_optimize').is(':checked')){
          optimalPanel();
        }
   

        var html = `<input type="hidden" id="dest_stops_lat_lng${stop_idx}" name="dest_stops_lat_lng${stop_idx}" />`;
        $('#dest_stops_lat_lng_div').append(html);
  
        var html = `<input type="hidden" id="d_stop_lat${stop_idx}" name="d_stop_lat[]" />` +
          `<input type="hidden" id="d_stop_lng${stop_idx}" name="d_stop_lng[]" />`
        $('#dest_stops_location_div').append(html);
        //
        add_google_place_auto_complete(stop_idx);
        //redraw_markers();
        //get_destination_stop(false);
        stop_idx++;
      }
  
   function removeStop(element_id) {
  $('#add_stop_message').hide();

  // Validar si la ltima parada est vaca
  const lastContainer = $('[id^="containerstop"]').last();
  const lastInput = lastContainer.find('input[type="text"]');

  if (!lastInput.val() || !lastInput.val().trim()) {
    // Si la ltima parada est vaca y NO es la que se intenta eliminar
    if (!$('#containerstop' + element_id).is(lastContainer)) {
      lastInput.css('border', '2px solid red');
      alert('Hay una parada vaca al final. Debes completarla o eliminarla antes de modificar otras.');
      return; // No elimina nada
    }
  }

  // Eliminar elementos relacionados con la parada
  document.getElementById('picu_lft' + element_id)?.remove();
  document.getElementById('d_stop_lat' + element_id)?.remove();
  document.getElementById('d_stop_lng' + element_id)?.remove();
  document.getElementById('dest_stops_lat_lng' + element_id)?.remove();

  if (destination_addresses_markers[element_id] !== undefined) {
    destination_addresses_markers[element_id].setMap(null);
    delete destination_addresses_markers[element_id];
    currentStopidx = null;
  }

  const remainingStops = $('#multiple_stops').children('div[id^="picu_lft"]');
  if (remainingStops.length === 0) {
    $('#destination').val('');
    $('#dest_lat_lng').val('');
    $('#dlat').val('');
    $('#dlng').val('');
    $('#multiple_stops_optimized').attr("hidden", true);
    if (typeof directionsDisplay !== 'undefined') {
      directionsDisplay.set('directions', null);
    }
  }

  get_destination_stop($('#b_optimize').is(':checked'));
}
    
      function addInternalStop() {
        $('#add_internal_stop_message').hide();
        let forms_data = $("#internal_stops_form").serializeJSON()  
        if (forms_data.stops_addresses.length == 40) {
          $('#add_internal_stop_message').show();
          return;
        }
        i_stop_idx ++;
        var html = `<div class="col_12 red_bg" id="i_picu_lft${i_stop_idx}" style="margin-bottom: 15px;">`+
        `<input type="text" id="i-stops-pac-input${i_stop_idx}" name="stops_addresses[]" class="place_holder_stop" placeholder="<%= __('title_stops_inside') %> ${i_stop_idx + 1} (<%= __('title_indicate_city') %>)"/>`+
        `<span style="background: rgb(37 14 98); left: 0px !important;"><i class="fa fa-map-marker"></i></span>`+
        `<span class="right-span" onclick="removeInternalStop('${i_stop_idx}')"><i class="fa fa-times"></i></span>`+
        `<input type="hidden" id="int_stops_lat_lng${i_stop_idx}" name="int_stops_lat_lng${i_stop_idx}" />`+
        `<input type="hidden" id="i_stop_lat${i_stop_idx}" name="i_stop_lat[]" />` +
        `<input type="hidden" id="i_stop_lng${i_stop_idx}" name="i_stop_lng[]" />` +
        `</div>`
  
        $('#internal_stops').append(html);
        add_google_place_auto_complete_stops(i_stop_idx);
      }
  
      function removeInternalStop(element_id) {
        $('#add_internal_stop_message').hide();
        $('#i_picu_lft' + element_id).remove();
        $('#i_stop_lat' + element_id).remove();
        $('#i_stop_lng' + element_id).remove();
  
        const element = $('#int_stops_lat_lng' + element_id)[0];
        var dlatlng = String(element.value);
        dlatlng = dlatlng.replace(/[{( )}]/g, '');
        dlatlng = dlatlng.split(',');
        $('#int_stops_lat_lng' + element_id).remove();
        // if (destination_addresses_markers[element_id] != undefined) {
        //   destination_addresses_markers[element_id].setMap(null);
        // }
        // if (dlatlng.length == 2) {
        //   var bounds = new google.maps.LatLngBounds();
        //  // draw_path(bounds);
        // }
      }
  
    function show_stop_user_data_modal(element_id){
      if (!validateAddress(element_id - 1)) {
        return;
      }

      $('#stop_username_field').val("")
      $('#stop_user_phone1_field').val("")
      $('#stop_user_phone2_field').val("")
      $('#main_stop_user_data_id').val(element_id)
      
      let stop_username = ""
      let stop_user_phone = []
      stop_username = $('#stop_username' + (element_id - 1)).val() || ""
      stop_user_phone = $('#stop_user_phone' + (element_id - 1)).val() || ""
      if(stop_user_phone != undefined && stop_user_phone != ""){
        stop_user_phone = stop_user_phone.split(',');
      }
      $('#stop_username_field').val(stop_username || "")
      $('#stop_user_phone1_field').val(stop_user_phone[0] || "")
      $('#stop_user_phone2_field').val(stop_user_phone[1] || "")

      $('#stop_user_data_modal').modal('show');
    }

    function validateAddress(element_id) {
      let address = $('#stops-pac-input' + element_id).val();
      if (!address || address === "") {
        const errorMessage = $('#error_add_address_first' + element_id);
        errorMessage.show();
        setTimeout(function() {
          errorMessage.hide();
        }, 3000);
        return false;
      }
      return true;
    }

    function show_internal_stop_modal(element_id){
      // console.log(element_id)
      $('#internal_stops').empty();
      
      let stop_string = ""
      if(element_id == 0){ // Destination Stop
        stop_string = document.getElementById('destination_stops').value
      }else{
        stop_string = document.getElementById('internal_stop_addresses' + (element_id - 1)).value
      }
      // console.log({stop_string})
      if(stop_string != undefined && stop_string != ""){ // Destination Stop
        let stops = JSON.parse(stop_string)
        if(stops.length > 0){
          stops.forEach((stop, index) => {
            const html = `<div class="col_12 red_bg" id="i_picu_lft${index}" style="margin-bottom: 15px;">`+
            `<input type="text" id="i-stops-pac-input${index}" name="stops_addresses[]"  value="${stop.address}" class="place_holder_stop" placeholder="<%= __('title_stops_inside') %> ${i_stop_idx + 1} (<%= __('title_indicate_city') %>)"/>`+
            `<span style="background: rgb(37 14 98); left: 0px !important;"><i class="fa fa-map-marker"></i></span>`+
            `<input type="hidden" name="external_stop_id" id="external_stop_id" value="${element_id}">`+
            `<input type="hidden" id="int_stops_lat_lng${index}" name="int_stops_lat_lng${index}" />`+
            `<input type="hidden" id="i_stop_lat${index}" name="i_stop_lat[]" value="${stop.location[0]}" />` +
            `<input type="hidden" id="i_stop_lng${index}" name="i_stop_lng[]" value="${stop.location[1]}" />` +
            `</div>`
            i_stop_idx = index 
            $('#internal_stops').append(html);
          })
          $('#internal_stop_modal').modal('show');
          add_google_place_auto_complete_stops(i_stop_idx);
          return;
        }
      }
      i_stop_idx = 0
      const html = `<div class="col_12 red_bg" id="i_picu_lft${i_stop_idx}" style="margin-bottom: 15px;">`+
      `<input type="text" id="i-stops-pac-input${i_stop_idx}" name="stops_addresses[]"  class="place_holder_stop" placeholder="<%= __('title_stops_inside') %> ${i_stop_idx + 1} (<%= __('title_indicate_city') %>)"/>`+
      `<span style="background: rgb(37 14 98); left: 0px !important;"><i class="fa fa-map-marker"></i></span>`+
      `<input type="hidden" name="external_stop_id" id="external_stop_id" value="${element_id}">`+
      `<input type="hidden" id="int_stops_lat_lng${i_stop_idx}" name="int_stops_lat_lng${i_stop_idx}" />`+
      `<input type="hidden" id="i_stop_lat${i_stop_idx}" name="i_stop_lat[]" />` +
      `<input type="hidden" id="i_stop_lng${i_stop_idx}" name="i_stop_lng[]" />` +
      `</div>`
      $('#internal_stops').append(html);
      $('#internal_stop_modal').modal('show');
      add_google_place_auto_complete_stops(i_stop_idx);
      }

      $('#confirm_stop_user_data').click( function(){
        let forms_data = $("#stops_user_data_form").serializeJSON() 
        let main_stop = Number(forms_data.main_stop_user_data_id)
        let username = forms_data.stop_username_field || ""  
        let phone1 = forms_data.stop_user_phone1_field || ""  
        let phone2 = forms_data.stop_user_phone2_field || ""  
        let phone_array = [] 
        let is_invalid_stop = 0       
          if(username == "" || 
            (phone1 == "" && phone2 == ""))
          {
              is_invalid_stop = 1
          }
          if(is_invalid_stop == 1){
            return;
          }
          if(phone1 !=""){
            phone_array.push(phone1)
          }
          if(phone2 !=""){
            phone_array.push(phone2)
          }
          $('#stop_username'+ (main_stop - 1)).val(username)
          $('#stop_user_phone'+ (main_stop - 1)).val(phone_array)
          $('#stop_user_data_modal').modal('hide');
        })

      $('#confirm_int_stop').click( function(){
      let forms_data = $("#internal_stops_form").serializeJSON()  
        let main_stop = Number(forms_data.external_stop_id)
        let int_stops_array = [] 
        let is_invalid_stop = 0       
        forms_data.stops_addresses.forEach((stop, i) => {
          if(forms_data.stops_addresses[i] == "" || 
            forms_data.i_stop_lat[i] == "" ||
            forms_data.i_stop_lng[i] == ""){
              is_invalid_stop = 1
              $('#valid_add_msg').show();
              setTimeout(function () {
                  $('#valid_add_msg').hide();
              }, 3000);
          }
          let stops_addresses = forms_data.stops_addresses[i]
          let int_stop_lat = Number(forms_data.i_stop_lat[i])
          let int_stop_lng = Number(forms_data.i_stop_lng[i])
          if(stops_addresses !="" && int_stop_lat != 0 && int_stop_lng != 0){
            let int_stop_details = {
              address: stops_addresses,
              location: [int_stop_lat, int_stop_lng]
            }
            int_stops_array.push(int_stop_details)
          }
        })
        if(is_invalid_stop == 1){
          return;
        }
  
        draw_path()
        $('#internal_stop_modal').modal('hide');
    })
    
    function addStopRepeatOrder(stop_details) {
      let address = stop_details.address
      let location = stop_details.location
      let stop_username = stop_details.stop_username || ""
      let stop_user_phone = stop_details.stop_user_phone || ""
      let optimize = stop_details.optimize_field
      
      // let stops_inside = stop_details.inside_stops || 0
      $('#add_internal_stop_message').hide();
      $('#add_stop_message').hide()
      if ($('#dest_stops_lat_lng_div')[0].childElementCount == "<%= setting_detail.multiple_stop_count %>") {
        $('#add_stop_message').show()
        return;
      }
  
        let int_stops =  JSON.stringify(stop_details.stops_inside)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;');
        var html =
        `<div class="col-sm-6 red_bg" id="picu_lft${stop_idx}" style="margin-bottom: 15px; text-align: left;">`+
        `<div id="containerlabel${stop_idx}">`+
          `<label id="stoplabel${stop_idx}" style="padding-left: 13% !important;font-family: 'Open Sans', sans-serif !important;font-size: 14px !important; font-weight: 600 !important; color:black;" for="stops-pac-input${stop_idx}">Parada</label>`+
          `</div>`+
        `<div id="containerstop${stop_idx}">`+
          //`<input type="text" id="stops-pac-input${stop_idx}" name="destination_addresses[]" class="place_holder_city" style="margin-bottom: 0; width: 60%;  display: inline-block;" placeholder="<%= __('title_stop') %> ${stop_idx + 1} (<%= __('title_indicate_city') %>)"/>`+
          `<span style="position:relative ;display: inline-block;background: rgb(37 14 98);"><i class="fa fa-map-marker"></i></span>`+
          `<input type="text" id="stops-pac-input${stop_idx}" name="destination_addresses[]" class="place_holder_city offset-auto-stops" style="padding-left:5%; margin-bottom: 0; width: 60%; display: inline-block;" placeholder="<%= __('title_stop_new') %>" value="${address}"/>`+
          `<input type="hidden" id="stop_username${stop_idx}" name="stop_username[]" value="${stop_username}" />`+
          `<input type="hidden" id="stop_user_phone${stop_idx}" name="stop_user_phone[]" value="${stop_user_phone}" />`+
        `<input type="hidden" id="internal_stop_addresses${stop_idx}" name="internal_stop_addresses[]" />`+
          `<span style="display: inline-block;background: transparent !important; position: absolute !important; left: 60%; top: 37%; color: black" onclick="removeStop('${stop_idx}')"><i class="fa fa-close"></i></span>`+
          `<button type="button" id="stop_user_data_btn${stop_idx}" onclick="show_stop_user_data_modal(${stop_idx + 1})" class="int_stop_btn" alt="<%= __('tooltip_stops_address') %>"  title="<%= __('tooltip_stops_address') %>" > Add User Data <i class="fa fa-plus-circle" aria-hidden="true"></i></button>`+
          `<div id="error_add_address_first${stop_idx}" style="color: red; display: none; font-size: 14px; margin-left: 15px;">Debe seleccionar una direccin primero</div>`+
          // `<button type="button" onclick="show_internal_stop_modal(${stop_idx + 1})" class="destination_field int_stop_btn" alt="<%= __('tooltip_stops_address') %>"  title="<%= __('tooltip_stops_address') %>" > <%= __('title_add_internal_stops') %> <i class="fa fa-plus-circle" aria-hidden="true"></i></button>`+
          //`<button type="button" onclick="removeStop('${stop_idx}')" class="destination_field int_stop_btn_delete" alt="<%= __('tooltip_stops_address') %>" title="<%= __('tooltip_stops_address') %>" > <%= __('remove_stop') %> <i class="fa fa-times"></i></button>`+
          `</div>`+
          `</div>`
  
      $('#multiple_stops').append(html);

              if($('#b_optimize').is(':checked')){
          optimalPanel();
        }
  
      var html = `<input type="hidden" id="dest_stops_lat_lng${stop_idx}" name="dest_stops_lat_lng${stop_idx}" value=${location} />`;
      $('#dest_stops_lat_lng_div').append(html);
  
      var html = `<input type="hidden" id="d_stop_lat${stop_idx}" name="d_stop_lat[]" value="${location[0]}" />` +
        `<input type="hidden" id="d_stop_lng${stop_idx}" name="d_stop_lng[]" value="${location[1]}" />`
      $('#dest_stops_location_div').append(html);
  
      add_google_place_auto_complete(stop_idx);
      stop_idx++;
    }
  
      function removeAddress(address_type) {
        if(address_type == 0){
          if (pickup_marker) {
            pickup_marker.setMap(null);
          }
          $('#lat').val("")
          $('#lng').val("")
          $('#pickup_address').val("")
          $('#pickup').val("")
        }else if(address_type == 1){
          if (destination_marker) {
            destination_marker.setMap(null);
          }
          $('#dlat').val("")
          $('#dlng').val("")
          $('#destination_address').val("")
          // $('#destination_stop').val("")
          $('#destination').val("")
          $('#destination_stops').val("")
        }
      }
  
      function show_trip_type(type) {
  
          var string = '';
          switch(type) {
              case 0:
                  string = "User";
                  break;
              case 1:
                  string = "User";
                  break;
              case 2:
                  string = "Hotel";
                  break;
              case 3:
                  string = "Dispatcher";
                  break;
              case 6:
                  string = "Provider";
                  break;
              case 7:
                  string = "Corporate";
                  break;
              default:
                  string = type;
          }
          $('#show_trip_type').text(string);
      }
  
      function assign_request(){
          $.ajax({
              type: 'POST',
              url: '/send_request',
              data: {trip_id: $('#select_trip').val(), provider_id: $('#select_trip_provider').val()},
              dataType: "json",
              success: function (response) {
                  if (response.success == false)
                  {
                      show_trip_data($('#select_trip').val(), 'accepted_request');
                      if (trip_response.error_code == 464)
                      {
                          trip_error("<%= __('error_payment_is_pending') %>")
                      }
                      else
                      {
                          trip_error("<%= __('error_provider_not_found') %>")
                      }
                  } else {
                      location.reload();
                  }
              }
          });
      }
  
    </script>
  
    <script type="text/javascript">
                                                                                                                                                                                                                                                    
  
      $(document).ready(function(){
  
          $(window).on('load resize',function(){
  
              if($(window).width() >=1024){
                $('.hide_btn').click(function(){
                  $('.container').toggleClass('hide_panel');
                });
              }
              else {
                $('.hide_btn, .content_in').click(function(){
                  $('.container').removeClass('hide_panel');
                  $('.left_panel').toggle();
                  $('.leftmenu').hide();
                });
  
              }
          });
  
          $(window).on('load resize', function(){
            if($(window).width() >= 1024){
              $('.menu_icon a, .leftmenu ul li a').click(function(){
                $('.container').toggleClass('show_left');
              });
            }
            else {
              $('.menu_icon a, .leftmenu ul li a').click(function(){
                $('.container').removeClass('show_left');
                $('.leftmenu').toggle();
                $('.left_panel').hide();
              });
            }
          });
          $('.content:last-child').css('border-bottom', 'none');
          
          <% if( trip_data ){ %>
            let trip_details = <%-JSON.stringify(trip_data)%>
            $('#src_lat_lng').val(trip_details.sourceLocation)
            $('#dest_lat_lng').val(trip_details.initialDestinationLocation)
            $('#lat').val(trip_details.sourceLocation[0])
            $('#lng').val(trip_details.sourceLocation[1])
            $('#dlat').val(trip_details.initialDestinationLocation[0])
            $('#dlng').val(trip_details.initialDestinationLocation[1])
            $('#selected_service_type_id').val(trip_details.service_type_id)
            $('#pickup_address').val(trip_details.source_address)
            $('#pickup').val(trip_details.source_address)
            if(trip_details.model_details){
              $('#selected_model_id').val(trip_details.model_details._id)
            }
            if(trip_details.capacity_details){
              $('#selected_capacity_id').val(trip_details.capacity_details._id)
            }
            if(trip_details.service_details){
              $('#selected_service_id').val(trip_details.service_details._id)
            }
            if(trip_details.initialDestinationLocation.length > 0 && trip_details.initial_destination_address){
              $('#destination').val(trip_details.initial_destination_address)
            }
            
            let pickup_data = trip_details.pickup_details[0]
            let pickup_user_details = pickup_data.user_details
            $('#pickup_company_name').val(pickup_user_details.company_name)
            $('#pickup_phone_code').val(pickup_user_details.country_phone_code)
            $('#pickup_username').val(pickup_user_details.name)
            $('#select_helpers_for_load').val(pickup_user_details.number_of_helpers_load)
            $('#select_helpers_for_download').val(pickup_user_details.number_of_helpers_download)
            $('#pickup_phone').val(pickup_user_details.phone)
            $('#pickup_address').val(pickup_data.address)
            $('#pickup_description').val(pickup_data.note)
            $('#pickup_weight_of_load').val(pickup_data.weight_of_load)
            $('#pickup_volume_of_load').val(pickup_data.volume_of_load)

            let delivery_data = trip_details.delivery_details[0]
            let delivery_user_details = delivery_data.user_details
  
            $('#delivery_company_name').val(delivery_user_details.company_name)
            $('#delivery_username').val(delivery_user_details.name)
            $('#delivery_phone').val(delivery_user_details.phone),
            $('#destination_address').val(delivery_data.address)
            $('#delivery_description').val(delivery_data.note)
            
            $('.new_req_info').show();
            $('.main_page .map_div').addClass('map_height');
            $('#provider_filter').hide();
            $('#provider_search_button').hide();
            $('#new_request_div').hide();
            $('#mapview_div').show();
            $('.pickup_info').hide();
            $('.no_provider_found_div').hide();
            $(".select_old_new_req").hide();
            $(".pick_dest_details").show();
            $(".forward_backward_btn").show();
  
            page_num = 3
          <% } else {%>
            $('.new_req_info').show();
            $('.main_page .map_div').addClass('map_height');
            new_request_creat()
          <% } %>
          /* new request info */
          $('.new_req_btn').click(function(){
            $('.new_req_info').show();
            $('.main_page .map_div').addClass('map_height');
          });
  
          /* tab */
          $('.tab_con').hide();
          $('.leftmenu ul li a, .content_in').click(function(e){
            e.preventDefault();
            $('.leftmenu ul li').removeClass('active');
            $(this).parent().addClass('active');
            var tab = $(this).attr('href');
            $('.main_page').hide();
            $('.tab_con').hide();
            $(tab).fadeIn('slow');
          });
  
  
  
          /* action button */
          $('.action_btn').click(function(){
            $(this).siblings('ul').slideToggle();
          });
  
          $('#pro_info').on('change', function(){
            if( this.value == 'manually'){
              $(".provider_info").show();
            }
            else
            {
              $(".provider_info").hide();
            }
          });
  
          $('.provider_details').hide();
  
            $('#pro_name').change(function () {
              $('.provider_details').hide();
              $('#'+$(this).val()).show();
            })
  
          });
  
          var i = 0;
          var dragging = false;
          $('#dragbar').mousedown(function(e){
          e.preventDefault();
  
          dragging = true;
          var main = $('#main');
          var wrapper = $('#wrapper');
          var ghostbar = $('<div>',
              {id:'ghostbar',
              css: {
              width: main.outerWidth(),
              top: e.pageY,
              left: main.offset().left
            }
          }).appendTo('#wrapper');
  
          $(document).mousemove(function(e){
            ghostbar.css("top", (e.pageY + 2));
          });
  
          $(document).mouseup(function(e){
            if (dragging)
            {
             var percentage = ((e.pageY - $('#wrapper').offset().top) / $('#wrapper').height()) * 100;
             var mainPercentage = 100-percentage;
  
             $('#sidebar').css("height",percentage + "%");
             $('#main').css("height",mainPercentage + "%");
             $('#ghostbar').remove();
             $(document).unbind('mousemove');
             dragging = false
            }
          });

      });
  
      $("#legend").removeClass("hide");

  
  </script>
  
</body>
<% include footer_form.html %>
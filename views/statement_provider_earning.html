<% if(type == "provider") { %>
<% include provider/provider_header.html %>
<% } else if(type == "dispatcher") { %>
<% include new_design_dispatcher/dispatcher_header.html %>
<% } else if(type == "partner") { %>
<% include partner/partner_header.html %>
<% } else if(type == "corporate") { %>
<% include corporate/corporate_header.html %>
<% } else if(type == "hotel") { %>
<% include hotel_header.html %>
<% } else { %>
<% include header.html %>
<% } %>

<style>
  img#logo {
    width: 315px;
    height: auto;
    margin-top: -31px;
  }

.col_details_1{
  width:45% !important;
}

@media screen and (max-width: 768px) {
  .cont_lft {width: 30% !important;}
}
@media screen and (max-width: 480px)  {
	.cont_lft {width: 100% !important;margin: 0 0 25px 0px !important;}
  .content{padding: 0 0 0 10px !important;}
}


</style>
<link rel="stylesheet" type="text/css" href="css/style.css">

<!--style.responsive-->
<link rel="stylesheet" type="text/css" href="css/responsive.css">
<!-- PAGE CONTENT WRAPPER -->
<div class="main">
  <div class="panel panel-default">
    <div class="panel-body">
      <div class="col-md-4">
        <h2><strong><%= detail.invoice_number %></strong></h2>
      </div>
      <div class="col-md-4" style="text-align: center;">
        <h4><strong><%= moment(detail.provider_trip_end_time).format("DD MMM 'YY") %></strong></h4>
      </div>
      <div class="col-md-4 btn-group" id="pdf_download_btn">
        <button class="btn btn-danger pull-right" id="demo"><%= __("button_export_pdf") %></button>
      </div>


      <!--content scection-->
      <div class="content_bg" style="margin-top: 0px;">
        <div class="margin">
          <div class="content" style="padding: 35px 0px 17px 25px;">
            <div class="cont_lft col_details_1" >
              <div class="cont_top">
                <h1><%= __("title_user_details") %></h1>
              </div>
              <div class="cont_dit">
                <p><%= __("title_user_id") %>: <%= user_detail.unique_id %></p>
                <p><%= __("title_company_name") %>: <%= corporate_detail ? corporate_detail.company_name : "" %></p>
                <p><%= __("title_user_name") %>: <%= user_detail.first_name %> <%= user_detail.last_name %></p>
                <p><%= __("title_rif") %>: <%= corporate_detail ? corporate_detail.rif : "" %></p>
                <p><%= __("title_address") %>: <%= corporate_detail ? corporate_detail.address : "" %></p>
              </div>
            </div>

            <div class="cont_lft " style="width: 22%;">
              <div class="cont_top">
                <h1><%= __("title_provider_details") %></h1>
              </div>
              <div class="cont_dit">
                <p><%= __("title_provider_id") %>:<%= provider_detail.unique_id %>
                </p>
                <p><%= __("title_provider_name") %>:
                  <%= provider_detail.first_name %> <%= provider_detail.last_name %>
                </p>
              </div>
            </div>
            <div class="cont_lft" style="width: 30%;">
              <img id="logo" src="logo_navyblue.png" alt="Logo">
            </div>
          </div>

          <div class="content" style="padding: 0px 0 0 25px;">
            <div class="cont_lft col_details_1">
              <div class="cont_top">
                <h1><%= __("title_pickup_address") %></h1>
              </div>
              <div class="cont_dit">
                <p><%= detail.source_address %></p>

              </div>
            </div>

            <div class="cont_lft" style="width: 30%;">
              <div class="cont_top">
                <h1><%= __("title_destination_address") %></h1>
              </div>
              <div class="cont_dit">
                <p><%= detail.destination_address %></p>
              </div>
            </div>
          </div>
          <% if(detail.actual_destination_addresses) { %>
          <% if(detail.actual_destination_addresses.length !=0) { %>
          <div class="content">
            <div class="cont_lft">
              <div class="cont_top">
                <h1><%= __("title_stops") %></h1>
              </div>
              <div class="cont_dit">
                <% detail.actual_destination_addresses.forEach((destination_address,index) => { %>
                <% if(destination_address.address != ''){ %>
                <p>
                  <%= __("title_stop") + " - " + (index+1) + " : " %>
                  <%= destination_address.address %>
                  <b>
                    <%= destination_address.start_time || destination_address.arrived_time ? '(' : ''%>
                    <% if(destination_address.start_time) { %>
                    <%= __("title_started_time") %> : <%= moment(destination_address.start_time).tz(setting_detail.timezone_for_display_date).format("hh:mm a") %>
                    <% } %>
                    <%= destination_address.start_time && destination_address.arrived_time ? ' - ' : ''%>
                    <% if(destination_address.arrived_time){ %>
                    <%= __("title_arrived_time") %> : <%= moment(destination_address.arrived_time).tz(setting_detail.timezone_for_display_date).format("hh:mm a") %>
                    <% } %>
                    <%= destination_address.start_time || destination_address.arrived_time ? ')' : ''%>
                  </b>
                </p>
                <% } %>
                <% }) %>
              </div>
            </div>
          </div>
          <% } %>
          <% } %>

          <div class="Trip_info_bg">
            <div class="margin">
              <div class=" Trip_info">
                <div class="trip_head cont_top">
                  <h1><%= __("title_trip_information") %></h1>


                  <% if(detail.is_trip_cancelled==1){ %>
                  <span><%= __("title_cancelled_request") %></span>
                  <% } %>
                  <% if(detail.is_trip_completed==1){ %>
                  <span style="color: green;"><%= __("title_trip_status_completed") %> </span>
                  <% } %>

                </div>

                <div class="trip_info_box_bg">
                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_invoice_total_distance") %></h4>
                    <p><%= detail.total_distance %>
                      <% if(detail.unit==1){ %>
                      <%= __("unit_km") %>s
                      <% } else { %>
                      <%= __("unit_mile") %>s
                      <% } %>
                    </p>
                  </div>

                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_number_of_helpers") %></h4>
                    <p><%= detail.pickup_details ? detail.pickup_details[0].user_details.no_of_helpers : 0  %></p>
                  </div>
                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_total_time") %></h4>
                    <p id="total_time"><%= detail.total_time %> mins</p>
                  </div>

                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_invoice_total_wait_time") %></h4>
                    <p><%= detail.total_waiting_time %> mins</p>
                  </div>
                </div>

                <div class="trip_info_box_bg">
                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_stop_wait_time") %></h4>
                    <p><%= detail.total_stop_waiting_time %> mins</p>
                  </div>
                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_max_speed") %></h4>
                    <p><%= detail.speed %> km/h</p>
                  </div>
                </div>
              </div>

              <div class=" Trip_info">
                <div class="trip_head cont_top">
                  <h1><%= __("title_trip_time_descriptiom") %></h1>
                </div>

                <div class="trip_info_box_bg">
                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_create_time") %></h4>
                    <p><%= moment(detail.created_at).tz(timezone_for_display_date).format("hh:mm a") %></p>
                  </div>

                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_provider_reach_time") %></h4>
                    <p><%= moment(detail.provider_arrived_time).tz(timezone_for_display_date).format("hh:mm a") %></p>
                  </div>

                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_started_time") %></h4>
                    <p><%= moment(detail.provider_trip_start_time).tz(timezone_for_display_date).format("hh:mm a") %></p>
                  </div>

                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_arrived_destination_time") %></h4>
                    <p><%= detail.provider_arrived_destination_time ? moment(detail.provider_arrived_destination_time).tz(timezone_for_display_date).format("hh:mm a") : 'NA'  %></p>
                  </div>

                  <div class="trip_info_box trip_info_box1">
                    <h4><%= __("title_ended_time") %></h4>
                    <p><%= moment(detail.provider_trip_end_time).tz(timezone_for_display_date).format("hh:mm a") %></p>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <!--invoice section-->
          <div class="invoice_bg">
            <div class="margin">
              <div class="invoice">
                <% if( type != "partner"){ %>

                <div class="invo_head cont_top">
                  <h1><%= __("title_invoice") %></h1>
                </div>

                <div class="invoice_table_bg">
                  <div class="invoice_table">
                    <div class="invo_one invo_one_bg">
                      <div class="invo_one_lft"><%= __("title_base_price") %></div>
                      <div class="invo_one_rgt">$<%= (detail.base_distance_cost).toFixed(2) %></div>
                    </div>

                    <div class="invo_one">
                      <div class="invo_one_lft"><%= __("title_distance_price") %></div>
                      <div class="invo_one_rgt">$<%= (detail.distance_cost).toFixed(2) %></div>
                    </div>

                    <div class="invo_one invo_one_bg">
                      <div class="invo_one_lft"><%= __("title_total_time_price") %></div>
                      <div class="invo_one_rgt">$<%= (detail.time_cost).toFixed(2) %></div>
                    </div>
                    <div class="invo_one">
                      <div class="invo_one_lft"><%= __("title_wait_time_price") %></div>
                      <div class="invo_one_rgt">$<%= (detail.waiting_time_cost).toFixed(2) %></div>
                    </div>
                    <% if(detail.stop_waiting_time_cost){ %>
                    <div class="invo_one invo_one_bg">
                      <div class="invo_one_lft"><%= __("title_stop_wait_time_price") %></div>
                      <div class="invo_one_rgt">$<%= (detail.stop_waiting_time_cost).toFixed(2) %></div>
                    </div>
                    <div class="invo_one">
                      <% }else{ %>
                      <div class="invo_one invo_one_bg">
                        <% } %>
                        <div class="invo_one_lft"><%= __("title_surge_price") %></div>
                        <div class="invo_one_rgt">$<%= (detail.surge_fee).toFixed(2) %></div>
                      </div>

                      <div class="invo_total">
                        <div class="invo_one_lft">
                          <%= __("title_service_price") %>
                        </div>
                        <div class="invo_one_rgt">$<%= (detail.total_after_surge_fees).toFixed(2) %></div>
                      </div>
                    </div>
                  </div>

                  <div class="invoice_table_bg">
                    <div class="invoice_table">
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_tax") %></div>
                        <div class="invo_one_rgt">$<%= (detail.tax_fee).toFixed(2) %></div>
                      </div>

                      <div class="invo_total">
                        <div class="invo_one_lft">
                          <%= __("title_total_service_price") %>
                          <% if(detail.trip_type == constant_json.TRIP_TYPE_AIRPORT){ %>
                          <%= __("title_airport_price_applied") %>
                          <% }else if(detail.trip_type == constant_json.TRIP_TYPE_ZONE){ %>
                          <%= __("title_zone_to_zone_price_applied") %>
                          <% }else if(detail.trip_type == constant_json.TRIP_TYPE_CITY){ %>
                          <%= __("title_city_to_city_price_applied") %>
                          <% }else if(detail.is_fixed_fare == 1){ %>
                          <%= __("title_fixed_price_applied") %>
                          <% }else if(detail.is_min_fare_used == 1){ %>
                          <%= __("title_min_fare_applied") %>
                          <% } %>
                        </div>
                        <div class="invo_one_rgt">$<%= (detail.total_after_tax_fees).toFixed(2) %></div>
                      </div>
                    </div>
                  </div>

                  <div class="invoice_table_bg">
                    <div class="invoice_table">
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_user_tax") %></div>
                        <div class="invo_one_rgt">$<%= (detail.user_tax_fee).toFixed(2) %></div>
                      </div>

                      <div class="invo_one invo_one_bg">
                        <div class="invo_one_lft"><%= __("title_user_miscellaneous_fee") %></div>
                        <div class="invo_one_rgt">$<%= (detail.user_miscellaneous_fee).toFixed(2) %></div>
                      </div>

                      <div class="invo_total">
                        <div class="invo_one_lft">
                          <%= __("title_sub_total") %>
                        </div>
                        <div class="invo_one_rgt">$<%= (detail.total_after_user_tax_fees).toFixed(2) %></div>
                      </div>
                    </div>
                  </div>

                  <div class="invoice_table_bg">
                    <div class="invoice_table">
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_is_trip") %></div>
                        <div class="invo_one_rgt">$<%= (detail.tip_amount).toFixed(2) %></div>
                      </div>
                      <div class="invo_one invo_one_bg">
                        <div class="invo_one_lft"><%= __("title_is_toll") %></div>
                        <div class="invo_one_rgt">$<%= (detail.toll_amount).toFixed(2) %></div>
                      </div>
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_promo_bonus") %></div>
                        <div class="invo_one_rgt">$<%= (detail.promo_payment).toFixed(2) %></div>
                      </div>
                      <div class="invo_total invo_total_final">
                        <div class="invo_one_lft"><%= __("title_total") %></div>
                        <div class="invo_one_rgt">$<%= (detail.total).toFixed(2) %></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="invoice">
                  <div class="invo_head cont_top">
                    <h1><%= __("title_user_details") %></h1>
                  </div>

                  <div class="invoice_table_bg">
                    <div class="invoice_table">
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_wallet_payment") %></div>
                        <div class="invo_one_rgt">$<%= (detail.wallet_payment).toFixed(2) %></div>
                      </div>
                      <div class="invo_one invo_one_bg">
                        <div class="invo_one_lft"><%= __("title_card_payment") %></div>
                        <div class="invo_one_rgt">$<%= (detail.card_payment).toFixed(2) %></div>
                      </div>
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_cash_payment") %></div>
                        <div class="invo_one_rgt">$<%= (detail.cash_payment).toFixed(2) %></div>
                      </div>
                      <div class="invo_one invo_one_bg">
                        <div class="invo_one_lft"><%= __("title_total_remaining_payment") %></div>
                        <div class="invo_one_rgt">$<%= (detail.remaining_payment).toFixed(2) %></div>
                      </div>
                    </div>
                  </div>
                </div>
                <% } %>

                <% if( type != "corporate"){ %>
                <div class="invoice">
                  <div class="invo_head cont_top">
                    <h1><%= __("title_total_provider_earning") %></h1>
                  </div>

                  <div class="invoice_table_bg">
                    <div class="invoice_table">
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_provider_profit") %></div>
                        <div class="invo_one_rgt">$<%= (detail.provider_profit_fees).toFixed(2) %></div>
                      </div>
                      <div class="invo_one invo_one_bg">
                        <div class="invo_one_lft"><%= __("title_is_trip") %></div>
                        <div class="invo_one_rgt">$<%= (detail.tip_amount).toFixed(2) %></div>
                      </div>
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_is_toll") %></div>
                        <div class="invo_one_rgt">$<%= (detail.toll_amount).toFixed(2) %></div>
                      </div>
                      <div class="invo_one invo_one_bg">
                        <div class="invo_one_lft"><%= __("title_provider_tax") %></div>
                        <div class="invo_one_rgt">$<%= (detail.provider_tax_fee).toFixed(2) %></div>
                      </div>
                      <div class="invo_one">
                        <div class="invo_one_lft"><%= __("title_provider_miscellaneous_fee") %></div>
                        <div class="invo_one_rgt">$<%= (detail.provider_miscellaneous_fee).toFixed(2) %></div>
                      </div>
                      <div class="invo_total invo_total_final">
                        <div class="invo_one_lft"><%= __("title_total_provider_earning") %></div>
                        <div class="invo_one_rgt">$<%= (detail.provider_service_fees).toFixed(2) %></div>
                      </div>
                    </div>
                  </div>
                </div>
                <% } %>
              </div>
            </div>
            <!--invoice section-->
          </div>
        </div>

      </div>
    <!--content scection-->
  </div>
</div>
</body>
  <!-- END PAGE CONTENT WRAPPER -->
</div>
<!-- END PAGE CONTENT -->
</div>
<!-- END PAGE CONTAINER -->
<script type="text/javascript" src='js/dist/pdfmake.min.js'></script>
<script type="text/javascript" src='js/dist/vfs_fonts.js'></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>


<script type="text/javascript">
  $(document).ready(function() {
    var totalMinutes = <%= detail.total_time %>;

// Convert minutes to hours and minutes
var hours = Math.floor(totalMinutes / 60); // Get the whole number of hours
var remainingMinutes = totalMinutes % 60; // Get the remaining minutes

// Format the result as "hours:minutes"
let formattedTime = 0 + " hours " + 0 + " mins";
if(hours > 0){
  formattedTime = hours + " hours " + remainingMinutes + " mins";
}else{
  formattedTime = remainingMinutes + " mins";
}

// Update the HTML element with the converted time
document.getElementById("total_time").textContent = formattedTime;

    $('#demo').click(function() {
      $('#pdf_download_btn').hide()
      var HTML_Width = $(".main").width();
    var HTML_Height = $(".main").height();
    var top_left_margin = 15;
    var PDF_Width = HTML_Width+(top_left_margin*2);
    var PDF_Height = (PDF_Width*1.5)+(top_left_margin*2);
    var canvas_image_width = HTML_Width;
    var canvas_image_height = HTML_Height;

    var totalPDFPages = Math.ceil(HTML_Height/PDF_Height)-1;


    html2canvas($(".main")[0],{allowTaint:true}).then(function(canvas) {
        canvas.getContext('2d');

        var imgData = canvas.toDataURL("image/jpeg", 1.0);
        var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
        pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin,canvas_image_width,canvas_image_height);


        for (var i = 1; i <= totalPDFPages; i++) {
            pdf.addPage(PDF_Width, PDF_Height);
            pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height*i)+(top_left_margin*4),canvas_image_width,canvas_image_height);
        }
        const date = Math.floor(new Date().getTime() / 1000);

        const filename = date + ' <%= detail.invoice_number %>' + '.pdf'
        pdf.save(filename);
        $('#pdf_download_btn').show()
    });

  });

  });
</script>
<% if(type == "provider") { %>
<% include provider/provider_footer.html %>
<% } else { %>
<% include footer_list.html %>
<% } %>
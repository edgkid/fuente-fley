var utils = require('./utils')
require('./constant')
var myAnalytics = require('./provider_analytics')
var allemails = require('./emails')
var Trip = require('mongoose').model('Trip')
var Trip_history = require('mongoose').model('Trip_history')
var Type = require('mongoose').model('Type')
var Trip_Service = require('mongoose').model('trip_service')
var User = require('mongoose').model('User')
var Provider = require('mongoose').model('Provider')
var TripLocation = require('mongoose').model('trip_location')
var Citytype = require('mongoose').model('city_type')
var Reviews = require('mongoose').model('Reviews')
var Promo_Code = require('mongoose').model('Promo_Code')
var User_promo_use = require('mongoose').model('User_promo_use')
var Card = require('mongoose').model('Card')
var EmergencyContactDetail = require('mongoose').model(
    'emergency_contact_detail'
)
var pad = require('pad-left')
var Country = require('mongoose').model('Country')
var City = require('mongoose').model('City')
var moment = require('moment')
var geolib = require('geolib')
var Citytype = require('mongoose').model('city_type')
var CityZone = require('mongoose').model('CityZone')
var ZoneValue = require('mongoose').model('ZoneValue')
var Airport = require('mongoose').model('Airport')
var AirportCity = require('mongoose').model('Airport_to_City')
var CitytoCity = require('mongoose').model('City_to_City')
var Partner = require('mongoose').model('Partner')
let Type_Models = require('mongoose').model('type_model')
let Type_Services = require('mongoose').model('type_services')
let Type_Capacity = require('mongoose').model('type_capacity')
let Helper = require('mongoose').model('Helper')
var console = require('./console')
var utils = require('./utils')
var Corporate = require('mongoose').model('Corporate')
const https = require('https')
let country_list = require('../../country_list.json')
var cards = require('./card')
const Provider_Document = require('mongoose').model('Provider_Document')
const Service_Specifications = require('mongoose').model(
    'service_specifications'
)
const mongoose = require('mongoose')
const Schema = mongoose.Types.ObjectId
const tripService = require('../services/trip.service')
const axios = require('axios').default
const Settings = require('mongoose').model('Settings')
const Partner_Vehicle_Document = require('mongoose').model('Partner_Vehicle_Document');

const { getStopsWithoutDestination } = require('./utils/trips')

////  CREATE TRIP SERVICE //// ////////
exports.create_trip = async function (
    user_data,
    trip_type,
    service_type_id,
    req_data,
    req,
    response
) {
    let sub_corporate_id = null
    let trip_approve = 0
    let corporate_data = null
    if (req_data.car_rental_id == '') {
        delete req_data.car_rental_id
    }
    var tripData = req_data
    if (user_data.is_approved == 0) {
        response({
            success: false,
            error_code: error_message.ERROR_CODE_USER_NOT_APPROVED,
        })
    } else {
        var user_id = tripData.user_id
        if (tripData.trip_type !== undefined) {
            trip_type = tripData.trip_type
        }
        if (user_data.user_type_id) {
            corporate_data = await Corporate.findOne({
                _id: user_data.user_type_id,
            })
                .select({
                    is_use_fixed_partner_profit: 1,
                    is_damasco: 1,
                    is_own_service_type: 1,
                })
                .lean()
            if (corporate_data?.is_damasco) {
                tripData.is_damasco = 1
            }
        }
        if (user_data.user_type_id) {
            tripData.trip_type == constant_json.TRIP_TYPE_CORPORATE
            tripData.user_type_id = user_data.user_type_id
            user_id = user_data.user_type_id
            let sub_corporate = await Corporate.findOne({
                _id: req?.session?.corporate?._id,
            })
                .select({
                    _id: 1,
                    is_trip_approve: 1,
                })
                .lean()
            if (!sub_corporate) {
                let associated_sub_corporates = await Corporate.find({
                    corporate_type_userid: user_data._id,
                })
                    .select({
                        _id: 1,
                        is_trip_approve: 1,
                    })
                    .lean()
                sub_corporate =
                    associated_sub_corporates.length == 1
                        ? associated_sub_corporates[0]
                        : null
            }

            if (sub_corporate) {
                if (
                    req.body.created_with_api != undefined &&
                    req.body.created_with_api
                ) {
                    trip_approve = 1
                    sub_corporate_id = sub_corporate ? sub_corporate._id : null
                } else {
                    sub_corporate_id = sub_corporate ? sub_corporate._id : null
                    trip_approve = sub_corporate.is_trip_approve
                        ? sub_corporate.is_trip_approve
                        : 0
                    trip_approve =
                        req.session.corporate !== undefined &&
                        !req.session.corporate.corporate_type_id
                            ? 0
                            : trip_approve
                }
            }
        }

        if (tripData.trip_type !== undefined) {
            trip_type = tripData.trip_type
        }

        Citytype.findOne({ _id: service_type_id }).then(
            (citytype) => {
                if (citytype) {
                    if (citytype.is_business == 1) {
                        var city_id = citytype.cityid
                        var country_id = citytype.countryid

                        Country.findOne({ _id: country_id }).then(
                            (country_data) => {
                                var payment_gateway_type =
                                    setting_detail.payment_gateway_type
                                if (
                                    country_data &&
                                    country_data.payment_gateways &&
                                    country_data.payment_gateways.length > 0
                                ) {
                                    payment_gateway_type =
                                        country_data.payment_gateways[0]
                                }

                                Card.find({
                                    user_id: user_id,
                                    payment_gateway_type: payment_gateway_type,
                                }).then(
                                    (card) => {
                                        if (
                                            tripData.payment_mode ==
                                                Number(
                                                    constant_json.PAYMENT_MODE_CARD
                                                ) &&
                                            Number(payment_gateway_type) !==
                                                PAYMENT_GATEWAY.payu
                                        ) {
                                            if (card.length == 0) {
                                                return response({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_ADD_CREDIT_CARD_FIRST,
                                                })
                                            }
                                        }

                                        City.findOne({ _id: city_id }).then(
                                            async (city_detail) => {
                                                if (city_detail) {
                                                    if (
                                                        city_detail.isBusiness ===
                                                        1
                                                    ) {
                                                        var is_fixed_fare = false
                                                        var fixed_price = 0
                                                        var received_trip_from_gender =
                                                            []
                                                        var provider_language =
                                                            []
                                                        var accessibility = []
                                                        var type_detail =
                                                            await Type.findById(
                                                                citytype.typeid
                                                            )

                                                        const destination_addresses =
                                                            getStopsWithoutDestination(
                                                                tripData.destination_addresses,
                                                                tripData.delivery_details
                                                            )
                                                        // Start 6 March //
                                                        if (
                                                            tripData.is_fixed_fare !=
                                                            undefined
                                                        ) {
                                                            is_fixed_fare =
                                                                tripData.is_fixed_fare
                                                            if (is_fixed_fare) {
                                                                fixed_price =
                                                                    tripData.fixed_price
                                                            }
                                                        }

                                                        if (
                                                            tripData.received_trip_from_gender !=
                                                            undefined
                                                        ) {
                                                            received_trip_from_gender =
                                                                tripData.received_trip_from_gender
                                                        }

                                                        if (
                                                            tripData.provider_language !=
                                                            undefined
                                                        ) {
                                                            provider_language =
                                                                tripData.provider_language
                                                        }

                                                        if (
                                                            tripData.accessibility !=
                                                            undefined
                                                        ) {
                                                            accessibility =
                                                                tripData.accessibility
                                                        }
                                                        // End 6 March //

                                                        var dateNow = new Date()
                                                        var schedule_start_time =
                                                            null
                                                        var server_start_time_for_schedule =
                                                            null
                                                        var is_schedule_trip = false
                                                        var start_date_tag = ''
                                                        if (
                                                            tripData.start_time
                                                        ) {
                                                            is_schedule_trip = true
                                                            schedule_start_time =
                                                                Number(
                                                                    tripData.start_time
                                                                )
                                                            var addMiliSec =
                                                                dateNow.getTime() +
                                                                +schedule_start_time
                                                            server_start_time_for_schedule =
                                                                new Date(
                                                                    addMiliSec
                                                                )
                                                        }

                                                        // Configurar origen y destino según el tipo de courier
                                                        if (
                                                            tripData.courier_type ==
                                                                constant_json.COURIER_FLOW ||
                                                            tripData.courier_type ==
                                                                constant_json.COURIER_ESCOMBRO_FLOW
                                                        ) {
                                                            tripData.sourceLocation =
                                                                [
                                                                    tripData.latitude,
                                                                    tripData.longitude,
                                                                ]
                                                            tripData.source_address =
                                                                tripData.source_address ||
                                                                ''
                                                        } else {
                                                            tripData.sourceLocation =
                                                                [
                                                                    tripData.d_latitude,
                                                                    tripData.d_longitude,
                                                                ]
                                                            tripData.source_address =
                                                                ''
                                                        }
                                                        var trip = new Trip({
                                                            user_last_name:
                                                                user_data.last_name,
                                                            user_first_name:
                                                                user_data.first_name,
                                                            service_type_id:
                                                                citytype._id,
                                                            service_type_name:
                                                                citytype.typename,
                                                            type_id:
                                                                citytype.typeid,
                                                            user_id:
                                                                user_data._id,
                                                            is_trip_inside_zone_queue:
                                                                tripData.is_trip_inside_zone_queue,
                                                            token: tripData.token,
                                                            current_provider:
                                                                null,
                                                            provider_id: null,
                                                            confirmed_provider:
                                                                null,
                                                            trip_type:
                                                                trip_type,
                                                            car_rental_id:
                                                                tripData.car_rental_id,
                                                            is_surge_hours:
                                                                tripData.is_surge_hours,
                                                            surge_multiplier:
                                                                tripData.surge_multiplier,
                                                            hotel_name:
                                                                tripData.hotel_name,
                                                            room_number:
                                                                tripData.room_number,
                                                            floor: tripData.floor,
                                                            source_address:
                                                                tripData.source_address,
                                                            destination_address:
                                                                '',
                                                            sourceLocation:
                                                                tripData.sourceLocation,
                                                            payment_gateway_type:
                                                                payment_gateway_type,
                                                            destinationLocation:
                                                                [],
                                                            initialDestinationLocation:
                                                                [],
                                                            initial_destination_address:
                                                                '',
                                                            timezone:
                                                                city_detail.timezone,
                                                            payment_mode:
                                                                tripData.payment_mode,
                                                            user_create_time:
                                                                tripData.user_create_time,
                                                            payment_id:
                                                                tripData.payment_id,
                                                            unit: city_detail.unit,
                                                            // Start 6 March //
                                                            country_id:
                                                                country_id,
                                                            city_id:
                                                                city_detail._id,
                                                            fixed_price:
                                                                fixed_price,
                                                            is_fixed_fare:
                                                                is_fixed_fare,
                                                            is_provider_earning_set_in_wallet: false,
                                                            received_trip_from_gender:
                                                                received_trip_from_gender,
                                                            provider_language:
                                                                provider_language,
                                                            accessibility:
                                                                accessibility,
                                                            // End 6 March //
                                                            // start 9 jul //
                                                            is_schedule_trip:
                                                                is_schedule_trip,
                                                            schedule_start_time:
                                                                schedule_start_time,
                                                            server_start_time_for_schedule:
                                                                server_start_time_for_schedule,
                                                            user_app_version:
                                                                user_data.app_version,
                                                            user_device_type:
                                                                user_data.device_type,
                                                            zone_queue_id:
                                                                tripData.zone_queue_id,
                                                            destination_addresses,
                                                            is_ride_share:
                                                                citytype.is_ride_share !=
                                                                1
                                                                    ? 0
                                                                    : 1,
                                                            ride_share_limit:
                                                                type_detail.ride_share_limit
                                                                    ? type_detail.ride_share_limit
                                                                    : null,
                                                            // end 9 jul //
                                                            created_by:
                                                                tripData.created_by,
                                                            pickup_details:
                                                                tripData.pickup_details,
                                                            selected_courier_type:
                                                                tripData.courier_type,
                                                            delivery_details:
                                                                tripData.delivery_details,
                                                            destination_stops:
                                                                tripData.destination_stops ||
                                                                [],
                                                            estimated_distance:
                                                                tripData.estimated_distance ||
                                                                0,
                                                            night_shift:
                                                                tripData.night_shifts_value,
                                                            boat_ticket:
                                                                tripData.ferry_ticket_value,
                                                            optimize_field:
                                                                tripData.optimize_field,
                                                            api_partner_id:
                                                                tripData.api_partner_id,
                                                        })

                                                        if (
                                                            citytype.model_type
                                                        ) {
                                                            trip.model_type =
                                                                citytype.model_type
                                                        }
                                                        if (
                                                            country_data.countryname ===
                                                                'Panama' &&
                                                            tripData?.selected_procedure
                                                        ) {
                                                            trip.selected_procedure =
                                                                tripData.selected_procedure
                                                            if (
                                                                tripData?.selected_transit_service
                                                            ) {
                                                                trip.selected_transit_service =
                                                                    tripData.selected_transit_service
                                                            }
                                                            if (
                                                                tripData?.selected_transit_type_number
                                                            ) {
                                                                trip.selected_transit_type_number =
                                                                    tripData.selected_transit_type_number
                                                            }
                                                        }
                                                        if (sub_corporate_id) {
                                                            if (
                                                                req.body
                                                                    .created_with_api !=
                                                                    undefined &&
                                                                req.body
                                                                    .created_with_api
                                                            ) {
                                                                trip.trip_approved = 1
                                                                trip.sub_corporate_id =
                                                                    sub_corporate_id
                                                            } else {
                                                                trip.sub_corporate_id =
                                                                    sub_corporate_id
                                                                trip.trip_approved =
                                                                    trip_approve ==
                                                                    1
                                                                        ? 0
                                                                        : trip.trip_approved
                                                            }
                                                        }
                                                        if (
                                                            server_start_time_for_schedule
                                                        ) {
                                                            trip.start_date_tag =
                                                                server_start_time_for_schedule
                                                        } else {
                                                            trip.start_date_tag =
                                                                trip.created_at
                                                        }
                                                        if (
                                                            tripData?.is_damasco
                                                        ) {
                                                            trip.is_damasco = 1
                                                        }
                                                        // Configurar destino según el tipo de courier y datos disponibles
                                                        if (
                                                            tripData.d_longitude &&
                                                            tripData.d_latitude &&
                                                            (tripData.courier_type ==
                                                                constant_json.COURIER_FLOW ||
                                                                tripData.courier_type ==
                                                                    constant_json.COURIER_CISTERNA_FLOW)
                                                        ) {
                                                            trip.destinationLocation =
                                                                [
                                                                    tripData.d_latitude,
                                                                    tripData.d_longitude,
                                                                ]
                                                            trip.initialDestinationLocation =
                                                                trip.destinationLocation
                                                            trip.destination_address =
                                                                tripData.destination_address ||
                                                                ''
                                                            trip.initial_destination_address =
                                                                trip.destination_address
                                                        } else if (
                                                            tripData.d_longitude &&
                                                            tripData.d_latitude
                                                        ) {
                                                            // Si hay coordenadas de destino, usarlas independientemente del tipo
                                                            trip.destinationLocation =
                                                                [
                                                                    tripData.d_latitude,
                                                                    tripData.d_longitude,
                                                                ]
                                                            trip.initialDestinationLocation =
                                                                trip.destinationLocation
                                                            trip.destination_address =
                                                                tripData.destination_address ||
                                                                ''
                                                            trip.initial_destination_address =
                                                                trip.destination_address
                                                        } else {
                                                            // Fallback: usar coordenadas de origen como destino temporal
                                                            trip.destinationLocation =
                                                                [
                                                                    tripData.latitude,
                                                                    tripData.longitude,
                                                                ]
                                                            trip.destination_address =
                                                                tripData.destination_address ||
                                                                ''
                                                        }
                                                        if (
                                                            user_data.user_type_id
                                                        ) {
                                                            trip.user_type =
                                                                tripData.user_type
                                                            trip.user_type_id =
                                                                user_data.user_type_id
                                                        } else {
                                                            trip.user_type =
                                                                constant_json.USER_TYPE_NORMAL
                                                            trip.user_type_id =
                                                                null
                                                        }

                                                        if (
                                                            tripData.device ==
                                                                undefined &&
                                                            trip_type !=
                                                                constant_json.TRIP_TYPE_PROVIDER
                                                        ) {
                                                            trip.is_tip =
                                                                setting_detail.is_tip
                                                        }
                                                        trip.is_toll =
                                                            setting_detail.is_toll

                                                        if (
                                                            trip_type !=
                                                            constant_json.TRIP_TYPE_PROVIDER
                                                        ) {
                                                            trip.is_otp_verification =
                                                                setting_detail.is_otp_verification_start_trip
                                                            trip.confirmation_code =
                                                                setting_detail.is_otp_verification_start_trip
                                                                    ? utils.generateOtp(
                                                                          6
                                                                      )
                                                                    : null
                                                        }

                                                        if (country_data) {
                                                            if (
                                                                country_data.isBusiness ===
                                                                1
                                                            ) {
                                                                let model_details =
                                                                    {}
                                                                let service_details =
                                                                    {}
                                                                let capacity_details =
                                                                    {}
                                                                if (
                                                                    tripData.is_use_model ==
                                                                        1 &&
                                                                    tripData.selected_model_id
                                                                ) {
                                                                    let model =
                                                                        await Type_Models.findOne(
                                                                            {
                                                                                _id: tripData.selected_model_id,
                                                                            }
                                                                        )
                                                                    if (
                                                                        !model
                                                                    ) {
                                                                        return response(
                                                                            {
                                                                                success: false,
                                                                                error_code:
                                                                                    error_message.ERROR_CODE_OUR_MODEL_NOT_AVAILABLE,
                                                                            }
                                                                        )
                                                                    }
                                                                    model_details =
                                                                        {
                                                                            _id: Schema(
                                                                                model._id
                                                                            ),
                                                                            model_name:
                                                                                model.model_name,
                                                                        }

                                                                    trip.model_details =
                                                                        model_details
                                                                }

                                                                if (
                                                                    tripData.is_use_service ==
                                                                        1 &&
                                                                    tripData.selected_service_id
                                                                ) {
                                                                    let selected_service =
                                                                        await Type_Services.findOne(
                                                                            {
                                                                                _id: tripData.selected_service_id,
                                                                            }
                                                                        )
                                                                    if (
                                                                        !selected_service
                                                                    ) {
                                                                        return response(
                                                                            {
                                                                                success: false,
                                                                                error_code:
                                                                                    error_message.ERROR_CODE_OUR_SERVICES_NOT_AVAILABLE,
                                                                            }
                                                                        )
                                                                    }
                                                                    service_details =
                                                                        {
                                                                            _id: Schema(
                                                                                selected_service._id
                                                                            ),
                                                                            service_name:
                                                                                selected_service.service_name,
                                                                        }
                                                                    trip.service_details =
                                                                        service_details
                                                                }

                                                                if (
                                                                    tripData.is_use_capacity ==
                                                                        1 &&
                                                                    tripData.selected_capacity_id
                                                                ) {
                                                                    let capacity =
                                                                        await Type_Capacity.findOne(
                                                                            {
                                                                                _id: tripData.selected_capacity_id,
                                                                            }
                                                                        )
                                                                    if (
                                                                        !capacity
                                                                    ) {
                                                                        return response(
                                                                            {
                                                                                success: false,
                                                                                error_code:
                                                                                    error_message.ERROR_CODE_OUR_CAPACITY_NOT_AVAILABLE,
                                                                            }
                                                                        )
                                                                    }
                                                                    capacity_details =
                                                                        {
                                                                            _id: Schema(
                                                                                capacity._id
                                                                            ),
                                                                            capacity_name:
                                                                                capacity.capacity_name,
                                                                            unit: capacity.unit,
                                                                        }
                                                                    trip.capacity_details =
                                                                        capacity_details
                                                                }
                                                                if (
                                                                    tripData.specification_id &&
                                                                    tripData.specification_id !=
                                                                        ''
                                                                ) {
                                                                    let specification =
                                                                        await Service_Specifications.findOne(
                                                                            {
                                                                                _id: tripData.specification_id,
                                                                            }
                                                                        )
                                                                    if (
                                                                        !specification
                                                                    ) {
                                                                        return response(
                                                                            {
                                                                                success: false,
                                                                                error_code:
                                                                                    error_message.ERROR_CODE_SELECTED_SPECIFICATION_NOT_AVAILABLE,
                                                                            }
                                                                        )
                                                                    }
                                                                    specification_details =
                                                                        {
                                                                            _id: Schema(
                                                                                specification._id
                                                                            ),
                                                                            specification_name:
                                                                                specification.specification_name,
                                                                        }
                                                                    trip.specification_details =
                                                                        specification_details
                                                                }
                                                                var currency =
                                                                    ''
                                                                var currencycode =
                                                                    ''
                                                                if (
                                                                    country_data
                                                                ) {
                                                                    currency =
                                                                        country_data.currencysign
                                                                    currencycode =
                                                                        country_data.currencycode
                                                                }
                                                                trip.currency =
                                                                    currency
                                                                trip.currencycode =
                                                                    currencycode
                                                                user_data.total_request =
                                                                    user_data.total_request +
                                                                    1
                                                                user_data.save()

                                                                var service_type_id =
                                                                    tripData.service_type_id
                                                                if (
                                                                    tripData.car_rental_id
                                                                ) {
                                                                    service_type_id =
                                                                        tripData.car_rental_id
                                                                }

                                                                Trip_Service.find(
                                                                    {
                                                                        service_type_id:
                                                                            service_type_id,
                                                                    },
                                                                    async function (
                                                                        err,
                                                                        tripservice
                                                                    ) {
                                                                        if (
                                                                            tripservice &&
                                                                            tripservice.length >
                                                                                0
                                                                        ) {
                                                                            trip.trip_service_city_type_id =
                                                                                tripservice[0]._id
                                                                            let insurance_fee =
                                                                                tripservice[0]
                                                                                    .cost_travel_insurance ||
                                                                                0
                                                                            let ferry_ticket_price =
                                                                                tripData.ferry_ticket_value ||
                                                                                0
                                                                            if (
                                                                                is_fixed_fare
                                                                            ) {
                                                                                trip.provider_service_fees =
                                                                                    Number(
                                                                                        (
                                                                                            (fixed_price -
                                                                                                insurance_fee -
                                                                                                ferry_ticket_price) *
                                                                                            tripservice[0]
                                                                                                .provider_profit *
                                                                                            0.01
                                                                                        ).toFixed(
                                                                                            3
                                                                                        )
                                                                                    )
                                                                                let destLocsFixedprofit =
                                                                                    tripData.d_longitude &&
                                                                                    tripData.d_latitude
                                                                                        ? [
                                                                                              tripData.d_latitude,
                                                                                              tripData.d_longitude,
                                                                                          ]
                                                                                        : []
                                                                                let selected_details =
                                                                                    {
                                                                                        selected_model_id:
                                                                                            tripData?.selected_model_id,
                                                                                        selected_service_id:
                                                                                            tripData?.selected_service_id,
                                                                                        selected_capacity_id:
                                                                                            tripData?.selected_capacity_id,
                                                                                        sourceLocation:
                                                                                            tripData?.sourceLocation ||
                                                                                            [],
                                                                                        destinationLocation:
                                                                                            destLocsFixedprofit,
                                                                                        provider_service_fees:
                                                                                            trip.provider_service_fees,
                                                                                        insurance_fee,
                                                                                        ferry_ticket_price,
                                                                                        provider_profit:
                                                                                            tripservice[0]
                                                                                                .provider_profit ||
                                                                                            0,
                                                                                        fixed_price:
                                                                                            fixed_price,
                                                                                    }
                                                                                if (
                                                                                    citytype.user_type_id &&
                                                                                    corporate_data?.is_use_fixed_partner_profit &&
                                                                                    corporate_data?.is_own_service_type
                                                                                ) {
                                                                                    let provider_static_profit =
                                                                                        await getCorporateStaticPartnerProfit(
                                                                                            citytype,
                                                                                            selected_details,
                                                                                            city_detail
                                                                                        )
                                                                                    trip.provider_service_fees =
                                                                                        Number(
                                                                                            provider_static_profit
                                                                                        )
                                                                                }
                                                                            }
                                                                        } else {
                                                                            var trip_service =
                                                                                new Trip_Service(
                                                                                    {
                                                                                        _id: new Schema(),
                                                                                        service_type_id:
                                                                                            citytype._id,
                                                                                        city_id:
                                                                                            citytype.cityid,
                                                                                        service_type_name:
                                                                                            citytype.typename,
                                                                                        min_fare:
                                                                                            citytype.min_fare,
                                                                                        typename:
                                                                                            citytype.typename,
                                                                                    }
                                                                                )
                                                                            await trip_service.save()
                                                                            trip.trip_service_city_type_id =
                                                                                trip_service._id
                                                                        }
                                                                        var multiple_trips =
                                                                            []
                                                                        if (
                                                                            trip_type ==
                                                                                constant_json.TRIP_TYPE_CORPORATE &&
                                                                            tripData.user_type_id &&
                                                                            Number(
                                                                                tripData.number_of_trips
                                                                            ) >
                                                                                1
                                                                        ) {
                                                                            trip.main_tripid =
                                                                                trip._id
                                                                            var trip_object =
                                                                                {
                                                                                    user_last_name:
                                                                                        trip.last_name,
                                                                                    user_first_name:
                                                                                        trip.user_first_name,
                                                                                    service_type_id:
                                                                                        trip.service_type_id,
                                                                                    service_type_name:
                                                                                        trip.service_type_name,
                                                                                    type_id:
                                                                                        trip.type_id,
                                                                                    user_id:
                                                                                        trip.user_id,
                                                                                    is_trip_inside_zone_queue:
                                                                                        trip.is_trip_inside_zone_queue,
                                                                                    token: trip.token,
                                                                                    current_provider:
                                                                                        trip.current_provider,
                                                                                    provider_id:
                                                                                        trip.provider_id,
                                                                                    confirmed_provider:
                                                                                        trip.confirmed_provider,
                                                                                    trip_type:
                                                                                        trip.trip_type,
                                                                                    car_rental_id:
                                                                                        trip.car_rental_id,
                                                                                    is_surge_hours:
                                                                                        trip.is_surge_hours,
                                                                                    surge_multiplier:
                                                                                        trip.surge_multiplier,
                                                                                    hotel_name:
                                                                                        trip.hotel_name,
                                                                                    room_number:
                                                                                        trip.room_number,
                                                                                    floor: trip.floor,
                                                                                    source_address:
                                                                                        trip.source_address,
                                                                                    destination_address:
                                                                                        trip.destination_address,
                                                                                    sourceLocation:
                                                                                        trip.sourceLocation,
                                                                                    payment_gateway_type:
                                                                                        trip.payment_gateway_type,
                                                                                    destinationLocation:
                                                                                        trip.destinationLocation,
                                                                                    initialDestinationLocation:
                                                                                        trip.initialDestinationLocation,
                                                                                    initial_destination_address:
                                                                                        trip.initial_destination_address,
                                                                                    timezone:
                                                                                        trip.timezone,
                                                                                    payment_mode:
                                                                                        trip.payment_mode,
                                                                                    user_create_time:
                                                                                        trip.user_create_time,
                                                                                    payment_id:
                                                                                        trip.payment_id,
                                                                                    unit: trip.unit,
                                                                                    country_id:
                                                                                        trip.country_id,
                                                                                    city_id:
                                                                                        trip.city_id,
                                                                                    fixed_price:
                                                                                        trip.fixed_price,
                                                                                    is_fixed_fare:
                                                                                        trip.is_fixed_fare,
                                                                                    is_provider_earning_set_in_wallet:
                                                                                        trip.is_provider_earning_set_in_wallet,
                                                                                    received_trip_from_gender:
                                                                                        trip.received_trip_from_gender,
                                                                                    provider_language:
                                                                                        trip.provider_language,
                                                                                    accessibility:
                                                                                        trip.accessibility,
                                                                                    is_schedule_trip:
                                                                                        trip.is_schedule_trip,
                                                                                    schedule_start_time:
                                                                                        trip.schedule_start_time,
                                                                                    server_start_time_for_schedule:
                                                                                        trip.server_start_time_for_schedule,
                                                                                    user_app_version:
                                                                                        trip.user_app_version,
                                                                                    user_device_type:
                                                                                        trip.user_device_type,
                                                                                    zone_queue_id:
                                                                                        trip.zone_queue_id,
                                                                                    destination_addresses:
                                                                                        trip.destination_addresses,
                                                                                    is_ride_share:
                                                                                        trip.is_ride_share,
                                                                                    ride_share_limit:
                                                                                        trip.ride_share_limit,
                                                                                    created_by:
                                                                                        trip.created_by,
                                                                                    pickup_details:
                                                                                        trip.pickup_details,
                                                                                    selected_courier_type:
                                                                                        trip.selected_courier_type,
                                                                                    delivery_details:
                                                                                        trip.delivery_details,
                                                                                    model_type:
                                                                                        trip.model_type,
                                                                                    start_date_tag:
                                                                                        trip.start_date_tag,
                                                                                    user_type:
                                                                                        trip.user_type,
                                                                                    user_type_id:
                                                                                        trip.user_type_id,
                                                                                    is_tip: trip.is_tip,
                                                                                    is_toll:
                                                                                        trip.is_toll,
                                                                                    is_otp_verification:
                                                                                        trip.is_otp_verification,
                                                                                    confirmation_code:
                                                                                        trip.confirmation_code,
                                                                                    model_details:
                                                                                        trip.model_details,
                                                                                    service_details:
                                                                                        trip.service_details,
                                                                                    capacity_details:
                                                                                        trip.capacity_details,
                                                                                    currency:
                                                                                        trip.currency,
                                                                                    currencycode:
                                                                                        trip.currencycode,
                                                                                    trip_service_city_type_id:
                                                                                        trip.trip_service_city_type_id,
                                                                                    provider_service_fees:
                                                                                        trip.provider_service_fees,
                                                                                    destination_stops:
                                                                                        trip.destination_stops,
                                                                                    estimated_distance:
                                                                                        trip.estimated_distance,
                                                                                    night_shift:
                                                                                        tripData.night_shifts_value,
                                                                                    boat_ticket:
                                                                                        tripData.ferry_ticket_value,
                                                                                    main_tripid:
                                                                                        trip._id,
                                                                                    optimize_field:
                                                                                        tripData.optimize_field,
                                                                                }
                                                                            if (
                                                                                trip.sub_corporate_id
                                                                            ) {
                                                                                if (
                                                                                    req
                                                                                        .body
                                                                                        .created_with_api !=
                                                                                        undefined &&
                                                                                    req
                                                                                        .body
                                                                                        .created_with_api
                                                                                ) {
                                                                                    trip_object.trip_approved = 1
                                                                                    trip_object.sub_corporate_id =
                                                                                        sub_corporate_id
                                                                                } else {
                                                                                    trip_object.sub_corporate_id =
                                                                                        sub_corporate_id
                                                                                    trip_object.trip_approved =
                                                                                        trip.trip_approved
                                                                                            ? 0
                                                                                            : trip.trip_approved
                                                                                }
                                                                            }
                                                                            if (
                                                                                trip?.is_damasco
                                                                            ) {
                                                                                trip_object.is_damasco = 1
                                                                            }
                                                                            if (
                                                                                country_data.countryname ===
                                                                                    'Panama' &&
                                                                                trip?.selected_procedure
                                                                            ) {
                                                                                trip_object.selected_procedure =
                                                                                    trip.selected_procedure
                                                                                if (
                                                                                    trip?.selected_transit_service
                                                                                ) {
                                                                                    trip_object.selected_transit_service =
                                                                                        trip.selected_transit_service
                                                                                }
                                                                                if (
                                                                                    trip?.selected_transit_type_number
                                                                                ) {
                                                                                    trip_object.selected_transit_type_number =
                                                                                        trip.selected_transit_type_number
                                                                                }
                                                                            }
                                                                        }

                                                                        await trip
                                                                            .save()
                                                                            .then(
                                                                                async () => {
                                                                                    var triplocation =
                                                                                        new TripLocation(
                                                                                            {
                                                                                                tripID: trip._id,
                                                                                                trip_unique_id:
                                                                                                    trip.unique_id,
                                                                                                providerStartTime:
                                                                                                    dateNow,
                                                                                                providerStartLocation:
                                                                                                    [
                                                                                                        0,
                                                                                                        0,
                                                                                                    ],
                                                                                                startTripTime:
                                                                                                    dateNow,
                                                                                                startTripLocation:
                                                                                                    [
                                                                                                        0,
                                                                                                        0,
                                                                                                    ],
                                                                                                endTripTime:
                                                                                                    dateNow,
                                                                                                endTripLocation:
                                                                                                    [
                                                                                                        0,
                                                                                                        0,
                                                                                                    ],
                                                                                                providerStartToStartTripLocations:
                                                                                                    [],
                                                                                                startTripToEndTripLocations:
                                                                                                    [],
                                                                                                googlePathStartLocationToPickUpLocation:
                                                                                                    '',
                                                                                                googlePickUpLocationToDestinationLocation:
                                                                                                    '',
                                                                                            }
                                                                                        )

                                                                                    await triplocation.save(
                                                                                        function () {},
                                                                                        () => {}
                                                                                    )

                                                                                    if (
                                                                                        trip_type ==
                                                                                            constant_json.TRIP_TYPE_CORPORATE &&
                                                                                        tripData.user_type_id &&
                                                                                        Number(
                                                                                            tripData.number_of_trips
                                                                                        ) >
                                                                                            1
                                                                                    ) {
                                                                                        for (
                                                                                            var i = 1;
                                                                                            i <
                                                                                            Number(
                                                                                                tripData.number_of_trips
                                                                                            );
                                                                                            i++
                                                                                        ) {
                                                                                            let new_trip =
                                                                                                await Trip.create(
                                                                                                    trip_object
                                                                                                )

                                                                                            await TripLocation.create(
                                                                                                {
                                                                                                    tripID: new_trip._id,
                                                                                                    trip_unique_id:
                                                                                                        new_trip.unique_id,
                                                                                                    providerStartTime:
                                                                                                        dateNow,
                                                                                                    providerStartLocation:
                                                                                                        [
                                                                                                            0,
                                                                                                            0,
                                                                                                        ],
                                                                                                    startTripTime:
                                                                                                        dateNow,
                                                                                                    startTripLocation:
                                                                                                        [
                                                                                                            0,
                                                                                                            0,
                                                                                                        ],
                                                                                                    endTripTime:
                                                                                                        dateNow,
                                                                                                    endTripLocation:
                                                                                                        [
                                                                                                            0,
                                                                                                            0,
                                                                                                        ],
                                                                                                    providerStartToStartTripLocations:
                                                                                                        [],
                                                                                                    startTripToEndTripLocations:
                                                                                                        [],
                                                                                                    googlePathStartLocationToPickUpLocation:
                                                                                                        '',
                                                                                                    googlePickUpLocationToDestinationLocation:
                                                                                                        '',
                                                                                                }
                                                                                            )
                                                                                            multiple_trips.push(
                                                                                                new_trip
                                                                                            )
                                                                                        }
                                                                                    }
                                                                                    if (
                                                                                        setting_detail
                                                                                            .email_list_trip_notifiy
                                                                                            .length >
                                                                                        0
                                                                                    ) {
                                                                                        allemails.sendAdminNewRequest(
                                                                                            req,
                                                                                            trip.unique_id,
                                                                                            country_data._id
                                                                                        )
                                                                                    }
                                                                                    response(
                                                                                        {
                                                                                            success: true,
                                                                                            trip: trip,
                                                                                            multiple_trips:
                                                                                                multiple_trips,
                                                                                            message:
                                                                                                success_messages.MESSAGE_CODE_YOUR_FUTURE_TRIP_CREATE_SUCCESSFULLY,
                                                                                        }
                                                                                    )
                                                                                },
                                                                                (
                                                                                    err
                                                                                ) => {
                                                                                    console.log(
                                                                                        err
                                                                                    )

                                                                                    response(
                                                                                        {
                                                                                            success: false,
                                                                                            error_code:
                                                                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                                                        }
                                                                                    )
                                                                                }
                                                                            )
                                                                    }
                                                                )
                                                                    .sort({
                                                                        _id: -1,
                                                                    })
                                                                    .limit(1)
                                                            } else {
                                                                response({
                                                                    success: false,
                                                                    error_code:
                                                                        error_message.ERROR_CODE_OUR_BUSINESS_NOT_IN_YOUR_COUNTRY,
                                                                })
                                                            }
                                                        } else {
                                                            response({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_COUNTRY_NOT_FOUND,
                                                            })
                                                        }
                                                    } else {
                                                        response({
                                                            success: false,
                                                            error_code:
                                                                error_message.ERROR_CODE_OUR_BUSINESS_NOT_IN_YOUR_CITY,
                                                        })
                                                    }
                                                } else {
                                                    response({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_CITY_TYPE_NOT_FOUND,
                                                    })
                                                }
                                            },
                                            (err) => {
                                                console.log(err)
                                                response({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                })
                                            }
                                        )
                                    },
                                    (err) => {
                                        console.log(err)
                                        response({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        )
                    } else {
                        response({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_OUR_BUSINESS_NOT_IN_YOUR_AREA,
                        })
                    }
                } else {
                    response({
                        success: false,
                        error_code:
                            error_message.ERROR_CODE_CITY_TYPE_NOT_FOUND,
                    })
                }
            },
            (err) => {
                console.log(err)
                response({
                    success: false,
                    error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                })
            }
        )
    }
}

// upload  document image
exports.upload_trip_images = async function (req, res) {
    try {
        // console.log(req.body)
        // console.log(req.files)
        utils.check_request_params(
            req.body,
            [
                { name: 'user_id', type: 'string' },
                { name: 'trip_id', type: 'string' },
            ],
            async function (response) {
                if (!response.success) {
                    return res.json({
                        success: false,
                        error_code: response.error_code,
                        error_description: response.error_description,
                    })
                }
                if (
                    req.body?.user_type == constant_json.CORPORATE_UNIQUE_NUMBER
                ) {
                    if (typeof req.session.corporate == 'undefined') {
                        return
                    }
                } else {
                    const user = await User.findOne({
                        _id: Schema(req.body.user_id),
                        token: req.body.token,
                    })
                    if (!user) {
                        return res.json({
                            success: false,
                            error_code: error_message.ERROR_CODE_INVALID_TOKEN,
                        })
                    }
                }
                let trip = await Trip.findOne({ _id: Schema(req.body.trip_id) })
                let Table = Trip
                if (!trip) {
                    trip = await Trip_history.findOne({
                        _id: Schema(req.body.trip_id),
                    })
                    Table = Trip_history
                }
                if (!trip) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
                    })
                }

                var image_file = req.files
                var file_list_size = 0
                //console.log('---------courier images------------')
                let image_url = []
                if (image_file != undefined && image_file.length > 0) {
                    file_list_size = image_file.length
                    for (i = 0; i < file_list_size; i++) {
                        let mime_type = image_file[i].mimetype.split('/')[1]

                        var image_name = trip._id + utils.tokenGenerator(4)
                        var url =
                            utils.getImageFolderPath(req, 10) +
                            image_name +
                            '.' +
                            mime_type
                        utils.saveImageFromBrowser(
                            image_file[i].path,
                            image_name + '.' + mime_type,
                            10
                        )
                        image_url.push(url)
                    }
                }

                let is_trip_condition = {
                    _id: trip._id,
                    user_id: Schema(req.body.user_id),
                }
                let is_trip_update = { image_url: image_url }
                await Table.updateOne(is_trip_condition, is_trip_update)
                if (trip.main_tripid) {
                    await Table.updateMany(
                        { main_tripid: trip._id },
                        is_trip_update
                    )
                }
                return res.json({ success: true })
            }
        )
    } catch (e) {
        console.log(e)
    }
}

exports.upload_pod_images = async function (req, res) {
    // proof of delivery image upload
    // console.log(req.body)
    // console.log(req.files)
    try {
        let params_array = [
            { name: 'provider_id', type: 'string' },
            { name: 'trip_id', type: 'string' },
        ]
        let response = await utils.check_request_params_async(
            req.body,
            params_array
        )
        if (!response.success) {
            res.json(response)
            return
        }
        let provider = await Provider.findOne({ _id: req.body.provider_id })
        if (!provider) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
            })
            return
        }

        if (req.body.token != null && provider.token != req.body.token) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_INVALID_TOKEN,
            })
            return
        }

        let trip = await Trip.findOne({ _id: Schema(req.body.trip_id) })
        let Table = Trip
        if (!trip) {
            trip = await Trip_history.findOne({ _id: Schema(req.body.trip_id) })
            Table = Trip_history
        }
        if (!trip) {
            return res.json({
                success: false,
                error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
            })
        }
        var image_file = req.files
        var file_list_size = 0
        //console.log('---------courier images------------')
        let pod_image_url = []
        if (image_file != undefined && image_file.length > 0) {
            file_list_size = image_file.length
            for (i = 0; i < file_list_size; i++) {
                var image_name = trip._id + utils.tokenGenerator(4)
                var url =
                    utils.getImageFolderPath(req, 12) + image_name + '.jpg'
                utils.saveImageFromBrowser(
                    req.files[i].path,
                    image_name + '.jpg',
                    12
                )
                pod_image_url.push(url)
            }
        }

        let is_trip_condition = {
            _id: trip._id,
            provider_id: Schema(req.body.provider_id),
        }
        let is_trip_update = { pod_image_url: pod_image_url }
        await Table.updateOne(is_trip_condition, is_trip_update)
        return res.json({ success: true })
    } catch (error) {
        utils.error_response(error, res)
    }
}

exports.nearest_provider_list = function (citytype, req_data, response) {
    // console.log(req_data)
    var cityid = null
    if (citytype) {
        cityid = citytype.cityid
    }
    let trip_date_tag = utils.getTripDateTag(req_data, new Date())
    let check_trip_date_start = new Date(
        trip_date_tag.getTime() - 30 * 60 * 1000
    )
    let check_trip_date_end = new Date(trip_date_tag.getTime() + 30 * 60 * 1000)

    City.findOne({ _id: cityid }).then(
        (city_detail) => {
            var provider_query = {}
            if (city_detail) {
                var is_check_provider_wallet_amount_for_received_cash_request =
                    city_detail.is_check_provider_wallet_amount_for_received_cash_request
                var provider_min_wallet_amount_set_for_received_cash_request =
                    city_detail.provider_min_wallet_amount_set_for_received_cash_request

                if (
                    is_check_provider_wallet_amount_for_received_cash_request &&
                    payment_mode == Number(constant_json.PAYMENT_MODE_CASH)
                ) {
                    wallet_query = {
                        $gte: provider_min_wallet_amount_set_for_received_cash_request,
                    }
                    provider_query['wallet'] = wallet_query
                }
                // provider_query["service_type"] = citytype._id;
            }
            let provider_vehicle_query = {}
            provider_vehicle_query['admin_type_id'] = req_data.type_id
            provider_vehicle_query['state'] = 1

            if (req_data.service_details) {
                provider_vehicle_query['selected_services_id'] = {
                    $in: [req_data.service_details._id],
                }
            }
            if (req_data.capacity_details) {
                provider_vehicle_query['selected_capacity_id'] =
                    req_data.capacity_details._id
            }
            if (req_data.model_details) {
                provider_vehicle_query['selected_model_id'] =
                    req_data.model_details._id
            }
            provider_vehicle_query['vehicle_book_dates'] = {
                $not: {
                    $elemMatch: {
                        trip_date: {
                            $gte: check_trip_date_start,
                            $lte: check_trip_date_end,
                        },
                    },
                },
            }

            provider_query['vehicle_detail'] = {
                $elemMatch: provider_vehicle_query,
            }
            // provider_query["vehicle_detail.vehicle_book_dates.trip_date"] = {$nin: [req_data.request_time]};
            provider_query['provider_trip_dates'] = {
                $not: {
                    $elemMatch: {
                        trip_date: {
                            $gte: check_trip_date_start,
                            $lte: check_trip_date_end,
                        },
                    },
                },
            }

            var distance =
                setting_detail.default_Search_radious /
                constant_json.DEGREE_TO_KM
            var received_trip_from_gender = []
            var provider_language = []
            var accessibility = []

            var payment_mode = -1
            if (req_data.payment_mode != undefined) {
                payment_mode = req_data.payment_mode
            }

            var is_trip_condition = []
            var is_available_condition = []

            is_trip_condition.push({ is_trip: [] })
            is_available_condition.push({ is_available: 1 })

            // if (setting_detail.is_receive_new_request_near_destination) {
            //     is_trip_condition.push({ "is_near_trip": [] })
            //     is_available_condition.push({ "is_near_available": 1 })
            // }

            // if (setting_detail.is_allow_ride_share) {
            //     is_trip_condition.push({ "is_ride_share": 1 })
            //     is_available_condition.push({ "is_ride_share": 1 })
            // }
            var is_trip = { $or: is_trip_condition }
            var is_available = { $or: is_available_condition }

            provider_query['is_active'] = 1
            // provider_query["is_vehicle_document_uploaded"] = true;
            provider_query['is_approved'] = 1

            provider_query['providerLocation'] = {
                $near: [req_data.latitude, req_data.longitude],
                $maxDistance: distance,
            }

            // provider_admin_type_query = {
            //     $and: [{
            //         "provider_type": Number(constant_json.PROVIDER_TYPE_NORMAL)
            //     }, {
            //         "is_approved": 1
            //     }
            //     ]
            // };
            // provider_partner_type_query = {
            //     $and: [{
            //         "provider_type": Number(constant_json.PROVIDER_TYPE_PARTNER)
            //     }, {
            //         "is_approved": 1
            //     }, {
            //         "is_partner_approved_by_admin": 1
            //     }
            //     ]
            // };

            // provider_type_query = {$or: [provider_admin_type_query, provider_partner_type_query]};

            accessibility = req_data.accessibility
            received_trip_from_gender = req_data.received_trip_from_gender
            provider_language = req_data.provider_language

            var provider_query_and = []
            provider_query_and.push(is_trip)
            provider_query_and.push(is_available)
            // provider_query_and.push(provider_type_query);

            if (accessibility != undefined && accessibility.length > 0) {
                accessibility_query = {
                    $and: [
                        {
                            'vehicle_detail.accessibility': {
                                $exists: true,
                                $ne: [],
                                $all: accessibility,
                            },
                        },
                    ],
                }
                provider_query_and.push(accessibility_query)
            }

            if (
                provider_language != undefined &&
                provider_language.length > 0
            ) {
                languages_exists_query = {
                    $and: [{ languages: { $in: provider_language } }],
                }
                provider_query_and.push(languages_exists_query)
            }

            if (
                received_trip_from_gender != undefined &&
                received_trip_from_gender.length > 0 &&
                received_trip_from_gender.length != 2
            ) {
                received_trip_from_gender_exists_query = {
                    $and: [
                        {
                            gender: {
                                $exists: true,
                                $all: received_trip_from_gender,
                            },
                        },
                    ],
                }
                provider_query_and.push(received_trip_from_gender_exists_query)
            }

            provider_query['$and'] = provider_query_and
            var query = Provider.find(provider_query)
            query.exec(function (err, providers) {
                if (!providers || providers.length == 0) {
                    // console.log("here")
                    response({
                        success: false,
                        error_code:
                            error_message.ERROR_CODE_NO_PROVIDER_FOUND_SELECTED_SERVICE_TYPE_AROUND_YOU,
                    })
                } else {
                    response({
                        success: true,
                        message:
                            success_messages.MESSAGE_CODE_YOU_GET_NEARBY_DRIVER_LIST,
                        providers: providers,
                    })
                }
            })
        },
        (err) => {
            console.log(err)
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
            })
        }
    )
}

// FIND NEAREST PROVIDER
exports.nearest_provider = function (
    trip,
    provider_id,
    user_favourite_providers,
    response
) {
    // console.log("nearest providerss")
    City.findOne({ _id: trip.city_id }).then(
        (city_detail) => {
            let trip_date_tag = utils.getTripDateTag(trip, new Date())
            let check_trip_date_start = new Date(
                trip_date_tag.getTime() - 30 * 60 * 1000
            )
            let check_trip_date_end = new Date(
                trip_date_tag.getTime() + 30 * 60 * 1000
            )

            if (city_detail) {
                var city_timezone = city_detail.timezone
                var is_check_provider_wallet_amount_for_received_cash_request =
                    city_detail.is_check_provider_wallet_amount_for_received_cash_request
                var provider_min_wallet_amount_set_for_received_cash_request =
                    city_detail.provider_min_wallet_amount_set_for_received_cash_request

                var distance =
                    setting_detail.default_Search_radious /
                    constant_json.DEGREE_TO_KM

                let provider_query = {}
                // var vehicle_query = {"vehicle_detail": {$elemMatch: {"vehicle_book_dates.trip_date": {$nin: [trip.start_date_tag]},"state": 1}}}
                var providers_id_that_rejected_trip =
                    trip.providers_id_that_rejected_trip

                provider_query['_id'] = {
                    $nin: providers_id_that_rejected_trip,
                }

                // provider_query["service_type"] = trip.service_type_id;

                let provider_vehicle_query = {}
                provider_vehicle_query['admin_type_id'] = trip.type_id
                provider_vehicle_query['state'] = 1

                if (trip.service_details) {
                    provider_vehicle_query['selected_services_id'] = {
                        $in: [trip.service_details._id],
                    }
                }
                if (trip.capacity_details) {
                    provider_vehicle_query['selected_capacity_id'] =
                        trip.capacity_details._id
                }
                if (trip.model_details) {
                    provider_vehicle_query['selected_model_id'] =
                        trip.model_details._id
                }
                provider_vehicle_query['vehicle_book_dates'] = {
                    $not: {
                        $elemMatch: {
                            trip_date: {
                                $gte: check_trip_date_start,
                                $lte: check_trip_date_end,
                            },
                        },
                    },
                }

                provider_query['vehicle_detail'] = {
                    $elemMatch: provider_vehicle_query,
                }
                provider_query['provider_trip_dates'] = {
                    $not: {
                        $elemMatch: {
                            trip_date: {
                                $gte: check_trip_date_start,
                                $lte: check_trip_date_end,
                            },
                        },
                    },
                }

                var is_trip_condition = []
                var is_available_condition = []

                is_trip_condition.push({ is_trip: [] })
                is_available_condition.push({ is_available: 1 })

                // if (setting_detail.is_receive_new_request_near_destination) {
                //     is_trip_condition.push({ "is_near_trip": [] })
                //     is_available_condition.push({ "is_near_available": 1 })
                // }

                // if (setting_detail.is_allow_ride_share && trip.is_ride_share) {
                //     is_trip_condition.push({ "is_ride_share": 1 })
                //     is_available_condition.push({ "is_ride_share": 1 })
                // }
                var is_trip = { $or: is_trip_condition }
                var is_available = { $or: is_available_condition }

                provider_query['is_active'] = 1

                if (
                    is_check_provider_wallet_amount_for_received_cash_request &&
                    trip.payment_mode == Number(constant_json.PAYMENT_MODE_CASH)
                ) {
                    wallet_query = {
                        $gte: provider_min_wallet_amount_set_for_received_cash_request,
                    }
                    provider_query['wallet'] = wallet_query
                }
                // provider_query["is_vehicle_document_uploaded"] = true;
                // provider_query["providerLocation"] = {$near: trip.sourceLocation, $maxDistance: distance};
                provider_query['is_approved'] = 1

                // provider_admin_type_query = {
                //     $and: [{
                //         "provider_type": Number(constant_json.PROVIDER_TYPE_NORMAL)
                //     }, {
                //         "is_approved": 1
                //     }
                //     ]
                // };
                // provider_partner_type_query = {
                //     $and: [{
                //         "provider_type": Number(constant_json.PROVIDER_TYPE_PARTNER)
                //     }, {
                //         "is_approved": 1
                //     }, {
                //         "is_partner_approved_by_admin": 1
                //     }
                //     ]
                // };
                // provider_type_query = {$or: [provider_admin_type_query, provider_partner_type_query]};
                // languages_exists_query = {$and: [{"languages": {$in: trip.provider_language}}]};

                // received_trip_from_gender_exists_query = {
                //     $and: [{
                //         "gender": {
                //             $exists: true,
                //             $all: trip.received_trip_from_gender
                //         }
                //     }]
                // }

                var provider_query_and = []
                provider_query_and.push(is_trip)
                provider_query_and.push(is_available)
                // provider_query_and.push(provider_type_query);

                if (provider_id != null) {
                    provider_query_and.push({
                        $and: [{ _id: { $eq: provider_id } }],
                    })
                }

                // var accessibility = trip.accessibility;
                // if (accessibility != undefined && accessibility.length > 0) {
                //     accessibility_query = {
                //         vehicle_detail: { $elemMatch: { is_selected: true, accessibility: { $exists: true, $ne: [], $all: accessibility } } }
                //     }
                //     provider_query_and.push(accessibility_query);
                // }

                // if (trip.provider_language.length > 0) {
                //     provider_query_and.push(languages_exists_query);
                // }
                // if (trip.received_trip_from_gender.length > 0 && trip.received_trip_from_gender.length != 2) {
                //     provider_query_and.push(received_trip_from_gender_exists_query);
                // }

                var limit = 1
                if (
                    setting_detail.find_nearest_driver_type ==
                    Number(constant_json.NEAREST_PROVIDER_TYPE_MULTIPLE)
                ) {
                    limit = setting_detail.request_send_to_no_of_providers
                }
                provider_query['$and'] = provider_query_and

                var favourite_providers = []
                if (user_favourite_providers) {
                    favourite_providers = user_favourite_providers
                }

                var query
                query = Provider.find(provider_query)

                query.exec(async function (err, providers) {
                    delete trip.provider_to_user_estimated_distance
                    delete trip.provider_to_user_estimated_time
                    providers = [] // Temporarily turning off the direct request to driver.
                    if (providers.length == 0) {
                        // console.log("no providers there")
                        trip.current_provider = null
                        trip.current_providers = []
                        trip.provider_first_name = ''
                        trip.provider_last_name = ''
                        trip.providers_id_that_rejected_trip = []
                        trip.find_nearest_provider_time = new Date()
                        trip.is_no_provider_found = true
                        if (
                            trip.trip_type.toString() !==
                            constant_json.TRIP_TYPE_DISPATCHER.toString()
                        ) {
                            trip.provider_trip_end_time = new Date()
                            var complete_date_in_city_timezone =
                                utils.get_date_now_at_city(
                                    new Date(),
                                    trip.timezone
                                )
                            var complete_date_tag = moment(
                                moment(complete_date_in_city_timezone).startOf(
                                    'day'
                                )
                            ).format(constant_json.DATE_FORMAT_MMM_D_YYYY)
                            trip.complete_date_in_city_timezone =
                                complete_date_in_city_timezone
                            trip.complete_date_tag = complete_date_tag
                            // trip.is_trip_cancelled = 1;
                            trip.is_provider_accepted = 0
                        } else {
                            trip.is_provider_accepted = 3
                        }
                        // if(trip.is_trip_cancelled == 0){
                        //     trip.save().then(()=>{
                        //         utils.update_request_status_socket(trip._id);
                        //         User.findOne({_id: trip.user_id}).then((user) => {
                        //             if (user) {
                        //                 user.current_trip_id = null;
                        //                 user.save();
                        //                 if (setting_detail.sms_notification) {
                        //                     // utils.sendOtherSMS(phoneWithCode, 5, "");
                        //                 }
                        //                 utils.sendPushNotification(constant_json.USER_UNIQUE_NUMBER, user.device_type, user.device_token, push_messages.PUSH_CODE_FOR_NO_PROVIDER_FOUND, constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS);
                        //             }
                        //         }, (err) => {
                        //             console.log(err);
                        //         });

                        //         response({
                        //             success: false,
                        //             error_code: error_message.ERROR_CODE_NO_PROVIDER_FOUND_AROUND_YOU
                        //         });
                        //     });
                        // } else {
                        await Trip.updateOne(
                            { _id: trip._id },
                            trip.getChanges()
                        )

                        // await trip.save()
                        response({
                            success: true,
                            message:
                                success_messages.MESSAGE_CODE_YOUR_TRIP_CREATED_SUCCESSFULLY,
                            trip_id: trip._id,
                            unique_id: trip.unique_id,
                        })

                        // Trip.findOneAndRemove({ _id: trip._id }).then((deleted_trip) => {
                        //     if (deleted_trip) {
                        //         var trip_history_data = new Trip_history(JSON.parse(JSON.stringify(deleted_trip)));
                        //         trip_history_data.save(function () {
                        //             utils.update_request_status_socket(trip._id);
                        //             User.findOne({ _id: trip.user_id }).then((user) => {
                        //                 if (user) {
                        //                     user.current_trip_id = null;
                        //                     user.save();
                        //                     if (setting_detail.sms_notification) {
                        //                         // utils.sendOtherSMS(phoneWithCode, 5, "");
                        //                     }
                        //                     utils.sendPushNotification(constant_json.USER_UNIQUE_NUMBER, user.device_type, user.device_token, push_messages.PUSH_CODE_FOR_NO_PROVIDER_FOUND, constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS);
                        //                 }
                        //             }, (err) => {
                        //                 console.log(err);
                        //             });

                        //             response({
                        //                 success: false,
                        //                 error_code: error_message.ERROR_CODE_NO_PROVIDER_FOUND_AROUND_YOU
                        //             });
                        //         });
                        //     } else {
                        //         utils.update_request_status_socket(trip._id);
                        //         User.findOne({ _id: trip.user_id }).then((user) => {
                        //             if (user) {
                        //                 user.current_trip_id = null;
                        //                 user.save();
                        //                 if (setting_detail.sms_notification) {
                        //                     // utils.sendOtherSMS(phoneWithCode, 5, "");
                        //                 }
                        //                 utils.sendPushNotification(constant_json.USER_UNIQUE_NUMBER, user.device_type, user.device_token, push_messages.PUSH_CODE_FOR_NO_PROVIDER_FOUND, constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS);
                        //             }
                        //         }, (err) => {
                        //             console.log(err);
                        //         });

                        //         response({
                        //             success: false,
                        //             error_code: error_message.ERROR_CODE_NO_PROVIDER_FOUND_AROUND_YOU
                        //         });
                        //     }
                        // });
                        // })
                        // }
                    } else {
                        function onlyUnique(value, index, self) {
                            return self.indexOf(value) === index
                        }
                        favourite_providers =
                            favourite_providers.filter(onlyUnique)

                        var final_providers = []

                        if (
                            trip.is_trip_inside_zone_queue &&
                            trip.zone_queue_id
                        ) {
                            let zone = await CityZone.findById(
                                trip.zone_queue_id
                            )
                            let zone_providers =
                                zone.total_provider_in_zone_queue

                            zone_providers.forEach(function (zone_provider) {
                                var zone_provider_index = providers.findIndex(
                                    (x) =>
                                        x._id.toString() ==
                                        zone_provider.toString()
                                )
                                if (zone_provider_index !== -1) {
                                    if (
                                        Number(final_providers.length) <
                                        Number(limit)
                                    ) {
                                        final_providers.push(
                                            providers[zone_provider_index]
                                        )
                                    }
                                }
                            })

                            favourite_providers.forEach(function (
                                fav_provider
                            ) {
                                var dup_index = final_providers.findIndex(
                                    (x) =>
                                        x._id.toString() ==
                                        fav_provider.toString()
                                )
                                if (dup_index == -1) {
                                    var fav_index = providers.findIndex(
                                        (x) =>
                                            x._id.toString() ==
                                            fav_provider.toString()
                                    )
                                    if (fav_index !== -1) {
                                        if (
                                            Number(final_providers.length) <
                                            Number(limit)
                                        ) {
                                            final_providers.push(
                                                providers[fav_index]
                                            )
                                        }
                                    }
                                }
                            })

                            providers.forEach(function (provider_detail) {
                                var fav_index = final_providers.findIndex(
                                    (x) =>
                                        x._id.toString() ==
                                        provider_detail._id.toString()
                                )
                                if (fav_index == -1) {
                                    if (
                                        Number(final_providers.length) <
                                        Number(limit)
                                    ) {
                                        final_providers.push(provider_detail)
                                    }
                                }
                            })
                        } else {
                            favourite_providers.forEach(function (
                                fav_provider
                            ) {
                                var fav_index = providers.findIndex(
                                    (x) =>
                                        x._id.toString() ==
                                        fav_provider.toString()
                                )
                                if (fav_index !== -1) {
                                    if (
                                        Number(final_providers.length) <
                                        Number(limit)
                                    ) {
                                        final_providers.push(
                                            providers[fav_index]
                                        )
                                    }
                                }
                            })

                            providers.forEach(function (provider_detail) {
                                var fav_index = final_providers.findIndex(
                                    (x) =>
                                        x._id.toString() ==
                                        provider_detail._id.toString()
                                )
                                if (fav_index == -1) {
                                    if (
                                        Number(final_providers.length) <
                                        Number(limit)
                                    ) {
                                        final_providers.push(provider_detail)
                                    }
                                }
                            })
                        }

                        if (
                            setting_detail.is_allow_ride_share &&
                            trip.is_ride_share
                        ) {
                            let final_providers_temp = []
                            final_providers.forEach((provider) => {
                                if (provider.is_trip.length != 0) {
                                    if (
                                        provider.is_trip.length <
                                        trip.ride_share_limit
                                    ) {
                                        let pickup_diff_km = Math.abs(
                                            utils.getDistanceFromTwoLocation(
                                                trip.sourceLocation,
                                                provider.providerLocation
                                            )
                                        )
                                        let destination_condition = false
                                        if (!provider.destinationLocation) {
                                            provider.destinationLocation = []
                                        }
                                        if (
                                            provider.destinationLocation
                                                .length != 0
                                        ) {
                                            destination_condition = true
                                            provider.destinationLocation.forEach(
                                                (destinationLocation) => {
                                                    let destination_diff_km =
                                                        Math.abs(
                                                            utils.getDistanceFromTwoLocation(
                                                                trip.destinationLocation,
                                                                destinationLocation
                                                            )
                                                        )
                                                    if (destination_condition) {
                                                        if (
                                                            destination_diff_km <=
                                                            setting_detail.ride_share_destination_radius
                                                        ) {
                                                            destination_condition = true
                                                        } else {
                                                            destination_condition = false
                                                        }
                                                    }
                                                }
                                            )
                                        }
                                        if (
                                            pickup_diff_km <=
                                                setting_detail.ride_share_pickup_radius &&
                                            destination_condition
                                        ) {
                                            final_providers_temp.push(provider)
                                        }
                                    }
                                } else {
                                    final_providers_temp.push(provider)
                                }
                            })
                            final_providers = final_providers_temp
                        }

                        if (setting_detail.is_driver_go_home) {
                            let final_providers_temp = []
                            final_providers.forEach((provider) => {
                                if (!provider.address_location) {
                                    provider.address_location = [0, 0]
                                }
                                if (provider.address_location.length == 0) {
                                    provider.address_location = [0, 0]
                                }
                                if (
                                    provider.is_go_home &&
                                    provider.address_location != [0, 0]
                                ) {
                                    if (
                                        trip.destinationLocation.length != 0 &&
                                        trip.destination_addresses.length == 0
                                    ) {
                                        let destination_diff_km = Math.abs(
                                            utils.getDistanceFromTwoLocation(
                                                trip.destinationLocation,
                                                provider.address_location
                                            )
                                        )
                                        let destination_diff_meter =
                                            destination_diff_km * 1000
                                        if (
                                            destination_diff_meter <=
                                            setting_detail.driver_go_home_radius
                                        ) {
                                            final_providers_temp.push(provider)
                                        }
                                    }
                                } else {
                                    final_providers_temp.push(provider)
                                }
                            })
                            final_providers = final_providers_temp
                        }

                        if (
                            setting_detail.find_nearest_driver_type ==
                            Number(constant_json.NEAREST_PROVIDER_TYPE_SINGLE)
                        ) {
                            trip.current_provider = final_providers[0]._id
                            trip.provider_type =
                                final_providers[0].provider_type
                            // trip.provider_type_id = final_providers[0].provider_type_id;
                        }
                        trip.no_of_time_send_request++
                        trip.unit = city_detail.unit
                        trip.is_provider_accepted = 0

                        var current_providers = []

                        if (
                            setting_detail.find_nearest_driver_type ==
                            Number(constant_json.NEAREST_PROVIDER_TYPE_SINGLE)
                        ) {
                            current_providers.push(final_providers[0]._id)
                        } else {
                            final_providers.forEach(function (provider) {
                                current_providers.push(provider._id)
                            })
                        }

                        trip.find_nearest_provider_time = new Date()
                        trip.current_providers = current_providers
                        trip.save().then(
                            async () => {
                                var trips = []
                                trips.push(trip._id)

                                for (const final_provider of final_providers) {
                                    let idx = current_providers.findIndex(
                                        (i) =>
                                            String(i) ==
                                            String(final_provider._id)
                                    )
                                    if (idx != -1) {
                                        let is_trip_condition = {
                                            _id: final_provider._id,
                                            is_trip: [],
                                        }
                                        let is_trip_update = {
                                            is_available: 0,
                                            is_trip: trips,
                                            is_near_available: 0,
                                            $inc: { total_request: 1 },
                                        }

                                        if (
                                            trip.is_ride_share &&
                                            setting_detail.is_allow_ride_share
                                        ) {
                                            is_trip_condition = {
                                                _id: final_provider._id,
                                            }
                                            is_trip_update = {
                                                is_available: 0,
                                                $push: { is_trip: trip._id },
                                                is_ride_share: 1,
                                                is_near_available: 0,
                                                $inc: { total_request: 1 },
                                            }
                                        }
                                        if (
                                            setting_detail.is_receive_new_request_near_destination
                                        ) {
                                            if (
                                                final_provider.is_trip.length !=
                                                    0 &&
                                                final_provider.is_near_available ==
                                                    1 &&
                                                !trip.is_ride_share
                                            ) {
                                                is_trip_condition = {
                                                    _id: final_provider._id,
                                                    is_near_trip: [],
                                                }
                                                is_trip_update = {
                                                    is_near_available: 0,
                                                    is_near_trip: trips,
                                                    $inc: { total_request: 1 },
                                                }
                                            }
                                        }

                                        let updateCount =
                                            await Provider.updateOne(
                                                is_trip_condition,
                                                is_trip_update
                                            )
                                        if (updateCount.modifiedCount != 0) {
                                            let is_trip_condition = {
                                                _id: final_provider._id,
                                                is_trip: trip._id,
                                            }
                                            if (
                                                setting_detail.is_receive_new_request_near_destination
                                            ) {
                                                if (
                                                    final_provider.is_trip
                                                        .length != 0 &&
                                                    final_provider.is_near_available ==
                                                        1
                                                ) {
                                                    is_trip_condition = {
                                                        _id: final_provider._id,
                                                        is_near_trip: trip._id,
                                                    }
                                                }
                                            }
                                            let provider =
                                                await Provider.findOne(
                                                    is_trip_condition
                                                )
                                            if (provider) {
                                                if (
                                                    trip.is_ride_share &&
                                                    final_provider.is_trip
                                                        .length != 0
                                                ) {
                                                    utils.update_request_status_socket(
                                                        final_provider
                                                            .is_trip[0],
                                                        trip._id
                                                    )
                                                    myAnalytics.insert_daily_provider_analytics(
                                                        city_timezone,
                                                        provider._id,
                                                        TRIP_STATUS.WAITING_FOR_PROVIDER,
                                                        null
                                                    )
                                                    utils.sendPushNotification(
                                                        constant_json.PROVIDER_UNIQUE_NUMBER,
                                                        provider.device_type,
                                                        provider.device_token,
                                                        push_messages.PUSH_CODE_FOR_NEW_NEAREST_TRIP,
                                                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                    )
                                                } else if (
                                                    final_provider.is_trip
                                                        .length != 0 &&
                                                    final_provider.is_near_available ==
                                                        1
                                                ) {
                                                    utils.update_request_status_socket(
                                                        final_provider
                                                            .is_trip[0],
                                                        trip._id
                                                    )
                                                    myAnalytics.insert_daily_provider_analytics(
                                                        city_timezone,
                                                        provider._id,
                                                        TRIP_STATUS.WAITING_FOR_PROVIDER,
                                                        null
                                                    )
                                                    utils.sendPushNotification(
                                                        constant_json.PROVIDER_UNIQUE_NUMBER,
                                                        provider.device_type,
                                                        provider.device_token,
                                                        push_messages.PUSH_CODE_FOR_NEW_NEAREST_TRIP,
                                                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                    )
                                                } else {
                                                    utils.send_socket_request(
                                                        trip._id,
                                                        provider._id
                                                    )
                                                    myAnalytics.insert_daily_provider_analytics(
                                                        city_timezone,
                                                        provider._id,
                                                        TRIP_STATUS.WAITING_FOR_PROVIDER,
                                                        null
                                                    )
                                                    utils.sendPushNotification(
                                                        constant_json.PROVIDER_UNIQUE_NUMBER,
                                                        provider.device_type,
                                                        provider.device_token,
                                                        push_messages.PUSH_CODE_FOR_NEW_TRIP,
                                                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                    )
                                                }
                                            }
                                        }
                                    }
                                }
                                response({
                                    success: true,
                                    message:
                                        success_messages.MESSAGE_CODE_YOUR_TRIP_CREATED_SUCCESSFULLY,
                                    trip_id: trip._id,
                                    unique_id: trip.unique_id,
                                })
                            },
                            (err) => {
                                console.log(err)
                                trip.current_providers = []
                                trip.provider_first_name = ''
                                trip.provider_last_name = ''

                                if (
                                    trip.trip_type.toString() !==
                                        constant_json.TRIP_TYPE_DISPATCHER.toString() &&
                                    !trip.is_schedule_trip
                                ) {
                                    trip.provider_trip_end_time = new Date()
                                    trip.is_trip_cancelled = 1
                                    trip.is_provider_accepted = 0
                                    var complete_date_in_city_timezone =
                                        utils.get_date_now_at_city(
                                            new Date(),
                                            trip.timezone
                                        )
                                    var complete_date_tag = moment(
                                        moment(
                                            complete_date_in_city_timezone
                                        ).startOf('day')
                                    ).format(
                                        constant_json.DATE_FORMAT_MMM_D_YYYY
                                    )
                                    trip.complete_date_in_city_timezone =
                                        complete_date_in_city_timezone
                                    trip.complete_date_tag = complete_date_tag
                                } else {
                                    trip.is_provider_accepted = 3
                                }
                                if (trip.is_trip_cancelled == 0) {
                                    trip.save()
                                    response({
                                        success: false,
                                        error_code:
                                            error_message.ERROR_CODE_CREATE_TRIP_FAILED,
                                    })
                                } else {
                                    trip.save().then(() => {
                                        Trip.findOneAndRemove({
                                            _id: trip._id,
                                        }).then((deleted_trip) => {
                                            if (deleted_trip) {
                                                var trip_history_data =
                                                    new Trip_history(
                                                        JSON.parse(
                                                            JSON.stringify(
                                                                deleted_trip
                                                            )
                                                        )
                                                    )
                                                trip_history_data.save(
                                                    function () {
                                                        response({
                                                            success: false,
                                                            error_code:
                                                                error_message.ERROR_CODE_CREATE_TRIP_FAILED,
                                                        })
                                                    }
                                                )
                                            } else {
                                                response({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_CREATE_TRIP_FAILED,
                                                })
                                            }
                                        })
                                    })
                                }
                            }
                        )
                    }
                })
            } else {
                response({
                    success: false,
                    error_code: error_message.ERROR_CODE_CITY_TYPE_NOT_FOUND,
                })
            }
        },
        (err) => {
            console.log(err)
            response({
                success: false,
                error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
            })
        }
    )
}

exports.get_partners_for_trip = async function (req, trip) {
    try {
        const country_id = trip.country_id
        let trip_date_tag = utils.getTripDateTag(trip, new Date())
        let check_trip_date_start = new Date(
            trip_date_tag.getTime() - 30 * 60 * 1000
        )
        let check_trip_date_end = new Date(
            trip_date_tag.getTime() + 30 * 60 * 1000
        )

        const elemMatchConditions = {}

        elemMatchConditions['state'] = { $eq: 1 }
        if (trip.type_id) {
            elemMatchConditions['admin_type_id'] = {
                $in: [trip.type_id],
            }
        }
        if (trip.capacity_details) {
            elemMatchConditions['selected_capacity_id'] = {
                $in: [trip.capacity_details._id],
            }
        }
        if (trip.model_details) {
            elemMatchConditions['selected_model_id'] = {
                $in: [trip.model_details._id],
            }
        }

        if (trip.service_details) {
            elemMatchConditions['selected_services_id'] = {
                $in: [trip.service_details._id],
            }
        }
        elemMatchConditions['vehicle_book_dates'] = {
            $not: {
                $elemMatch: {
                    trip_date: {
                        $gte: check_trip_date_start,
                        $lte: check_trip_date_end,
                    },
                },
            },
        }

        const query = {
            is_approved: 1,
            country_id: country_id,
            vehicle_detail: {
                $elemMatch: elemMatchConditions,
            },
        }

        const partners = await Partner.find(query)
        partners.forEach((partner) => {
            utils.sendPushNotification(
                constant_json.PARTNER_UNIQUE_NUMBER,
                'web',
                '',
                push_messages.PUSH_CODE_FOR_PARTNER_GET_NEW_TRIP,
                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                partner.first_name + ' ' + partner.last_name,
                partner.webpush_config
            )
            allemails.sendPartnerNewTripEmail(req, partner)
        })
        // console.log(partners)
    } catch (e) {
        console.log(e)
    }
}

////  START USER CREATE TRIP SERVICE //// ////////
exports.create = function (req, res) {
    if (req.body.destination_addresses) {
        req.body.destination_addresses = req.body.destination_addresses.map(
            (stop) => {
                if (!stop.stops_inside) {
                    stop.stops_inside = [] // Add inside_stops: [] if it doesn't exist
                }
                return stop
            }
        )
    }

    if (req.body.destination_addresses) {
        req.body.destination_addresses.forEach((dest) => {
            dest.stops_inside.forEach((stop) => {
                stop.location = [
                    Number(stop.location[0]),
                    Number(stop.location[1]),
                ]
            })
        })
    }
    if (req.body.destination_stops && req.body.destination_stops != '') {
        req.body.destination_stops.forEach((stop) => {
            stop.location = [Number(stop.location[0]), Number(stop.location[1])]
        })
    } else {
        req.body.destination_stops = []
    }

    utils.check_request_params(
        req.body,
        [
            { name: 'user_id', type: 'string' },
            { name: 'service_type_id', type: 'string' },
            { name: 'timezone', type: 'string' },
        ],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user_data) => {
                        if (!user_data) {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
                            })
                        } else {
                            var provider_id = null
                            if (req.body.provider_id) {
                                provider_id = req.body.provider_id
                            }
                            if (typeof req.body.created_by == 'undefined') {
                                req.body.created_by =
                                    constant_json.CREATED_BY_USER_APP
                            }
                            req.body.created_by = Number(req.body.created_by)
                            Citytype.findOne({
                                _id: req.body.service_type_id,
                            }).then((citytype) => {
                                req.body.is_trip_inside_zone_queue = false
                                req.body.zone_queue_id = null
                                var trip_type = constant_json.TRIP_TYPE_NORMAL
                                exports.create_trip(
                                    user_data,
                                    trip_type,
                                    req.body.service_type_id,
                                    req.body,
                                    req,
                                    function (response) {
                                        if (response.success) {
                                            var trip = response.trip

                                            if (req.body.promo_id) {
                                                Promo_Code.findOne(
                                                    { _id: req.body.promo_id },
                                                    async function (
                                                        error,
                                                        promocode
                                                    ) {
                                                        if (promocode) {
                                                            let promo_value =
                                                                promocode.code_value
                                                            trip.promo_payment =
                                                                promocode.code_type ==
                                                                1
                                                                    ? promo_value
                                                                    : Number(
                                                                          (
                                                                              promo_value *
                                                                              0.01 *
                                                                              trip.fixed_price
                                                                          ).toFixed(
                                                                              2
                                                                          )
                                                                      )

                                                            trip.promo_id =
                                                                promocode._id
                                                            await Trip.updateOne(
                                                                {
                                                                    _id: trip._id,
                                                                },
                                                                trip.getChanges()
                                                            )
                                                            promocode.user_used_promo =
                                                                promocode.user_used_promo +
                                                                1
                                                            promocode.save()
                                                            var userpromouse =
                                                                new User_promo_use(
                                                                    {
                                                                        promo_id:
                                                                            promocode._id,
                                                                        promocode:
                                                                            promocode.promocode,
                                                                        user_id:
                                                                            user_data.user_type_id
                                                                                ? user_data.user_type_id
                                                                                : user_data._id,
                                                                        promo_type:
                                                                            promocode.code_type,
                                                                        promo_value:
                                                                            promocode.code_value,
                                                                        trip_id:
                                                                            trip._id,
                                                                        user_used_amount: 0,
                                                                    }
                                                                )
                                                            userpromouse.save()
                                                        }
                                                    }
                                                )
                                            }
                                            if (
                                                trip.trip_type ==
                                                constant_json.TRIP_TYPE_HOTEL
                                            ) {
                                                message =
                                                    admin_messages.success_create_trip
                                                req.flash(
                                                    'response_code',
                                                    admin_messages.success_create_trip
                                                )
                                            }
                                            if (trip.is_schedule_trip) {
                                                exports.get_partners_for_trip(
                                                    req,
                                                    trip
                                                )
                                                res.json({
                                                    success: true,
                                                    trip: trip,
                                                    message:
                                                        success_messages.MESSAGE_CODE_YOUR_FUTURE_TRIP_CREATE_SUCCESSFULLY,
                                                })
                                            } else {
                                                exports.nearest_provider(
                                                    trip,
                                                    provider_id,
                                                    user_data.favourite_providers,
                                                    function (
                                                        nearest_provider_response
                                                    ) {
                                                        if (
                                                            nearest_provider_response.success
                                                        ) {
                                                            exports.get_partners_for_trip(
                                                                req,
                                                                trip
                                                            )
                                                            res.json(
                                                                nearest_provider_response
                                                            )
                                                        } else {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_CREATE_TRIP_FAILED,
                                                            })
                                                        }
                                                    }
                                                )
                                                if (
                                                    response.multiple_trips &&
                                                    response.multiple_trips
                                                        .length > 0
                                                ) {
                                                    response.multiple_trips.forEach(
                                                        (multi_trip) => {
                                                            exports.nearest_provider(
                                                                multi_trip,
                                                                provider_id,
                                                                user_data.favourite_providers,
                                                                function (
                                                                    nearest_provider_response
                                                                ) {}
                                                            )
                                                        }
                                                    )
                                                }
                                            }
                                        } else {
                                            res.json(response)
                                        }
                                    }
                                )
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                console.log(response.error_description)
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.provider_create = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            {
                name: 'phone',
                type: 'string',
            },
            { name: 'service_type_id', type: 'string' },
        ],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider_detail) => {
                        if (provider_detail) {
                            Trip.aggregate([
                                {
                                    $match: {
                                        provider_id: {
                                            $eq: req.body.provider_id,
                                        },
                                        $and: [
                                            { is_trip_cancelled: { $eq: 0 } },
                                            { is_trip_completed: { $eq: 0 } },
                                            { is_trip_end: { $eq: 0 } },
                                        ],
                                    },
                                },
                            ]).then(
                                (trips) => {
                                    if (trips.length === 0) {
                                        req.body.created_by = Number(
                                            constant_json.CREATED_BY_PROVIDER_APP
                                        )

                                        User.findOne({
                                            phone: req.body.phone,
                                        }).then(
                                            (user_data) => {
                                                if (user_data) {
                                                    // if (user_data.current_trip_id === null) {
                                                    exports.create_trip(
                                                        user_data,
                                                        constant_json.TRIP_TYPE_PROVIDER,
                                                        req.body
                                                            .service_type_id,
                                                        req.body,
                                                        function (response) {
                                                            if (
                                                                response.success
                                                            ) {
                                                                var trip =
                                                                    response.trip
                                                                if (
                                                                    trip.is_schedule_trip
                                                                ) {
                                                                    res.json({
                                                                        success: true,
                                                                        trip: trip,
                                                                        message:
                                                                            success_messages.MESSAGE_CODE_YOUR_FUTURE_TRIP_CREATE_SUCCESSFULLY,
                                                                    })
                                                                } else {
                                                                    var now_date =
                                                                        new Date()
                                                                    trip.is_toll =
                                                                        setting_detail.is_toll
                                                                    trip.provider_first_name =
                                                                        provider_detail.first_name
                                                                    trip.provider_last_name =
                                                                        provider_detail.last_name
                                                                    trip.provider_type =
                                                                        provider_detail.provider_type
                                                                    trip.provider_type_id =
                                                                        provider_detail.provider_type_id
                                                                    trip.current_provider =
                                                                        provider_detail._id
                                                                    trip.current_providers =
                                                                        [
                                                                            provider_detail._id,
                                                                        ]
                                                                    trip.confirmed_provider =
                                                                        provider_detail._id
                                                                    trip.provider_id =
                                                                        provider_detail._id
                                                                    trip.is_provider_accepted = 1
                                                                    trip.is_provider_status = 4
                                                                    trip.accepted_time =
                                                                        now_date
                                                                    trip.provider_arrived_time =
                                                                        now_date
                                                                    trip.provider_trip_start_time =
                                                                        now_date

                                                                    var unique_id =
                                                                        pad(
                                                                            trip.unique_id,
                                                                            7,
                                                                            '0'
                                                                        )
                                                                    var invoice_number =
                                                                        constant_json.INVOICE_APP_NAME_CODE +
                                                                        ' ' +
                                                                        constant_json.INVOICE_PROVIDER_TRIP_EARNING_CODE +
                                                                        ' ' +
                                                                        moment(
                                                                            new Date()
                                                                        ).format(
                                                                            constant_json.DATE_FORMAT_MMDDYYYY
                                                                        ) +
                                                                        ' ' +
                                                                        unique_id
                                                                    trip.invoice_number =
                                                                        invoice_number

                                                                    var is_favourite_provider = false
                                                                    if (
                                                                        user_data
                                                                    ) {
                                                                        var index =
                                                                            user_data.favourite_providers.findIndex(
                                                                                (
                                                                                    x
                                                                                ) =>
                                                                                    x.toString() ==
                                                                                    provider_detail._id.toString()
                                                                            )
                                                                        if (
                                                                            index !==
                                                                            -1
                                                                        ) {
                                                                            is_favourite_provider = true
                                                                        }
                                                                    }
                                                                    trip.is_favourite_provider =
                                                                        is_favourite_provider

                                                                    trip.save().then(
                                                                        () => {
                                                                            var trips =
                                                                                []
                                                                            trips.push(
                                                                                trip._id
                                                                            )
                                                                            provider_detail.is_trip =
                                                                                trips

                                                                            provider_detail.total_request =
                                                                                provider_detail.total_request +
                                                                                1
                                                                            myAnalytics.insert_daily_provider_analytics(
                                                                                trip.timezone,
                                                                                provider_detail._id,
                                                                                TRIP_STATUS.INITIATE_TRIP,
                                                                                null
                                                                            )

                                                                            provider_detail.accepted_request =
                                                                                provider_detail.accepted_request +
                                                                                1
                                                                            // myAnalytics.insert_daily_provider_analytics(trip.timezone, provider_detail._id, TRIP_STATUS.PROVIDER_ACCEPTED, null);

                                                                            provider_detail.save(
                                                                                function (
                                                                                    err
                                                                                ) {
                                                                                    console.log(
                                                                                        err
                                                                                    )
                                                                                }
                                                                            )

                                                                            utils.sendPushNotification(
                                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                                user_data.device_type,
                                                                                user_data.device_token,
                                                                                push_messages.PUSH_CODE_FOR_PROVIDER_INITATE_TRIP,
                                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                                            )

                                                                            // user_data.current_trip_id = trip._id;
                                                                            // user_data.save();
                                                                            res.json(
                                                                                {
                                                                                    success: true,
                                                                                    message:
                                                                                        success_messages.MESSAGE_CODE_YOUR_TRIP_CREATED_SUCCESSFULLY,
                                                                                    trip_id:
                                                                                        trip._id,
                                                                                    user: user_data,
                                                                                }
                                                                            )
                                                                        }
                                                                    )
                                                                }
                                                            } else {
                                                                res.json(
                                                                    response
                                                                )
                                                            }
                                                        }
                                                    )
                                                    // } else {
                                                    //     res.json({
                                                    //         success: false,
                                                    //         error_code: error_message.ERROR_CODE_TRIP_ALREADY_RUNNING
                                                    //     });

                                                    // }
                                                } else {
                                                    var country_phone_code =
                                                        req.body
                                                            .country_phone_code
                                                    Country.findOne({
                                                        countryphonecode:
                                                            country_phone_code,
                                                    }).then((country) => {
                                                        var first_name =
                                                            req.body.first_name
                                                        var last_name =
                                                            req.body.last_name
                                                        var encrypt_password =
                                                            require('crypto')
                                                                .createHash(
                                                                    'md5'
                                                                )
                                                                .update(
                                                                    req.body
                                                                        .phone
                                                                )
                                                                .digest('hex')
                                                        var referral_code =
                                                            utils
                                                                .tokenGenerator(
                                                                    8
                                                                )
                                                                .toUpperCase()
                                                        var wallet_currency_code =
                                                            ''
                                                        var countryname = ''
                                                        if (country) {
                                                            wallet_currency_code =
                                                                country.currencycode
                                                            countryname =
                                                                country.countryname
                                                        } else {
                                                            let i =
                                                                country_list.findIndex(
                                                                    (i) =>
                                                                        i.code ==
                                                                        country_phone_code
                                                                )
                                                            if (i != -1) {
                                                                wallet_currency_code =
                                                                    country_list[0]
                                                                        .currency_code
                                                            } else {
                                                                wallet_currency_code =
                                                                    ''
                                                            }
                                                        }
                                                        var user = new User({
                                                            first_name:
                                                                first_name,
                                                            last_name:
                                                                last_name,
                                                            email: req.body.email
                                                                .trim()
                                                                .toLowerCase(),
                                                            password:
                                                                encrypt_password,
                                                            user_type: Number(
                                                                constant_json.USER_TYPE_PROVIDER
                                                            ),
                                                            user_type_id:
                                                                provider_detail._id,
                                                            country_phone_code:
                                                                req.body
                                                                    .country_phone_code,
                                                            phone: req.body
                                                                .phone,
                                                            token: utils.tokenGenerator(
                                                                32
                                                            ),
                                                            country:
                                                                countryname,
                                                            referral_code:
                                                                referral_code,
                                                            wallet_currency_code:
                                                                wallet_currency_code,
                                                        })

                                                        user.save().then(
                                                            () => {
                                                                if (
                                                                    setting_detail.email_notification
                                                                ) {
                                                                    allemails.sendUserRegisterEmail(
                                                                        user.email,
                                                                        user.country
                                                                    )
                                                                }
                                                                exports.create_trip(
                                                                    user,
                                                                    constant_json.TRIP_TYPE_PROVIDER,
                                                                    req.body
                                                                        .service_type_id,
                                                                    req.body,
                                                                    function (
                                                                        response
                                                                    ) {
                                                                        if (
                                                                            response.success
                                                                        ) {
                                                                            var trip =
                                                                                response.trip
                                                                            // user.current_trip_id = trip._id;
                                                                            // user.save();
                                                                            if (
                                                                                trip.is_schedule_trip
                                                                            ) {
                                                                                res.json(
                                                                                    {
                                                                                        success: true,
                                                                                        trip: trip,
                                                                                        message:
                                                                                            success_messages.MESSAGE_CODE_YOUR_FUTURE_TRIP_CREATE_SUCCESSFULLY,
                                                                                    }
                                                                                )
                                                                            } else {
                                                                                trip.is_toll =
                                                                                    setting_detail.is_toll
                                                                                trip.provider_first_name =
                                                                                    provider_detail.first_name
                                                                                trip.provider_last_name =
                                                                                    provider_detail.last_name
                                                                                trip.provider_type =
                                                                                    provider_detail.provider_type
                                                                                trip.provider_type_id =
                                                                                    provider_detail.provider_type_id
                                                                                trip.current_provider =
                                                                                    provider_detail._id
                                                                                trip.current_providers =
                                                                                    [
                                                                                        provider_detail._id,
                                                                                    ]
                                                                                trip.confirmed_provider =
                                                                                    provider_detail._id
                                                                                trip.provider_id =
                                                                                    provider_detail._id
                                                                                trip.is_provider_accepted = 1
                                                                                trip.is_provider_status = 4
                                                                                var now_date =
                                                                                    new Date()
                                                                                trip.accepted_time =
                                                                                    now_date
                                                                                trip.provider_arrived_time =
                                                                                    now_date
                                                                                trip.provider_trip_start_time =
                                                                                    now_date

                                                                                var unique_id =
                                                                                    pad(
                                                                                        trip.unique_id,
                                                                                        7,
                                                                                        '0'
                                                                                    )
                                                                                var invoice_number =
                                                                                    constant_json.INVOICE_APP_NAME_CODE +
                                                                                    ' ' +
                                                                                    constant_json.INVOICE_PROVIDER_TRIP_EARNING_CODE +
                                                                                    ' ' +
                                                                                    moment(
                                                                                        new Date()
                                                                                    ).format(
                                                                                        constant_json.DATE_FORMAT_MMDDYYYY
                                                                                    ) +
                                                                                    ' ' +
                                                                                    unique_id
                                                                                trip.invoice_number =
                                                                                    invoice_number

                                                                                trip.save().then(
                                                                                    () => {
                                                                                        var trips =
                                                                                            []
                                                                                        trips.push(
                                                                                            trip._id
                                                                                        )
                                                                                        provider_detail.is_trip =
                                                                                            trips

                                                                                        provider_detail.save(
                                                                                            function () {}
                                                                                        )

                                                                                        // user.current_trip_id = trip._id;
                                                                                        // user.save();
                                                                                        res.json(
                                                                                            {
                                                                                                success: true,
                                                                                                message:
                                                                                                    success_messages.MESSAGE_CODE_YOUR_TRIP_CREATED_SUCCESSFULLY,
                                                                                                trip_id:
                                                                                                    trip._id,
                                                                                                user: user,
                                                                                            }
                                                                                        )
                                                                                    },
                                                                                    (
                                                                                        err
                                                                                    ) => {
                                                                                        console.log(
                                                                                            err
                                                                                        )
                                                                                        res.json(
                                                                                            {
                                                                                                success: false,
                                                                                                error_code:
                                                                                                    error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                                                            }
                                                                                        )
                                                                                    }
                                                                                )
                                                                            }
                                                                        } else {
                                                                            res.json(
                                                                                response
                                                                            )
                                                                        }
                                                                    }
                                                                )
                                                            },
                                                            (err) => {
                                                                console.log(err)
                                                                res.json({
                                                                    success: false,
                                                                    error_code:
                                                                        error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                                })
                                                            }
                                                        )
                                                    })
                                                }
                                            },
                                            (err) => {
                                                console.log(err)
                                                res.json({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                })
                                            }
                                        )
                                    } else {
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                                        })
                                    }
                                },
                                (err) => {
                                    console.log(err)
                                    res.json({
                                        success: false,
                                        error_code:
                                            error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                    })
                                }
                            )
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.send_request_from_dispatcher = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'trip_id', type: 'string' }],
        function (response) {
            if (response.success) {
                var provider_id = null
                if (req.body.provider_id) {
                    provider_id = req.body.provider_id
                }
                Trip.findOne({ _id: req.body.trip_id }).then(
                    (tripData) => {
                        exports.nearest_provider(
                            tripData,
                            provider_id,
                            [],
                            function (nearest_provider_response) {
                                res.json(nearest_provider_response)
                            }
                        )
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.get_near_by_provider = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'user_id', type: 'string' }],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user) => {
                        if (user) {
                            if (
                                req.body.token != null &&
                                user.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                if (req.body.request_time) {
                                    req.body.request_time = moment(
                                        moment(
                                            req.body.scheduled_request_time
                                        ).startOf('day')
                                    ).format(
                                        constant_json.DATE_FORMAT_MMM_D_YYYY
                                    )
                                } else {
                                    req.body.request_time = moment(
                                        moment(new Date()).startOf('day')
                                    ).format(
                                        constant_json.DATE_FORMAT_MMM_D_YYYY
                                    )
                                }
                                Citytype.findOne({
                                    _id: req.body.service_type_id,
                                }).then(
                                    (citytype) => {
                                        if (citytype) {
                                            exports.nearest_provider_list(
                                                citytype,
                                                req.body,
                                                function (
                                                    nearest_provider_response
                                                ) {
                                                    res.json(
                                                        nearest_provider_response
                                                    )
                                                }
                                            )
                                        } else {
                                            exports.nearest_provider_list(
                                                null,
                                                req.body,
                                                function (
                                                    nearest_provider_response
                                                ) {
                                                    res.json(
                                                        nearest_provider_response
                                                    )
                                                }
                                            )
                                        }
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.provider_get_trips = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'provider_id', type: 'string' }],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    async (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                if (!provider.is_near_trip) {
                                    provider.is_near_trip = []
                                }
                                if (
                                    provider.is_trip.length == 0 &&
                                    provider.is_near_trip.length != 0
                                ) {
                                    provider.is_trip = provider.is_near_trip
                                    provider.is_available = 0
                                    provider.is_near_trip = []
                                    await provider.save()
                                }
                                return res.json({
                                    success: true,
                                    message:
                                        success_messages.MESSAGE_CODE_YOU_GET_TRIP,
                                    trip_detail: provider.is_trip,
                                })
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.provider_get_trip_details = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'provider_id', type: 'string' }],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
            try {
                let provider = await Provider.findOne({
                    _id: req.body.provider_id,
                })
                if (!provider) {
                    return res.json({
                        success: false,
                        error_code:
                            error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                    })
                }
                if (
                    req.body.token != null &&
                    provider.token != req.body.token
                ) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_INVALID_TOKEN,
                    })
                }
                if (!provider.is_near_trip) {
                    provider.is_near_trip = []
                }
                if (
                    provider.is_trip.length == 0 &&
                    provider.is_near_trip.length != 0
                ) {
                    provider.is_trip = provider.is_near_trip
                    provider.is_available = 0
                    provider.is_near_trip = []
                }
                if (provider.is_trip.length == 0) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
                    })
                }

                let trip = await Trip.find({ _id: { $in: provider.is_trip } })
                let trip_histories = await Trip_history.find({
                    _id: { $in: provider.is_trip },
                })
                let trips = [...trip, ...trip_histories]
                let trip_detail = []

                for (const trip of trips) {
                    if (
                        trip.is_trip_cancelled == 0 &&
                        trip.is_provider_invoice_show == 0 &&
                        trip.is_trip_completed == 0
                    ) {
                        let user_detail = await User.findOne({
                            _id: trip.user_id,
                        })
                        let start_time = trip.updated_at
                        let end_time = new Date()
                        let res_sec = utils.getTimeDifferenceInSecond(
                            end_time,
                            start_time
                        )
                        let provider_timeout = setting_detail.provider_timeout
                        let time_left_to_responds_trip =
                            provider_timeout - res_sec

                        trip_detail.push({
                            trip_id: trip._id,
                            unique_id: trip.unique_id,
                            user_id: trip.user_id,
                            is_provider_accepted: trip.is_provider_accepted,
                            is_provider_status: trip.is_provider_status,
                            trip_type: trip.trip_type,
                            source_address: trip.source_address,
                            destination_address: trip.destination_address,
                            sourceLocation: trip.sourceLocation,
                            destinationLocation: trip.destinationLocation,
                            is_trip_end: trip.is_trip_end,
                            time_left_to_responds_trip:
                                time_left_to_responds_trip,
                            user: {
                                first_name: user_detail.first_name,
                                last_name: user_detail.last_name,
                                phone: user_detail.phone,
                                country_phone_code:
                                    user_detail.country_phone_code,
                                rate: user_detail.rate,
                                rate_count: user_detail.rate_count,
                                picture: user_detail.picture,
                            },
                        })
                    } else {
                        provider = utils.remove_is_trip_from_provider(
                            provider,
                            trip._id,
                            trip.initialDestinationLocation
                        )
                        if (!provider.is_near_trip) {
                            provider.is_near_trip = []
                        }
                        if (
                            String(provider.is_near_trip[0]) == String(trip._id)
                        ) {
                            provider.is_near_available = 1
                            provider.is_near_trip = []
                        }
                    }
                }
                await provider.save()

                if (trip_detail.length == 0) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
                    })
                }
                trip_detail.sort(
                    (a, b) => a.is_provider_accepted - b.is_provider_accepted
                )
                return res.json({
                    success: true,
                    message: success_messages.MESSAGE_CODE_YOU_GET_TRIP,
                    trip_detail,
                })
            } catch (e) {
                console.log(e)
                return res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                })
            }
        }
    )
}

////////////USER  GET TRIPSTATUS//////////// ///
exports.user_get_trip_status = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'user_id', type: 'string' }],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user) => {
                        if (user) {
                            if (user.is_approved == 0) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_USER_NOT_APPROVED,
                                })
                            } else {
                                if (user.token != req.body.token) {
                                    res.json({
                                        success: false,
                                        error_code:
                                            error_message.ERROR_CODE_INVALID_TOKEN,
                                    })
                                } else {
                                    var json

                                    if (req.body.type == 'web') {
                                        json = {
                                            user_id: req.body.user_id,
                                            _id: req.body.trip_id,
                                        }
                                    } else {
                                        json = {
                                            user_id: req.body.user_id,
                                            _id: req.body.trip_id,
                                        }
                                    }
                                    Trip.findOne(json).then(
                                        (trip) => {
                                            Trip_history.findOne(json).then(
                                                (trip_history) => {
                                                    if (!trip) {
                                                        trip = trip_history
                                                    }

                                                    if (trip) {
                                                        if (
                                                            trip.is_trip_cancelled_by_provider ==
                                                            1
                                                        ) {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_TRIP_CANCELLED_BY_PROVIDER,
                                                            })
                                                        } else {
                                                            Trip_Service.findOne(
                                                                {
                                                                    _id: trip.trip_service_city_type_id,
                                                                }
                                                            ).then(
                                                                (
                                                                    tripservice
                                                                ) => {
                                                                    if (
                                                                        tripservice
                                                                    ) {
                                                                        Citytype.findById(
                                                                            trip.service_type_id
                                                                        ).then(
                                                                            (
                                                                                citytype_detail
                                                                            ) => {
                                                                                Type.findById(
                                                                                    citytype_detail.typeid
                                                                                ).then(
                                                                                    async (
                                                                                        type_detail
                                                                                    ) => {
                                                                                        var cancellation_fee =
                                                                                            tripservice.cancellation_fee

                                                                                        if (
                                                                                            trip.car_rental_id
                                                                                        ) {
                                                                                            var rental_main_citytype =
                                                                                                await Citytype.findOne(
                                                                                                    {
                                                                                                        car_rental_ids:
                                                                                                            trip.car_rental_id,
                                                                                                    }
                                                                                                )
                                                                                            if (
                                                                                                rental_main_citytype
                                                                                            ) {
                                                                                                cancellation_fee =
                                                                                                    rental_main_citytype.cancellation_fee
                                                                                            }
                                                                                        }

                                                                                        var waiting_time_start_after_minute =
                                                                                            tripservice.waiting_time_start_after_minute
                                                                                        var price_for_waiting_time =
                                                                                            tripservice.price_for_waiting_time
                                                                                        var total_wait_time = 0
                                                                                        var provider_arrived_time =
                                                                                            trip.provider_arrived_time
                                                                                        if (
                                                                                            provider_arrived_time !=
                                                                                            null
                                                                                        ) {
                                                                                            var end_time =
                                                                                                new Date()
                                                                                            total_wait_time =
                                                                                                utils.getTimeDifferenceInSecond(
                                                                                                    end_time,
                                                                                                    provider_arrived_time
                                                                                                )
                                                                                            total_wait_time =
                                                                                                total_wait_time -
                                                                                                waiting_time_start_after_minute *
                                                                                                    60
                                                                                        }

                                                                                        City.findOne(
                                                                                            {
                                                                                                _id: citytype_detail.cityid,
                                                                                            }
                                                                                        ).then(
                                                                                            (
                                                                                                cityDetail
                                                                                            ) => {
                                                                                                if (
                                                                                                    !cityDetail
                                                                                                ) {
                                                                                                    res.json(
                                                                                                        {
                                                                                                            success: false,
                                                                                                            error_code:
                                                                                                                error_message.ERROR_CODE_NO_CITY_LIST_FOUND,
                                                                                                        }
                                                                                                    )
                                                                                                } else {
                                                                                                    User_promo_use.findOne(
                                                                                                        {
                                                                                                            trip_id:
                                                                                                                trip._id,
                                                                                                        }
                                                                                                    ).then(
                                                                                                        (
                                                                                                            user_promo_use
                                                                                                        ) => {
                                                                                                            var isPromoUsed = 0
                                                                                                            var PAYMENT_TYPES =
                                                                                                                utils.PAYMENT_TYPES()
                                                                                                            if (
                                                                                                                user_promo_use
                                                                                                            ) {
                                                                                                                isPromoUsed = 1
                                                                                                            }
                                                                                                            if (
                                                                                                                trip.is_provider_status ==
                                                                                                                6
                                                                                                            ) {
                                                                                                                var now =
                                                                                                                    new Date()
                                                                                                                var minutes =
                                                                                                                    utils.getTimeDifferenceInMinute(
                                                                                                                        now,
                                                                                                                        trip.provider_trip_start_time
                                                                                                                    )
                                                                                                                trip.total_time =
                                                                                                                    minutes
                                                                                                                trip.save()
                                                                                                            }

                                                                                                            var now =
                                                                                                                new Date()
                                                                                                            var provider_trip_end_time =
                                                                                                                trip.provider_trip_end_time
                                                                                                            var diff =
                                                                                                                utils.getTimeDifferenceInSecond(
                                                                                                                    now,
                                                                                                                    provider_trip_end_time
                                                                                                                )
                                                                                                            // console.log("diff: "+diff)
                                                                                                            var tip_timeout = 30
                                                                                                            if (
                                                                                                                diff <
                                                                                                                0
                                                                                                            ) {
                                                                                                                diff = 0
                                                                                                            }
                                                                                                            var time_left_for_tip =
                                                                                                                tip_timeout -
                                                                                                                diff
                                                                                                            res.json(
                                                                                                                {
                                                                                                                    success: true,
                                                                                                                    map_pin_image_url:
                                                                                                                        type_detail.map_pin_image_url,
                                                                                                                    message:
                                                                                                                        success_messages.MESSAGE_CODE_YOU_GET_TRIP_STATUS,
                                                                                                                    city_detail:
                                                                                                                        cityDetail,
                                                                                                                    trip: trip,
                                                                                                                    time_left_for_tip:
                                                                                                                        time_left_for_tip,
                                                                                                                    waiting_time_start_after_minute:
                                                                                                                        waiting_time_start_after_minute,
                                                                                                                    price_for_waiting_time:
                                                                                                                        price_for_waiting_time,
                                                                                                                    total_wait_time:
                                                                                                                        total_wait_time,
                                                                                                                    isPromoUsed:
                                                                                                                        isPromoUsed,
                                                                                                                    cancellation_fee:
                                                                                                                        cancellation_fee,
                                                                                                                    payment_gateway:
                                                                                                                        PAYMENT_TYPES,
                                                                                                                }
                                                                                                            )
                                                                                                        }
                                                                                                    )
                                                                                                }
                                                                                            }
                                                                                        )
                                                                                    }
                                                                                )
                                                                            }
                                                                        )
                                                                    } else {
                                                                        res.json(
                                                                            {
                                                                                success: false,
                                                                                error_code:
                                                                                    error_message.ERROR_CODE_NO_TRIP,
                                                                            }
                                                                        )
                                                                    }
                                                                }
                                                            )
                                                        }
                                                    } else {
                                                        res.json({
                                                            success: false,
                                                            error_code:
                                                                error_message.ERROR_CODE_NO_TRIP,
                                                        })
                                                    }
                                                }
                                            )
                                        },
                                        (err) => {
                                            console.log(err)
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                            })
                                        }
                                    )
                                }
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

/////////////RESPOND TRIP///////////////////

exports.responds_trip = function (req, res) {
    // console.log(req.body)

    utils.check_request_params(
        req.body,
        [{ name: 'provider_id', type: 'string' }],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    current_providers: provider._id,
                                }).then(
                                    (trip) => {
                                        if (trip) {
                                            var is_provider_accepted =
                                                req.body.is_provider_accepted

                                            if (trip.is_trip_cancelled == 1) {
                                                if (is_provider_accepted == 1) {
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_TRIP_IS_ALREADY_CANCELLED,
                                                    })
                                                } else {
                                                    res.json({
                                                        success: true,
                                                        message:
                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_REJECTED_TRIP,
                                                    })
                                                }
                                            } else if (
                                                trip.is_provider_accepted == 1
                                            ) {
                                                if (is_provider_accepted == 1) {
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_TRIP_IS_ALREADY_ACCEPTED,
                                                    })
                                                } else {
                                                    res.json({
                                                        success: true,
                                                        message:
                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_REJECTED_TRIP,
                                                    })
                                                }
                                            } else {
                                                if (is_provider_accepted == 1) {
                                                    exports.accept_trip(
                                                        provider,
                                                        trip,
                                                        req.body.partner_id,
                                                        function (
                                                            accepte_trip_response
                                                        ) {
                                                            res.json(
                                                                accepte_trip_response
                                                            )
                                                        }
                                                    )
                                                } else {
                                                    exports.reject_trip(
                                                        trip,
                                                        req.body.provider_id,
                                                        req.body
                                                            .is_request_timeout,
                                                        function (
                                                            reject_trip_response
                                                        ) {
                                                            res.json(
                                                                reject_trip_response
                                                            )
                                                        }
                                                    )
                                                }
                                            }
                                        } else {
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_TRIP_IS_ALREADY_ACCEPTED,
                                            })
                                        }
                                    },
                                    () => {
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.accept_trip = async function (provider, trip, partner_id, response) {
    var now = new Date()
    trip.current_provider = provider._id
    trip.provider_type = provider.provider_type
    // trip.provider_type_id = provider.provider_type_id;
    trip.confirmed_provider = provider._id
    trip.provider_app_version = provider.app_version
    trip.provider_device_type = provider.device_type
    trip.is_provider_accepted = 1
    if (trip.is_provider_status == 0) {
        trip.is_provider_status = 1
    }
    trip.accepted_time = now
    trip.is_schedule_trip = false
    trip.provider_first_name = provider.first_name
    trip.provider_last_name = provider.last_name
    trip.assigned_provider_id = provider._id
    // trip.trip_assigned_by = constant_json.PARTNER_UNIQUE_NUMBER;
    trip.assigned_provider_details = {
        _id: provider._id,
        name: provider.first_name + ' ' + provider.last_name,
        email: provider.email,
        phone: provider.phone,
        country_phone_code: provider.country_phone_code,
    }
    var unique_id = pad(trip.unique_id, 7, '0')
    var invoice_number =
        constant_json.INVOICE_APP_NAME_CODE +
        ' ' +
        constant_json.INVOICE_PROVIDER_TRIP_EARNING_CODE +
        ' ' +
        moment(now).format(constant_json.DATE_FORMAT_MMDDYYYY) +
        ' ' +
        unique_id
    trip.invoice_number = invoice_number
    trip.provider_id = provider._id
    trip.providerLocation = provider.providerLocation
    trip.bearing = provider.bearing

    var current_providers = trip.current_providers

    trip.current_providers = []
    var partner_details = await Partner.findOne({ _id: Schema(partner_id) })
    if (!partner_details) {
        response({
            success: false,
            error_code: error_message.ERROR_CODE_SELECT_PARTNER,
        })
    }

    trip.assigned_partner_name =
        partner_details.first_name + ' ' + partner_details.last_name
    trip.provider_type_id = partner_details._id
    let trip_date_tag = utils.getTripDateTag(trip, new Date())
    let check_trip_date_start = new Date(
        trip_date_tag.getTime() - 30 * 60 * 1000
    )
    let check_trip_date_end = new Date(trip_date_tag.getTime() + 30 * 60 * 1000)
    if (response && !trip.assigned_vehicle_details) {
        let available_vehicle = provider.vehicle_detail.find(find_vehicle)
        function find_vehicle(vehicle) {
            let a = -1
            let selected_partner = true
            let service = 0
            let capacity = 0
            let model = 0

            if (
                vehicle.vehicle_book_dates &&
                vehicle.vehicle_book_dates.length > 0
            ) {
                a = vehicle.vehicle_book_dates.findIndex(
                    (x) =>
                        x.trip_date >= check_trip_date_start &&
                        x.trip_date <= check_trip_date_end
                )
            }

            if (
                trip.capacity_details &&
                vehicle.selected_capacity_id.length == 0
            ) {
                capacity = -1
            } else if (
                trip.capacity_details &&
                vehicle.selected_capacity_id &&
                vehicle.selected_capacity_id.length > 0
            ) {
                capacity = vehicle.selected_capacity_id.findIndex(
                    (x) => x.toString() == trip.capacity_details._id.toString()
                )
            }

            // if(trip.service_details && trip.service_details._id.toString() != vehicle.selected_services_id.toString()){
            //     service_details = false
            // }

            if (
                trip.service_details &&
                vehicle.selected_services_id.length == 0
            ) {
                service = -1
            } else if (
                trip.service_details &&
                vehicle.selected_services_id &&
                vehicle.selected_services_id.length > 0
            ) {
                service = vehicle.selected_services_id.findIndex(
                    (x) => x.toString() == trip.service_details._id.toString()
                )
            }

            if (trip.model_details && vehicle.selected_model_id.length == 0) {
                model = -1
            } else if (
                trip.model_details &&
                vehicle.selected_model_id &&
                vehicle.selected_model_id.length > 0
            ) {
                model = vehicle.selected_model_id.findIndex(
                    (x) => x.toString() == trip.model_details._id.toString()
                )
            }
            if (vehicle.vehicle_type_id.toString() != partner_id.toString()) {
                selected_partner = false
            }
            if (
                a == -1 &&
                service > -1 &&
                capacity > -1 &&
                model > -1 &&
                selected_partner &&
                vehicle.state == 1
            ) {
                return vehicle
            }
        }

        let plate_no = ''
        if (available_vehicle) {
            plate_no = available_vehicle.plate_no

            let vehicle1_type = ''
            let vehicle1_model = ''

            var service_type = await Citytype.findOne({
                _id: available_vehicle.service_type,
            })
            vehicle1_model = service_type.typename

            if (available_vehicle.selected_model_id.length > 0) {
                var vehicle_model = await Type_Models.find({
                    _id: { $in: available_vehicle.selected_model_id },
                }).lean()
            }

            if (available_vehicle.selected_services_id.length > 0) {
                var vehicle_services = await Type_Services.find({
                    _id: { $in: available_vehicle.selected_services_id },
                }).lean()
            }

            if (available_vehicle.selected_capacity_id.length > 0) {
                var vehicle_capacity = await Type_Capacity.find({
                    _id: { $in: available_vehicle.selected_capacity_id },
                }).lean()
            }

            let vehicle_model_details = []
            if (vehicle_model && vehicle_model.length > 0) {
                vehicle_model.forEach((model) => {
                    let vehicle_model_data = {
                        vehicle_model_id: model._id,
                        vehicle_model_name: model.model_name,
                    }
                    vehicle1_type = model.model_name
                    vehicle_model_details.push(vehicle_model_data)
                })
            }

            let vehicle_service_details = []
            if (vehicle_services && vehicle_services.length > 0) {
                vehicle_services.forEach((service) => {
                    let vehicle_service_data = {
                        vehicle_service_id: service._id,
                        vehicle_service_name: service.service_name,
                    }
                    vehicle_service_details.push(vehicle_service_data)
                })
            }

            let vehicle_capacity_details = []
            if (vehicle_capacity && vehicle_capacity.length > 0) {
                vehicle_capacity.forEach((capacity) => {
                    let vehicle_capacity_data = {
                        vehicle_capacity_id: capacity._id,
                        vehicle_capacity_name: capacity.capacity_name,
                    }
                    vehicle_capacity_details.push(vehicle_capacity_data)
                })
            }

            trip.assigned_vehicle_details = {
                vehicle_model_details: vehicle_model_details,
                vehicle_capacity_details: vehicle_capacity_details,
                vehicle_service_details: vehicle_service_details,
                vehicle_truck_type_id: service_type._id,
                vehicle_truck_type_name: service_type.typename,
                vehicle_plate_no: plate_no,
            }

            trip.assigned_vehicle_id = available_vehicle._id
        } else {
            response({
                success: false,
                error_code: error_message.ERROR_CODE_NO_VEHICLE_AVAILABLE,
            })
            return
        }
    }
    User.findOne({ _id: trip.user_id }, async function (error, user_detail) {
        var is_favourite_provider = false
        if (user_detail) {
            var index = user_detail.favourite_providers.findIndex(
                (x) => x.toString() == provider._id.toString()
            )
            if (index !== -1) {
                is_favourite_provider = true
            }
        }
        trip.is_favourite_provider = is_favourite_provider
        let updateCount = await Trip.updateOne(
            { _id: trip._id },
            trip.getChanges()
        )
        if (updateCount.modifiedCount != 0) {
            Provider.find({
                $and: [
                    { _id: { $in: current_providers } },
                    { _id: { $ne: trip.confirmed_provider } },
                ],
            }).then((providers_list) => {
                providers_list.forEach(function (provider) {
                    utils.sendPushNotification(
                        constant_json.PROVIDER_UNIQUE_NUMBER,
                        provider.device_type,
                        provider.device_token,
                        push_messages.PUSH_CODE_FOR_TRIP_ACCEPTED_BY_ANOTHER_PROVIDER,
                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                    )
                })
            })

            Provider.find({
                $and: [
                    { _id: { $in: current_providers } },
                    { _id: { $ne: trip.confirmed_provider } },
                ],
            }).then(async (provider_list) => {
                for (const provider of provider_list) {
                    let is_trip_condition = { _id: provider._id }
                    let is_trip_update = { is_available: 1, is_trip: [] }

                    if (provider.is_trip.length > 1) {
                        is_trip_update = {
                            is_available: 0,
                            $pull: { is_trip: trip._id },
                        }
                    }

                    if (!provider.is_near_trip) {
                        provider.is_near_trip = []
                    }
                    if (provider.is_near_trip.length != 0) {
                        is_trip_update = {
                            is_near_available: 1,
                            is_near_trip: [],
                        }
                    }
                    await Provider.updateOne(is_trip_condition, is_trip_update)
                }
            })

            User.findOne({ _id: trip.user_id }).then((user) => {
                if (user) {
                    if (setting_detail.sms_notification) {
                        utils.sendOtherSMS(
                            user.country_phone_code + user.phone,
                            5,
                            ''
                        )
                    }
                    let extra_param = {
                        trip_id: trip._id,
                    }
                    utils.sendPushNotification(
                        constant_json.USER_UNIQUE_NUMBER,
                        user.device_type,
                        user.device_token,
                        push_messages.PUSH_CODE_FOR_ACCEPT_TRIP,
                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                        extra_param
                    )
                }
            })

            myAnalytics.insert_daily_provider_analytics(
                trip.timezone,
                provider._id,
                TRIP_STATUS.PROVIDER_ACCEPTED,
                null
            )

            provider.accepted_request = provider.accepted_request + 1
            provider.is_available = 0
            if (trip.is_ride_share) {
                provider.is_ride_share = 1
                if (!provider.destinationLocation) {
                    provider.destinationLocation = []
                }
                provider.destinationLocation.push(trip.destinationLocation)
            }
            provider.markModified('destinationLocation')
            await provider.save()
            utils.update_request_status_socket(trip._id)
            if (response) {
                let provider_trip_date_tag = {
                    trip_id: trip._id,
                    trip_date: trip_date_tag,
                }
                await Provider.updateOne(
                    { _id: provider._id },
                    { $push: { provider_trip_dates: provider_trip_date_tag } }
                )
                await Partner.updateOne(
                    { 'vehicle_detail._id': trip.assigned_vehicle_id },
                    {
                        $push: {
                            'vehicle_detail.$.vehicle_book_dates':
                                provider_trip_date_tag,
                        },
                    }
                )
                await Provider.updateMany(
                    { 'vehicle_detail._id': trip.assigned_vehicle_id },
                    {
                        $push: {
                            'vehicle_detail.$.vehicle_book_dates':
                                provider_trip_date_tag,
                        },
                    }
                )

                response({
                    success: true,
                    message:
                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_ACCEPTED_TRIP_SUCCESSFULLY,
                    is_provider_accepted: trip.is_provider_accepted,
                })
            } else {
                let device_type = provider.device_type
                let device_token = provider.device_token
                utils.sendPushNotification(
                    constant_json.PROVIDER_UNIQUE_NUMBER,
                    device_type,
                    device_token,
                    push_messages.PUSH_CODE_FOR_DRIVER_NOTIFY_FOR_SCHEDULE_TRIP,
                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                )
                const provider_id = "'get_new_request_" + provider._id + "'"
                socket_object.emit(provider_id, { trip_id: trip._id })
            }
        } else {
            response({
                success: false,
                error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
            })
        }
    })
}

exports.reject_trip = function (
    trip,
    provider_id,
    is_request_timeout,
    response
) {
    // console.log("trip rejection")
    var now = new Date()
    var unique_id = pad(trip.unique_id, 7, '0')
    var invoice_number =
        constant_json.INVOICE_APP_NAME_CODE +
        ' ' +
        constant_json.INVOICE_PROVIDER_TRIP_EARNING_CODE +
        ' ' +
        moment(now).format(constant_json.DATE_FORMAT_MMDDYYYY) +
        ' ' +
        unique_id
    trip.invoice_number = invoice_number
    if (
        !is_request_timeout ||
        setting_detail.find_nearest_driver_type ==
            Number(constant_json.NEAREST_PROVIDER_TYPE_SINGLE)
    ) {
        var providers_id_that_rejected_trip =
            trip.providers_id_that_rejected_trip
        providers_id_that_rejected_trip.push(provider_id)
        trip.providers_id_that_rejected_trip = providers_id_that_rejected_trip
    }

    Provider.findOne({ _id: provider_id }).then((current_provider) => {
        if (current_provider) {
            var zone_queue_id = current_provider.zone_queue_id
            if (current_provider.zone_queue_id) {
                Citytype.findOne(
                    { _id: trip.service_type_id },
                    async function () {
                        current_provider =
                            await utils.remove_from_zone_queue_new(
                                current_provider
                            )
                        current_provider = await utils.add_in_zone_queue_new(
                            zone_queue_id,
                            current_provider
                        )
                        if (is_request_timeout) {
                            myAnalytics.insert_daily_provider_analytics(
                                trip.timezone,
                                current_provider._id,
                                TRIP_STATUS.NOT_ANSWERED,
                                null
                            )
                        } else {
                            myAnalytics.insert_daily_provider_analytics(
                                trip.timezone,
                                current_provider._id,
                                TRIP_STATUS.PROVIDER_REJECTED,
                                null
                            )
                        }
                        current_provider.rejected_request =
                            current_provider.rejected_request + 1
                        current_provider = utils.remove_is_trip_from_provider(
                            current_provider,
                            trip._id
                        )
                        if (!current_provider.is_near_trip) {
                            current_provider.is_near_trip = []
                        }
                        if (
                            String(current_provider.is_near_trip[0]) ==
                            String(trip._id)
                        ) {
                            current_provider.is_near_available = 1
                            current_provider.is_near_trip = []
                        }
                        current_provider.save()

                        Provider.updateMany(
                            {
                                zone_queue_id: current_provider.zone_queue_id,
                                _id: { $ne: current_provider._id },
                            },
                            { $inc: { zone_queue_no: -1 } },
                            { multi: true },
                            function (error) {
                                console.log(error)
                            }
                        )
                    }
                )
            } else {
                if (is_request_timeout) {
                    myAnalytics.insert_daily_provider_analytics(
                        trip.timezone,
                        current_provider._id,
                        TRIP_STATUS.NOT_ANSWERED,
                        null
                    )
                } else {
                    myAnalytics.insert_daily_provider_analytics(
                        trip.timezone,
                        current_provider._id,
                        TRIP_STATUS.PROVIDER_REJECTED,
                        null
                    )
                }
                current_provider.rejected_request =
                    current_provider.rejected_request + 1
                current_provider = utils.remove_is_trip_from_provider(
                    current_provider,
                    trip._id
                )

                if (!current_provider.is_near_trip) {
                    current_provider.is_near_trip = []
                }
                if (
                    String(current_provider.is_near_trip[0]) == String(trip._id)
                ) {
                    current_provider.is_near_available = 1
                    current_provider.is_near_trip = []
                }
                current_provider.save()
            }
        }
    })

    if (
        setting_detail.find_nearest_driver_type ==
        Number(constant_json.NEAREST_PROVIDER_TYPE_MULTIPLE)
    ) {
        var index = trip.current_providers.findIndex(
            (x) => x.toString() == provider_id.toString()
        )
        if (index !== -1) {
            trip.current_providers.splice(index, 1)
            trip.markModified('current_providers')
        }
    }

    trip.save().then(
        () => {
            utils.update_request_status_socket(trip._id)
            response({
                success: true,
                message:
                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_REJECTED_TRIP,
                is_provider_accepted: trip.is_provider_accepted,
            })
            if (
                setting_detail.find_nearest_driver_type ==
                Number(constant_json.NEAREST_PROVIDER_TYPE_SINGLE)
            ) {
                exports.nearest_provider(trip, null, [], function () {})
            }
        },
        (err) => {
            console.log(err)
            response({
                success: false,
                error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
            })
        }
    )
}

exports.trip_cancel_by_user = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'user_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user) => {
                        if (user) {
                            if (
                                req.body.type !=
                                    constant_json.TRIP_TYPE_DISPATCHER &&
                                req.body.type !=
                                    constant_json.TRIP_TYPE_CORPORATE &&
                                user.token != req.body.token
                            ) {
                                if (req.body.type !== 'Admin') {
                                    res.json({
                                        success: false,
                                        error_code:
                                            error_message.ERROR_CODE_INVALID_TOKEN,
                                    })
                                }
                            } else {
                                Trip.findOne({ _id: req.body.trip_id }).then(
                                    async (trip) => {
                                        if (!trip) {
                                            trip = await Trip_history.findOne({
                                                _id: req.body.trip_id,
                                            })
                                        }

                                        var cancel_reason =
                                            req.body.cancel_reason
                                        if (trip) {
                                            let corporate_data = null
                                            if (user.user_type_id) {
                                                corporate_data =
                                                    await Corporate.findOne({
                                                        _id: user.user_type_id,
                                                    })
                                                        .select({
                                                            is_use_fixed_partner_profit: 1,
                                                            is_own_service_type: 1,
                                                        })
                                                        .lean()
                                            }

                                            if (
                                                trip.is_trip_completed == 0 &&
                                                trip.is_trip_end == 0
                                            ) {
                                                if (
                                                    trip.is_trip_cancelled ==
                                                        0 &&
                                                    trip.is_trip_cancelled_by_user ==
                                                        0 &&
                                                    trip.is_trip_cancelled_by_provider ==
                                                        0
                                                ) {
                                                    var trip_type =
                                                        trip.trip_type
                                                    var providerID =
                                                        trip.confirmed_provider

                                                    var status =
                                                        trip.is_provider_status
                                                    var complete_date_in_city_timezone =
                                                        utils.get_date_now_at_city(
                                                            new Date(),
                                                            trip.timezone
                                                        )
                                                    var complete_date_tag =
                                                        moment(
                                                            moment(
                                                                complete_date_in_city_timezone
                                                            ).startOf('day')
                                                        ).format(
                                                            constant_json.DATE_FORMAT_MMM_D_YYYY
                                                        )
                                                    trip.complete_date_in_city_timezone =
                                                        complete_date_in_city_timezone
                                                    trip.complete_date_tag =
                                                        complete_date_tag
                                                    trip.payment_status =
                                                        PAYMENT_STATUS.COMPLETED
                                                    trip.provider_trip_end_time =
                                                        new Date()

                                                    trip.cancellation_details =
                                                        trip.cancellation_details ||
                                                        {}
                                                    trip.cancellation_details.type =
                                                        req.body.user_type ==
                                                        constant_json.CORPORATE_UNIQUE_NUMBER
                                                            ? Number(
                                                                  constant_json.CORPORATE_UNIQUE_NUMBER
                                                              )
                                                            : Number(
                                                                  constant_json.USER_UNIQUE_NUMBER
                                                              )

                                                    Provider.find({
                                                        _id: {
                                                            $in: trip.current_providers,
                                                        },
                                                    }).then(
                                                        async (
                                                            provider_list
                                                        ) => {
                                                            for (const provider of provider_list) {
                                                                let is_trip_condition =
                                                                    {
                                                                        _id: provider._id,
                                                                    }
                                                                let is_trip_update =
                                                                    {
                                                                        is_available: 1,
                                                                        is_trip:
                                                                            [],
                                                                    }

                                                                if (
                                                                    !provider.is_near_trip
                                                                ) {
                                                                    provider.is_near_trip =
                                                                        []
                                                                }
                                                                if (
                                                                    provider
                                                                        .is_near_trip
                                                                        .length !=
                                                                    0
                                                                ) {
                                                                    is_trip_update =
                                                                        {
                                                                            is_near_available: 1,
                                                                            is_near_trip:
                                                                                [],
                                                                        }
                                                                }
                                                                await Provider.updateOne(
                                                                    is_trip_condition,
                                                                    is_trip_update
                                                                )
                                                            }
                                                        }
                                                    )
                                                    if (status == 0) {
                                                        trip.cancel_reason =
                                                            cancel_reason
                                                        trip.is_trip_cancelled = 1
                                                        trip.is_trip_cancelled_by_user = 1

                                                        trip.save().then(
                                                            () => {
                                                                // user.current_trip_id = null;
                                                                user.cancelled_request =
                                                                    user.cancelled_request +
                                                                    1
                                                                user.save()
                                                                utils.update_request_status_socket(
                                                                    trip._id
                                                                )
                                                                Trip.findOneAndRemove(
                                                                    {
                                                                        _id: req
                                                                            .body
                                                                            .trip_id,
                                                                    }
                                                                ).then(
                                                                    async (
                                                                        deleted_trip
                                                                    ) => {
                                                                        if (
                                                                            deleted_trip
                                                                        ) {
                                                                            var trip_history_data =
                                                                                new Trip_history(
                                                                                    JSON.parse(
                                                                                        JSON.stringify(
                                                                                            deleted_trip
                                                                                        )
                                                                                    )
                                                                                )
                                                                            trip_history_data.save(
                                                                                async function () {
                                                                                    utils.remove_dates_driver_vehicle(
                                                                                        trip._id,
                                                                                        trip.model_type
                                                                                    )
                                                                                    res.json(
                                                                                        {
                                                                                            success: true,
                                                                                            message:
                                                                                                success_messages.MESSAGE_CODE_YOUR_TRIP_CANCELLED_SUCCESSFULLY,
                                                                                        }
                                                                                    )
                                                                                }
                                                                            )
                                                                        } else {
                                                                            utils.remove_dates_driver_vehicle(
                                                                                trip._id,
                                                                                trip.model_type
                                                                            )
                                                                            res.json(
                                                                                {
                                                                                    success: true,
                                                                                    message:
                                                                                        success_messages.MESSAGE_CODE_YOUR_TRIP_CANCELLED_SUCCESSFULLY,
                                                                                }
                                                                            )
                                                                        }
                                                                    }
                                                                )
                                                            },
                                                            () => {
                                                                res.json({
                                                                    success: false,
                                                                    error_code:
                                                                        error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                                })
                                                            }
                                                        )
                                                    } else {
                                                        trip.cancel_reason =
                                                            cancel_reason
                                                        trip.is_trip_cancelled = 1
                                                        if (
                                                            trip.is_provider_accepted ==
                                                            constant_json.YES
                                                        ) {
                                                            trip.is_trip_cancelled_by_user = 1
                                                        }

                                                        trip.save().then(
                                                            () => {
                                                                Provider.findOne(
                                                                    {
                                                                        _id: providerID,
                                                                    }
                                                                ).then(
                                                                    (
                                                                        provider
                                                                    ) => {
                                                                        if (
                                                                            provider
                                                                        ) {
                                                                            utils.sendPushNotification(
                                                                                constant_json.PROVIDER_UNIQUE_NUMBER,
                                                                                provider.device_type,
                                                                                provider.device_token,
                                                                                push_messages.PUSH_CODE_FOR_TRIP_CANCELLED_BY_USER,
                                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                                            )
                                                                            provider =
                                                                                utils.remove_is_trip_from_provider(
                                                                                    provider,
                                                                                    trip._id,
                                                                                    trip.initialDestinationLocation
                                                                                )
                                                                            provider.save()
                                                                        }
                                                                    }
                                                                )

                                                                User_promo_use.findOne(
                                                                    {
                                                                        trip_id:
                                                                            trip._id,
                                                                    }
                                                                ).then(
                                                                    (
                                                                        userpromouse
                                                                    ) => {
                                                                        if (
                                                                            userpromouse
                                                                        ) {
                                                                            userpromouse.remove()
                                                                        }
                                                                    }
                                                                )
                                                                Promo_Code.findOne(
                                                                    {
                                                                        _id: trip.promo_id,
                                                                    }
                                                                ).then(
                                                                    (
                                                                        promo_code
                                                                    ) => {
                                                                        if (
                                                                            promo_code
                                                                        ) {
                                                                            promo_code.user_used_promo =
                                                                                promo_code.user_used_promo -
                                                                                1
                                                                            promo_code.save()
                                                                        }
                                                                    }
                                                                )

                                                                if (
                                                                    status == 4
                                                                ) {
                                                                    Trip_Service.findOne(
                                                                        {
                                                                            _id: trip.trip_service_city_type_id,
                                                                        }
                                                                    ).then(
                                                                        async (
                                                                            tripservice_data
                                                                        ) => {
                                                                            var cancellationCharges =
                                                                                tripservice_data.cancellation_fee
                                                                            Number(
                                                                                (
                                                                                    trip.fixed_price *
                                                                                    tripservice_data.cancellation_fee *
                                                                                    0.01
                                                                                ).toFixed(
                                                                                    3
                                                                                )
                                                                            )
                                                                            if (
                                                                                trip.car_rental_id
                                                                            ) {
                                                                                var rental_main_citytype =
                                                                                    await Citytype.findOne(
                                                                                        {
                                                                                            car_rental_ids:
                                                                                                trip.car_rental_id,
                                                                                        }
                                                                                    )
                                                                                if (
                                                                                    rental_main_citytype
                                                                                ) {
                                                                                    cancellationCharges =
                                                                                        tripservice_data.cancellation_fee
                                                                                    Number(
                                                                                        (
                                                                                            trip.fixed_price *
                                                                                            tripservice_data.cancellation_fee *
                                                                                            0.01
                                                                                        ).toFixed(
                                                                                            3
                                                                                        )
                                                                                    )
                                                                                }
                                                                            }
                                                                            var provider_profit =
                                                                                tripservice_data.provider_profit
                                                                            trip.is_cancellation_fee = 1
                                                                            var current_rate = 1
                                                                            console.log(
                                                                                {
                                                                                    cancellationCharges,
                                                                                }
                                                                            )
                                                                            if (
                                                                                cancellationCharges >
                                                                                0
                                                                            ) {
                                                                                var admin_currencycode =
                                                                                    setting_detail.adminCurrencyCode
                                                                                var admin_currency =
                                                                                    setting_detail.adminCurrency

                                                                                var countryCurrencyCode =
                                                                                    trip.currencycode

                                                                                City.findOne(
                                                                                    {
                                                                                        _id: trip.city_id,
                                                                                    }
                                                                                ).then(
                                                                                    (
                                                                                        city
                                                                                    ) => {
                                                                                        var is_provider_earning_set_in_wallet_on_other_payment = false
                                                                                        var is_provider_earning_set_in_wallet_on_cash_payment = false
                                                                                        if (
                                                                                            city
                                                                                        ) {
                                                                                            is_provider_earning_set_in_wallet_on_other_payment =
                                                                                                city.is_provider_earning_set_in_wallet_on_other_payment
                                                                                            is_provider_earning_set_in_wallet_on_cash_payment =
                                                                                                city.is_provider_earning_set_in_wallet_on_cash_payment
                                                                                        }

                                                                                        utils.getCurrencyConvertRate(
                                                                                            1,
                                                                                            countryCurrencyCode,
                                                                                            admin_currencycode,
                                                                                            async function (
                                                                                                response
                                                                                            ) {
                                                                                                if (
                                                                                                    response.success
                                                                                                ) {
                                                                                                    current_rate =
                                                                                                        response.current_rate
                                                                                                } else {
                                                                                                    current_rate = 1
                                                                                                }

                                                                                                var provider_service_fees = 0
                                                                                                var total_in_admin_currency = 0
                                                                                                var service_total_in_admin_currency = 0
                                                                                                var provider_service_fees_in_admin_currency = 0

                                                                                                provider_service_fees =
                                                                                                    cancellationCharges *
                                                                                                    provider_profit *
                                                                                                    0.01
                                                                                                let citytype =
                                                                                                    await Citytype.findOne(
                                                                                                        {
                                                                                                            _id: trip.service_type_id,
                                                                                                        }
                                                                                                    )
                                                                                                const selected_details =
                                                                                                    {
                                                                                                        provider_service_fees:
                                                                                                            trip.provider_service_fees,
                                                                                                    }

                                                                                                if (
                                                                                                    citytype?.user_type_id &&
                                                                                                    corporate_data?.is_use_fixed_partner_profit &&
                                                                                                    corporate_data?.is_own_service_type
                                                                                                ) {
                                                                                                    let provider_static_profit =
                                                                                                        await getCorporateStaticPartnerProfit(
                                                                                                            citytype,
                                                                                                            selected_details,
                                                                                                            city
                                                                                                        )
                                                                                                    provider_service_fees =
                                                                                                        Number(
                                                                                                            provider_static_profit
                                                                                                        )
                                                                                                }
                                                                                                provider_service_fees_in_admin_currency =
                                                                                                    provider_service_fees *
                                                                                                    current_rate

                                                                                                total_in_admin_currency =
                                                                                                    cancellationCharges *
                                                                                                    current_rate
                                                                                                service_total_in_admin_currency =
                                                                                                    cancellationCharges *
                                                                                                    current_rate

                                                                                                trip.total_service_fees =
                                                                                                    cancellationCharges
                                                                                                trip.total =
                                                                                                    cancellationCharges
                                                                                                trip.provider_service_fees =
                                                                                                    provider_service_fees.toFixed(
                                                                                                        2
                                                                                                    )
                                                                                                trip.pay_to_provider =
                                                                                                    trip.provider_service_fees
                                                                                                trip.total_in_admin_currency =
                                                                                                    total_in_admin_currency
                                                                                                trip.service_total_in_admin_currency =
                                                                                                    service_total_in_admin_currency
                                                                                                trip.provider_service_fees_in_admin_currency =
                                                                                                    provider_service_fees_in_admin_currency
                                                                                                trip.current_rate =
                                                                                                    current_rate
                                                                                                trip.payment_status =
                                                                                                    PAYMENT_STATUS.WAITING

                                                                                                trip.admin_currency =
                                                                                                    admin_currency
                                                                                                trip.admin_currencycode =
                                                                                                    admin_currencycode

                                                                                                var user_id =
                                                                                                    req
                                                                                                        .body
                                                                                                        .user_id
                                                                                                if (
                                                                                                    trip_type ==
                                                                                                    constant_json.TRIP_TYPE_CORPORATE
                                                                                                ) {
                                                                                                    user_id =
                                                                                                        trip.user_type_id
                                                                                                }

                                                                                                if (
                                                                                                    trip.payment_mode ==
                                                                                                        Number(
                                                                                                            constant_json.PAYMENT_MODE_CASH
                                                                                                        ) &&
                                                                                                    is_provider_earning_set_in_wallet_on_cash_payment
                                                                                                ) {
                                                                                                    Provider.findOne(
                                                                                                        {
                                                                                                            _id: providerID,
                                                                                                        }
                                                                                                    ).then(
                                                                                                        (
                                                                                                            provider
                                                                                                        ) => {
                                                                                                            if (
                                                                                                                provider
                                                                                                            ) {
                                                                                                                if (
                                                                                                                    provider.provider_type ==
                                                                                                                    Number(
                                                                                                                        constant_json.PROVIDER_TYPE_NORMAL
                                                                                                                    )
                                                                                                                ) {
                                                                                                                    var total_wallet_amount =
                                                                                                                        utils.addWalletHistory(
                                                                                                                            constant_json.PROVIDER_UNIQUE_NUMBER,
                                                                                                                            provider.unique_id,
                                                                                                                            provider._id,
                                                                                                                            provider.country_id,
                                                                                                                            provider.wallet_currency_code,
                                                                                                                            trip.currencycode,
                                                                                                                            1,
                                                                                                                            trip.pay_to_provider,
                                                                                                                            provider.wallet,
                                                                                                                            constant_json.ADD_WALLET_AMOUNT,
                                                                                                                            constant_json.SET_TRIP_PROFIT,
                                                                                                                            'Profit Of This Trip : ' +
                                                                                                                                trip.unique_id
                                                                                                                        )

                                                                                                                    provider.wallet =
                                                                                                                        total_wallet_amount
                                                                                                                    provider.save()
                                                                                                                } else {
                                                                                                                    Partner.findOne(
                                                                                                                        {
                                                                                                                            _id: trip.provider_type_id,
                                                                                                                        }
                                                                                                                    ).then(
                                                                                                                        (
                                                                                                                            partner
                                                                                                                        ) => {
                                                                                                                            var total_wallet_amount =
                                                                                                                                utils.addWalletHistory(
                                                                                                                                    constant_json.PARTNER_UNIQUE_NUMBER,
                                                                                                                                    partner.unique_id,
                                                                                                                                    partner._id,
                                                                                                                                    partner.country_id,
                                                                                                                                    partner.wallet_currency_code,
                                                                                                                                    trip.currencycode,
                                                                                                                                    1,
                                                                                                                                    trip.pay_to_provider,
                                                                                                                                    partner.wallet,
                                                                                                                                    constant_json.ADD_WALLET_AMOUNT,
                                                                                                                                    constant_json.SET_TRIP_PROFIT,
                                                                                                                                    'Profit Of This Trip : ' +
                                                                                                                                        trip.unique_id
                                                                                                                                )

                                                                                                                            partner.wallet =
                                                                                                                                total_wallet_amount
                                                                                                                            partner.save()
                                                                                                                        }
                                                                                                                    )
                                                                                                                }

                                                                                                                trip.is_provider_earning_set_in_wallet = true
                                                                                                                trip.provider_income_set_in_wallet =
                                                                                                                    Math.abs(
                                                                                                                        trip.pay_to_provider
                                                                                                                    )
                                                                                                            }
                                                                                                        }
                                                                                                    )
                                                                                                }

                                                                                                trip.remaining_payment =
                                                                                                    cancellationCharges
                                                                                                if (
                                                                                                    trip.payment_mode ==
                                                                                                    constant_json.PAYMENT_MODE_APPLE_PAY
                                                                                                ) {
                                                                                                    trip.payment_status =
                                                                                                        PAYMENT_STATUS.FAILED
                                                                                                    trip.save().then(
                                                                                                        () => {
                                                                                                            utils.remove_dates_driver_vehicle(
                                                                                                                trip._id,
                                                                                                                trip.model_type
                                                                                                            )
                                                                                                            utils.update_request_status_socket(
                                                                                                                trip._id
                                                                                                            )
                                                                                                            res.json(
                                                                                                                {
                                                                                                                    success: true,
                                                                                                                    message:
                                                                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                                    payment_status:
                                                                                                                        trip.payment_status,
                                                                                                                }
                                                                                                            )
                                                                                                        }
                                                                                                    )
                                                                                                } else {
                                                                                                    trip.payment_mode =
                                                                                                        constant_json.PAYMENT_MODE_CARD
                                                                                                    Card.findOne(
                                                                                                        {
                                                                                                            user_id:
                                                                                                                user._id,
                                                                                                            payment_gateway_type:
                                                                                                                trip.payment_gateway_type,
                                                                                                            is_default: true,
                                                                                                        },
                                                                                                        function (
                                                                                                            error,
                                                                                                            card_detail
                                                                                                        ) {
                                                                                                            if (
                                                                                                                card_detail
                                                                                                            ) {
                                                                                                                trip.payment_status =
                                                                                                                    PAYMENT_STATUS.FAILED
                                                                                                                trip.save().then(
                                                                                                                    () => {
                                                                                                                        utils.update_request_status_socket(
                                                                                                                            trip._id
                                                                                                                        )
                                                                                                                        Trip.findOneAndRemove(
                                                                                                                            {
                                                                                                                                _id: trip._id,
                                                                                                                            }
                                                                                                                        ).then(
                                                                                                                            (
                                                                                                                                deleted_trip
                                                                                                                            ) => {
                                                                                                                                if (
                                                                                                                                    deleted_trip
                                                                                                                                ) {
                                                                                                                                    var trip_history_data =
                                                                                                                                        new Trip_history(
                                                                                                                                            JSON.parse(
                                                                                                                                                JSON.stringify(
                                                                                                                                                    deleted_trip
                                                                                                                                                )
                                                                                                                                            )
                                                                                                                                        )
                                                                                                                                    trip_history_data.save(
                                                                                                                                        function () {
                                                                                                                                            utils.remove_dates_driver_vehicle(
                                                                                                                                                trip._id,
                                                                                                                                                trip.model_type
                                                                                                                                            )
                                                                                                                                            res.json(
                                                                                                                                                {
                                                                                                                                                    success: true,
                                                                                                                                                    error: '',
                                                                                                                                                    message:
                                                                                                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                                                                    payment_status:
                                                                                                                                                        trip.payment_status,
                                                                                                                                                }
                                                                                                                                            )
                                                                                                                                        }
                                                                                                                                    )
                                                                                                                                } else {
                                                                                                                                    utils.remove_dates_driver_vehicle(
                                                                                                                                        trip._id,
                                                                                                                                        trip.model_type
                                                                                                                                    )
                                                                                                                                    res.json(
                                                                                                                                        {
                                                                                                                                            success: true,
                                                                                                                                            error: '',
                                                                                                                                            message:
                                                                                                                                                success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                                                            payment_status:
                                                                                                                                                trip.payment_status,
                                                                                                                                        }
                                                                                                                                    )
                                                                                                                                }
                                                                                                                            }
                                                                                                                        )
                                                                                                                    }
                                                                                                                )
                                                                                                            } else {
                                                                                                                trip.payment_status =
                                                                                                                    PAYMENT_STATUS.FAILED
                                                                                                                trip.save().then(
                                                                                                                    () => {
                                                                                                                        utils.update_request_status_socket(
                                                                                                                            trip._id
                                                                                                                        )
                                                                                                                        Trip.findOneAndRemove(
                                                                                                                            {
                                                                                                                                _id: trip._id,
                                                                                                                            }
                                                                                                                        ).then(
                                                                                                                            (
                                                                                                                                deleted_trip
                                                                                                                            ) => {
                                                                                                                                if (
                                                                                                                                    deleted_trip
                                                                                                                                ) {
                                                                                                                                    var trip_history_data =
                                                                                                                                        new Trip_history(
                                                                                                                                            JSON.parse(
                                                                                                                                                JSON.stringify(
                                                                                                                                                    deleted_trip
                                                                                                                                                )
                                                                                                                                            )
                                                                                                                                        )
                                                                                                                                    trip_history_data.save(
                                                                                                                                        function () {
                                                                                                                                            utils.remove_dates_driver_vehicle(
                                                                                                                                                trip._id,
                                                                                                                                                trip.model_type
                                                                                                                                            )
                                                                                                                                            res.json(
                                                                                                                                                {
                                                                                                                                                    success: true,
                                                                                                                                                    message:
                                                                                                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                                                                    payment_status:
                                                                                                                                                        trip.payment_status,
                                                                                                                                                }
                                                                                                                                            )
                                                                                                                                        }
                                                                                                                                    )
                                                                                                                                } else {
                                                                                                                                    utils.remove_dates_driver_vehicle(
                                                                                                                                        trip._id,
                                                                                                                                        trip.model_type
                                                                                                                                    )
                                                                                                                                    res.json(
                                                                                                                                        {
                                                                                                                                            success: true,
                                                                                                                                            message:
                                                                                                                                                success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                                                            payment_status:
                                                                                                                                                trip.payment_status,
                                                                                                                                        }
                                                                                                                                    )
                                                                                                                                }
                                                                                                                            }
                                                                                                                        )
                                                                                                                    }
                                                                                                                )
                                                                                                            }
                                                                                                        }
                                                                                                    )
                                                                                                }
                                                                                            }
                                                                                        )
                                                                                    }
                                                                                )
                                                                            } else {
                                                                                trip.provider_service_fees = 0
                                                                                trip.save(
                                                                                    () => {
                                                                                        user.cancelled_request =
                                                                                            user.cancelled_request +
                                                                                            1
                                                                                        // user.current_trip_id = null;
                                                                                        user.save()
                                                                                        utils.update_request_status_socket(
                                                                                            trip._id
                                                                                        )
                                                                                        if (
                                                                                            req
                                                                                                .body
                                                                                                .type !==
                                                                                            'Admin'
                                                                                        ) {
                                                                                            Trip.findOneAndRemove(
                                                                                                {
                                                                                                    _id: req
                                                                                                        .body
                                                                                                        .trip_id,
                                                                                                }
                                                                                            ).then(
                                                                                                async (
                                                                                                    deleted_trip
                                                                                                ) => {
                                                                                                    if (
                                                                                                        deleted_trip
                                                                                                    ) {
                                                                                                        var trip_history_data =
                                                                                                            new Trip_history(
                                                                                                                JSON.parse(
                                                                                                                    JSON.stringify(
                                                                                                                        deleted_trip
                                                                                                                    )
                                                                                                                )
                                                                                                            )
                                                                                                        trip_history_data.save(
                                                                                                            async function () {
                                                                                                                utils.remove_dates_driver_vehicle(
                                                                                                                    trip._id,
                                                                                                                    trip.model_type
                                                                                                                )
                                                                                                                res.json(
                                                                                                                    {
                                                                                                                        success: true,
                                                                                                                        payment_status:
                                                                                                                            trip.payment_status,
                                                                                                                        message:
                                                                                                                            success_messages.MESSAGE_CODE_YOUR_TRIP_CANCELLED_SUCCESSFULLY,
                                                                                                                    }
                                                                                                                )
                                                                                                            }
                                                                                                        )
                                                                                                    } else {
                                                                                                        utils.remove_dates_driver_vehicle(
                                                                                                            trip._id,
                                                                                                            trip.model_type
                                                                                                        )
                                                                                                        res.json(
                                                                                                            {
                                                                                                                success: true,
                                                                                                                payment_status:
                                                                                                                    trip.payment_status,
                                                                                                                message:
                                                                                                                    success_messages.MESSAGE_CODE_YOUR_TRIP_CANCELLED_SUCCESSFULLY,
                                                                                                            }
                                                                                                        )
                                                                                                    }
                                                                                                }
                                                                                            )
                                                                                        }
                                                                                    }
                                                                                )
                                                                            }
                                                                        }
                                                                    )
                                                                } else {
                                                                    trip.provider_service_fees = 0
                                                                    trip.save(
                                                                        () => {
                                                                            user.cancelled_request =
                                                                                user.cancelled_request +
                                                                                1
                                                                            // user.current_trip_id = null;
                                                                            user.save()
                                                                            utils.update_request_status_socket(
                                                                                trip._id
                                                                            )
                                                                            if (
                                                                                req
                                                                                    .body
                                                                                    .type !==
                                                                                'Admin'
                                                                            ) {
                                                                                Trip.findOneAndRemove(
                                                                                    {
                                                                                        _id: req
                                                                                            .body
                                                                                            .trip_id,
                                                                                    }
                                                                                ).then(
                                                                                    async (
                                                                                        deleted_trip
                                                                                    ) => {
                                                                                        if (
                                                                                            deleted_trip
                                                                                        ) {
                                                                                            var trip_history_data =
                                                                                                new Trip_history(
                                                                                                    JSON.parse(
                                                                                                        JSON.stringify(
                                                                                                            deleted_trip
                                                                                                        )
                                                                                                    )
                                                                                                )
                                                                                            trip_history_data.save(
                                                                                                async function () {
                                                                                                    utils.remove_dates_driver_vehicle(
                                                                                                        trip._id,
                                                                                                        trip.model_type
                                                                                                    )
                                                                                                    res.json(
                                                                                                        {
                                                                                                            success: true,
                                                                                                            payment_status:
                                                                                                                trip.payment_status,
                                                                                                            message:
                                                                                                                success_messages.MESSAGE_CODE_YOUR_TRIP_CANCELLED_SUCCESSFULLY,
                                                                                                        }
                                                                                                    )
                                                                                                }
                                                                                            )
                                                                                        } else {
                                                                                            utils.remove_dates_driver_vehicle(
                                                                                                trip._id,
                                                                                                trip.model_type
                                                                                            )
                                                                                            res.json(
                                                                                                {
                                                                                                    success: true,
                                                                                                    payment_status:
                                                                                                        trip.payment_status,
                                                                                                    message:
                                                                                                        success_messages.MESSAGE_CODE_YOUR_TRIP_CANCELLED_SUCCESSFULLY,
                                                                                                }
                                                                                            )
                                                                                        }
                                                                                    }
                                                                                )
                                                                            }
                                                                        }
                                                                    )
                                                                }
                                                            },
                                                            (err) => {
                                                                console.log(err)
                                                                res.json({
                                                                    success: false,
                                                                    error_code:
                                                                        error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                                })
                                                            }
                                                        )
                                                    }
                                                } else {
                                                    // if (user.current_trip_id) {
                                                    //     user.current_trip_id = null;
                                                    user.cancelled_request =
                                                        user.cancelled_request +
                                                        1
                                                    user.save()
                                                    // }
                                                    utils.update_request_status_socket(
                                                        trip._id
                                                    )
                                                    if (
                                                        req.body.type !==
                                                        'Admin'
                                                    ) {
                                                        utils.remove_dates_driver_vehicle(
                                                            trip._id,
                                                            trip.model_type
                                                        )
                                                        res.json({
                                                            success: true,
                                                            payment_status:
                                                                trip.payment_status,
                                                            message:
                                                                success_messages.ERROR_CODE_TRIP_IS_ALREADY_CANCELLED,
                                                        })
                                                    }
                                                }
                                            } else {
                                                utils.update_request_status_socket(
                                                    trip._id
                                                )
                                                utils.remove_dates_driver_vehicle(
                                                    trip._id,
                                                    trip.model_type
                                                )

                                                res.json({
                                                    success: true,
                                                    payment_status:
                                                        trip.payment_status,
                                                    message:
                                                        success_messages.ERROR_CODE_TRIP_ALREADY_COMPLETED,
                                                })
                                            }
                                        } else {
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_NO_TRIP,
                                            })
                                        }
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            if (req.body.type !== 'Admin') {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
                                })
                            }
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.trip_cancel_by_provider = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    is_trip_cancelled: 0,
                                    is_trip_cancelled_by_provider: 0,
                                    is_trip_cancelled_by_user: 0,
                                }).then((trip) => {
                                    if (trip) {
                                        var city_timezone = trip.timezone
                                        var cancel_reason =
                                            req.body.cancel_reason

                                        User.findOne({
                                            _id: trip.user_id,
                                        }).then((user) => {
                                            trip.cancellation_details =
                                                trip.cancellation_details || {}
                                            trip.cancellation_details.type =
                                                Number(
                                                    constant_json.PROVIDER_UNIQUE_NUMBER
                                                )
                                            trip.cancel_reason = cancel_reason
                                            trip.is_trip_cancelled = 1
                                            trip.is_trip_cancelled_by_provider = 1
                                            trip.provider_trip_end_time =
                                                new Date()
                                            var complete_date_in_city_timezone =
                                                utils.get_date_now_at_city(
                                                    new Date(),
                                                    trip.timezone
                                                )
                                            var complete_date_tag = moment(
                                                moment(
                                                    complete_date_in_city_timezone
                                                ).startOf('day')
                                            ).format(
                                                constant_json.DATE_FORMAT_MMM_D_YYYY
                                            )
                                            trip.complete_date_in_city_timezone =
                                                complete_date_in_city_timezone
                                            trip.complete_date_tag =
                                                complete_date_tag
                                            trip.provider_service_fees = 0
                                            trip.save().then(
                                                async () => {
                                                    provider.cancelled_request =
                                                        provider.cancelled_request +
                                                        1
                                                    provider =
                                                        utils.remove_is_trip_from_provider(
                                                            provider,
                                                            trip._id,
                                                            trip.initialDestinationLocation
                                                        )
                                                    await provider.save()

                                                    myAnalytics.insert_daily_provider_analytics(
                                                        city_timezone,
                                                        provider._id,
                                                        TRIP_STATUS.PROVIDER_CANCELLED,
                                                        null
                                                    )
                                                    utils.sendPushNotification(
                                                        constant_json.USER_UNIQUE_NUMBER,
                                                        user.device_type,
                                                        user.device_token,
                                                        push_messages.PUSH_CODE_FOR_TRIP_CANCELLED_BY_PROVIDER,
                                                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                    )

                                                    User_promo_use.findOne({
                                                        trip_id: trip._id,
                                                    }).then((userpromouse) => {
                                                        if (userpromouse) {
                                                            userpromouse.remove()
                                                        }
                                                    })
                                                    Promo_Code.findOne({
                                                        _id: trip.promo_id,
                                                    }).then((promo_code) => {
                                                        if (promo_code) {
                                                            promo_code.user_used_promo =
                                                                promo_code.user_used_promo -
                                                                1
                                                            promo_code.save()
                                                        }
                                                    })
                                                    utils.remove_dates_driver_vehicle(
                                                        trip._id,
                                                        trip.model_type
                                                    )

                                                    // user.current_trip_id = null;
                                                    // user.save();
                                                    utils.update_request_status_socket(
                                                        trip._id
                                                    )

                                                    Trip.findOneAndRemove({
                                                        _id: req.body.trip_id,
                                                    }).then(
                                                        async (
                                                            deleted_trip
                                                        ) => {
                                                            if (deleted_trip) {
                                                                var trip_history_data =
                                                                    new Trip_history(
                                                                        JSON.parse(
                                                                            JSON.stringify(
                                                                                deleted_trip
                                                                            )
                                                                        )
                                                                    )
                                                                trip_history_data.save(
                                                                    async function () {
                                                                        res.json(
                                                                            {
                                                                                success: true,
                                                                                message:
                                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_CANCELLED_SUCCESSFULLY,
                                                                                is_trip_cancelled_by_provider:
                                                                                    trip.is_trip_cancelled_by_provider,
                                                                            }
                                                                        )
                                                                    }
                                                                )
                                                            } else {
                                                                res.json({
                                                                    success: true,
                                                                    message:
                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_CANCELLED_SUCCESSFULLY,
                                                                    is_trip_cancelled_by_provider:
                                                                        trip.is_trip_cancelled_by_provider,
                                                                })
                                                            }
                                                        }
                                                    )
                                                },
                                                (err) => {
                                                    console.log(err)
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                    })
                                                }
                                            )
                                        })
                                    } else {
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_TRIP_IS_ALREADY_CANCELLED,
                                        })
                                    }
                                })
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.trip_cancel_by_admin = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                Trip.findOne({
                    _id: req.body.trip_id,
                    is_trip_cancelled: 0,
                    is_trip_cancelled_by_provider: 0,
                    is_trip_cancelled_by_user: 0,
                }).then((trip) => {
                    if (trip) {
                        Provider.findOne({ _id: trip.confirmed_provider }).then(
                            (provider) => {
                                User.findOne({ _id: trip.user_id }).then(
                                    (user) => {
                                        if (provider) {
                                            provider =
                                                utils.remove_is_trip_from_provider(
                                                    provider,
                                                    trip._id,
                                                    trip.initialDestinationLocation
                                                )
                                            if (!provider.is_near_trip) {
                                                provider.is_near_trip = []
                                            }
                                            if (
                                                String(
                                                    provider.is_near_trip[0]
                                                ) == String(trip._id)
                                            ) {
                                                provider.is_near_available = 1
                                                provider.is_near_trip = []
                                            }
                                            provider.save()
                                            utils.sendPushNotification(
                                                constant_json.PROVIDER_UNIQUE_NUMBER,
                                                provider.device_type,
                                                provider.device_token,
                                                push_messages.PUSH_CODE_FOR_TRIP_CANCELLED_BY_ADMIN,
                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                            )
                                        }

                                        Provider.find({
                                            _id: {
                                                $in: trip.current_providers,
                                            },
                                        }).then(async (provider_list) => {
                                            for (const provider of provider_list) {
                                                let is_trip_condition = {
                                                    _id: provider._id,
                                                }
                                                let is_trip_update = {
                                                    is_available: 1,
                                                    is_trip: [],
                                                }

                                                if (!provider.is_near_trip) {
                                                    provider.is_near_trip = []
                                                }
                                                if (
                                                    provider.is_near_trip
                                                        .length != 0
                                                ) {
                                                    is_trip_update = {
                                                        is_near_available: 1,
                                                        is_near_trip: [],
                                                    }
                                                }
                                                await Provider.updateOne(
                                                    is_trip_condition,
                                                    is_trip_update
                                                )
                                            }
                                        })
                                        trip.cancellation_details =
                                            trip.cancellation_details || {}
                                        trip.cancellation_details.type =
                                            req.session.admin.type == 1
                                                ? Number(
                                                      constant_json.SUB_ADMIN_UNIQUE_NUMBER
                                                  )
                                                : Number(
                                                      constant_json.ADMIN_UNIQUE_NUMBER
                                                  )
                                        trip.cancel_reason =
                                            req.body.cancel_reason
                                        trip.is_trip_cancelled = 1
                                        trip.provider_trip_end_time = new Date()
                                        var complete_date_in_city_timezone =
                                            utils.get_date_now_at_city(
                                                new Date(),
                                                trip.timezone
                                            )
                                        var complete_date_tag = moment(
                                            moment(
                                                complete_date_in_city_timezone
                                            ).startOf('day')
                                        ).format(
                                            constant_json.DATE_FORMAT_MMM_D_YYYY
                                        )
                                        trip.complete_date_in_city_timezone =
                                            complete_date_in_city_timezone
                                        trip.complete_date_tag =
                                            complete_date_tag

                                        trip.save().then(
                                            () => {
                                                utils.sendPushNotification(
                                                    constant_json.USER_UNIQUE_NUMBER,
                                                    user.device_type,
                                                    user.device_token,
                                                    push_messages.PUSH_CODE_FOR_TRIP_CANCELLED_BY_ADMIN,
                                                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                )
                                                User_promo_use.findOne({
                                                    trip_id: trip._id,
                                                }).then((userpromouse) => {
                                                    if (userpromouse) {
                                                        userpromouse.remove()
                                                    }
                                                })
                                                Promo_Code.findOne({
                                                    _id: trip.promo_id,
                                                }).then((promo_code) => {
                                                    if (promo_code) {
                                                        promo_code.user_used_promo =
                                                            promo_code.user_used_promo -
                                                            1
                                                        promo_code.save()
                                                    }
                                                })

                                                // if (String(trip._id) == String(user.current_trip_id)) {
                                                //     user.current_trip_id = null;
                                                //     user.save();
                                                // }

                                                message =
                                                    admin_messages.success_message_trip_cancelled
                                                utils.update_request_status_socket(
                                                    trip._id
                                                )
                                                utils.remove_dates_driver_vehicle(
                                                    trip._id,
                                                    trip.model_type
                                                )

                                                Trip.findOneAndRemove({
                                                    _id: req.body.trip_id,
                                                }).then(
                                                    async (deleted_trip) => {
                                                        if (deleted_trip) {
                                                            var trip_history_data =
                                                                new Trip_history(
                                                                    JSON.parse(
                                                                        JSON.stringify(
                                                                            deleted_trip
                                                                        )
                                                                    )
                                                                )
                                                            trip_history_data.save(
                                                                async function () {
                                                                    res.json({
                                                                        success: true,
                                                                    })
                                                                }
                                                            )
                                                        } else {
                                                            res.json({
                                                                success: true,
                                                            })
                                                        }
                                                    }
                                                )
                                            },
                                            (err) => {
                                                console.log(err)
                                                res.json({ success: true })
                                            }
                                        )
                                    }
                                )
                            }
                        )
                    } else {
                        res.json({ success: true })
                    }
                })
            } else {
            }
        }
    )
}

exports.scheduled_trip_cancel_by_admin = async function (req, res) {
    utils.check_request_params(
        req.body,
        [
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                Trip.findOne({
                    _id: req.body.trip_id,
                    is_trip_cancelled: 0,
                    is_trip_cancelled_by_provider: 0,
                    is_trip_cancelled_by_user: 0,
                }).then((trip) => {
                    if (trip) {
                        User.findOne({ _id: trip.user_id }).then((user) => {
                            trip.cancellation_details =
                                trip.cancellation_details || {}
                            trip.cancellation_details.type =
                                req.session.admin.type == 1
                                    ? Number(
                                          constant_json.SUB_ADMIN_UNIQUE_NUMBER
                                      )
                                    : Number(constant_json.ADMIN_UNIQUE_NUMBER)
                            trip.cancel_reason = req.body.cancel_reason
                            trip.is_trip_cancelled = 1
                            trip.is_trip_cancelled_by_admin = 1
                            trip.provider_trip_end_time = new Date()
                            var complete_date_in_city_timezone =
                                utils.get_date_now_at_city(
                                    new Date(),
                                    trip.timezone
                                )
                            var complete_date_tag = moment(
                                moment(complete_date_in_city_timezone).startOf(
                                    'day'
                                )
                            ).format(constant_json.DATE_FORMAT_MMM_D_YYYY)
                            trip.complete_date_in_city_timezone =
                                complete_date_in_city_timezone
                            trip.complete_date_tag = complete_date_tag
                            trip.save().then(
                                async () => {
                                    utils.remove_dates_driver_vehicle(
                                        trip._id,
                                        trip.model_type
                                    )
                                    user.cancelled_request =
                                        user.cancelled_request + 1
                                    await user.save()
                                    message =
                                        admin_messages.success_message_trip_cancelled
                                    utils.update_request_status_socket(trip._id)
                                    Trip.findOneAndRemove({
                                        _id: req.body.trip_id,
                                    }).then(async (deleted_trip) => {
                                        if (deleted_trip) {
                                            var trip_history_data =
                                                new Trip_history(
                                                    JSON.parse(
                                                        JSON.stringify(
                                                            deleted_trip
                                                        )
                                                    )
                                                )
                                            trip_history_data.save(
                                                async function () {
                                                    res.json({ success: true })
                                                }
                                            )
                                        } else {
                                            res.json({ success: true })
                                        }
                                    })
                                },
                                (err) => {
                                    console.log(err)
                                    res.json({ success: true })
                                }
                            )
                        })
                    } else {
                        res.json({ success: true })
                    }
                })
            } else {
                res.json({ success: true })
            }
        }
    )
}

exports.provider_set_trip_status = function (req, res) {
    // console.log("Set Trip")
    // console.log(req.body)
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
            { name: 'is_provider_status', type: 'number' },
            { name: 'latitude', type: 'number' },
            { name: 'longitude', type: 'number' },
        ],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    confirmed_provider: req.body.provider_id,
                                }).then(
                                    (trip) => {
                                        if (trip) {
                                            if (
                                                trip.is_trip_cancelled == 0 &&
                                                trip.is_trip_cancelled_by_provider ==
                                                    0
                                            ) {
                                                var is_provider_status = Number(
                                                    req.body.is_provider_status
                                                )

                                                var now = new Date()
                                                if (is_provider_status == 6) {
                                                    if (
                                                        trip
                                                            .actual_destination_addresses
                                                            .length == 0
                                                    ) {
                                                        trip.provider_trip_start_time =
                                                            now
                                                    }

                                                    if (
                                                        trip.is_otp_verification &&
                                                        trip
                                                            .actual_destination_addresses
                                                            .length == 0
                                                    ) {
                                                        var confirmation_code =
                                                            req.body
                                                                .trip_start_otp
                                                        if (
                                                            trip.confirmation_code !=
                                                            confirmation_code
                                                        ) {
                                                            return res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_INVALID_TRIP_START_OTP,
                                                            })
                                                        }
                                                    }

                                                    if (
                                                        req.body
                                                            .is_destination_stop &&
                                                        req.body
                                                            .is_destination_stop ==
                                                            1
                                                    ) {
                                                        var provider_arrived_time =
                                                            trip.provider_arrived_time
                                                        if (
                                                            trip
                                                                .actual_destination_stops
                                                                .length != 0
                                                        ) {
                                                            provider_arrived_time =
                                                                trip
                                                                    .actual_destination_stops[
                                                                    trip
                                                                        .actual_destination_stops
                                                                        .length -
                                                                        1
                                                                ].arrived_time
                                                        } else if (
                                                            trip
                                                                .actual_destination_addresses
                                                                .length != 0
                                                        ) {
                                                            provider_arrived_time =
                                                                trip
                                                                    .actual_destination_addresses[
                                                                    trip
                                                                        .actual_destination_addresses
                                                                        .length -
                                                                        1
                                                                ].arrived_time
                                                        }
                                                        var waiting_time =
                                                            utils.getTimeDifferenceInMinute(
                                                                now,
                                                                provider_arrived_time
                                                            )
                                                        if (waiting_time < 0) {
                                                            waiting_time = 0
                                                        }

                                                        trip.actual_destination_stops.push(
                                                            {
                                                                address: '',
                                                                location: [],
                                                                arrived_time:
                                                                    null,
                                                                start_time: now,
                                                                total_time: 0,
                                                                waiting_time:
                                                                    Number(
                                                                        waiting_time
                                                                    ),
                                                            }
                                                        )
                                                    } else {
                                                        if (
                                                            trip
                                                                .destination_addresses
                                                                .length != 0
                                                        ) {
                                                            var provider_arrived_time =
                                                                trip.provider_arrived_time
                                                            if (
                                                                trip
                                                                    .actual_destination_addresses
                                                                    .length != 0
                                                            ) {
                                                                provider_arrived_time =
                                                                    trip
                                                                        .actual_destination_addresses[
                                                                        trip
                                                                            .actual_destination_addresses
                                                                            .length -
                                                                            1
                                                                    ]
                                                                        .arrived_time
                                                            }
                                                            var waiting_time =
                                                                utils.getTimeDifferenceInMinute(
                                                                    now,
                                                                    provider_arrived_time
                                                                )
                                                            if (
                                                                waiting_time < 0
                                                            ) {
                                                                waiting_time = 0
                                                            }
                                                            if (
                                                                trip
                                                                    .destination_addresses
                                                                    .length ==
                                                                Number(
                                                                    req.body
                                                                        .city_index
                                                                )
                                                            ) {
                                                                var provider_arrived_time =
                                                                    trip.provider_arrived_time
                                                                if (
                                                                    trip
                                                                        .actual_destination_addresses
                                                                        .length !=
                                                                    0
                                                                ) {
                                                                    provider_arrived_time =
                                                                        trip
                                                                            .actual_destination_addresses[
                                                                            trip
                                                                                .actual_destination_addresses
                                                                                .length -
                                                                                1
                                                                        ]
                                                                            .arrived_time
                                                                }
                                                                var waiting_time =
                                                                    utils.getTimeDifferenceInMinute(
                                                                        now,
                                                                        provider_arrived_time
                                                                    )
                                                                if (
                                                                    waiting_time <
                                                                    0
                                                                ) {
                                                                    waiting_time = 0
                                                                }

                                                                trip.actual_destination_stops.push(
                                                                    {
                                                                        address:
                                                                            '',
                                                                        location:
                                                                            [],
                                                                        arrived_time:
                                                                            null,
                                                                        start_time:
                                                                            now,
                                                                        total_time: 0,
                                                                        waiting_time:
                                                                            Number(
                                                                                waiting_time
                                                                            ),
                                                                    }
                                                                )

                                                                trip.actual_destination_addresses.push(
                                                                    {
                                                                        address:
                                                                            '',
                                                                        location:
                                                                            [
                                                                                0,
                                                                                0,
                                                                            ],
                                                                        arrived_time:
                                                                            null,
                                                                        start_time:
                                                                            now,
                                                                        total_time: 0,
                                                                        waiting_time: 0,
                                                                        stops_inside:
                                                                            [],
                                                                    }
                                                                )
                                                            } else {
                                                                if (
                                                                    trip
                                                                        .actual_destination_addresses
                                                                        .length ==
                                                                    Number(
                                                                        req.body
                                                                            .city_index
                                                                    )
                                                                ) {
                                                                    trip.actual_destination_addresses.push(
                                                                        {
                                                                            address:
                                                                                trip
                                                                                    .destination_addresses[
                                                                                    Number(
                                                                                        req
                                                                                            .body
                                                                                            .city_index
                                                                                    )
                                                                                ]
                                                                                    .address,
                                                                            location:
                                                                                trip
                                                                                    .destination_addresses[
                                                                                    Number(
                                                                                        req
                                                                                            .body
                                                                                            .city_index
                                                                                    )
                                                                                ]
                                                                                    .location,
                                                                            arrived_time:
                                                                                null,
                                                                            start_time:
                                                                                now,
                                                                            total_time: 0,
                                                                            waiting_time:
                                                                                Number(
                                                                                    waiting_time
                                                                                ),
                                                                            stops_inside:
                                                                                [],
                                                                        }
                                                                    )
                                                                    if (
                                                                        trip
                                                                            .destination_addresses[
                                                                            Number(
                                                                                req
                                                                                    .body
                                                                                    .city_index
                                                                            )
                                                                        ]
                                                                            .stops_inside
                                                                            .length >
                                                                        0
                                                                    ) {
                                                                        trip.actual_destination_addresses[
                                                                            Number(
                                                                                req
                                                                                    .body
                                                                                    .city_index
                                                                            )
                                                                        ].stops_inside.push(
                                                                            {
                                                                                address:
                                                                                    '',
                                                                                location:
                                                                                    [],
                                                                                arrived_time:
                                                                                    null,
                                                                                start_time:
                                                                                    now,
                                                                                total_time: 0,
                                                                                waiting_time:
                                                                                    Number(
                                                                                        waiting_time
                                                                                    ),
                                                                            }
                                                                        )
                                                                    }
                                                                } else {
                                                                    let provider_arrived_time_stop =
                                                                        trip.provider_arrived_time
                                                                    if (
                                                                        trip
                                                                            .actual_destination_addresses
                                                                            .length !=
                                                                        0
                                                                    ) {
                                                                        provider_arrived_time_stop =
                                                                            trip
                                                                                .actual_destination_addresses[
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .city_index
                                                                                )
                                                                            ]
                                                                                .stops_inside[
                                                                                trip
                                                                                    .actual_destination_addresses[
                                                                                    Number(
                                                                                        req
                                                                                            .body
                                                                                            .city_index
                                                                                    )
                                                                                ]
                                                                                    .stops_inside
                                                                                    .length -
                                                                                    1
                                                                            ]
                                                                                .arrived_time
                                                                    }

                                                                    let stop_waiting_time =
                                                                        utils.getTimeDifferenceInMinute(
                                                                            now,
                                                                            provider_arrived_time_stop
                                                                        )
                                                                    if (
                                                                        stop_waiting_time <
                                                                        0
                                                                    ) {
                                                                        stop_waiting_time = 0
                                                                    }
                                                                    trip.actual_destination_addresses[
                                                                        Number(
                                                                            req
                                                                                .body
                                                                                .city_index
                                                                        )
                                                                    ].stops_inside.push(
                                                                        {
                                                                            address:
                                                                                '',
                                                                            location:
                                                                                [],
                                                                            arrived_time:
                                                                                null,
                                                                            start_time:
                                                                                now,
                                                                            total_time: 0,
                                                                            waiting_time:
                                                                                Number(
                                                                                    stop_waiting_time
                                                                                ),
                                                                        }
                                                                    )
                                                                }
                                                            }
                                                            trip.markModified(
                                                                'actual_destination_addresses'
                                                            )
                                                        }
                                                    }
                                                    sendTrackingLinkSms(trip)
                                                }

                                                if (is_provider_status == 4) {
                                                    trip.provider_arrived_time =
                                                        now
                                                }

                                                if (is_provider_status == 7) {
                                                    trip.provider_arrived_destination_time =
                                                        now
                                                }

                                                trip.is_provider_status =
                                                    is_provider_status
                                                trip.save().then(
                                                    () => {
                                                        if (
                                                            trip.actual_destination_addresses &&
                                                            trip
                                                                .actual_destination_addresses
                                                                .length > 1
                                                        ) {
                                                            utils.update_request_status_socket(
                                                                trip._id
                                                            )
                                                            return res.json({
                                                                success: true,
                                                                message:
                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_SET_TRIP_STATUS_SUCCESSFULLY,
                                                                trip: trip,
                                                            })
                                                        }

                                                        TripLocation.findOne({
                                                            tripID: req.body
                                                                .trip_id,
                                                        }).then(
                                                            (tripLocation) => {
                                                                var latlong = [
                                                                    0, 0,
                                                                ]
                                                                latlong = [
                                                                    Number(
                                                                        req.body
                                                                            .latitude
                                                                    ),
                                                                    Number(
                                                                        req.body
                                                                            .longitude
                                                                    ),
                                                                ]
                                                                switch (
                                                                    is_provider_status
                                                                ) {
                                                                    case 2:
                                                                        tripLocation.providerStartTime =
                                                                            now
                                                                        tripLocation.providerStartLocation =
                                                                            latlong
                                                                        tripLocation.providerStartToStartTripLocations.push(
                                                                            latlong
                                                                        )
                                                                        break
                                                                    case 6:
                                                                        tripLocation.startTripTime =
                                                                            now
                                                                        tripLocation.startTripLocation =
                                                                            latlong
                                                                        tripLocation.startTripToEndTripLocations.push(
                                                                            latlong
                                                                        )
                                                                        break
                                                                }
                                                                tripLocation.save()
                                                            },
                                                            (err) => {
                                                                console.log(err)
                                                            }
                                                        )

                                                        User.findOne({
                                                            _id: trip.user_id,
                                                        }).then((user) => {
                                                            var device_token =
                                                                user.device_token
                                                            var device_type =
                                                                user.device_type
                                                            if (
                                                                is_provider_status ==
                                                                6
                                                            ) {
                                                                EmergencyContactDetail.find(
                                                                    {
                                                                        user_id:
                                                                            trip.user_id,
                                                                        is_always_share_ride_detail: 1,
                                                                    }
                                                                ).then(
                                                                    (
                                                                        emergencyContactDetails
                                                                    ) => {
                                                                        emergencyContactDetails.forEach(
                                                                            function (
                                                                                emergencyContactDetail
                                                                            ) {
                                                                                var phoneWithCode =
                                                                                    emergencyContactDetail.phone
                                                                                if (
                                                                                    setting_detail.sms_notification
                                                                                ) {
                                                                                    utils.sendSmsForOTPVerificationAndForgotPassword(
                                                                                        phoneWithCode,
                                                                                        7,
                                                                                        [
                                                                                            user.first_name +
                                                                                                ' ' +
                                                                                                user.last_name,
                                                                                            provider.first_name +
                                                                                                ' ' +
                                                                                                provider.last_name,
                                                                                            trip.source_address,
                                                                                            trip.destination_address,
                                                                                        ]
                                                                                    )
                                                                                }
                                                                            }
                                                                        )
                                                                    }
                                                                )
                                                            }

                                                            var value
                                                            var providerStatusCase =
                                                                trip.is_provider_status
                                                            switch (
                                                                providerStatusCase
                                                            ) {
                                                                case 2:
                                                                    value =
                                                                        push_messages.PUSH_CODE_FOR_PROVIDER_COMMING_YOUR_LOCATION
                                                                    break
                                                                case 4:
                                                                    value =
                                                                        push_messages.PUSH_CODE_FOR_PROVIDER_ARRIVED
                                                                    break
                                                                case 6:
                                                                    value =
                                                                        push_messages.PUSH_CODE_FOR_YOUR_TRIP_STARTED
                                                                    break
                                                                case 7:
                                                                    value =
                                                                        push_messages.PUSH_CODE_FOR_PROVIDER_ARRIVED_AT_DESTINATION
                                                                    break
                                                            }
                                                            if (value) {
                                                                const extra_param =
                                                                    {
                                                                        trip_id:
                                                                            trip._id,
                                                                    }
                                                                utils.sendPushNotification(
                                                                    constant_json.USER_UNIQUE_NUMBER,
                                                                    device_type,
                                                                    device_token,
                                                                    value,
                                                                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                    extra_param
                                                                )
                                                            }
                                                        })
                                                        utils.update_request_status_socket(
                                                            trip._id
                                                        )
                                                        res.json({
                                                            success: true,
                                                            message:
                                                                success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_SET_TRIP_STATUS_SUCCESSFULLY,
                                                            trip: trip,
                                                        })
                                                    },
                                                    (err) => {
                                                        console.log(err)
                                                        res.json({
                                                            success: false,
                                                            error_code:
                                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                        })
                                                    }
                                                )
                                            } else {
                                                res.json({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_MISMATCH_PROVIDER_ID_OR_TRIP_ID,
                                                })
                                            }
                                        } else {
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_NO_TRIP_FOUND,
                                            })
                                        }
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.check_destination = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                var geo = false
                var geo2 = false
                var zone1,
                    zone2,
                    k = 0
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({ _id: req.body.trip_id }).then(
                                    (trip) => {
                                        if (trip) {
                                            Citytype.findOne({
                                                _id: trip.service_type_id,
                                            }).then(
                                                (citytype) => {
                                                    if (citytype) {
                                                        City.findOne({
                                                            _id: citytype.cityid,
                                                            zone_business: true,
                                                        }).then(
                                                            (city) => {
                                                                if (
                                                                    trip.destination_addresses &&
                                                                    trip
                                                                        .destination_addresses
                                                                        .length >
                                                                        0
                                                                ) {
                                                                    res.json({
                                                                        success: true,
                                                                    })
                                                                } else if (
                                                                    city
                                                                ) {
                                                                    CityZone.find(
                                                                        {
                                                                            cityid: citytype.cityid,
                                                                        }
                                                                    ).then(
                                                                        (
                                                                            cityzone
                                                                        ) => {
                                                                            if (
                                                                                citytype.is_zone ==
                                                                                    1 &&
                                                                                cityzone !==
                                                                                    null &&
                                                                                cityzone.length >
                                                                                    0
                                                                            ) {
                                                                                var zone_count =
                                                                                    cityzone.length
                                                                                cityzone.forEach(
                                                                                    function (
                                                                                        cityzoneDetail
                                                                                    ) {
                                                                                        geo =
                                                                                            geolib.isPointInside(
                                                                                                {
                                                                                                    latitude:
                                                                                                        trip
                                                                                                            .sourceLocation[0],
                                                                                                    longitude:
                                                                                                        trip
                                                                                                            .sourceLocation[1],
                                                                                                },
                                                                                                cityzoneDetail.kmlzone
                                                                                            )
                                                                                        geo2 =
                                                                                            geolib.isPointInside(
                                                                                                {
                                                                                                    latitude:
                                                                                                        req
                                                                                                            .body
                                                                                                            .latitude,
                                                                                                    longitude:
                                                                                                        req
                                                                                                            .body
                                                                                                            .longitude,
                                                                                                },
                                                                                                cityzoneDetail.kmlzone
                                                                                            )
                                                                                        if (
                                                                                            geo
                                                                                        ) {
                                                                                            zone1 =
                                                                                                cityzoneDetail.id
                                                                                        }
                                                                                        if (
                                                                                            geo2
                                                                                        ) {
                                                                                            zone2 =
                                                                                                cityzoneDetail.id
                                                                                        }
                                                                                        k++
                                                                                        if (
                                                                                            k ==
                                                                                            zone_count
                                                                                        ) {
                                                                                            ZoneValue.findOne(
                                                                                                {
                                                                                                    service_type_id:
                                                                                                        trip.service_type_id,
                                                                                                    $or: [
                                                                                                        {
                                                                                                            from: zone1,
                                                                                                            to: zone2,
                                                                                                        },
                                                                                                        {
                                                                                                            from: zone2,
                                                                                                            to: zone1,
                                                                                                        },
                                                                                                    ],
                                                                                                }
                                                                                            ).then(
                                                                                                (
                                                                                                    zonevalue
                                                                                                ) => {
                                                                                                    if (
                                                                                                        zonevalue
                                                                                                    ) {
                                                                                                        trip.trip_type =
                                                                                                            constant_json.TRIP_TYPE_ZONE
                                                                                                        trip.trip_type_amount =
                                                                                                            zonevalue.amount.toFixed(
                                                                                                                2
                                                                                                            )
                                                                                                        trip.save(
                                                                                                            function () {
                                                                                                                res.json(
                                                                                                                    {
                                                                                                                        success: true,
                                                                                                                        zone: '',
                                                                                                                    }
                                                                                                                )
                                                                                                            }
                                                                                                        )
                                                                                                    } else {
                                                                                                        airport(
                                                                                                            citytype.cityid,
                                                                                                            citytype,
                                                                                                            trip,
                                                                                                            req.body,
                                                                                                            res
                                                                                                        )
                                                                                                    }
                                                                                                }
                                                                                            )
                                                                                        }
                                                                                    }
                                                                                )
                                                                            } else {
                                                                                airport(
                                                                                    citytype.cityid,
                                                                                    citytype,
                                                                                    trip,
                                                                                    req.body,
                                                                                    res
                                                                                )
                                                                            }
                                                                        }
                                                                    )
                                                                } else {
                                                                    airport(
                                                                        citytype.cityid,
                                                                        citytype,
                                                                        trip,
                                                                        req.body,
                                                                        res
                                                                    )
                                                                }
                                                            },
                                                            (err) => {
                                                                console.log(err)
                                                                res.json({
                                                                    success: false,
                                                                    error_code:
                                                                        error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                                })
                                                            }
                                                        )
                                                    } else {
                                                        res.json({
                                                            success: false,
                                                            error_code:
                                                                error_message.ERROR_CODE_NO_CITY_LIST_FOUND,
                                                        })
                                                    }
                                                },
                                                (err) => {
                                                    console.log(err)
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                    })
                                                }
                                            )
                                        } else {
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_TRIP_NOT_FOUND,
                                            })
                                        }
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

function airport(cityid, citytype, trip, body, res) {
    var airport
    Airport.find({ city_id: cityid }).then(
        (airport_data) => {
            if (airport_data != null && airport_data.length > 0) {
                var k = 0
                City.findOne({ _id: cityid, airport_business: true }).then(
                    (city) => {
                        if (city) {
                            airport_data.forEach(function (airportDetail) {
                                if (airport == undefined) {
                                    var pickup_airport = geolib.isPointInside(
                                        {
                                            latitude: trip.sourceLocation[0],
                                            longitude: trip.sourceLocation[1],
                                        },
                                        airportDetail.kmlzone
                                    )

                                    var dest_airport = geolib.isPointInside(
                                        {
                                            latitude: body.latitude,
                                            longitude: body.longitude,
                                        },
                                        airportDetail.kmlzone
                                    )

                                    if (pickup_airport) {
                                        city_distance =
                                            utils.getDistanceFromTwoLocation(
                                                [body.latitude, body.longitude],
                                                city.cityLatLong
                                            )
                                        if (city_distance < city.cityRadius) {
                                            AirportCity.findOne({
                                                airport_id: airportDetail._id,
                                                service_type_id: citytype._id,
                                            }).then((airportcity) => {
                                                if (
                                                    airportcity !== null &&
                                                    airportcity.price > 0
                                                ) {
                                                    airport = airportDetail._id
                                                    trip.trip_type =
                                                        constant_json.TRIP_TYPE_AIRPORT
                                                    trip.trip_type_amount =
                                                        airportcity.price.toFixed(
                                                            2
                                                        )
                                                    trip.save().then(() => {
                                                        res.json({
                                                            success: true,
                                                            airport: '',
                                                        })
                                                    })
                                                } else if (
                                                    airport_data.length - 1 ==
                                                    k
                                                ) {
                                                    cityCheck(
                                                        cityid,
                                                        citytype,
                                                        trip,
                                                        body,
                                                        res
                                                    )
                                                } else {
                                                    k++
                                                }
                                            })
                                        } else if (
                                            airport_data.length - 1 ==
                                            k
                                        ) {
                                            cityCheck(
                                                cityid,
                                                citytype,
                                                trip,
                                                body,
                                                res
                                            )
                                        } else {
                                            k++
                                        }
                                    } else if (dest_airport) {
                                        city_distance =
                                            utils.getDistanceFromTwoLocation(
                                                trip.sourceLocation,
                                                city.cityLatLong
                                            )
                                        if (city_distance < city.cityRadius) {
                                            AirportCity.findOne({
                                                airport_id: airportDetail._id,
                                                service_type_id: citytype._id,
                                            }).then((airportcity) => {
                                                if (
                                                    airportcity !== null &&
                                                    airportcity.price > 0
                                                ) {
                                                    airport = airportDetail._id
                                                    trip.trip_type =
                                                        constant_json.TRIP_TYPE_AIRPORT
                                                    trip.trip_type_amount =
                                                        airportcity.price.toFixed(
                                                            2
                                                        )
                                                    trip.save().then(() => {
                                                        res.json({
                                                            success: true,
                                                            airport: '',
                                                        })
                                                    })
                                                } else if (
                                                    airport_data.length - 1 ==
                                                    k
                                                ) {
                                                    cityCheck(
                                                        cityid,
                                                        citytype,
                                                        trip,
                                                        body,
                                                        res
                                                    )
                                                } else {
                                                    k++
                                                }
                                            })
                                        } else if (
                                            airport_data.length - 1 ==
                                            k
                                        ) {
                                            cityCheck(
                                                cityid,
                                                citytype,
                                                trip,
                                                body,
                                                res
                                            )
                                        } else {
                                            k++
                                        }
                                    } else if (
                                        airport_data.length - 1 == k &&
                                        airport == undefined
                                    ) {
                                        cityCheck(
                                            cityid,
                                            citytype,
                                            trip,
                                            body,
                                            res
                                        )
                                    } else {
                                        k++
                                    }
                                }
                            })
                        } else {
                            cityCheck(cityid, citytype, trip, body, res)
                        }
                    },
                    () => {
                        cityCheck(cityid, citytype, trip, body, res)
                    }
                )
            } else {
                cityCheck(cityid, citytype, trip, body, res)
            }
        },
        () => {
            cityCheck(cityid, citytype, trip, body, res)
        }
    )
}

function cityCheck(cityid, citytype, trip, body, res) {
    var flag = 0
    var k = 0
    City.findOne({ _id: cityid, city_business: true }).then(
        (city) => {
            if (city) {
                CitytoCity.find({
                    city_id: cityid,
                    service_type_id: citytype._id,
                    destination_city_id: { $in: city.destination_city },
                }).then((citytocity) => {
                    if (citytocity !== null && citytocity.length > 0) {
                        citytocity.forEach(function (citytocity_detail) {
                            City.findById(
                                citytocity_detail.destination_city_id
                            ).then((city_detail) => {
                                if (flag == 0) {
                                    var city_radius = city_detail.cityRadius
                                    var destination_city_radius =
                                        utils.getDistanceFromTwoLocation(
                                            [body.latitude, body.longitude],
                                            city_detail.cityLatLong
                                        )

                                    var inside_city
                                    if (
                                        city_detail.city_locations &&
                                        city_detail.city_locations.length > 2
                                    ) {
                                        inside_city = geolib.isPointInside(
                                            {
                                                latitude: body.latitude,
                                                longitude: body.longitude,
                                            },
                                            city_detail.city_locations
                                        )
                                    }

                                    if (
                                        citytocity_detail.price > 0 &&
                                        ((!city_detail.is_use_city_boundary &&
                                            city_radius >
                                                destination_city_radius) ||
                                            (city_detail.is_use_city_boundary &&
                                                inside_city))
                                    ) {
                                        trip.trip_type =
                                            constant_json.TRIP_TYPE_CITY
                                        trip.trip_type_amount =
                                            citytocity_detail.price.toFixed(2)
                                        flag = 1
                                        trip.save().then(() => {
                                            res.json({
                                                success: true,
                                                city: '',
                                            })
                                        })
                                    } else if (citytocity.length - 1 == k) {
                                        res.json({ success: true })
                                    } else {
                                        k++
                                    }
                                }
                            })
                        })
                    } else {
                        res.json({ success: true })
                    }
                })
            } else {
                res.json({ success: true })
            }
        },
        (err) => {
            console.log(err)
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
            })
        }
    )
}

exports.provider_complete_trip = function (req, res) {
    // console.log("Complete")
    // console.log(req.body)

    utils.check_request_params(
        req.body,
        [
            { name: 'trip_id', type: 'string' },
            { name: 'provider_id', type: 'string' },
        ],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    confirmed_provider: req.body.provider_id,
                                    is_trip_completed: 0,
                                    is_trip_end: 0,
                                }).then(
                                    (trip) => {
                                        if (trip) {
                                            if (
                                                trip.is_trip_cancelled == 0 &&
                                                trip.is_trip_cancelled_by_user ==
                                                    0 &&
                                                trip.is_trip_cancelled_by_provider ==
                                                    0
                                            ) {
                                                var city_timezone =
                                                    trip.timezone
                                                User.findOne({
                                                    _id: trip.user_id,
                                                }).then((user) => {
                                                    var total_distance = Number(
                                                        trip.total_distance.toFixed(
                                                            2
                                                        )
                                                    )
                                                    var total_time = Number(
                                                        trip.total_time.toFixed(
                                                            2
                                                        )
                                                    )
                                                    var total_waiting_time = 0
                                                    var total_stop_waiting_time = 0
                                                    var distance_cost = 0
                                                    var time_cost = 0
                                                    var waiting_time_cost = 0
                                                    var stop_waiting_time_cost = 0
                                                    var total_service_fees = 0
                                                    var tax_fee = 0
                                                    var provider_tax_fee = 0
                                                    var total_after_tax_fees = 0
                                                    var total_after_tax_fees_without_insurance = 0
                                                    var surge_fee = 0
                                                    var total_after_surge_fees = 0
                                                    var total_after_surge_fees_without_insurance = 0
                                                    var promo_payment = 0
                                                    var total_after_promo_payment = 0

                                                    var promo_value = 0

                                                    var total = 0
                                                    var is_min_fare_used = 0
                                                    var user_tax_fee = 0
                                                    var is_surge_hours =
                                                        trip.is_surge_hours
                                                    var total_time_end = 0
                                                    var now = new Date()
                                                    var dateNow = new Date()
                                                    total_time_end =
                                                        utils.getTimeDifferenceInMinute(
                                                            dateNow,
                                                            trip.provider_trip_start_time
                                                        )
                                                    if (
                                                        total_time_end >
                                                        total_time
                                                    ) {
                                                        total_time =
                                                            total_time_end
                                                    }

                                                    if (total_time < 0) {
                                                        total_time = 0
                                                    }
                                                    trip.total_time = total_time

                                                    total_waiting_time =
                                                        utils.getTimeDifferenceInMinute(
                                                            trip.provider_trip_start_time,
                                                            trip.provider_arrived_time
                                                        )
                                                    if (
                                                        total_waiting_time < 0
                                                    ) {
                                                        total_waiting_time = 0
                                                    }

                                                    TripLocation.findOne({
                                                        tripID: req.body
                                                            .trip_id,
                                                    }).then((tripLocation) => {
                                                        tripLocation.endTripTime =
                                                            now

                                                        var total_distance_diff = 0
                                                        let start_end_Location =
                                                            tripLocation.startTripToEndTripLocations
                                                        if (
                                                            req.body.location &&
                                                            req.body.location
                                                                .length > 0
                                                        ) {
                                                            var prev_location =
                                                                [
                                                                    Number(
                                                                        start_end_Location[0][0]
                                                                    ),
                                                                    Number(
                                                                        start_end_Location[0][1]
                                                                    ),
                                                                ]
                                                            var time =
                                                                provider.location_updated_time
                                                            for (
                                                                var i = 0;
                                                                i <
                                                                req.body
                                                                    .location
                                                                    .length;
                                                                i++
                                                            ) {
                                                                var location = [
                                                                    Number(
                                                                        req.body
                                                                            .location[
                                                                            i
                                                                        ][0]
                                                                    ),
                                                                    Number(
                                                                        req.body
                                                                            .location[
                                                                            i
                                                                        ][1]
                                                                    ),
                                                                ]
                                                                start_end_Location.push(
                                                                    location
                                                                )
                                                                var distance_diff =
                                                                    Math.abs(
                                                                        utils.getDistanceFromTwoLocation(
                                                                            prev_location,
                                                                            location
                                                                        )
                                                                    )
                                                                var time_diff =
                                                                    Math.abs(
                                                                        utils.getTimeDifferenceInSecond(
                                                                            new Date(
                                                                                time
                                                                            ),
                                                                            new Date(
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .location[
                                                                                        i
                                                                                    ][2]
                                                                                )
                                                                            )
                                                                        )
                                                                    )
                                                                var max_distance = 0.05
                                                                // if ((distance_diff < max_distance * time_diff && distance_diff > 0.005) || time_diff == 0) {
                                                                if (
                                                                    (distance_diff <
                                                                        max_distance *
                                                                            time_diff &&
                                                                        distance_diff >
                                                                            0.005) ||
                                                                    (distance_diff <
                                                                        max_distance &&
                                                                        time_diff ==
                                                                            0)
                                                                ) {
                                                                    total_distance_diff =
                                                                        total_distance_diff +
                                                                        distance_diff
                                                                    time =
                                                                        Number(
                                                                            req
                                                                                .body
                                                                                .location[
                                                                                i
                                                                            ][2]
                                                                        )
                                                                    prev_location =
                                                                        location
                                                                }
                                                            }
                                                            if (
                                                                trip.unit == 0
                                                            ) {
                                                                /// 0 = mile
                                                                total_distance_diff =
                                                                    total_distance_diff *
                                                                    0.621371
                                                            }
                                                            trip.total_distance =
                                                                (
                                                                    +trip.total_distance +
                                                                    +total_distance_diff
                                                                ).toFixed(2)
                                                            total_distance =
                                                                trip.total_distance
                                                        }

                                                        if (
                                                            !req.body
                                                                .latitude ||
                                                            !req.body.longitude
                                                        ) {
                                                            req.body.latitude =
                                                                tripLocation.startTripToEndTripLocations[
                                                                    tripLocation
                                                                        .startTripToEndTripLocations
                                                                        .length -
                                                                        1
                                                                ][0]
                                                            req.body.longitude =
                                                                tripLocation.startTripToEndTripLocations[
                                                                    tripLocation
                                                                        .startTripToEndTripLocations
                                                                        .length -
                                                                        1
                                                                ][1]
                                                        }

                                                        start_end_Location.push(
                                                            [
                                                                req.body
                                                                    .latitude,
                                                                req.body
                                                                    .longitude,
                                                            ]
                                                        )

                                                        tripLocation.startTripToEndTripLocations =
                                                            start_end_Location
                                                        tripLocation.endTripLocation =
                                                            [
                                                                req.body
                                                                    .latitude,
                                                                req.body
                                                                    .longitude,
                                                            ]

                                                        var url =
                                                            'https://maps.googleapis.com/maps/api/geocode/json?latlng=' +
                                                            req.body.latitude +
                                                            ',' +
                                                            req.body.longitude +
                                                            '&key=' +
                                                            setting_detail.web_app_google_key
                                                        var request_data = require('request')
                                                        if (
                                                            !req.body
                                                                .destination_address
                                                        ) {
                                                            request_data(
                                                                url,
                                                                function (
                                                                    error,
                                                                    response,
                                                                    body
                                                                ) {
                                                                    if (
                                                                        body.status ==
                                                                        'OK'
                                                                    ) {
                                                                        req.body.destination_address =
                                                                            body.results[0].formatted_address
                                                                    }
                                                                }
                                                            )
                                                        }
                                                        tripLocation.googlePathStartLocationToPickUpLocation =
                                                            ''
                                                        tripLocation.googlePickUpLocationToDestinationLocation =
                                                            ''
                                                        tripLocation.actual_startTripToEndTripLocations =
                                                            tripLocation.startTripToEndTripLocations

                                                        trip.speed =
                                                            tripLocation.speed
                                                        tripLocation
                                                            .save()
                                                            .then(() => {
                                                                let now =
                                                                    new Date()
                                                                const dest_addresses =
                                                                    trip.destination_addresses
                                                                if (
                                                                    req.body
                                                                        .is_destination_stop &&
                                                                    req.body
                                                                        .is_destination_stop ==
                                                                        1
                                                                ) {
                                                                    trip.actual_destination_stops[
                                                                        trip
                                                                            .actual_destination_stops
                                                                            .length -
                                                                            1
                                                                    ].address =
                                                                        req.body.destination_address
                                                                    trip.actual_destination_stops[
                                                                        trip
                                                                            .actual_destination_stops
                                                                            .length -
                                                                            1
                                                                    ].location =
                                                                        [
                                                                            Number(
                                                                                req
                                                                                    .body
                                                                                    .latitude
                                                                            ),
                                                                            Number(
                                                                                req
                                                                                    .body
                                                                                    .longitude
                                                                            ),
                                                                        ]
                                                                    trip.actual_destination_stops[
                                                                        trip
                                                                            .actual_destination_stops
                                                                            .length -
                                                                            1
                                                                    ].arrived_time =
                                                                        now
                                                                    let time_diff =
                                                                        Math.abs(
                                                                            utils.getTimeDifferenceInMinute(
                                                                                now,
                                                                                trip
                                                                                    .actual_destination_stops[
                                                                                    trip
                                                                                        .actual_destination_stops
                                                                                        .length -
                                                                                        1
                                                                                ]
                                                                                    .start_time
                                                                            )
                                                                        )
                                                                    if (
                                                                        time_diff <
                                                                        0
                                                                    ) {
                                                                        time_diff = 0
                                                                    }
                                                                    trip.actual_destination_stops[
                                                                        trip
                                                                            .actual_destination_stops
                                                                            .length -
                                                                            1
                                                                    ].total_time =
                                                                        time_diff
                                                                    if (
                                                                        trip
                                                                            .actual_destination_addresses
                                                                            .length >
                                                                            0 &&
                                                                        trip
                                                                            .actual_destination_addresses[
                                                                            trip
                                                                                .actual_destination_addresses
                                                                                .length -
                                                                                1
                                                                        ]
                                                                            .address ==
                                                                            ''
                                                                    ) {
                                                                        trip.actual_destination_addresses.pop()
                                                                    }
                                                                    trip.markModified(
                                                                        'actual_destination_addresses'
                                                                    )
                                                                    if (
                                                                        trip
                                                                            .actual_destination_stops[
                                                                            trip
                                                                                .actual_destination_stops
                                                                                .length -
                                                                                1
                                                                        ]
                                                                            .address >
                                                                            0 &&
                                                                        trip
                                                                            .actual_destination_stops[
                                                                            trip
                                                                                .actual_destination_stops
                                                                                .length -
                                                                                1
                                                                        ]
                                                                            .address ==
                                                                            ''
                                                                    ) {
                                                                        trip.actual_destination_stops.pop()
                                                                    }
                                                                    trip.markModified(
                                                                        'actual_destination_stops'
                                                                    )
                                                                } else if (
                                                                    req.body
                                                                        .city_index >
                                                                        0 &&
                                                                    dest_addresses.length ==
                                                                        trip
                                                                            .actual_destination_addresses
                                                                            .length -
                                                                            1
                                                                ) {
                                                                    let city_address =
                                                                        trip
                                                                            .actual_destination_addresses[
                                                                            dest_addresses.length -
                                                                                1
                                                                        ]
                                                                    if (
                                                                        dest_addresses[
                                                                            dest_addresses.length -
                                                                                1
                                                                        ]
                                                                            .stops_inside
                                                                            .length >
                                                                        0
                                                                    ) {
                                                                        city_address.stops_inside[
                                                                            city_address
                                                                                .stops_inside
                                                                                .length -
                                                                                1
                                                                        ].address =
                                                                            req.body.destination_address
                                                                        city_address.stops_inside[
                                                                            city_address
                                                                                .stops_inside
                                                                                .length -
                                                                                1
                                                                        ].location =
                                                                            [
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .latitude
                                                                                ),
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .longitude
                                                                                ),
                                                                            ]
                                                                        city_address.stops_inside[
                                                                            city_address
                                                                                .stops_inside
                                                                                .length -
                                                                                1
                                                                        ].arrived_time =
                                                                            now
                                                                        var time_diff =
                                                                            Math.abs(
                                                                                utils.getTimeDifferenceInMinute(
                                                                                    now,
                                                                                    city_address
                                                                                        .stops_inside[
                                                                                        city_address
                                                                                            .stops_inside
                                                                                            .length -
                                                                                            1
                                                                                    ]
                                                                                        .start_time
                                                                                )
                                                                            )
                                                                        if (
                                                                            time_diff <
                                                                            0
                                                                        ) {
                                                                            time_diff = 0
                                                                        }

                                                                        city_address.stops_inside[
                                                                            city_address
                                                                                .stops_inside
                                                                                .length -
                                                                                1
                                                                        ].total_time =
                                                                            time_diff
                                                                        const stops =
                                                                            city_address.stops_inside
                                                                        const total_waiting_time =
                                                                            stops.reduce(
                                                                                (
                                                                                    acc,
                                                                                    stop
                                                                                ) =>
                                                                                    acc +
                                                                                    stop.waiting_time,
                                                                                0
                                                                            )
                                                                        city_address.waiting_time =
                                                                            total_waiting_time
                                                                        const total_city_time =
                                                                            stops.reduce(
                                                                                (
                                                                                    acc,
                                                                                    stop
                                                                                ) =>
                                                                                    acc +
                                                                                    stop.total_time,
                                                                                0
                                                                            )
                                                                        city_address.total_time =
                                                                            total_city_time
                                                                        city_address.arrived_time =
                                                                            now
                                                                    } else {
                                                                        let time_diff =
                                                                            Math.abs(
                                                                                utils.getTimeDifferenceInMinute(
                                                                                    now,
                                                                                    city_address
                                                                                        .stops_inside
                                                                                        .start_time
                                                                                )
                                                                            )
                                                                        if (
                                                                            time_diff <
                                                                            0
                                                                        ) {
                                                                            time_diff = 0
                                                                        }

                                                                        city_address.address =
                                                                            req.body.destination_address
                                                                        city_address.location =
                                                                            [
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .latitude
                                                                                ),
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .longitude
                                                                                ),
                                                                            ]
                                                                    }

                                                                    city_address.arrived_time =
                                                                        now

                                                                    trip.actual_destination_addresses[
                                                                        dest_addresses.length -
                                                                            1
                                                                    ] =
                                                                        city_address
                                                                    trip.markModified(
                                                                        'actual_destination_addresses'
                                                                    )
                                                                    if (
                                                                        trip
                                                                            .actual_destination_addresses
                                                                            .length >
                                                                            0 &&
                                                                        trip
                                                                            .actual_destination_addresses[
                                                                            trip
                                                                                .actual_destination_addresses
                                                                                .length -
                                                                                1
                                                                        ]
                                                                            .address ==
                                                                            ''
                                                                    ) {
                                                                        trip.actual_destination_addresses.pop()
                                                                        trip.markModified(
                                                                            'actual_destination_addresses'
                                                                        )
                                                                    }
                                                                    if (
                                                                        trip
                                                                            .actual_destination_stops
                                                                            .length >
                                                                            0 &&
                                                                        trip
                                                                            .actual_destination_stops[
                                                                            trip
                                                                                .actual_destination_stops
                                                                                .length -
                                                                                1
                                                                        ]
                                                                            .address ==
                                                                            ''
                                                                    ) {
                                                                        trip.actual_destination_stops.pop()
                                                                        trip.markModified(
                                                                            'actual_destination_stops'
                                                                        )
                                                                    }
                                                                } else if (
                                                                    req.body
                                                                        .city_index >
                                                                        0 &&
                                                                    dest_addresses.length !=
                                                                        trip
                                                                            .actual_destination_addresses
                                                                            .length -
                                                                            1
                                                                ) {
                                                                    let city_address =
                                                                        trip
                                                                            .actual_destination_addresses[
                                                                            trip
                                                                                .actual_destination_addresses
                                                                                .length -
                                                                                1
                                                                        ]

                                                                    if (
                                                                        trip
                                                                            .actual_destination_addresses[
                                                                            trip
                                                                                .actual_destination_addresses
                                                                                .length -
                                                                                1
                                                                        ]
                                                                            .stops_inside
                                                                            .length >
                                                                        0
                                                                    ) {
                                                                        let inside_stop =
                                                                            city_address.stops_inside
                                                                        let stop_total_time =
                                                                            Math.abs(
                                                                                utils.getTimeDifferenceInMinute(
                                                                                    now,
                                                                                    inside_stop[
                                                                                        inside_stop.length -
                                                                                            1
                                                                                    ]
                                                                                        .start_time
                                                                                )
                                                                            )
                                                                        if (
                                                                            stop_total_time <
                                                                            0
                                                                        ) {
                                                                            stop_total_time = 0
                                                                        }
                                                                        inside_stop[
                                                                            inside_stop.length -
                                                                                1
                                                                        ].total_time =
                                                                            stop_total_time
                                                                        const total_waiting_time =
                                                                            inside_stop.reduce(
                                                                                (
                                                                                    acc,
                                                                                    stop
                                                                                ) =>
                                                                                    acc +
                                                                                    stop.waiting_time,
                                                                                0
                                                                            )
                                                                        city_address.waiting_time =
                                                                            total_waiting_time
                                                                        const total_city_time =
                                                                            inside_stop.reduce(
                                                                                (
                                                                                    acc,
                                                                                    stop
                                                                                ) =>
                                                                                    acc +
                                                                                    stop.total_time,
                                                                                0
                                                                            )
                                                                        city_address.total_time =
                                                                            total_city_time
                                                                        city_address.arrived_time =
                                                                            now
                                                                        inside_stop[
                                                                            inside_stop.length -
                                                                                1
                                                                        ].total_time =
                                                                            total_city_time
                                                                        inside_stop[
                                                                            inside_stop.length -
                                                                                1
                                                                        ].address =
                                                                            req.body.destination_address
                                                                        inside_stop[
                                                                            inside_stop.length -
                                                                                1
                                                                        ].location =
                                                                            [
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .latitude
                                                                                ),
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .longitude
                                                                                ),
                                                                            ]
                                                                        inside_stop[
                                                                            inside_stop.length -
                                                                                1
                                                                        ].arrived_time =
                                                                            now
                                                                        city_address.stops_inside =
                                                                            inside_stop
                                                                    } else {
                                                                        city_address.address =
                                                                            req.body.destination_address
                                                                        city_address.location =
                                                                            [
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .latitude
                                                                                ),
                                                                                Number(
                                                                                    req
                                                                                        .body
                                                                                        .longitude
                                                                                ),
                                                                            ]
                                                                        city_address.arrived_time =
                                                                            now
                                                                    }
                                                                    trip.actual_destination_addresses[
                                                                        trip
                                                                            .actual_destination_addresses
                                                                            .length -
                                                                            1
                                                                    ] =
                                                                        city_address
                                                                    trip.markModified(
                                                                        'actual_destination_addresses'
                                                                    )
                                                                }
                                                                var index =
                                                                    tripLocation.index_for_that_covered_path_in_google
                                                                var startTripToEndTripLocations =
                                                                    tripLocation.startTripToEndTripLocations
                                                                var size =
                                                                    startTripToEndTripLocations.length
                                                                var gap = 95
                                                                var start_index =
                                                                    index * gap
                                                                var end_index =
                                                                    size
                                                                start_index--
                                                                if (
                                                                    start_index <
                                                                    0
                                                                ) {
                                                                    start_index = 0
                                                                }
                                                                var locations =
                                                                    []

                                                                for (
                                                                    ;
                                                                    start_index <
                                                                    end_index;
                                                                    start_index++
                                                                ) {
                                                                    locations.push(
                                                                        startTripToEndTripLocations[
                                                                            start_index
                                                                        ]
                                                                    )
                                                                }

                                                                utils.getSmoothPath(
                                                                    locations,
                                                                    function (
                                                                        getSmoothPathresponse
                                                                    ) {
                                                                        utils.bendAndSnap(
                                                                            getSmoothPathresponse,
                                                                            locations.length,
                                                                            function (
                                                                                response
                                                                            ) {
                                                                                if (
                                                                                    response
                                                                                ) {
                                                                                    var index =
                                                                                        tripLocation.index_for_that_covered_path_in_google
                                                                                    var google_start_trip_to_end_trip_locations =
                                                                                        tripLocation.google_start_trip_to_end_trip_locations
                                                                                    google_start_trip_to_end_trip_locations =
                                                                                        google_start_trip_to_end_trip_locations.concat(
                                                                                            response.temp_array
                                                                                        )
                                                                                    tripLocation.google_start_trip_to_end_trip_locations =
                                                                                        google_start_trip_to_end_trip_locations
                                                                                    var google_total_distance =
                                                                                        +tripLocation.google_total_distance +
                                                                                        +response.distance
                                                                                    tripLocation.google_total_distance =
                                                                                        google_total_distance
                                                                                    index++
                                                                                    tripLocation.index_for_that_covered_path_in_google =
                                                                                        index
                                                                                    tripLocation.startTripToEndTripLocations =
                                                                                        tripLocation.google_start_trip_to_end_trip_locations
                                                                                    tripLocation.save()

                                                                                    var distance_diff =
                                                                                        total_distance -
                                                                                        google_total_distance
                                                                                    if (
                                                                                        distance_diff >
                                                                                            0.5 ||
                                                                                        distance_diff <
                                                                                            -0.5
                                                                                    ) {
                                                                                        total_distance =
                                                                                            google_total_distance.toFixed(
                                                                                                2
                                                                                            )

                                                                                        if (
                                                                                            trip.unit ==
                                                                                            0
                                                                                        ) {
                                                                                            /// 0 = mile
                                                                                            total_distance =
                                                                                                total_distance *
                                                                                                0.621371
                                                                                        }

                                                                                        trip.total_distance =
                                                                                            total_distance
                                                                                    }
                                                                                }

                                                                                Provider.findOne(
                                                                                    {
                                                                                        _id: req
                                                                                            .body
                                                                                            .provider_id,
                                                                                    }
                                                                                ).then(
                                                                                    (
                                                                                        provider
                                                                                    ) => {
                                                                                        City.findOne(
                                                                                            {
                                                                                                _id: trip.city_id,
                                                                                            }
                                                                                        ).then(
                                                                                            () => {
                                                                                                provider.providerLocation =
                                                                                                    [
                                                                                                        Number(
                                                                                                            req
                                                                                                                .body
                                                                                                                .latitude
                                                                                                        ),
                                                                                                        Number(
                                                                                                            req
                                                                                                                .body
                                                                                                                .longitude
                                                                                                        ),
                                                                                                    ]
                                                                                                provider.bearing =
                                                                                                    req.body.bearing
                                                                                                provider.save()

                                                                                                Trip_Service.findOne(
                                                                                                    {
                                                                                                        _id: trip.trip_service_city_type_id,
                                                                                                    }
                                                                                                ).then(
                                                                                                    (
                                                                                                        tripservice
                                                                                                    ) => {
                                                                                                        var surge_multiplier = 0
                                                                                                        var min_fare = 0
                                                                                                        var base_price = 0
                                                                                                        var base_price_distance = 0
                                                                                                        var tax = 0
                                                                                                        var user_miscellaneous_fee = 0
                                                                                                        var provider_miscellaneous_fee = 0
                                                                                                        var user_tax = 0
                                                                                                        var provider_tax = 0
                                                                                                        var provider_profit = 0
                                                                                                        var price_per_unit_distance = 0
                                                                                                        var price_for_total_time = 0
                                                                                                        var price_for_waiting_time = 0
                                                                                                        var waiting_time_start_after_minute = 0
                                                                                                        var price_for_waiting_time_multiple_stops = 0
                                                                                                        var waiting_time_start_after_minute_multiple_stops = 0
                                                                                                        var base_price_time = 0
                                                                                                        var total_after_user_tax_fees = 0
                                                                                                        ///////////////// Distance cost and Time cost calculation /////
                                                                                                        trip.is_provider_status = 9
                                                                                                        // DISTANCE CALCULATIONS
                                                                                                        trip.destination_address =
                                                                                                            req.body.destination_address
                                                                                                        trip.destinationLocation =
                                                                                                            [
                                                                                                                req
                                                                                                                    .body
                                                                                                                    .latitude,
                                                                                                                req
                                                                                                                    .body
                                                                                                                    .longitude,
                                                                                                            ]
                                                                                                        trip.provider_trip_end_time =
                                                                                                            now

                                                                                                        var toll_amount =
                                                                                                            req
                                                                                                                .body
                                                                                                                .toll_amount

                                                                                                        if (
                                                                                                            toll_amount ==
                                                                                                            undefined
                                                                                                        ) {
                                                                                                            toll_amount = 0
                                                                                                        }

                                                                                                        var trip_type_amount =
                                                                                                            trip.trip_type_amount
                                                                                                        provider_miscellaneous_fee =
                                                                                                            tripservice.provider_miscellaneous_fee

                                                                                                        provider_tax =
                                                                                                            tripservice.provider_tax

                                                                                                        provider_profit =
                                                                                                            tripservice.provider_profit

                                                                                                        if (
                                                                                                            trip.is_fixed_fare &&
                                                                                                            trip.fixed_price >
                                                                                                                0
                                                                                                        ) {
                                                                                                            tax =
                                                                                                                tripservice.tax
                                                                                                            user_miscellaneous_fee =
                                                                                                                tripservice.user_miscellaneous_fee
                                                                                                            user_tax =
                                                                                                                tripservice.user_tax

                                                                                                            total_after_surge_fees =
                                                                                                                trip.fixed_price
                                                                                                            trip.total_service_fees =
                                                                                                                total_after_surge_fees

                                                                                                            total_after_surge_fees =
                                                                                                                utils.get_reverse_service_fee(
                                                                                                                    total_after_surge_fees,
                                                                                                                    tax
                                                                                                                )
                                                                                                            total_after_surge_fees_without_insurance =
                                                                                                                utils.get_reverse_service_fee(
                                                                                                                    trip.fixed_price,
                                                                                                                    tax
                                                                                                                )
                                                                                                            trip.fixed_price =
                                                                                                                total_after_surge_fees
                                                                                                            tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.tax_fee =
                                                                                                                tax_fee
                                                                                                            total_after_tax_fees =
                                                                                                                +total_after_surge_fees +
                                                                                                                +tax_fee
                                                                                                            total_after_tax_fees_without_insurance =
                                                                                                                +total_after_surge_fees_without_insurance +
                                                                                                                +Number(
                                                                                                                    (
                                                                                                                        tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees_without_insurance
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            user_tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        user_tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.user_tax_fee =
                                                                                                                user_tax_fee
                                                                                                            trip.user_miscellaneous_fee =
                                                                                                                user_miscellaneous_fee
                                                                                                        } else if (
                                                                                                            trip.trip_type ==
                                                                                                            constant_json.TRIP_TYPE_AIRPORT
                                                                                                        ) {
                                                                                                            tax =
                                                                                                                tripservice.tax
                                                                                                            user_miscellaneous_fee =
                                                                                                                tripservice.user_miscellaneous_fee
                                                                                                            user_tax =
                                                                                                                tripservice.user_tax

                                                                                                            total_after_surge_fees =
                                                                                                                trip_type_amount
                                                                                                            trip.total_service_fees =
                                                                                                                total_after_surge_fees

                                                                                                            total_after_surge_fees =
                                                                                                                utils.get_reverse_service_fee(
                                                                                                                    total_after_surge_fees,
                                                                                                                    tax
                                                                                                                )
                                                                                                            trip.fixed_price =
                                                                                                                total_after_surge_fees
                                                                                                            tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.tax_fee =
                                                                                                                tax_fee
                                                                                                            total_after_tax_fees =
                                                                                                                +total_after_surge_fees +
                                                                                                                +tax_fee
                                                                                                            user_tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        user_tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.user_tax_fee =
                                                                                                                user_tax_fee
                                                                                                            trip.user_miscellaneous_fee =
                                                                                                                user_miscellaneous_fee
                                                                                                        } else if (
                                                                                                            trip.trip_type ==
                                                                                                            constant_json.TRIP_TYPE_ZONE
                                                                                                        ) {
                                                                                                            tax =
                                                                                                                tripservice.tax
                                                                                                            user_miscellaneous_fee =
                                                                                                                tripservice.user_miscellaneous_fee
                                                                                                            user_tax =
                                                                                                                tripservice.user_tax

                                                                                                            total_after_surge_fees =
                                                                                                                trip_type_amount
                                                                                                            trip.total_service_fees =
                                                                                                                total_after_surge_fees

                                                                                                            total_after_surge_fees =
                                                                                                                utils.get_reverse_service_fee(
                                                                                                                    total_after_surge_fees,
                                                                                                                    tax
                                                                                                                )
                                                                                                            trip.fixed_price =
                                                                                                                total_after_surge_fees
                                                                                                            tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.tax_fee =
                                                                                                                tax_fee
                                                                                                            total_after_tax_fees =
                                                                                                                +total_after_surge_fees +
                                                                                                                +tax_fee
                                                                                                            user_tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        user_tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.user_tax_fee =
                                                                                                                user_tax_fee
                                                                                                            trip.user_miscellaneous_fee =
                                                                                                                user_miscellaneous_fee
                                                                                                        } else if (
                                                                                                            trip.trip_type ==
                                                                                                            constant_json.TRIP_TYPE_CITY
                                                                                                        ) {
                                                                                                            tax =
                                                                                                                tripservice.tax
                                                                                                            user_miscellaneous_fee =
                                                                                                                tripservice.user_miscellaneous_fee
                                                                                                            user_tax =
                                                                                                                tripservice.user_tax

                                                                                                            total_after_surge_fees =
                                                                                                                trip_type_amount
                                                                                                            trip.total_service_fees =
                                                                                                                total_after_surge_fees

                                                                                                            total_after_surge_fees =
                                                                                                                utils.get_reverse_service_fee(
                                                                                                                    total_after_surge_fees,
                                                                                                                    tax
                                                                                                                )
                                                                                                            trip.fixed_price =
                                                                                                                total_after_surge_fees
                                                                                                            tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.tax_fee =
                                                                                                                tax_fee
                                                                                                            total_after_tax_fees =
                                                                                                                +total_after_surge_fees +
                                                                                                                +tax_fee
                                                                                                            user_tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        user_tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.user_tax_fee =
                                                                                                                user_tax_fee
                                                                                                            trip.user_miscellaneous_fee =
                                                                                                                user_miscellaneous_fee
                                                                                                        } else if (
                                                                                                            trip.car_rental_id
                                                                                                        ) {
                                                                                                            if (
                                                                                                                trip.surge_multiplier
                                                                                                            ) {
                                                                                                                surge_multiplier =
                                                                                                                    trip.surge_multiplier
                                                                                                            }
                                                                                                            min_fare =
                                                                                                                tripservice.min_fare
                                                                                                            base_price =
                                                                                                                tripservice.base_price
                                                                                                            base_price_distance =
                                                                                                                tripservice.base_price_distance
                                                                                                            tax =
                                                                                                                tripservice.tax
                                                                                                            user_miscellaneous_fee =
                                                                                                                tripservice.user_miscellaneous_fee
                                                                                                            user_tax =
                                                                                                                tripservice.user_tax

                                                                                                            price_per_unit_distance =
                                                                                                                tripservice.price_per_unit_distance
                                                                                                            price_for_total_time =
                                                                                                                tripservice.price_for_total_time
                                                                                                            price_for_waiting_time =
                                                                                                                tripservice.price_for_waiting_time
                                                                                                            waiting_time_start_after_minute =
                                                                                                                tripservice.waiting_time_start_after_minute
                                                                                                            if (
                                                                                                                total_distance <=
                                                                                                                base_price_distance
                                                                                                            ) {
                                                                                                                distance_cost = 0
                                                                                                            } else {
                                                                                                                distance_cost =
                                                                                                                    Number(
                                                                                                                        (
                                                                                                                            (total_distance -
                                                                                                                                base_price_distance) *
                                                                                                                            price_per_unit_distance
                                                                                                                        ).toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                            }

                                                                                                            trip.distance_cost =
                                                                                                                distance_cost
                                                                                                            // TIME CALCULATIONS
                                                                                                            if (
                                                                                                                total_time >
                                                                                                                base_price_time
                                                                                                            ) {
                                                                                                                time_cost =
                                                                                                                    (total_time -
                                                                                                                        base_price_time) *
                                                                                                                    price_for_total_time
                                                                                                            }
                                                                                                            time_cost =
                                                                                                                Number(
                                                                                                                    time_cost.toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.time_cost =
                                                                                                                time_cost

                                                                                                            total_waiting_time =
                                                                                                                total_waiting_time -
                                                                                                                waiting_time_start_after_minute
                                                                                                            trip.waiting_time_cost = 0

                                                                                                            trip.total_waiting_time =
                                                                                                                total_waiting_time

                                                                                                            total_service_fees =
                                                                                                                +base_price +
                                                                                                                +distance_cost +
                                                                                                                +time_cost +
                                                                                                                +waiting_time_cost
                                                                                                            trip.total_service_fees =
                                                                                                                total_service_fees
                                                                                                            if (
                                                                                                                is_surge_hours ==
                                                                                                                constant_json.YES
                                                                                                            ) {
                                                                                                                surge_fee =
                                                                                                                    Number(
                                                                                                                        (
                                                                                                                            total_service_fees *
                                                                                                                            (surge_multiplier -
                                                                                                                                1)
                                                                                                                        ).toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                                trip.surge_fee =
                                                                                                                    surge_fee
                                                                                                                total_after_surge_fees =
                                                                                                                    total_service_fees +
                                                                                                                    surge_fee
                                                                                                                total_after_surge_fees =
                                                                                                                    Number(
                                                                                                                        total_after_surge_fees.toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                            } else {
                                                                                                                surge_fee = 0
                                                                                                                trip.surge_fee =
                                                                                                                    surge_fee
                                                                                                                total_after_surge_fees =
                                                                                                                    total_service_fees
                                                                                                                total_after_surge_fees =
                                                                                                                    Number(
                                                                                                                        total_after_surge_fees.toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                            }

                                                                                                            tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.tax_fee =
                                                                                                                tax_fee
                                                                                                            total_after_tax_fees =
                                                                                                                +total_after_surge_fees +
                                                                                                                +tax_fee
                                                                                                            if (
                                                                                                                total_after_tax_fees <
                                                                                                                min_fare
                                                                                                            ) {
                                                                                                                total_after_tax_fees =
                                                                                                                    min_fare
                                                                                                                is_min_fare_used = 1

                                                                                                                total_after_surge_fees =
                                                                                                                    utils.get_reverse_service_fee(
                                                                                                                        min_fare,
                                                                                                                        tax
                                                                                                                    )

                                                                                                                tax_fee =
                                                                                                                    Number(
                                                                                                                        (
                                                                                                                            tax *
                                                                                                                            0.01 *
                                                                                                                            total_after_surge_fees
                                                                                                                        ).toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                                trip.tax_fee =
                                                                                                                    tax_fee
                                                                                                                total_after_tax_fees =
                                                                                                                    +total_after_surge_fees +
                                                                                                                    +tax_fee
                                                                                                            }
                                                                                                            trip.is_min_fare_used =
                                                                                                                is_min_fare_used

                                                                                                            user_tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        user_tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.user_tax_fee =
                                                                                                                user_tax_fee
                                                                                                            trip.user_miscellaneous_fee =
                                                                                                                user_miscellaneous_fee
                                                                                                        } else {
                                                                                                            // surge_multiplier = tripservice.surge_multiplier;
                                                                                                            if (
                                                                                                                trip.surge_multiplier
                                                                                                            ) {
                                                                                                                surge_multiplier =
                                                                                                                    trip.surge_multiplier
                                                                                                            }
                                                                                                            min_fare =
                                                                                                                tripservice.min_fare
                                                                                                            base_price =
                                                                                                                tripservice.base_price
                                                                                                            base_price_distance =
                                                                                                                tripservice.base_price_distance
                                                                                                            tax =
                                                                                                                tripservice.tax
                                                                                                            user_miscellaneous_fee =
                                                                                                                tripservice.user_miscellaneous_fee
                                                                                                            user_tax =
                                                                                                                tripservice.user_tax

                                                                                                            price_per_unit_distance =
                                                                                                                tripservice.price_per_unit_distance
                                                                                                            price_for_total_time =
                                                                                                                tripservice.price_for_total_time
                                                                                                            price_for_waiting_time =
                                                                                                                tripservice.price_for_waiting_time
                                                                                                            waiting_time_start_after_minute =
                                                                                                                tripservice.waiting_time_start_after_minute

                                                                                                            price_for_waiting_time_multiple_stops =
                                                                                                                tripservice.price_for_waiting_time_multiple_stops
                                                                                                                    ? tripservice.price_for_waiting_time_multiple_stops
                                                                                                                    : 0
                                                                                                            waiting_time_start_after_minute_multiple_stops =
                                                                                                                tripservice.waiting_time_start_after_minute_multiple_stops
                                                                                                                    ? tripservice.waiting_time_start_after_minute_multiple_stops
                                                                                                                    : 0

                                                                                                            if (
                                                                                                                total_distance <=
                                                                                                                base_price_distance
                                                                                                            ) {
                                                                                                                distance_cost = 0
                                                                                                            } else {
                                                                                                                distance_cost =
                                                                                                                    Number(
                                                                                                                        (
                                                                                                                            (total_distance -
                                                                                                                                base_price_distance) *
                                                                                                                            price_per_unit_distance
                                                                                                                        ).toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                            }
                                                                                                            trip.distance_cost =
                                                                                                                distance_cost
                                                                                                            // TIME CALCULATIONS
                                                                                                            if (
                                                                                                                time_cost <
                                                                                                                0
                                                                                                            ) {
                                                                                                                time_cost = 0
                                                                                                            }
                                                                                                            if (
                                                                                                                trip.actual_destination_addresses
                                                                                                            ) {
                                                                                                                trip.actual_destination_addresses.forEach(
                                                                                                                    (
                                                                                                                        destination_address
                                                                                                                    ) => {
                                                                                                                        total_time =
                                                                                                                            total_time -
                                                                                                                            destination_address.waiting_time
                                                                                                                    }
                                                                                                                )
                                                                                                            }
                                                                                                            if (
                                                                                                                total_time <
                                                                                                                0
                                                                                                            ) {
                                                                                                                total_time = 0
                                                                                                            }
                                                                                                            time_cost =
                                                                                                                total_time *
                                                                                                                price_for_total_time
                                                                                                            time_cost =
                                                                                                                Number(
                                                                                                                    time_cost.toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.time_cost =
                                                                                                                time_cost
                                                                                                            //  WAITING TIME CALCULATIONS
                                                                                                            total_waiting_time =
                                                                                                                total_waiting_time -
                                                                                                                waiting_time_start_after_minute
                                                                                                            if (
                                                                                                                total_waiting_time <
                                                                                                                0
                                                                                                            ) {
                                                                                                                total_waiting_time = 0
                                                                                                            }

                                                                                                            if (
                                                                                                                total_waiting_time >
                                                                                                                0
                                                                                                            ) {
                                                                                                                waiting_time_cost =
                                                                                                                    Number(
                                                                                                                        (
                                                                                                                            total_waiting_time *
                                                                                                                            price_for_waiting_time
                                                                                                                        ).toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                            }
                                                                                                            if (
                                                                                                                trip.actual_destination_addresses
                                                                                                            ) {
                                                                                                                if (
                                                                                                                    setting_detail.is_multiple_stop_waiting_free_on_each_stop
                                                                                                                ) {
                                                                                                                    trip.actual_destination_addresses.forEach(
                                                                                                                        (
                                                                                                                            destination_address
                                                                                                                        ) => {
                                                                                                                            if (
                                                                                                                                destination_address.waiting_time -
                                                                                                                                    waiting_time_start_after_minute_multiple_stops >
                                                                                                                                0
                                                                                                                            ) {
                                                                                                                                total_stop_waiting_time +=
                                                                                                                                    destination_address.waiting_time
                                                                                                                            }
                                                                                                                        }
                                                                                                                    )
                                                                                                                } else {
                                                                                                                    trip.actual_destination_addresses.forEach(
                                                                                                                        (
                                                                                                                            destination_address
                                                                                                                        ) => {
                                                                                                                            total_stop_waiting_time +=
                                                                                                                                destination_address.waiting_time
                                                                                                                        }
                                                                                                                    )
                                                                                                                    total_stop_waiting_time =
                                                                                                                        total_stop_waiting_time -
                                                                                                                        waiting_time_start_after_minute_multiple_stops
                                                                                                                    if (
                                                                                                                        total_stop_waiting_time <
                                                                                                                        0
                                                                                                                    ) {
                                                                                                                        total_stop_waiting_time = 0
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                            if (
                                                                                                                total_stop_waiting_time >
                                                                                                                0
                                                                                                            ) {
                                                                                                                stop_waiting_time_cost =
                                                                                                                    Number(
                                                                                                                        (
                                                                                                                            total_stop_waiting_time *
                                                                                                                            price_for_waiting_time_multiple_stops
                                                                                                                        ).toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                            }

                                                                                                            trip.waiting_time_cost =
                                                                                                                waiting_time_cost
                                                                                                            trip.total_waiting_time =
                                                                                                                total_waiting_time
                                                                                                            trip.total_stop_waiting_time =
                                                                                                                total_stop_waiting_time
                                                                                                            trip.stop_waiting_time_cost =
                                                                                                                stop_waiting_time_cost

                                                                                                            total_service_fees =
                                                                                                                +base_price +
                                                                                                                +distance_cost +
                                                                                                                +time_cost +
                                                                                                                +waiting_time_cost +
                                                                                                                +stop_waiting_time_cost
                                                                                                            trip.total_service_fees =
                                                                                                                total_service_fees

                                                                                                            if (
                                                                                                                is_surge_hours ==
                                                                                                                constant_json.YES
                                                                                                            ) {
                                                                                                                surge_fee =
                                                                                                                    Number(
                                                                                                                        (
                                                                                                                            total_service_fees *
                                                                                                                            (surge_multiplier -
                                                                                                                                1)
                                                                                                                        ).toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                                trip.surge_fee =
                                                                                                                    surge_fee
                                                                                                                total_after_surge_fees =
                                                                                                                    total_service_fees +
                                                                                                                    surge_fee
                                                                                                                total_after_surge_fees =
                                                                                                                    Number(
                                                                                                                        total_after_surge_fees.toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                            } else {
                                                                                                                surge_fee = 0
                                                                                                                trip.surge_fee =
                                                                                                                    surge_fee
                                                                                                                total_after_surge_fees =
                                                                                                                    total_service_fees
                                                                                                                total_after_surge_fees =
                                                                                                                    Number(
                                                                                                                        total_after_surge_fees.toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                            }

                                                                                                            tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.tax_fee =
                                                                                                                tax_fee
                                                                                                            total_after_tax_fees =
                                                                                                                +total_after_surge_fees +
                                                                                                                +tax_fee

                                                                                                            if (
                                                                                                                total_after_tax_fees <
                                                                                                                min_fare
                                                                                                            ) {
                                                                                                                total_after_tax_fees =
                                                                                                                    min_fare
                                                                                                                is_min_fare_used = 1

                                                                                                                total_after_surge_fees =
                                                                                                                    utils.get_reverse_service_fee(
                                                                                                                        min_fare,
                                                                                                                        tax
                                                                                                                    )

                                                                                                                tax_fee =
                                                                                                                    Number(
                                                                                                                        (
                                                                                                                            tax *
                                                                                                                            0.01 *
                                                                                                                            total_after_surge_fees
                                                                                                                        ).toFixed(
                                                                                                                            2
                                                                                                                        )
                                                                                                                    )
                                                                                                                trip.tax_fee =
                                                                                                                    tax_fee
                                                                                                                total_after_tax_fees =
                                                                                                                    +total_after_surge_fees +
                                                                                                                    +tax_fee
                                                                                                            }
                                                                                                            trip.is_min_fare_used =
                                                                                                                is_min_fare_used

                                                                                                            user_tax_fee =
                                                                                                                Number(
                                                                                                                    (
                                                                                                                        user_tax *
                                                                                                                        0.01 *
                                                                                                                        total_after_surge_fees
                                                                                                                    ).toFixed(
                                                                                                                        2
                                                                                                                    )
                                                                                                                )
                                                                                                            trip.user_tax_fee =
                                                                                                                user_tax_fee
                                                                                                            trip.user_miscellaneous_fee =
                                                                                                                user_miscellaneous_fee
                                                                                                        }
                                                                                                        trip.total_after_tax_fees =
                                                                                                            total_after_tax_fees
                                                                                                        trip.total_after_surge_fees =
                                                                                                            total_after_surge_fees

                                                                                                        ///////////////////////// FOR INVOICE //////////////////////////
                                                                                                        var current_rate = 1
                                                                                                        var countryCurrencyCode =
                                                                                                            trip.currencycode
                                                                                                        var adminCurrencyCode =
                                                                                                            trip.currencycode
                                                                                                        var adminCurrency =
                                                                                                            trip.currency

                                                                                                        adminCurrencyCode =
                                                                                                            setting_detail.adminCurrencyCode
                                                                                                        adminCurrency =
                                                                                                            setting_detail.adminCurrency

                                                                                                        utils.getCurrencyConvertRate(
                                                                                                            1,
                                                                                                            countryCurrencyCode,
                                                                                                            adminCurrencyCode,
                                                                                                            function (
                                                                                                                response
                                                                                                            ) {
                                                                                                                if (
                                                                                                                    response.success
                                                                                                                ) {
                                                                                                                    current_rate =
                                                                                                                        response.current_rate
                                                                                                                } else {
                                                                                                                    current_rate = 1
                                                                                                                }

                                                                                                                trip.current_rate =
                                                                                                                    current_rate

                                                                                                                Promo_Code.findOne(
                                                                                                                    {
                                                                                                                        _id: trip.promo_id,
                                                                                                                    }
                                                                                                                ).then(
                                                                                                                    (
                                                                                                                        promocode
                                                                                                                    ) => {
                                                                                                                        total_after_user_tax_fees =
                                                                                                                            +total_after_tax_fees +
                                                                                                                            +user_miscellaneous_fee +
                                                                                                                            +user_tax_fee

                                                                                                                        if (
                                                                                                                            trip.promo_id !=
                                                                                                                                null &&
                                                                                                                            promocode
                                                                                                                        ) {
                                                                                                                            var promo_type =
                                                                                                                                promocode.code_type
                                                                                                                            promo_value =
                                                                                                                                promocode.code_value
                                                                                                                            if (
                                                                                                                                promo_type ==
                                                                                                                                1
                                                                                                                            ) {
                                                                                                                                ///abs
                                                                                                                                promo_payment =
                                                                                                                                    promo_value
                                                                                                                            } else {
                                                                                                                                // perc
                                                                                                                                promo_payment =
                                                                                                                                    Number(
                                                                                                                                        (
                                                                                                                                            promo_value *
                                                                                                                                            0.01 *
                                                                                                                                            total_after_user_tax_fees
                                                                                                                                        ).toFixed(
                                                                                                                                            2
                                                                                                                                        )
                                                                                                                                    )
                                                                                                                            }

                                                                                                                            total_after_promo_payment =
                                                                                                                                total_after_user_tax_fees -
                                                                                                                                promo_payment

                                                                                                                            if (
                                                                                                                                total_after_promo_payment <
                                                                                                                                0
                                                                                                                            ) {
                                                                                                                                total_after_promo_payment = 0
                                                                                                                                promo_payment =
                                                                                                                                    total_after_user_tax_fees
                                                                                                                            }

                                                                                                                            User_promo_use.findOne(
                                                                                                                                {
                                                                                                                                    trip_id:
                                                                                                                                        trip._id,
                                                                                                                                },
                                                                                                                                function (
                                                                                                                                    err,
                                                                                                                                    userpromouse
                                                                                                                                ) {
                                                                                                                                    userpromouse.user_used_amount =
                                                                                                                                        promo_payment
                                                                                                                                    userpromouse.user_used_amount_in_admin_currency =
                                                                                                                                        promo_payment *
                                                                                                                                        current_rate
                                                                                                                                    userpromouse.save()
                                                                                                                                }
                                                                                                                            )
                                                                                                                        } else {
                                                                                                                            promo_payment = 0
                                                                                                                            total_after_promo_payment =
                                                                                                                                total_after_user_tax_fees
                                                                                                                        }

                                                                                                                        total_after_promo_payment =
                                                                                                                            Number(
                                                                                                                                total_after_promo_payment.toFixed(
                                                                                                                                    2
                                                                                                                                )
                                                                                                                            )
                                                                                                                        trip.promo_payment =
                                                                                                                            promo_payment
                                                                                                                        trip.total_after_promo_payment =
                                                                                                                            total_after_promo_payment

                                                                                                                        trip.total_after_referral_payment =
                                                                                                                            total_after_promo_payment
                                                                                                                        ////////ENTRY IN PROVIDER EARNING TABLE ///////////
                                                                                                                        var service_total_in_admin_currency =
                                                                                                                            Number(
                                                                                                                                (
                                                                                                                                    total_after_user_tax_fees *
                                                                                                                                    current_rate
                                                                                                                                ).toFixed(
                                                                                                                                    3
                                                                                                                                )
                                                                                                                            )

                                                                                                                        var provider_profit_fees =
                                                                                                                            Number(
                                                                                                                                (
                                                                                                                                    total_after_tax_fees_without_insurance *
                                                                                                                                    provider_profit *
                                                                                                                                    0.01
                                                                                                                                ).toFixed(
                                                                                                                                    2
                                                                                                                                )
                                                                                                                            )

                                                                                                                        provider_tax_fee =
                                                                                                                            Number(
                                                                                                                                (
                                                                                                                                    provider_tax *
                                                                                                                                    0.01 *
                                                                                                                                    provider_profit_fees
                                                                                                                                ).toFixed(
                                                                                                                                    2
                                                                                                                                )
                                                                                                                            )
                                                                                                                        trip.provider_miscellaneous_fee =
                                                                                                                            provider_miscellaneous_fee
                                                                                                                        trip.provider_tax_fee =
                                                                                                                            provider_tax_fee
                                                                                                                        provider_service_fees =
                                                                                                                            trip.provider_service_fees

                                                                                                                        var provider_service_fees_in_admin_currency =
                                                                                                                            Number(
                                                                                                                                (
                                                                                                                                    provider_service_fees *
                                                                                                                                    current_rate
                                                                                                                                ).toFixed(
                                                                                                                                    3
                                                                                                                                )
                                                                                                                            )

                                                                                                                        var promo_referral_amount =
                                                                                                                            promo_payment
                                                                                                                        total =
                                                                                                                            total_after_promo_payment

                                                                                                                        total =
                                                                                                                            +total +
                                                                                                                            +toll_amount
                                                                                                                        total =
                                                                                                                            Number(
                                                                                                                                total.toFixed(
                                                                                                                                    2
                                                                                                                                )
                                                                                                                            )
                                                                                                                        var total_in_admin_currency =
                                                                                                                            Number(
                                                                                                                                (
                                                                                                                                    total *
                                                                                                                                    current_rate
                                                                                                                                ).toFixed(
                                                                                                                                    3
                                                                                                                                )
                                                                                                                            )
                                                                                                                        trip.total_after_user_tax_fees =
                                                                                                                            total_after_user_tax_fees
                                                                                                                        trip.base_distance_cost =
                                                                                                                            base_price
                                                                                                                        trip.admin_currency =
                                                                                                                            adminCurrency
                                                                                                                        trip.admin_currencycode =
                                                                                                                            adminCurrencyCode
                                                                                                                        trip.provider_service_fees =
                                                                                                                            provider_service_fees
                                                                                                                        trip.provider_profit_fees =
                                                                                                                            provider_profit_fees
                                                                                                                        trip.total_in_admin_currency =
                                                                                                                            total_in_admin_currency
                                                                                                                        trip.service_total_in_admin_currency =
                                                                                                                            service_total_in_admin_currency
                                                                                                                        trip.provider_service_fees_in_admin_currency =
                                                                                                                            provider_service_fees_in_admin_currency
                                                                                                                        trip.promo_referral_amount =
                                                                                                                            promo_referral_amount
                                                                                                                        trip.toll_amount =
                                                                                                                            toll_amount
                                                                                                                        trip.total =
                                                                                                                            total

                                                                                                                        var wallet_currency_code =
                                                                                                                            user.wallet_currency_code
                                                                                                                        if (
                                                                                                                            wallet_currency_code ==
                                                                                                                                '' ||
                                                                                                                            !wallet_currency_code
                                                                                                                        ) {
                                                                                                                            wallet_currency_code =
                                                                                                                                setting_detail.adminCurrencyCode
                                                                                                                        }
                                                                                                                        utils.getCurrencyConvertRate(
                                                                                                                            1,
                                                                                                                            wallet_currency_code,
                                                                                                                            countryCurrencyCode,
                                                                                                                            function (
                                                                                                                                response
                                                                                                                            ) {
                                                                                                                                var wallet_current_rate = 1
                                                                                                                                if (
                                                                                                                                    response.success
                                                                                                                                ) {
                                                                                                                                    wallet_current_rate =
                                                                                                                                        response.current_rate
                                                                                                                                }

                                                                                                                                trip.wallet_current_rate =
                                                                                                                                    wallet_current_rate
                                                                                                                                let split_payment_users =
                                                                                                                                    trip.split_payment_users.filter(
                                                                                                                                        (
                                                                                                                                            split_payment_user_detail
                                                                                                                                        ) => {
                                                                                                                                            if (
                                                                                                                                                split_payment_user_detail.status ==
                                                                                                                                                SPLIT_PAYMENT.ACCEPTED
                                                                                                                                            ) {
                                                                                                                                                return split_payment_user_detail
                                                                                                                                            }
                                                                                                                                        }
                                                                                                                                    )
                                                                                                                                trip.split_payment_users =
                                                                                                                                    split_payment_users
                                                                                                                                trip.split_payment_users.forEach(
                                                                                                                                    (
                                                                                                                                        split_payment_user_detail
                                                                                                                                    ) => {
                                                                                                                                        split_payment_user_detail.total =
                                                                                                                                            total /
                                                                                                                                            (trip
                                                                                                                                                .split_payment_users
                                                                                                                                                .length +
                                                                                                                                                1)
                                                                                                                                        if (
                                                                                                                                            split_payment_user_detail.payment_mode ==
                                                                                                                                            constant_json.PAYMENT_MODE_CASH
                                                                                                                                        ) {
                                                                                                                                            split_payment_user_detail.cash_payment =
                                                                                                                                                split_payment_user_detail.total
                                                                                                                                            split_payment_user_detail.payment_status =
                                                                                                                                                PAYMENT_STATUS.COMPLETED
                                                                                                                                        } else {
                                                                                                                                            split_payment_user_detail.remaining_payment =
                                                                                                                                                split_payment_user_detail.total
                                                                                                                                        }
                                                                                                                                    }
                                                                                                                                )
                                                                                                                                trip.markModified(
                                                                                                                                    'split_payment_users'
                                                                                                                                )
                                                                                                                                trip.save().then(
                                                                                                                                    async () => {
                                                                                                                                        if (
                                                                                                                                            trip.is_tip ==
                                                                                                                                            true
                                                                                                                                        ) {
                                                                                                                                            // utils.sendPushNotification(constant_json.USER_UNIQUE_NUMBER, device_type, device_token, push_messages.PUSH_CODE_FOR_WAITING_FOR_TIP, constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS);
                                                                                                                                        }
                                                                                                                                        myAnalytics.insert_daily_provider_analytics(
                                                                                                                                            city_timezone,
                                                                                                                                            provider._id,
                                                                                                                                            TRIP_STATUS.TRIP_COMPLETED,
                                                                                                                                            null
                                                                                                                                        )
                                                                                                                                        utils.update_request_status_socket(
                                                                                                                                            trip._id
                                                                                                                                        )
                                                                                                                                        utils.remove_dates_driver_vehicle(
                                                                                                                                            trip._id,
                                                                                                                                            trip.model_type
                                                                                                                                        )
                                                                                                                                        res.json(
                                                                                                                                            {
                                                                                                                                                success: true,
                                                                                                                                                message:
                                                                                                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                                                                trip: trip,
                                                                                                                                                tripservice:
                                                                                                                                                    tripservice,
                                                                                                                                            }
                                                                                                                                        )
                                                                                                                                    },
                                                                                                                                    (
                                                                                                                                        err
                                                                                                                                    ) => {
                                                                                                                                        console.log(
                                                                                                                                            err
                                                                                                                                        )
                                                                                                                                        res.json(
                                                                                                                                            {
                                                                                                                                                success: false,
                                                                                                                                                error_code:
                                                                                                                                                    error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                                                                                                            }
                                                                                                                                        )
                                                                                                                                    }
                                                                                                                                )
                                                                                                                            }
                                                                                                                        )
                                                                                                                    }
                                                                                                                )
                                                                                                            }
                                                                                                        )
                                                                                                    }
                                                                                                )
                                                                                            }
                                                                                        )
                                                                                    }
                                                                                )
                                                                            }
                                                                        )
                                                                    }
                                                                )
                                                            })
                                                    })
                                                })
                                            } else {
                                                utils.update_request_status_socket(
                                                    trip._id
                                                )
                                                res.json({
                                                    success: true,
                                                    message:
                                                        success_messages.ERROR_CODE_TRIP_IS_ALREADY_CANCELLED,
                                                })
                                            }
                                        } else {
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_NO_TRIP_FOUND,
                                            })
                                        }
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.pay_payment = function (req, res, next) {
    var trip_id = ''
    if (res == null) {
        trip_id = next
    } else {
        trip_id = req.body.trip_id
    }

    Trip.findOne({ _id: trip_id, is_trip_end: 0 }).then(
        (trip) => {
            if (trip) {
                City.findOne({ _id: trip.city_id }).then((city) => {
                    var is_provider_earning_set_in_wallet_on_other_payment = false
                    var is_provider_earning_set_in_wallet_on_cash_payment = false
                    if (city) {
                        is_provider_earning_set_in_wallet_on_other_payment =
                            city.is_provider_earning_set_in_wallet_on_other_payment
                        is_provider_earning_set_in_wallet_on_cash_payment =
                            city.is_provider_earning_set_in_wallet_on_cash_payment
                    }

                    var tip_amount
                    var payment_id

                    if (res == null) {
                        tip_amount = 0
                        payment_id = trip.payment_id
                    } else {
                        tip_amount = Number(req.body.tip_amount)
                        tip_amount = tip_amount.toFixed(2)
                        payment_id = req.body.payment_id
                    }

                    var payment_mode = trip.payment_mode
                    var is_user_need_save = false // to avoid can't save() the same doc multiple times in parallel.

                    Provider.findOne({ _id: trip.confirmed_provider }).then(
                        (provider) => {
                            var provider_device_token = provider.device_token
                            var provider_device_type = provider.device_type

                            User.findOne({ _id: trip.user_id }).then((user) => {
                                var device_token = user.device_token
                                var device_type = user.device_type

                                Corporate.findOne({
                                    _id: trip.user_type_id,
                                }).then((corporate) => {
                                    var countryCurrencyCode = trip.currencycode

                                    trip.is_trip_end = 1
                                    if (
                                        trip.user_type ==
                                            Number(
                                                constant_json.USER_TYPE_DISPATCHER
                                            ) ||
                                        trip.user_type ==
                                            Number(
                                                constant_json.USER_TYPE_HOTEL
                                            ) ||
                                        trip.user_type ==
                                            Number(
                                                constant_json.USER_TYPE_PROVIDER
                                            )
                                    ) {
                                        trip.is_user_invoice_show = 1
                                        // user.current_trip_id = null;
                                        is_user_need_save = true
                                    }

                                    var total = +trip.total + +tip_amount
                                    total = Number(total.toFixed(2))
                                    trip.total = total

                                    var wallet_amount = Number(
                                        Math.max(user.wallet, 0).toFixed(2) *
                                            trip.wallet_current_rate
                                    )
                                    var is_use_wallet = user.is_use_wallet
                                    if (
                                        trip.trip_type ==
                                            constant_json.TRIP_TYPE_CORPORATE &&
                                        corporate
                                    ) {
                                        wallet_amount = Number(
                                            Math.max(
                                                corporate.wallet,
                                                0
                                            ).toFixed(2) *
                                                trip.wallet_current_rate
                                        )
                                        is_use_wallet = 1
                                    }
                                    var wallet_payment = 0
                                    var remaining_payment = 0
                                    if (trip.split_payment_users.length > 0) {
                                        total =
                                            trip.total /
                                                (trip.split_payment_users
                                                    .length +
                                                    1) +
                                            +tip_amount
                                    }
                                    var total_after_wallet_payment = total

                                    if (
                                        wallet_amount > 0 &&
                                        total_after_wallet_payment > 0 &&
                                        is_use_wallet == constant_json.YES
                                    ) {
                                        if (
                                            wallet_amount >
                                            total_after_wallet_payment
                                        ) {
                                            wallet_payment =
                                                total_after_wallet_payment
                                        } else {
                                            wallet_payment = wallet_amount
                                        }
                                        if (
                                            trip.trip_type ==
                                                constant_json.TRIP_TYPE_CORPORATE &&
                                            corporate
                                        ) {
                                            var total_wallet_amount =
                                                utils.addWalletHistory(
                                                    constant_json.USER_UNIQUE_NUMBER,
                                                    corporate.unique_id,
                                                    corporate._id,
                                                    null,
                                                    corporate.wallet_currency_code,
                                                    trip.currencycode,
                                                    trip.wallet_current_rate,
                                                    wallet_payment,
                                                    corporate.wallet,
                                                    constant_json.DEDUCT_WALLET_AMOUNT,
                                                    constant_json.PAID_TRIP_AMOUNT,
                                                    'Charge Of This Trip : ' +
                                                        trip.unique_id
                                                )
                                            corporate.wallet =
                                                total_wallet_amount
                                            corporate.save()
                                            user.corporate_wallet_limit =
                                                user.corporate_wallet_limit -
                                                wallet_payment
                                            is_user_need_save = true
                                        } else {
                                            var total_wallet_amount =
                                                utils.addWalletHistory(
                                                    constant_json.USER_UNIQUE_NUMBER,
                                                    user.unique_id,
                                                    user._id,
                                                    null,
                                                    user.wallet_currency_code,
                                                    trip.currencycode,
                                                    trip.wallet_current_rate,
                                                    wallet_payment,
                                                    user.wallet,
                                                    constant_json.DEDUCT_WALLET_AMOUNT,
                                                    constant_json.PAID_TRIP_AMOUNT,
                                                    'Charge Of This Trip : ' +
                                                        trip.unique_id
                                                )
                                            user.wallet = total_wallet_amount
                                            is_user_need_save = true
                                        }

                                        total_after_wallet_payment =
                                            total_after_wallet_payment -
                                            wallet_payment
                                    } else {
                                        wallet_payment = 0
                                    }

                                    if (is_user_need_save) {
                                        user.save()
                                    }

                                    total_after_wallet_payment = Number(
                                        total_after_wallet_payment.toFixed(2)
                                    )
                                    wallet_payment = Number(
                                        wallet_payment.toFixed(2)
                                    )
                                    remaining_payment = total - wallet_payment
                                    remaining_payment = Number(
                                        remaining_payment.toFixed(2)
                                    )
                                    trip.wallet_payment = wallet_payment
                                    trip.total_after_wallet_payment =
                                        total_after_wallet_payment
                                    trip.remaining_payment = remaining_payment
                                    trip.payment_status =
                                        PAYMENT_STATUS.COMPLETED

                                    trip.provider_service_fees =
                                        +trip.provider_service_fees +
                                        +tip_amount
                                    trip.total_in_admin_currency =
                                        trip.total * trip.current_rate
                                    trip.provider_service_fees_in_admin_currency =
                                        trip.provider_service_fees *
                                        trip.current_rate
                                    trip.tip_amount = tip_amount
                                    trip.provider_have_cash = remaining_payment

                                    trip.split_payment_users.forEach(
                                        (split_user) => {
                                            let split_user_remaining_payment =
                                                split_user.remaining_payment
                                            if (
                                                split_user.payment_mode ==
                                                Number(
                                                    constant_json.PAYMENT_MODE_CASH
                                                )
                                            ) {
                                                trip.provider_have_cash =
                                                    trip.provider_have_cash +
                                                    split_user.cash_payment
                                                trip.cash_payment =
                                                    trip.cash_payment +
                                                    split_user.cash_payment
                                            }
                                            if (
                                                split_user.payment_mode == null
                                            ) {
                                                trip.wallet_payment =
                                                    trip.wallet_payment +
                                                    split_user.remaining_payment
                                                split_user.wallet_payment =
                                                    split_user.remaining_payment
                                                split_user.remaining_payment = 0
                                                split_user.payment_status =
                                                    PAYMENT_STATUS.COMPLETED
                                            }
                                            User.findOne({
                                                _id: split_user.user_id,
                                            }).then((split_user_detail) => {
                                                let push_data = {
                                                    trip_id: trip._id,
                                                    first_name: user.first_name,
                                                    last_name: user.last_name,
                                                    is_trip_end:
                                                        trip.is_trip_end,
                                                    currency: trip.currency,
                                                    phone: user.phone,
                                                    country_phone_code:
                                                        user.country_phone_code,
                                                    user_id: trip.user_id,
                                                    status: split_user.status,
                                                    payment_mode:
                                                        split_user.payment_mode,
                                                    payment_status:
                                                        split_user.payment_status,
                                                    payment_intent_id:
                                                        split_user.payment_intent_id,
                                                    total: split_user.total,
                                                }

                                                utils.sendPushNotification(
                                                    constant_json.USER_UNIQUE_NUMBER,
                                                    split_user_detail.device_type,
                                                    split_user_detail.device_token,
                                                    push_messages.PUSH_CODE_FOR_YOUR_TRIP_END_SPLIT_PAYMENT,
                                                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                    push_data
                                                )
                                                if (
                                                    split_user.payment_mode ==
                                                    null
                                                ) {
                                                    // trip.wallet_payment = trip.wallet_payment + split_user.remaining_payment;
                                                    // let split_user_remaining_payment = split_user_remaining_payment;
                                                    // split_user.wallet_payment = split_user.remaining_payment;
                                                    // split_user.remaining_payment = 0;
                                                    // split_user.payment_status = PAYMENT_STATUS.COMPLETED;

                                                    var total_aplit_wallet_amount =
                                                        utils.addWalletHistory(
                                                            constant_json.USER_UNIQUE_NUMBER,
                                                            split_user_detail.unique_id,
                                                            split_user_detail._id,
                                                            null,
                                                            split_user_detail.wallet_currency_code,
                                                            trip.currencycode,
                                                            trip.wallet_current_rate,
                                                            split_user_remaining_payment,
                                                            split_user_detail.wallet,
                                                            constant_json.DEDUCT_WALLET_AMOUNT,
                                                            constant_json.PAID_TRIP_AMOUNT,
                                                            'Charge Of This Trip : ' +
                                                                trip.unique_id
                                                        )

                                                    split_user_detail.wallet =
                                                        total_aplit_wallet_amount
                                                    split_user_detail.save()
                                                }
                                            })
                                        }
                                    )
                                    trip.markModified('split_payment_users')

                                    // trip.cash_payment = trip.provider_have_cash;
                                    trip.pay_to_provider =
                                        trip.provider_service_fees -
                                        trip.provider_have_cash

                                    var complete_date_in_city_timezone =
                                        utils.get_date_now_at_city(
                                            new Date(),
                                            trip.timezone
                                        )
                                    var complete_date_tag = moment(
                                        moment(
                                            complete_date_in_city_timezone
                                        ).startOf('day')
                                    ).format(
                                        constant_json.DATE_FORMAT_MMM_D_YYYY
                                    )
                                    trip.complete_date_in_city_timezone =
                                        complete_date_in_city_timezone
                                    trip.complete_date_tag = complete_date_tag

                                    var total_wallet_amount = 0
                                    if (
                                        payment_mode ==
                                            Number(
                                                constant_json.PAYMENT_MODE_CASH
                                            ) &&
                                        is_provider_earning_set_in_wallet_on_cash_payment
                                    ) {
                                        if (
                                            provider.provider_type ==
                                            Number(
                                                constant_json.PROVIDER_TYPE_NORMAL
                                            )
                                        ) {
                                            if (trip.pay_to_provider < 0) {
                                                total_wallet_amount =
                                                    utils.addWalletHistory(
                                                        constant_json.PROVIDER_UNIQUE_NUMBER,
                                                        provider.unique_id,
                                                        provider._id,
                                                        provider.country_id,
                                                        provider.wallet_currency_code,
                                                        trip.currencycode,
                                                        1,
                                                        Math.abs(
                                                            trip.pay_to_provider
                                                        ),
                                                        provider.wallet,
                                                        constant_json.DEDUCT_WALLET_AMOUNT,
                                                        constant_json.SET_TRIP_PROFIT,
                                                        'Set Profit Of This Trip : ' +
                                                            trip.unique_id
                                                    )
                                            } else {
                                                total_wallet_amount =
                                                    utils.addWalletHistory(
                                                        constant_json.PROVIDER_UNIQUE_NUMBER,
                                                        provider.unique_id,
                                                        provider._id,
                                                        provider.country_id,
                                                        provider.wallet_currency_code,
                                                        trip.currencycode,
                                                        1,
                                                        trip.pay_to_provider,
                                                        provider.wallet,
                                                        constant_json.ADD_WALLET_AMOUNT,
                                                        constant_json.SET_TRIP_PROFIT,
                                                        'Set Profit Of This Trip : ' +
                                                            trip.unique_id
                                                    )
                                            }
                                            provider.wallet =
                                                total_wallet_amount
                                            provider.save()
                                        } else {
                                            Partner.findOne({
                                                _id: trip.provider_type_id,
                                            }).then((partner) => {
                                                if (trip.pay_to_provider < 0) {
                                                    total_wallet_amount =
                                                        utils.addWalletHistory(
                                                            constant_json.PARTNER_UNIQUE_NUMBER,
                                                            partner.unique_id,
                                                            partner._id,
                                                            partner.country_id,
                                                            partner.wallet_currency_code,
                                                            trip.currencycode,
                                                            1,
                                                            Math.abs(
                                                                trip.pay_to_provider
                                                            ),
                                                            partner.wallet,
                                                            constant_json.DEDUCT_WALLET_AMOUNT,
                                                            constant_json.SET_TRIP_PROFIT,
                                                            'Set Profit Of This Trip : ' +
                                                                trip.unique_id
                                                        )
                                                } else {
                                                    total_wallet_amount =
                                                        utils.addWalletHistory(
                                                            constant_json.PARTNER_UNIQUE_NUMBER,
                                                            partner.unique_id,
                                                            partner._id,
                                                            partner.country_id,
                                                            partner.wallet_currency_code,
                                                            trip.currencycode,
                                                            1,
                                                            trip.pay_to_provider,
                                                            partner.wallet,
                                                            constant_json.ADD_WALLET_AMOUNT,
                                                            constant_json.SET_TRIP_PROFIT,
                                                            'Set Profit Of This Trip : ' +
                                                                trip.unique_id
                                                        )
                                                }
                                                partner.wallet =
                                                    total_wallet_amount
                                                partner.save()
                                            })
                                        }

                                        trip.is_provider_earning_set_in_wallet = true
                                        trip.provider_income_set_in_wallet =
                                            Math.abs(trip.pay_to_provider)
                                    }

                                    // End 6 March //

                                    if (
                                        payment_mode ==
                                        constant_json.PAYMENT_MODE_CASH
                                    ) {
                                        trip.is_paid = 1
                                        trip.is_pending_payments = 0
                                        trip.cash_payment =
                                            trip.cash_payment +
                                            remaining_payment
                                        trip.remaining_payment = 0

                                        trip.save().then(() => {
                                            utils.update_request_status_socket(
                                                trip._id
                                            )
                                            var email_notification =
                                                setting_detail.email_notification
                                            if (email_notification == true) {
                                            }
                                            const extra_param = {
                                                trip_id: trip._id,
                                            }

                                            if (trip.is_tip == true) {
                                                if (res == null) {
                                                    utils.sendPushNotification(
                                                        constant_json.PROVIDER_UNIQUE_NUMBER,
                                                        provider_device_type,
                                                        provider_device_token,
                                                        push_messages.PUSH_CODE_FOR_PROVIDER_TRIP_END,
                                                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                    )
                                                    utils.sendPushNotification(
                                                        constant_json.USER_UNIQUE_NUMBER,
                                                        device_type,
                                                        device_token,
                                                        push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                        extra_param
                                                    )
                                                } else {
                                                    utils.sendPushNotification(
                                                        constant_json.PROVIDER_UNIQUE_NUMBER,
                                                        provider_device_type,
                                                        provider_device_token,
                                                        push_messages.PUSH_CODE_FOR_PROVIDER_TRIP_END,
                                                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                    )
                                                    utils.sendPushNotification(
                                                        constant_json.USER_UNIQUE_NUMBER,
                                                        device_type,
                                                        device_token,
                                                        push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                        constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                        extra_param
                                                    )

                                                    if (
                                                        trip.payment_status ==
                                                        PAYMENT_STATUS.COMPLETED
                                                    ) {
                                                        Trip.findOneAndRemove({
                                                            _id: trip._id,
                                                        }).then(
                                                            (deleted_trip) => {
                                                                if (
                                                                    deleted_trip
                                                                ) {
                                                                    var trip_history_data =
                                                                        new Trip_history(
                                                                            JSON.parse(
                                                                                JSON.stringify(
                                                                                    deleted_trip
                                                                                )
                                                                            )
                                                                        )
                                                                    trip_history_data.split_payment_users =
                                                                        deleted_trip.split_payment_users
                                                                    trip_history_data.save(
                                                                        function () {
                                                                            res.json(
                                                                                {
                                                                                    success: true,
                                                                                    message:
                                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                    payment_status:
                                                                                        trip.payment_status,
                                                                                }
                                                                            )
                                                                        }
                                                                    )
                                                                } else {
                                                                    res.json({
                                                                        success: true,
                                                                        message:
                                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                        payment_status:
                                                                            trip.payment_status,
                                                                    })
                                                                }
                                                            }
                                                        )
                                                    } else {
                                                        res.json({
                                                            success: true,
                                                            message:
                                                                success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                            payment_status:
                                                                trip.payment_status,
                                                        })
                                                    }
                                                }
                                            } else {
                                                if (res != null) {
                                                    if (
                                                        req.body.provider_id !=
                                                        undefined
                                                    ) {
                                                        if (
                                                            trip.payment_status ==
                                                            PAYMENT_STATUS.COMPLETED
                                                        ) {
                                                            Trip.findOneAndRemove(
                                                                {
                                                                    _id: trip._id,
                                                                }
                                                            ).then(
                                                                (
                                                                    deleted_trip
                                                                ) => {
                                                                    if (
                                                                        deleted_trip
                                                                    ) {
                                                                        console.log(
                                                                            deleted_trip.split_payment_users
                                                                        )
                                                                        var trip_history_data =
                                                                            new Trip_history(
                                                                                JSON.parse(
                                                                                    JSON.stringify(
                                                                                        deleted_trip
                                                                                    )
                                                                                )
                                                                            )
                                                                        trip_history_data.split_payment_users =
                                                                            deleted_trip.split_payment_users
                                                                        trip_history_data.save(
                                                                            function () {
                                                                                res.json(
                                                                                    {
                                                                                        success: true,
                                                                                        message:
                                                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                        payment_status:
                                                                                            trip.payment_status,
                                                                                    }
                                                                                )
                                                                            }
                                                                        )
                                                                    } else {
                                                                        res.json(
                                                                            {
                                                                                success: true,
                                                                                message:
                                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                payment_status:
                                                                                    trip.payment_status,
                                                                            }
                                                                        )
                                                                    }
                                                                }
                                                            )
                                                        } else {
                                                            res.json({
                                                                success: true,
                                                                message:
                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                payment_status:
                                                                    trip.payment_status,
                                                            })
                                                        }
                                                        const extra_param = {
                                                            trip_id: trip._id,
                                                        }

                                                        utils.sendPushNotification(
                                                            constant_json.USER_UNIQUE_NUMBER,
                                                            device_type,
                                                            device_token,
                                                            push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                            constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                            extra_param
                                                        )
                                                    } else {
                                                        res.json({
                                                            success: false,
                                                            error_code:
                                                                error_message.ERROR_CODE_PAY_PAYMENT_FAILED,
                                                        })
                                                    }
                                                }
                                            }
                                        })
                                    } else if (
                                        payment_mode ==
                                        constant_json.PAYMENT_MODE_APPLE_PAY
                                    ) {
                                        if (remaining_payment > 0) {
                                            trip.is_paid = 0
                                            trip.payment_status =
                                                PAYMENT_STATUS.FAILED
                                            var email_notification =
                                                setting_detail.email_notification
                                            if (email_notification == true) {
                                            }
                                            // trip.split_payment_users.forEach((split_payment_user_detail)=>{
                                            //     remaining_payment = remaining_payment + split_payment_user_detail.remaining_payment;
                                            // });
                                            // trip.remaining_payment = remaining_payment;
                                            trip.save().then(() => {
                                                utils.update_request_status_socket(
                                                    trip._id
                                                )
                                                trip.payment_status =
                                                    PAYMENT_STATUS.FAILED
                                                res.json({
                                                    success: true,
                                                    message:
                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                    payment_status:
                                                        trip.payment_status,
                                                })
                                                const extra_param = {
                                                    trip_id: trip._id,
                                                }

                                                utils.sendPushNotification(
                                                    constant_json.USER_UNIQUE_NUMBER,
                                                    device_type,
                                                    device_token,
                                                    push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                    extra_param
                                                )
                                            })
                                        } else {
                                            trip.is_paid = 1
                                            trip.is_pending_payments = 0
                                            trip.payment_status =
                                                PAYMENT_STATUS.COMPLETED
                                            trip.card_payment = 0
                                            // trip.split_payment_users.forEach((split_payment_user_detail)=>{
                                            //     remaining_payment = remaining_payment + split_payment_user_detail.remaining_payment;
                                            // });
                                            // trip.remaining_payment = remaining_payment;
                                            trip.save().then(
                                                () => {
                                                    utils.update_request_status_socket(
                                                        trip._id
                                                    )
                                                    var email_notification =
                                                        setting_detail.email_notification
                                                    if (
                                                        email_notification ==
                                                        true
                                                    ) {
                                                    }
                                                    const extra_param = {
                                                        trip_id: trip._id,
                                                    }

                                                    if (trip.is_tip == true) {
                                                        if (
                                                            req.body.user_id ==
                                                                undefined &&
                                                            req.body.token ==
                                                                undefined
                                                        ) {
                                                            utils.sendPushNotification(
                                                                constant_json.PROVIDER_UNIQUE_NUMBER,
                                                                provider_device_type,
                                                                provider_device_token,
                                                                push_messages.PUSH_CODE_FOR_PROVIDER_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                            )
                                                            utils.sendPushNotification(
                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                device_type,
                                                                device_token,
                                                                push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                extra_param
                                                            )
                                                        } else {
                                                            utils.sendPushNotification(
                                                                constant_json.PROVIDER_UNIQUE_NUMBER,
                                                                provider_device_type,
                                                                provider_device_token,
                                                                push_messages.PUSH_CODE_FOR_PROVIDER_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                            )
                                                            res.json({
                                                                success: true,
                                                                message:
                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                payment_status:
                                                                    trip.payment_status,
                                                            })
                                                        }
                                                    } else {
                                                        if (
                                                            req.body
                                                                .provider_id !=
                                                            undefined
                                                        ) {
                                                            const extra_param =
                                                                {
                                                                    trip_id:
                                                                        trip._id,
                                                                }
                                                            res.json({
                                                                success: true,
                                                                message:
                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                payment_status:
                                                                    trip.payment_status,
                                                            })

                                                            utils.sendPushNotification(
                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                device_type,
                                                                device_token,
                                                                push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                extra_param
                                                            )
                                                        } else {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_PAY_PAYMENT_FAILED,
                                                            })
                                                        }
                                                    }
                                                },
                                                (err) => {
                                                    console.log(err)
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                    })
                                                }
                                            )
                                        }
                                    } else {
                                        if (remaining_payment > 0) {
                                            var user_id = trip.user_id
                                            var email = user.email
                                            var customer_id = user.customer_id
                                            if (
                                                trip.trip_type ==
                                                    constant_json.TRIP_TYPE_CORPORATE &&
                                                corporate
                                            ) {
                                                user_id = trip.user_type_id
                                                customer_id =
                                                    corporate.customer_id
                                                email = corporate.email
                                            }
                                            trip.is_paid = 0
                                            trip.remaining_payment =
                                                remaining_payment
                                            trip.payment_status =
                                                PAYMENT_STATUS.WAITING
                                            var email_notification =
                                                setting_detail.email_notification
                                            if (email_notification == true) {
                                            }

                                            Card.findOne(
                                                {
                                                    user_id: user_id,
                                                    payment_gateway_type:
                                                        trip.payment_gateway_type,
                                                    is_default: true,
                                                },
                                                function (error, card_detail) {
                                                    if (card_detail) {
                                                        if (
                                                            countryCurrencyCode ==
                                                                '' ||
                                                            !countryCurrencyCode
                                                        ) {
                                                            countryCurrencyCode =
                                                                setting_detail.adminCurrencyCode
                                                        }
                                                        if (
                                                            trip.payment_gateway_type ==
                                                            PAYMENT_GATEWAY.stripe
                                                        ) {
                                                            var stripe_secret_key =
                                                                setting_detail.stripe_secret_key

                                                            var stripe =
                                                                require('stripe')(
                                                                    stripe_secret_key
                                                                )
                                                            stripe.paymentIntents.create(
                                                                {
                                                                    amount: Math.round(
                                                                        remaining_payment *
                                                                            100
                                                                    ),
                                                                    currency:
                                                                        countryCurrencyCode,
                                                                    customer:
                                                                        customer_id,
                                                                    payment_method:
                                                                        card_detail.payment_method,
                                                                },
                                                                function (
                                                                    error,
                                                                    paymentIntent
                                                                ) {
                                                                    if (
                                                                        paymentIntent
                                                                    ) {
                                                                        trip.payment_intent_id =
                                                                            paymentIntent.id
                                                                        trip.save().then(
                                                                            () => {
                                                                                utils.update_request_status_socket(
                                                                                    trip._id
                                                                                )
                                                                                const extra_param =
                                                                                    {
                                                                                        trip_id:
                                                                                            trip._id,
                                                                                    }

                                                                                res.json(
                                                                                    {
                                                                                        success: true,
                                                                                        message:
                                                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                        payment_status:
                                                                                            trip.payment_status,
                                                                                        payment_method:
                                                                                            card_detail.payment_method,
                                                                                        client_secret:
                                                                                            paymentIntent.client_secret,
                                                                                    }
                                                                                )
                                                                                utils.sendPushNotification(
                                                                                    constant_json.USER_UNIQUE_NUMBER,
                                                                                    device_type,
                                                                                    device_token,
                                                                                    push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                                    extra_param
                                                                                )
                                                                            }
                                                                        )
                                                                    } else {
                                                                        utils.trip_payment_failed(
                                                                            trip,
                                                                            city,
                                                                            provider
                                                                        )
                                                                        trip.payment_status =
                                                                            PAYMENT_STATUS.FAILED
                                                                        trip.save().then(
                                                                            () => {
                                                                                const extra_param =
                                                                                    {
                                                                                        trip_id:
                                                                                            trip._id,
                                                                                    }

                                                                                utils.update_request_status_socket(
                                                                                    trip._id
                                                                                )
                                                                                res.json(
                                                                                    {
                                                                                        success: true,
                                                                                        error: error
                                                                                            .raw
                                                                                            .message,
                                                                                        message:
                                                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                        payment_status:
                                                                                            trip.payment_status,
                                                                                    }
                                                                                )
                                                                                utils.sendPushNotification(
                                                                                    constant_json.USER_UNIQUE_NUMBER,
                                                                                    device_type,
                                                                                    device_token,
                                                                                    push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                                    extra_param
                                                                                )
                                                                            }
                                                                        )
                                                                    }
                                                                }
                                                            )
                                                        } else {
                                                            const params =
                                                                JSON.stringify({
                                                                    email: email,
                                                                    amount: Math.round(
                                                                        remaining_payment *
                                                                            100
                                                                    ),
                                                                    // currency : wallet_currency_code,
                                                                    authorization_code:
                                                                        card_detail.payment_method,
                                                                })
                                                            const options = {
                                                                hostname:
                                                                    'api.paystack.co',
                                                                port: 443,
                                                                path: '/charge',
                                                                method: 'POST',
                                                                headers: {
                                                                    Authorization:
                                                                        'Bearer ' +
                                                                        setting_detail.paystack_secret_key,
                                                                    'Content-Type':
                                                                        'application/json',
                                                                },
                                                            }
                                                            const request =
                                                                https
                                                                    .request(
                                                                        options,
                                                                        (
                                                                            res_data
                                                                        ) => {
                                                                            let data =
                                                                                ''
                                                                            res_data.on(
                                                                                'data',
                                                                                (
                                                                                    chunk
                                                                                ) => {
                                                                                    data +=
                                                                                        chunk
                                                                                }
                                                                            )
                                                                            res_data.on(
                                                                                'end',
                                                                                () => {
                                                                                    var payment_response =
                                                                                        JSON.parse(
                                                                                            data
                                                                                        )
                                                                                    if (
                                                                                        payment_response.status
                                                                                    ) {
                                                                                        trip.payment_intent_id =
                                                                                            payment_response.reference
                                                                                        trip.save().then(
                                                                                            async () => {
                                                                                                trip.payment_intent_id =
                                                                                                    payment_response.data.reference
                                                                                                const extra_param =
                                                                                                    {
                                                                                                        trip_id:
                                                                                                            trip._id,
                                                                                                    }

                                                                                                if (
                                                                                                    payment_response
                                                                                                        .data
                                                                                                        .status ==
                                                                                                    'success'
                                                                                                ) {
                                                                                                    trip.is_paid = 1
                                                                                                    trip.is_pending_payments = 0
                                                                                                    trip.card_payment = 0
                                                                                                    trip.payment_status =
                                                                                                        PAYMENT_STATUS.COMPLETED
                                                                                                    trip.remaining_payment = 0
                                                                                                    trip.card_payment =
                                                                                                        payment_response
                                                                                                            .data
                                                                                                            .amount /
                                                                                                        100

                                                                                                    // start provider profit after card payment done
                                                                                                    await utils.trip_provider_profit_card_wallet_settlement(
                                                                                                        trip
                                                                                                    )
                                                                                                    // end of provider profit after card payment done
                                                                                                    const extra_param =
                                                                                                        {
                                                                                                            trip_id:
                                                                                                                trip._id,
                                                                                                        }

                                                                                                    trip.save().then(
                                                                                                        () => {
                                                                                                            utils.update_request_status_socket(
                                                                                                                trip._id
                                                                                                            )
                                                                                                            utils.sendPushNotification(
                                                                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                                                                device_type,
                                                                                                                device_token,
                                                                                                                push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                                                                extra_param
                                                                                                            )
                                                                                                            Trip.findOneAndRemove(
                                                                                                                {
                                                                                                                    _id: trip._id,
                                                                                                                }
                                                                                                            ).then(
                                                                                                                (
                                                                                                                    deleted_trip
                                                                                                                ) => {
                                                                                                                    if (
                                                                                                                        deleted_trip
                                                                                                                    ) {
                                                                                                                        var trip_history_data =
                                                                                                                            new Trip_history(
                                                                                                                                JSON.parse(
                                                                                                                                    JSON.stringify(
                                                                                                                                        deleted_trip
                                                                                                                                    )
                                                                                                                                )
                                                                                                                            )
                                                                                                                        trip_history_data.split_payment_users =
                                                                                                                            deleted_trip.split_payment_users
                                                                                                                        trip_history_data.save(
                                                                                                                            function () {
                                                                                                                                res.json(
                                                                                                                                    {
                                                                                                                                        success: true,
                                                                                                                                        message:
                                                                                                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                                                        payment_status:
                                                                                                                                            trip.payment_status,
                                                                                                                                    }
                                                                                                                                )
                                                                                                                            }
                                                                                                                        )
                                                                                                                    } else {
                                                                                                                        res.json(
                                                                                                                            {
                                                                                                                                success: true,
                                                                                                                                message:
                                                                                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                                                payment_status:
                                                                                                                                    trip.payment_status,
                                                                                                                            }
                                                                                                                        )
                                                                                                                    }
                                                                                                                }
                                                                                                            )
                                                                                                        },
                                                                                                        (
                                                                                                            err
                                                                                                        ) => {
                                                                                                            console.log(
                                                                                                                err
                                                                                                            )
                                                                                                            res.json(
                                                                                                                {
                                                                                                                    success: false,
                                                                                                                    error_code:
                                                                                                                        error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                                                                                }
                                                                                                            )
                                                                                                        }
                                                                                                    )
                                                                                                } else if (
                                                                                                    payment_response
                                                                                                        .data
                                                                                                        .status ==
                                                                                                    'open_url'
                                                                                                ) {
                                                                                                    trip.payment_status =
                                                                                                        PAYMENT_STATUS.FAILED
                                                                                                    utils.update_request_status_socket(
                                                                                                        trip._id
                                                                                                    )

                                                                                                    trip.save().then(
                                                                                                        () => {
                                                                                                            utils.update_request_status_socket(
                                                                                                                trip._id
                                                                                                            )
                                                                                                            var json_response =
                                                                                                                {
                                                                                                                    success: false,
                                                                                                                    url: payment_response
                                                                                                                        .data
                                                                                                                        .url,
                                                                                                                }
                                                                                                            res.json(
                                                                                                                json_response
                                                                                                            )
                                                                                                            utils.sendPushNotification(
                                                                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                                                                device_type,
                                                                                                                device_token,
                                                                                                                push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                                                                extra_param
                                                                                                            )
                                                                                                        }
                                                                                                    )
                                                                                                } else {
                                                                                                    utils.trip_payment_failed(
                                                                                                        trip,
                                                                                                        city,
                                                                                                        provider
                                                                                                    )
                                                                                                    trip.payment_status =
                                                                                                        PAYMENT_STATUS.FAILED
                                                                                                    utils.update_request_status_socket(
                                                                                                        trip._id
                                                                                                    )
                                                                                                    trip.save().then(
                                                                                                        () => {
                                                                                                            utils.update_request_status_socket(
                                                                                                                trip._id
                                                                                                            )
                                                                                                            var json_response =
                                                                                                                {
                                                                                                                    success: false,
                                                                                                                    reference:
                                                                                                                        payment_response
                                                                                                                            .data
                                                                                                                            .reference,
                                                                                                                    required_param:
                                                                                                                        payment_response
                                                                                                                            .data
                                                                                                                            .status,
                                                                                                                }
                                                                                                            console.log(
                                                                                                                json_response
                                                                                                            )
                                                                                                            res.json(
                                                                                                                json_response
                                                                                                            )
                                                                                                            utils.sendPushNotification(
                                                                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                                                                device_type,
                                                                                                                device_token,
                                                                                                                push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                                                                extra_param
                                                                                                            )
                                                                                                        }
                                                                                                    )
                                                                                                }
                                                                                            }
                                                                                        )
                                                                                    } else {
                                                                                        var error_message =
                                                                                            ''
                                                                                        if (
                                                                                            payment_response.data
                                                                                        ) {
                                                                                            error_message =
                                                                                                payment_response
                                                                                                    .data
                                                                                                    .message
                                                                                        } else {
                                                                                            error_message =
                                                                                                payment_response.message
                                                                                        }
                                                                                        trip.payment_status =
                                                                                            PAYMENT_STATUS.FAILED
                                                                                        trip.save().then(
                                                                                            () => {
                                                                                                utils.update_request_status_socket(
                                                                                                    trip._id
                                                                                                )
                                                                                                const extra_param =
                                                                                                    {
                                                                                                        trip_id:
                                                                                                            trip._id,
                                                                                                    }

                                                                                                res.json(
                                                                                                    {
                                                                                                        success: true,
                                                                                                        error: error_message,
                                                                                                        message:
                                                                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                                        payment_status:
                                                                                                            trip.payment_status,
                                                                                                    }
                                                                                                )
                                                                                                utils.sendPushNotification(
                                                                                                    constant_json.USER_UNIQUE_NUMBER,
                                                                                                    device_type,
                                                                                                    device_token,
                                                                                                    push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                                                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                                                    extra_param
                                                                                                )
                                                                                            }
                                                                                        )
                                                                                    }
                                                                                }
                                                                            )
                                                                        }
                                                                    )
                                                                    .on(
                                                                        'error',
                                                                        (
                                                                            error
                                                                        ) => {
                                                                            console.error(
                                                                                error
                                                                            )
                                                                        }
                                                                    )
                                                            request.write(
                                                                params
                                                            )
                                                            request.end()
                                                        }
                                                    } else {
                                                        trip.payment_status =
                                                            PAYMENT_STATUS.FAILED
                                                        const extra_param = {
                                                            trip_id: trip._id,
                                                        }

                                                        trip.save().then(() => {
                                                            utils.update_request_status_socket(
                                                                trip._id
                                                            )
                                                            res.json({
                                                                success: true,
                                                                message:
                                                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                payment_status:
                                                                    trip.payment_status,
                                                            })
                                                            utils.sendPushNotification(
                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                device_type,
                                                                device_token,
                                                                push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                extra_param
                                                            )
                                                        })
                                                    }
                                                }
                                            )
                                        } else {
                                            trip.is_paid = 1
                                            trip.is_pending_payments = 0
                                            trip.card_payment = 0
                                            trip.save().then(
                                                () => {
                                                    utils.update_request_status_socket(
                                                        trip._id
                                                    )
                                                    var email_notification =
                                                        setting_detail.email_notification
                                                    if (
                                                        email_notification ==
                                                        true
                                                    ) {
                                                    }
                                                    const extra_param = {
                                                        trip_id: trip._id,
                                                    }

                                                    if (trip.is_tip == true) {
                                                        if (
                                                            req.body.user_id ==
                                                                undefined &&
                                                            req.body.token ==
                                                                undefined
                                                        ) {
                                                            utils.sendPushNotification(
                                                                constant_json.PROVIDER_UNIQUE_NUMBER,
                                                                provider_device_type,
                                                                provider_device_token,
                                                                push_messages.PUSH_CODE_FOR_PROVIDER_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                            )
                                                            utils.sendPushNotification(
                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                device_type,
                                                                device_token,
                                                                push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                extra_param
                                                            )
                                                        } else {
                                                            utils.sendPushNotification(
                                                                constant_json.PROVIDER_UNIQUE_NUMBER,
                                                                provider_device_type,
                                                                provider_device_token,
                                                                push_messages.PUSH_CODE_FOR_PROVIDER_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                            )
                                                            if (
                                                                trip.payment_status ==
                                                                PAYMENT_STATUS.COMPLETED
                                                            ) {
                                                                Trip.findOneAndRemove(
                                                                    {
                                                                        _id: trip._id,
                                                                    }
                                                                ).then(
                                                                    (
                                                                        deleted_trip
                                                                    ) => {
                                                                        if (
                                                                            deleted_trip
                                                                        ) {
                                                                            var trip_history_data =
                                                                                new Trip_history(
                                                                                    JSON.parse(
                                                                                        JSON.stringify(
                                                                                            deleted_trip
                                                                                        )
                                                                                    )
                                                                                )
                                                                            trip_history_data.split_payment_users =
                                                                                deleted_trip.split_payment_users
                                                                            trip_history_data.save(
                                                                                function () {
                                                                                    res.json(
                                                                                        {
                                                                                            success: true,
                                                                                            message:
                                                                                                success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                            payment_status:
                                                                                                trip.payment_status,
                                                                                        }
                                                                                    )
                                                                                }
                                                                            )
                                                                        } else {
                                                                            res.json(
                                                                                {
                                                                                    success: true,
                                                                                    message:
                                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                    payment_status:
                                                                                        trip.payment_status,
                                                                                }
                                                                            )
                                                                        }
                                                                    }
                                                                )
                                                            } else {
                                                                res.json({
                                                                    success: true,
                                                                    message:
                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                    payment_status:
                                                                        trip.payment_status,
                                                                })
                                                            }
                                                        }
                                                    } else {
                                                        if (
                                                            req.body
                                                                .provider_id !=
                                                            undefined
                                                        ) {
                                                            if (
                                                                trip.payment_status ==
                                                                PAYMENT_STATUS.COMPLETED
                                                            ) {
                                                                Trip.findOneAndRemove(
                                                                    {
                                                                        _id: trip._id,
                                                                    }
                                                                ).then(
                                                                    (
                                                                        deleted_trip
                                                                    ) => {
                                                                        if (
                                                                            deleted_trip
                                                                        ) {
                                                                            var trip_history_data =
                                                                                new Trip_history(
                                                                                    JSON.parse(
                                                                                        JSON.stringify(
                                                                                            deleted_trip
                                                                                        )
                                                                                    )
                                                                                )
                                                                            trip_history_data.split_payment_users =
                                                                                deleted_trip.split_payment_users
                                                                            trip_history_data.save(
                                                                                function () {
                                                                                    res.json(
                                                                                        {
                                                                                            success: true,
                                                                                            message:
                                                                                                success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                            payment_status:
                                                                                                trip.payment_status,
                                                                                        }
                                                                                    )
                                                                                }
                                                                            )
                                                                        } else {
                                                                            res.json(
                                                                                {
                                                                                    success: true,
                                                                                    message:
                                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                                    payment_status:
                                                                                        trip.payment_status,
                                                                                }
                                                                            )
                                                                        }
                                                                    }
                                                                )
                                                            } else {
                                                                res.json({
                                                                    success: true,
                                                                    message:
                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                                                    payment_status:
                                                                        trip.payment_status,
                                                                })
                                                            }
                                                            const extra_param =
                                                                {
                                                                    trip_id:
                                                                        trip._id,
                                                                }
                                                            utils.sendPushNotification(
                                                                constant_json.USER_UNIQUE_NUMBER,
                                                                device_type,
                                                                device_token,
                                                                push_messages.PUSH_CODE_FOR_YOUR_TRIP_END,
                                                                constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS,
                                                                extra_param
                                                            )
                                                        } else {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_PAY_PAYMENT_FAILED,
                                                            })
                                                        }
                                                    }
                                                },
                                                (err) => {
                                                    console.log(err)
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                                    })
                                                }
                                            )
                                        }
                                    }
                                })
                            })
                        }
                    )
                })
            } else {
                res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_TRIP_NOT_FOUND,
                })
            }
        },
        (err) => {
            console.log(err)
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
            })
        }
    ) ///////// end TRIP
}

exports.pay_tip_payment = function (req, res) {
    if (req.body.udf5) {
        req.body.trip_id = req.body.udf5
    }
    Trip.findOne({ _id: req.body.trip_id }).then((trip) => {
        Trip_history.findOne({ _id: req.body.trip_id, is_trip_end: 1 }).then(
            (trip_history) => {
                if (!trip) {
                    trip = trip_history
                }
                if (trip) {
                    if (
                        !trip.payment_gateway_type ||
                        trip.payment_gateway_type == PAYMENT_GATEWAY.stripe
                    ) {
                        var stripe_secret_key = setting_detail.stripe_secret_key

                        var stripe = require('stripe')(stripe_secret_key)
                        stripe.paymentIntents.retrieve(
                            trip.tip_payment_intent_id,
                            function (error, intent) {
                                if (
                                    intent &&
                                    intent.charges &&
                                    intent.charges.data &&
                                    intent.charges.data.length > 0
                                ) {
                                    trip.tip_amount =
                                        intent.charges.data[0].amount / 100
                                    trip.total = trip.total + trip.tip_amount
                                    trip.provider_service_fees =
                                        +trip.provider_service_fees +
                                        +trip.tip_amount
                                    trip.pay_to_provider =
                                        trip.pay_to_provider + +trip.tip_amount
                                    trip.card_payment =
                                        trip.card_payment + trip.tip_amount

                                    Provider.findOne(
                                        { _id: trip.confirmed_provider },
                                        function (error, provider) {
                                            City.findOne({
                                                _id: trip.city_id,
                                            }).then((city) => {
                                                if (
                                                    city.is_provider_earning_set_in_wallet_on_other_payment
                                                ) {
                                                    if (
                                                        provider.provider_type ==
                                                        Number(
                                                            constant_json.PROVIDER_TYPE_NORMAL
                                                        )
                                                    ) {
                                                        var total_wallet_amount =
                                                            utils.addWalletHistory(
                                                                constant_json.PROVIDER_UNIQUE_NUMBER,
                                                                provider.unique_id,
                                                                provider._id,
                                                                provider.country_id,
                                                                provider.wallet_currency_code,
                                                                trip.currencycode,
                                                                1,
                                                                trip.tip_amount,
                                                                provider.wallet,
                                                                constant_json.ADD_WALLET_AMOUNT,
                                                                constant_json.SET_TRIP_PROFIT,
                                                                'Set Profit Of This Trip : ' +
                                                                    trip.unique_id
                                                            )

                                                        provider.wallet =
                                                            total_wallet_amount
                                                        provider.save()
                                                    } else {
                                                        Partner.findOne({
                                                            _id: trip.provider_type_id,
                                                        }).then((partner) => {
                                                            var total_wallet_amount =
                                                                utils.addWalletHistory(
                                                                    constant_json.PARTNER_UNIQUE_NUMBER,
                                                                    partner.unique_id,
                                                                    partner._id,
                                                                    partner.country_id,
                                                                    partner.wallet_currency_code,
                                                                    trip.currencycode,
                                                                    1,
                                                                    trip.tip_amount,
                                                                    partner.wallet,
                                                                    constant_json.ADD_WALLET_AMOUNT,
                                                                    constant_json.SET_TRIP_PROFIT,
                                                                    'Set Profit Of This Trip : ' +
                                                                        trip.unique_id
                                                                )

                                                            partner.wallet =
                                                                total_wallet_amount
                                                            partner.save()
                                                        })
                                                    }

                                                    trip.is_provider_earning_set_in_wallet = true
                                                    trip.provider_income_set_in_wallet =
                                                        trip.provider_income_set_in_wallet +
                                                        Math.abs(
                                                            trip.tip_amount
                                                        )
                                                }

                                                trip.save().then(() => {
                                                    res.json({
                                                        success: true,
                                                        message:
                                                            success_messages.MESSAGE_CODE_PAYMENT_PAID_SUCCESSFULLY,
                                                    })
                                                })
                                            })
                                        }
                                    )
                                } else {
                                    res.json({
                                        success: false,
                                        error_code:
                                            error_message.ERROR_CODE_YOUR_TRIP_PAYMENT_IS_PENDING,
                                    })
                                }
                            }
                        )
                    } else if (
                        trip.payment_gateway_type == PAYMENT_GATEWAY.payu
                    ) {
                        trip.tip_amount = req.body.amount
                        trip.total = trip.total + trip.tip_amount
                        trip.provider_service_fees =
                            +trip.provider_service_fees + +trip.tip_amount
                        trip.pay_to_provider =
                            trip.pay_to_provider + +trip.tip_amount
                        trip.card_payment = trip.card_payment + trip.tip_amount
                        trip.payment_intent_id = req.body.mihpayid

                        Provider.findOne(
                            { _id: trip.confirmed_provider },
                            function (error, provider) {
                                City.findOne({ _id: trip.city_id }).then(
                                    (city) => {
                                        if (
                                            city.is_provider_earning_set_in_wallet_on_other_payment
                                        ) {
                                            if (
                                                provider.provider_type ==
                                                Number(
                                                    constant_json.PROVIDER_TYPE_NORMAL
                                                )
                                            ) {
                                                var total_wallet_amount =
                                                    utils.addWalletHistory(
                                                        constant_json.PROVIDER_UNIQUE_NUMBER,
                                                        provider.unique_id,
                                                        provider._id,
                                                        provider.country_id,
                                                        provider.wallet_currency_code,
                                                        trip.currencycode,
                                                        1,
                                                        trip.tip_amount,
                                                        provider.wallet,
                                                        constant_json.ADD_WALLET_AMOUNT,
                                                        constant_json.SET_TRIP_PROFIT,
                                                        'Set Profit Of This Trip : ' +
                                                            trip.unique_id
                                                    )

                                                provider.wallet =
                                                    total_wallet_amount
                                                provider.save()
                                            } else {
                                                Partner.findOne({
                                                    _id: trip.provider_type_id,
                                                }).then((partner) => {
                                                    var total_wallet_amount =
                                                        utils.addWalletHistory(
                                                            constant_json.PARTNER_UNIQUE_NUMBER,
                                                            partner.unique_id,
                                                            partner._id,
                                                            partner.country_id,
                                                            partner.wallet_currency_code,
                                                            trip.currencycode,
                                                            1,
                                                            trip.tip_amount,
                                                            partner.wallet,
                                                            constant_json.ADD_WALLET_AMOUNT,
                                                            constant_json.SET_TRIP_PROFIT,
                                                            'Set Profit Of This Trip : ' +
                                                                trip.unique_id
                                                        )

                                                    partner.wallet =
                                                        total_wallet_amount
                                                    partner.save()
                                                })
                                            }

                                            trip.is_provider_earning_set_in_wallet = true
                                            trip.provider_income_set_in_wallet =
                                                trip.provider_income_set_in_wallet +
                                                Math.abs(trip.tip_amount)
                                        }

                                        trip.save().then(() => {
                                            if (req.body.udf4) {
                                                res.redirect(req.body.udf4)
                                            } else {
                                                res.json({
                                                    success: true,
                                                    message:
                                                        success_messages.MESSAGE_CODE_PAYMENT_PAID_SUCCESSFULLY,
                                                })
                                            }
                                        })
                                    }
                                )
                            }
                        )
                    }
                } else {
                    res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_TRIP_NOT_FOUND,
                    })
                }
            }
        )
    })
}

exports.pay_stripe_intent_payment = function (req, res) {
    if (req.body.txnid) {
        req.body.trip_id = req.body.txnid
    }

    Trip.findOne({ _id: req.body.trip_id }).then((trip) => {
        Trip_history.findOne({ _id: req.body.trip_id }).then(
            async (trip_history) => {
                if (!trip) {
                    trip = trip_history
                }
                if (trip) {
                    let is_main_user = true
                    let split_payment_index = null
                    trip.split_payment_users.forEach(
                        (split_payment_user_detail, index) => {
                            if (
                                split_payment_user_detail.user_id.toString() ==
                                req.body.user_id.toString()
                            ) {
                                is_main_user = false
                                split_payment_index = index
                            }
                        }
                    )
                    console.log(is_main_user)

                    if (
                        !trip.payment_gateway_type ||
                        trip.payment_gateway_type == PAYMENT_GATEWAY.stripe
                    ) {
                        var stripe_secret_key = setting_detail.stripe_secret_key

                        var stripe = require('stripe')(stripe_secret_key)
                        let payment_intent_id = trip.payment_intent_id
                        if (!is_main_user) {
                            payment_intent_id =
                                trip.split_payment_users[split_payment_index]
                                    .payment_intent_id
                        }
                        console.log('payment_intent_id: ' + payment_intent_id)
                        stripe.paymentIntents.retrieve(
                            payment_intent_id,
                            async function (error, intent) {
                                if (
                                    intent &&
                                    intent.charges &&
                                    intent.charges.data &&
                                    intent.charges.data.length > 0
                                ) {
                                    if (is_main_user) {
                                        trip.payment_status =
                                            PAYMENT_STATUS.COMPLETED
                                        trip.remaining_payment = 0
                                        trip.card_payment =
                                            intent.charges.data[0].amount / 100
                                    } else {
                                        trip.split_payment_users[
                                            split_payment_index
                                        ].card_payment =
                                            intent.charges.data[0].amount / 100
                                        trip.split_payment_users[
                                            split_payment_index
                                        ].remaining_payment = 0
                                        trip.split_payment_users[
                                            split_payment_index
                                        ].payment_status =
                                            PAYMENT_STATUS.COMPLETED
                                        trip.card_payment =
                                            trip.card_payment +
                                            intent.charges.data[0].amount / 100
                                    }

                                    // if (trip.is_trip_cancelled == 1) {
                                    //     User.findOne({ _id: trip.user_id }).then((user) => {
                                    //         user.current_trip_id = null;
                                    //         user.save();
                                    //     });
                                    // }

                                    // start provider profit after card payment done
                                    await utils.trip_provider_profit_card_wallet_settlement(
                                        trip
                                    )
                                    // end of provider profit after card payment done

                                    trip.markModified('split_payment_users')
                                    trip.save().then(() => {
                                        utils.update_request_status_socket(
                                            trip._id
                                        )
                                        if (is_main_user) {
                                            User.findOne(
                                                { _id: trip.user_id },
                                                function (error, user) {
                                                    user.corporate_wallet_limit =
                                                        user.corporate_wallet_limit -
                                                        trip.card_payment
                                                    user.save()
                                                }
                                            )
                                        }
                                        Trip.findOneAndRemove({
                                            _id: trip._id,
                                        }).then((deleted_trip) => {
                                            if (deleted_trip) {
                                                var trip_history_data =
                                                    new Trip_history(
                                                        JSON.parse(
                                                            JSON.stringify(
                                                                deleted_trip
                                                            )
                                                        )
                                                    )
                                                trip_history_data.split_payment_users =
                                                    deleted_trip.split_payment_users
                                                trip_history_data.save(
                                                    function () {
                                                        res.json({
                                                            success: true,
                                                            message:
                                                                success_messages.PAYMENT_PAID_SUCCESSFULLY,
                                                        })
                                                    }
                                                )
                                            } else {
                                                res.json({
                                                    success: true,
                                                    message:
                                                        success_messages.PAYMENT_PAID_SUCCESSFULLY,
                                                })
                                            }
                                        })
                                    })
                                } else {
                                    res.json({
                                        success: false,
                                        error_code:
                                            error_message.ERROR_CODE_YOUR_TRIP_PAYMENT_IS_PENDING,
                                    })
                                }
                            }
                        )
                    } else if (
                        trip.payment_gateway_type == PAYMENT_GATEWAY.payu
                    ) {
                        if (is_main_user) {
                            trip.payment_status = PAYMENT_STATUS.COMPLETED
                            trip.remaining_payment = 0
                            trip.card_payment =
                                intent.charges.data[0].amount / 100
                            trip.payment_intent_id = req.body.mihpayid
                        } else {
                            ttrip.split_payment_users[
                                split_payment_index
                            ].card_payment = intent.charges.data[0].amount / 100
                            trip.split_payment_users[
                                split_payment_index
                            ].remaining_payment = 0
                            trip.split_payment_users[
                                split_payment_index
                            ].payment_status = PAYMENT_STATUS.COMPLETED
                            trip.split_payment_users[
                                split_payment_index
                            ].payment_intent_id = req.body.mihpayid
                            trip.card_payment =
                                trip.card_payment +
                                intent.charges.data[0].amount / 100
                        }

                        // if (trip.is_trip_cancelled == 1) {
                        //     User.findOne({ _id: trip.user_id }).then((user) => {
                        //         user.current_trip_id = null;
                        //         user.save();
                        //     });
                        // }

                        // start provider profit after card payment done
                        await utils.trip_provider_profit_card_wallet_settlement(
                            trip
                        )
                        // end of provider profit after card payment done

                        trip.markModified('split_payment_users')
                        trip.save().then(() => {
                            utils.update_request_status_socket(trip._id)
                            if (is_main_user) {
                                User.findOne(
                                    { _id: trip.user_id },
                                    function (error, user) {
                                        user.corporate_wallet_limit =
                                            user.corporate_wallet_limit -
                                            trip.card_payment
                                        user.save()
                                    }
                                )
                            }
                            Trip.findOneAndRemove({ _id: trip._id }).then(
                                (deleted_trip) => {
                                    if (deleted_trip) {
                                        var trip_history_data =
                                            new Trip_history(
                                                JSON.parse(
                                                    JSON.stringify(deleted_trip)
                                                )
                                            )
                                        trip_history_data.split_payment_users =
                                            deleted_trip.split_payment_users
                                        trip_history_data.save(function () {
                                            if (req.body.udf4) {
                                                res.redirect(req.body.udf4)
                                            } else {
                                                res.json({
                                                    success: true,
                                                    message:
                                                        success_messages.PAYMENT_PAID_SUCCESSFULLY,
                                                })
                                            }
                                        })
                                    } else {
                                        if (req.body.udf4) {
                                            res.redirect(req.body.udf4)
                                        } else {
                                            res.json({
                                                success: true,
                                                message:
                                                    success_messages.PAYMENT_PAID_SUCCESSFULLY,
                                            })
                                        }
                                    }
                                }
                            )
                        })
                    }
                } else {
                    res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_TRIP_NOT_FOUND,
                    })
                }
            }
        )
    })
}

exports.fail_stripe_intent_payment = function (req, res) {
    if (req.body.txnid) {
        req.body.trip_id = req.body.txnid
    }
    Trip.findOne({
        _id: req.body.trip_id,
        $or: [
            { payment_status: PAYMENT_STATUS.WAITING },
            { payment_status: PAYMENT_STATUS.FAILED },
        ],
    }).then((trip) => {
        if (trip) {
            Corporate.findOne({ _id: trip.user_type_id }).then((corporate) => {
                if (
                    trip.trip_type == constant_json.TRIP_TYPE_CORPORATE &&
                    corporate
                ) {
                    var wallet_payment = trip.remaining_payment
                    var total_wallet_amount = utils.addWalletHistory(
                        constant_json.USER_UNIQUE_NUMBER,
                        corporate.unique_id,
                        corporate._id,
                        null,
                        corporate.wallet_currency_code,
                        trip.currencycode,
                        trip.wallet_current_rate,
                        wallet_payment,
                        corporate.wallet,
                        constant_json.DEDUCT_WALLET_AMOUNT,
                        constant_json.PAID_TRIP_AMOUNT,
                        'Charge Of This Trip : ' + trip.unique_id
                    )
                    corporate.wallet = total_wallet_amount
                    corporate.save()

                    utils.update_request_status_socket(trip._id)
                    trip.payment_status = PAYMENT_STATUS.COMPLETED
                    trip.remaining_payment = 0
                    trip.wallet_payment = wallet_payment

                    // if (trip.is_trip_cancelled == 1) {
                    //     User.findOne({ _id: trip.user_id }).then((user) => {
                    //         user.current_trip_id = null;
                    //         user.save();
                    //     });
                    // }
                    trip.save().then(() => {
                        User.findOne(
                            { _id: trip.user_id },
                            function (error, user) {
                                user.corporate_wallet_limit =
                                    user.corporate_wallet_limit -
                                    trip.card_payment
                                user.save()
                            }
                        )
                        Trip.findOneAndRemove({ _id: trip._id }).then(
                            (deleted_trip) => {
                                if (deleted_trip) {
                                    var trip_history_data = new Trip_history(
                                        JSON.parse(JSON.stringify(deleted_trip))
                                    )
                                    trip_history_data.split_payment_users =
                                        deleted_trip.split_payment_users
                                    trip_history_data.save(function () {
                                        res.json({
                                            success: true,
                                            message:
                                                success_messages.PAYMENT_PAID_SUCCESSFULLY,
                                        })
                                    })
                                } else {
                                    res.json({
                                        success: true,
                                        message:
                                            success_messages.PAYMENT_PAID_SUCCESSFULLY,
                                    })
                                }
                            }
                        )
                    })
                } else {
                    if (trip.payment_gateway_type != PAYMENT_GATEWAY.payu) {
                        utils.update_request_status_socket(trip._id)
                    }

                    trip.payment_status = PAYMENT_STATUS.FAILED
                    trip.save().then(
                        () => {
                            res.json({
                                success: true,
                                message: success_messages.PAYMENT_FAILD,
                            })
                        },
                        (error) => {
                            console.log(error)
                        }
                    )
                }
            })
        } else {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_TRIP_NOT_FOUND,
            })
        }
    })
}

///////////////////GETTRIP STATUS PROVIDER SIDE //////
exports.providergettripstatus = async function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'trip_id', type: 'string' }],
        async function (response) {
            if (response.success) {
                var provider_id = req.body.provider_id
                var token = req.body.token
                var country_phone_code = ''
                var phone = ''
                let is_truck_owner = 0

                if (provider_id != undefined && token != undefined) {
                    Provider.findOne({ _id: req.body.provider_id }).then(
                        (provider) => {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                if (provider.is_trip.length > 0) {
                                    Trip.findOne({
                                        _id: req.body.trip_id,
                                        $or: [
                                            { current_providers: provider._id },
                                            {
                                                confirmed_provider:
                                                    provider._id,
                                            },
                                        ],

                                        is_trip_cancelled: 0,
                                        is_trip_cancelled_by_provider: 0,
                                    }).then(
                                        (trip) => {
                                            //  console.log(trip)
                                            Trip_history.findOne({
                                                _id: req.body.trip_id,
                                                $or: [
                                                    {
                                                        current_providers:
                                                            provider._id,
                                                    },
                                                    {
                                                        confirmed_provider:
                                                            provider._id,
                                                    },
                                                ],

                                                is_trip_cancelled: 0,
                                                is_trip_cancelled_by_provider: 0,
                                            }).then(async (trip_history) => {
                                                if (!trip) {
                                                    trip = trip_history
                                                }

                                                if (trip) {
                                                    let truck_index =
                                                        provider.partner_ids.findIndex(
                                                            (e) =>
                                                                e.partner_id.toString() ==
                                                                    trip.provider_type_id?.toString() &&
                                                                e.truck_owner ==
                                                                    1
                                                        )
                                                    if (truck_index != -1) {
                                                        is_truck_owner = 1
                                                    }
                                                    let trip_location =
                                                        await TripLocation.findOne(
                                                            { tripID: trip._id }
                                                        )
                                                            .select({
                                                                arrivedTripToEndTripLocations: 1,
                                                            })
                                                            .lean()
                                                    Trip_Service.findOne({
                                                        _id: trip.trip_service_city_type_id,
                                                    }).then((tripservice) => {
                                                        if (tripservice) {
                                                            User.findOne({
                                                                _id: trip.user_id,
                                                            }).then((user) => {
                                                                if (user) {
                                                                    country_phone_code =
                                                                        user.country_phone_code
                                                                    phone =
                                                                        user.phone
                                                                }

                                                                Citytype.findById(
                                                                    trip.service_type_id
                                                                ).then(
                                                                    (
                                                                        citytype_detail
                                                                    ) => {
                                                                        Type.findById(
                                                                            citytype_detail.typeid
                                                                        ).then(
                                                                            async (
                                                                                type_detail
                                                                            ) => {
                                                                                var waiting_time_start_after_minute = 0
                                                                                var price_for_waiting_time = 0
                                                                                var total_wait_time = 0
                                                                                var provider_arrived_time =
                                                                                    trip.provider_arrived_time
                                                                                if (
                                                                                    provider_arrived_time !=
                                                                                    null
                                                                                ) {
                                                                                    var end_time =
                                                                                        new Date()
                                                                                    waiting_time_start_after_minute =
                                                                                        tripservice.waiting_time_start_after_minute
                                                                                    price_for_waiting_time =
                                                                                        tripservice.price_for_waiting_time
                                                                                    total_wait_time =
                                                                                        utils.getTimeDifferenceInSecond(
                                                                                            end_time,
                                                                                            provider_arrived_time
                                                                                        )
                                                                                    total_wait_time =
                                                                                        total_wait_time -
                                                                                        waiting_time_start_after_minute *
                                                                                            60
                                                                                }
                                                                                if (
                                                                                    trip.is_provider_status ==
                                                                                    6
                                                                                ) {
                                                                                    var now =
                                                                                        new Date()
                                                                                    var minutes =
                                                                                        utils.getTimeDifferenceInMinute(
                                                                                            now,
                                                                                            trip.provider_trip_start_time
                                                                                        )
                                                                                    trip.total_time =
                                                                                        minutes
                                                                                    trip.save()
                                                                                }
                                                                                let trip_date_tag =
                                                                                    utils.getTripDateTag(
                                                                                        trip,
                                                                                        new Date()
                                                                                    )
                                                                                let check_trip_date_start =
                                                                                    new Date(
                                                                                        trip_date_tag.getTime() -
                                                                                            30 *
                                                                                                60 *
                                                                                                1000
                                                                                    )
                                                                                let check_trip_date_end =
                                                                                    new Date(
                                                                                        trip_date_tag.getTime() +
                                                                                            30 *
                                                                                                60 *
                                                                                                1000
                                                                                    )

                                                                                var index =
                                                                                    user.favourite_providers.findIndex(
                                                                                        (
                                                                                            x
                                                                                        ) =>
                                                                                            x.toString() ==
                                                                                            req.body.provider_id.toString()
                                                                                    )

                                                                                if (
                                                                                    index !==
                                                                                    -1
                                                                                ) {
                                                                                    trip.is_favourite_provider = true
                                                                                }
                                                                                let partner_ids =
                                                                                    []
                                                                                provider.vehicle_detail.forEach(
                                                                                    (
                                                                                        vehicle
                                                                                    ) => {
                                                                                        // console.log(vehicle)
                                                                                        let service = 0
                                                                                        let capacity = 0
                                                                                        let model = 0
                                                                                        let a =
                                                                                            -1
                                                                                        let truck_type = true

                                                                                        if (
                                                                                            vehicle.admin_type_id.toString() !=
                                                                                            trip.type_id.toString()
                                                                                        ) {
                                                                                            truck_type = false
                                                                                        }
                                                                                        if (
                                                                                            vehicle.vehicle_book_dates &&
                                                                                            vehicle
                                                                                                .vehicle_book_dates
                                                                                                .length >
                                                                                                0
                                                                                        ) {
                                                                                            a =
                                                                                                vehicle.vehicle_book_dates.findIndex(
                                                                                                    (
                                                                                                        x
                                                                                                    ) =>
                                                                                                        x.trip_date >=
                                                                                                            check_trip_date_start &&
                                                                                                        x.trip_date <=
                                                                                                            check_trip_date_end
                                                                                                )
                                                                                        }

                                                                                        if (
                                                                                            trip.capacity_details &&
                                                                                            vehicle
                                                                                                .selected_capacity_id
                                                                                                .length ==
                                                                                                0
                                                                                        ) {
                                                                                            capacity =
                                                                                                -1
                                                                                        } else if (
                                                                                            trip.capacity_details &&
                                                                                            vehicle.selected_capacity_id &&
                                                                                            vehicle
                                                                                                .selected_capacity_id
                                                                                                .length >
                                                                                                0
                                                                                        ) {
                                                                                            capacity =
                                                                                                vehicle.selected_capacity_id.findIndex(
                                                                                                    (
                                                                                                        x
                                                                                                    ) =>
                                                                                                        x.toString() ==
                                                                                                        trip.capacity_details._id.toString()
                                                                                                )
                                                                                        }

                                                                                        // if(trip.service_details && trip.service_details._id.toString() != vehicle.selected_services_id.toString()){
                                                                                        //     service_details = false
                                                                                        // }

                                                                                        if (
                                                                                            trip.service_details &&
                                                                                            vehicle
                                                                                                .selected_services_id
                                                                                                .length ==
                                                                                                0
                                                                                        ) {
                                                                                            service =
                                                                                                -1
                                                                                        } else if (
                                                                                            trip.service_details &&
                                                                                            vehicle.selected_services_id &&
                                                                                            vehicle
                                                                                                .selected_services_id
                                                                                                .length >
                                                                                                0
                                                                                        ) {
                                                                                            service =
                                                                                                vehicle.selected_services_id.findIndex(
                                                                                                    (
                                                                                                        x
                                                                                                    ) =>
                                                                                                        x.toString() ==
                                                                                                        trip.service_details._id.toString()
                                                                                                )
                                                                                        }

                                                                                        if (
                                                                                            trip.model_details &&
                                                                                            vehicle
                                                                                                .selected_model_id
                                                                                                .length ==
                                                                                                0
                                                                                        ) {
                                                                                            model =
                                                                                                -1
                                                                                        } else if (
                                                                                            trip.model_details &&
                                                                                            vehicle.selected_model_id &&
                                                                                            vehicle
                                                                                                .selected_model_id
                                                                                                .length >
                                                                                                0
                                                                                        ) {
                                                                                            model =
                                                                                                vehicle.selected_model_id.findIndex(
                                                                                                    (
                                                                                                        x
                                                                                                    ) =>
                                                                                                        x.toString() ==
                                                                                                        trip.model_details._id.toString()
                                                                                                )
                                                                                        }

                                                                                        if (
                                                                                            trip.assigned_vehicle_details &&
                                                                                            trip.assigned_vehicle_details.vehicle_truck_type_id?.toString() ===
                                                                                                vehicle.service_type?.toString() &&
                                                                                            trip.assigned_vehicle_details.vehicle_plate_no
                                                                                                ?.trim()
                                                                                                .toLowerCase() ===
                                                                                                vehicle.plate_no
                                                                                                    ?.trim()
                                                                                                    .toLowerCase()
                                                                                        ) {
                                                                                            trip.assigned_vehicle_details.hasDevicesTemperature =
                                                                                                vehicle.hasDevicesTemperature ||
                                                                                                false
                                                                                        }
                                                                                        if (
                                                                                            a ==
                                                                                                -1 &&
                                                                                            service >
                                                                                                -1 &&
                                                                                            capacity >
                                                                                                -1 &&
                                                                                            model >
                                                                                                -1 &&
                                                                                            truck_type
                                                                                        ) {
                                                                                            partner_ids.push(
                                                                                                vehicle.vehicle_type_id
                                                                                            )
                                                                                        }
                                                                                    }
                                                                                )
                                                                                let select =
                                                                                    {
                                                                                        _id: 1,
                                                                                        first_name: 1,
                                                                                        last_name: 1,
                                                                                        phone: 1,
                                                                                        country_phone_code: 1,
                                                                                    }

                                                                                let partners =
                                                                                    await Partner.find(
                                                                                        {
                                                                                            _id: {
                                                                                                $in: partner_ids,
                                                                                            },
                                                                                        }
                                                                                    )
                                                                                        .select(
                                                                                            select
                                                                                        )
                                                                                        .lean()

                                                                                res.json(
                                                                                    {
                                                                                        success: true,
                                                                                        map_pin_image_url:
                                                                                            type_detail.map_pin_image_url,
                                                                                        message:
                                                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_GET_TRIP_STATUS_SUCCESSFULLY,
                                                                                        country_phone_code:
                                                                                            country_phone_code,
                                                                                        phone: phone,
                                                                                        trip: trip,
                                                                                        user: user,
                                                                                        tripservice:
                                                                                            tripservice,
                                                                                        waiting_time_start_after_minute:
                                                                                            waiting_time_start_after_minute,
                                                                                        price_for_waiting_time:
                                                                                            price_for_waiting_time,
                                                                                        total_wait_time:
                                                                                            total_wait_time,
                                                                                        partner_list:
                                                                                            partners,
                                                                                        is_truck_owner:
                                                                                            is_truck_owner,
                                                                                        trip_location,
                                                                                    }
                                                                                )
                                                                            }
                                                                        )
                                                                    }
                                                                )
                                                            })
                                                        } else {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_NOT_GET_TRIP_STATUS,
                                                            })
                                                        }
                                                    })
                                                } else {
                                                    Trip.findOne({
                                                        _id: req.body.trip_id,
                                                        is_trip_cancelled_by_user: 1,
                                                        is_trip_cancelled: 1,
                                                    }).then((cancel_trip) => {
                                                        if (cancel_trip) {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_TRIP_CANCELLED_BY_USER,
                                                            })
                                                        } else {
                                                            provider =
                                                                utils.remove_is_trip_from_provider(
                                                                    provider,
                                                                    req.body
                                                                        .trip_id
                                                                )
                                                            if (
                                                                !provider.is_near_trip
                                                            ) {
                                                                provider.is_near_trip =
                                                                    []
                                                            }
                                                            if (
                                                                String(
                                                                    provider
                                                                        .is_near_trip[0]
                                                                ) ==
                                                                String(
                                                                    req.body
                                                                        .trip_id
                                                                )
                                                            ) {
                                                                provider.is_near_available = 1
                                                                provider.is_near_trip =
                                                                    []
                                                            }
                                                            provider
                                                                .save()
                                                                .then(() => {
                                                                    res.json({
                                                                        success: false,
                                                                        error_code:
                                                                            error_message.ERROR_CODE_NOT_GET_TRIP_STATUS,
                                                                    })
                                                                })
                                                        }
                                                    })
                                                }
                                            })
                                        },
                                        (err) => {
                                            console.log(err)
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                            })
                                        }
                                    )
                                } else {
                                    res.json({
                                        success: false,
                                        error_code:
                                            error_message.ERROR_CODE_NOT_GET_TRIP_STATUS,
                                    })
                                }
                            }
                        },
                        (err) => {
                            console.log(err)
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                            })
                        }
                    )
                } else {
                    Trip.findOne({
                        _id: req.body.trip_id,
                        is_trip_cancelled: 0,
                        is_trip_cancelled_by_provider: 0,
                    }).then(
                        (trip) => {
                            if (trip) {
                                Trip_Service.findOne({
                                    _id: trip.trip_service_city_type_id,
                                }).then((tripservice) => {
                                    if (tripservice) {
                                        User.findOne({
                                            _id: trip.user_id,
                                        }).then((user) => {
                                            if (user) {
                                                country_phone_code =
                                                    user.country_phone_code
                                                phone = user.phone
                                            }
                                            Citytype.findById(
                                                trip.service_type_id
                                            ).then((citytype_detail) => {
                                                Type.findById(
                                                    citytype_detail.typeid
                                                ).then((type_detail) => {
                                                    var waiting_time_start_after_minute = 0
                                                    var price_for_waiting_time = 0
                                                    var total_wait_time = 0
                                                    var provider_arrived_time =
                                                        trip.provider_arrived_time
                                                    if (
                                                        provider_arrived_time !=
                                                        null
                                                    ) {
                                                        var end_time =
                                                            new Date()
                                                        waiting_time_start_after_minute =
                                                            tripservice.waiting_time_start_after_minute
                                                        price_for_waiting_time =
                                                            tripservice.price_for_waiting_time
                                                        total_wait_time =
                                                            utils.getTimeDifferenceInSecond(
                                                                end_time,
                                                                provider_arrived_time
                                                            )
                                                        total_wait_time =
                                                            total_wait_time -
                                                            waiting_time_start_after_minute *
                                                                60
                                                    }

                                                    res.json({
                                                        success: true,
                                                        country_phone_code:
                                                            country_phone_code,
                                                        phone: phone,
                                                        map_pin_image_url:
                                                            type_detail.map_pin_image_url,
                                                        message:
                                                            success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_GET_TRIP_STATUS_SUCCESSFULLY,
                                                        trip: trip,
                                                        user: user,
                                                        waiting_time_start_after_minute:
                                                            waiting_time_start_after_minute,
                                                        price_for_waiting_time:
                                                            price_for_waiting_time,
                                                        total_wait_time:
                                                            total_wait_time,
                                                        is_truck_owner:
                                                            is_truck_owner,
                                                    })
                                                })
                                            })
                                        })
                                    } else {
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_NOT_GET_TRIP_STATUS,
                                        })
                                    }
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    is_trip_cancelled_by_user: 1,
                                }).then((cancel_trip) => {
                                    if (cancel_trip) {
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_TRIP_CANCELLED_BY_USER,
                                        })
                                    } else {
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_NOT_GET_TRIP_STATUS,
                                        })
                                    }
                                })
                            }
                        },
                        (err) => {
                            console.log(err)
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                            })
                        }
                    )
                }
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

//////////////////// user_history //////////////////////
exports.user_history = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'user_id', type: 'string' }],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user) => {
                        if (user.token != req.body.token) {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_INVALID_TOKEN,
                            })
                        } else {
                            var lookup1 = {
                                $lookup: {
                                    from: 'providers',
                                    localField: 'confirmed_provider',
                                    foreignField: '_id',
                                    as: 'provider_detail',
                                },
                            }
                            var unwind1 = { $unwind: '$provider_detail' }
                            var lookup2 = {
                                $lookup: {
                                    from: 'provider_documents',
                                    let: {
                                        providers_id: '$provider_detail._id',
                                    },
                                    pipeline: [
                                        {
                                            $match: {
                                                $expr: {
                                                    $and: [
                                                        {
                                                            $eq: [
                                                                '$provider_id',
                                                                '$$providers_id',
                                                            ],
                                                        },
                                                        {
                                                            $eq: [
                                                                '$name',
                                                                'Cédula',
                                                            ],
                                                        },
                                                    ],
                                                },
                                            },
                                        },
                                    ],
                                    as: 'provider_doc',
                                },
                            }
                            var condition = {
                                $match: {
                                    user_id: { $eq: Schema(req.body.user_id) },
                                },
                            }
                            var condition1 = {
                                $match: {
                                    $or: [
                                        { is_trip_cancelled: { $eq: 1 } },
                                        { is_trip_end: { $eq: 1 } },
                                        {
                                            is_trip_cancelled_by_user: {
                                                $eq: 1,
                                            },
                                        },
                                        {
                                            is_trip_cancelled_by_provider: {
                                                $eq: 1,
                                            },
                                        },
                                    ],
                                },
                            }

                            var group = {
                                $project: {
                                    trip_id: '$_id',
                                    unique_id: 1,
                                    invoice_number: 1,
                                    current_provider: 1,
                                    provider_service_fees: 1,
                                    is_trip_cancelled_by_user: 1,
                                    is_trip_completed: 1,
                                    is_trip_cancelled: 1,
                                    is_user_rated: 1,
                                    is_provider_rated: 1,
                                    is_trip_cancelled_by_provider: 1,
                                    first_name: '$provider_detail.first_name',
                                    last_name: '$provider_detail.last_name',
                                    picture: '$provider_detail.picture',
                                    total: 1,
                                    unit: 1,
                                    currency: 1,
                                    currencycode: 1,
                                    total_time: 1,
                                    user_create_time: 1,
                                    total_distance: 1,
                                    source_address: 1,
                                    destination_address: 1,
                                    destination_addresses: 1,
                                    provider_trip_end_time: 1,
                                    timezone: 1,
                                    initial_destination_address: 1,
                                    initialDestinationLocation: 1,
                                    confirmed_provider: 1,
                                    cedula: {
                                        $cond: {
                                            if: {
                                                $eq: [
                                                    { $size: '$provider_doc' },
                                                    0,
                                                ],
                                            },
                                            then: '',
                                            else: {
                                                $arrayElemAt: [
                                                    '$provider_doc.unique_code',
                                                    0,
                                                ],
                                            },
                                        },
                                    },
                                    created_at: 1,
                                },
                            }

                            var start_date = req.body.start_date
                            var end_date = req.body.end_date
                            if (end_date == '' || end_date == undefined) {
                                end_date = new Date()
                            } else {
                                end_date = new Date(end_date)
                                end_date = end_date.setHours(23, 59, 59, 999)
                                end_date = new Date(end_date)
                            }

                            if (start_date == '' || start_date == undefined) {
                                start_date = new Date(0)
                                start_date = start_date.setHours(0, 0, 0, 0)
                                start_date = new Date(start_date)
                            } else {
                                start_date = new Date(start_date)
                                start_date = start_date.setHours(0, 0, 0, 0)
                                start_date = new Date(start_date)
                            }
                            var query1 = {}
                            query1['created_at'] = {
                                $gte: start_date,
                                $lt: end_date,
                            }
                            var filter = { $match: query1 }

                            var number_of_rec = 10
                            var page = req.body.page || 1
                            var skip = {}
                            skip['$skip'] = (page - 1) * number_of_rec

                            var limit = {}
                            limit['$limit'] = number_of_rec

                            var sort = { $sort: { created_at: -1 } }

                            Trip_history.aggregate([
                                condition,
                                condition1,
                                lookup1,
                                unwind1,
                                lookup2,
                                filter,
                                group,
                                sort,
                                skip,
                                limit,
                            ]).then(
                                (array) => {
                                    Trip.aggregate([
                                        condition,
                                        condition1,
                                        lookup1,
                                        unwind1,
                                        lookup2,
                                        filter,
                                        group,
                                        sort,
                                        skip,
                                        limit,
                                    ]).then((array_list) => {
                                        array_list = array_list.concat(array)
                                        function compare(a, b) {
                                            return (
                                                new Date(b.created_at) -
                                                new Date(a.created_at)
                                            )
                                        }
                                        array_list.sort(compare)
                                        res.json({
                                            success: true,
                                            trips: array_list,
                                        })
                                    })
                                },
                                (err) => {
                                    console.log(err)
                                    res.json({
                                        success: false,
                                        error_code:
                                            error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                    })
                                }
                            )
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

/////////////////////// provider_history ///////////////////////////////////
exports.provider_history = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'provider_id', type: 'string' }],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }

            let provider = await Provider.findOne({ _id: req.body.provider_id })
                .select({ _id: 1, token: 1, is_truck_owner: 1, partner_ids: 1 })
                .lean()
            if (!provider) {
                return res.json({
                    success: false,
                    error_code:
                        error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                })
            }

            if (provider.token != req.body.token) {
                return res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_INVALID_TOKEN,
                })
            }
            let lookup1 = {
                $lookup: {
                    from: 'users',
                    localField: 'user_id',
                    foreignField: '_id',
                    as: 'user_detail',
                },
            }
            let unwind1 = { $unwind: '$user_detail' }

            let condition = {
                $match: {
                    confirmed_provider: { $eq: Schema(req.body.provider_id) },
                },
            }
            let partner_list = provider.partner_ids || []
            let group = {
                $project: {
                    trip_id: '$_id',
                    unique_id: 1,
                    invoice_number: 1,
                    current_provider: 1,
                    provider_service_fees: 1,
                    is_trip_cancelled_by_user: 1,
                    is_trip_cancelled: 1,
                    is_user_rated: 1,
                    is_trip_completed: 1,
                    is_provider_rated: 1,
                    is_trip_cancelled_by_provider: 1,
                    first_name: '$user_detail.first_name',
                    last_name: '$user_detail.last_name',
                    picture: '$user_detail.picture',
                    total: 1,
                    unit: 1,
                    currency: 1,
                    currencycode: 1,
                    total_time: 1,
                    user_create_time: 1,
                    total_distance: 1,
                    source_address: 1,
                    destination_address: 1,
                    destination_addresses: 1,
                    provider_trip_end_time: 1,
                    timezone: 1,
                    provider_type_id: 1,
                    is_truck_owner: {
                        $cond: {
                            if: {
                                $and: [
                                    {
                                        $in: [
                                            '$provider_type_id',
                                            partner_list.map(
                                                (p) => p.partner_id
                                            ),
                                        ],
                                    },
                                    {
                                        $eq: [
                                            {
                                                $arrayElemAt: [
                                                    {
                                                        $map: {
                                                            input: partner_list,
                                                            as: 'p',
                                                            in: {
                                                                $cond: [
                                                                    {
                                                                        $eq: [
                                                                            '$$p.partner_id',
                                                                            '$provider_type_id',
                                                                        ],
                                                                    },
                                                                    '$$p.truck_owner',
                                                                    -1,
                                                                ],
                                                            },
                                                        },
                                                    },
                                                    0,
                                                ],
                                            },
                                            1,
                                        ],
                                    },
                                ],
                            },
                            then: 1,
                            else: 0,
                        },
                    },
                    created_at: 1,
                },
            }

            let start_date = req.body.start_date
            let end_date = req.body.end_date
            if (end_date == '' || end_date == undefined) {
                end_date = new Date()
            } else {
                end_date = new Date(end_date)
                end_date = end_date.setHours(23, 59, 59, 999)
                end_date = new Date(end_date)
            }

            if (start_date == '' || start_date == undefined) {
                start_date = new Date(0)
                start_date = start_date.setHours(0, 0, 0, 0)
                start_date = new Date(start_date)
            } else {
                start_date = new Date(start_date)
                start_date = start_date.setHours(0, 0, 0, 0)
                start_date = new Date(start_date)
            }
            let query1 = {}
            query1['created_at'] = { $gte: start_date, $lt: end_date }
            let filter = { $match: query1 }

            let number_of_rec = 10
            let page = req.body.page || 1
            let skip = {}
            skip['$skip'] = (page - 1) * number_of_rec

            let limit = {}
            limit['$limit'] = number_of_rec
            let sort = { $sort: { created_at: -1 } }

            let trips = await Trip_history.aggregate([
                condition,
                lookup1,
                unwind1,
                filter,
                group,
                sort,
                skip,
                limit,
            ])
            return res.json({ success: true, trips: trips, provider: provider })
        }
    )
}

exports.provider_submit_invoice = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    is_trip_end: 1,
                                }).then(
                                    (trip) => {
                                        Trip_history.findOne({
                                            _id: req.body.trip_id,
                                            is_trip_end: 1,
                                        }).then((trip_history) => {
                                            if (!trip) {
                                                trip = trip_history
                                            }
                                            if (trip) {
                                                User.findOne({
                                                    _id: trip.user_id,
                                                }).then((user) => {
                                                    trip.is_trip_completed = 1
                                                    trip.is_provider_invoice_show = 1
                                                    trip.save(function () {
                                                        provider.completed_request =
                                                            provider.completed_request +
                                                            1
                                                        provider =
                                                            utils.remove_is_trip_from_provider(
                                                                provider,
                                                                trip._id,
                                                                trip.initialDestinationLocation
                                                            )
                                                        provider.save()

                                                        Trip_Service.findOne({
                                                            _id: trip.trip_service_city_type_id,
                                                        }).then(
                                                            (tripservice) => {
                                                                var email_notification =
                                                                    setting_detail.email_notification
                                                                if (
                                                                    email_notification ==
                                                                    true
                                                                ) {
                                                                    allemails.sendProviderInvoiceEmail(
                                                                        req,
                                                                        provider,
                                                                        trip,
                                                                        tripservice,
                                                                        user
                                                                    )
                                                                }
                                                            }
                                                        )

                                                        // if (trip.trip_type == Number(constant_json.TRIP_TYPE_DISPATCHER) || trip.trip_type == Number(constant_json.TRIP_TYPE_HOTEL) || trip.trip_type == Number(constant_json.TRIP_TYPE_PROVIDER) || trip.trip_type == Number(constant_json.TRIP_TYPE_GUEST_TOKEN)) {
                                                        //     user.current_trip_id = null;
                                                        //     user.save();
                                                        // }
                                                        utils.remove_dates_driver_vehicle(
                                                            trip._id,
                                                            trip.model_type
                                                        )
                                                        if (
                                                            trip.is_user_invoice_show ==
                                                                1 ||
                                                            trip.trip_type == 6
                                                        ) {
                                                            Trip.findOneAndRemove(
                                                                {
                                                                    _id: req
                                                                        .body
                                                                        .trip_id,
                                                                }
                                                            ).then(
                                                                (
                                                                    deleted_trip
                                                                ) => {
                                                                    if (
                                                                        deleted_trip
                                                                    ) {
                                                                        var trip_history_data =
                                                                            new Trip_history(
                                                                                JSON.parse(
                                                                                    JSON.stringify(
                                                                                        deleted_trip
                                                                                    )
                                                                                )
                                                                            )
                                                                        trip_history_data.split_payment_users =
                                                                            deleted_trip.split_payment_users
                                                                        trip_history_data.save(
                                                                            function (
                                                                                error
                                                                            ) {
                                                                                console.log(
                                                                                    error
                                                                                )
                                                                                res.json(
                                                                                    {
                                                                                        success: true,
                                                                                    }
                                                                                )
                                                                            }
                                                                        )
                                                                    } else {
                                                                        res.json(
                                                                            {
                                                                                success: true,
                                                                            }
                                                                        )
                                                                    }
                                                                },
                                                                (error) => {
                                                                    console.log(
                                                                        error
                                                                    )
                                                                }
                                                            )
                                                        } else {
                                                            res.json({
                                                                success: true,
                                                            })
                                                        }
                                                    })
                                                })
                                            } else {
                                                res.json({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_YOUR_TRIP_IS_NOT_END,
                                                })
                                            }
                                        })
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.user_submit_invoice = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'user_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user) => {
                        if (user) {
                            if (
                                req.body.token != null &&
                                user.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    is_trip_end: 1,
                                    payment_status: PAYMENT_STATUS.COMPLETED,
                                }).then((trip) => {
                                    Trip_history.findOne({
                                        _id: req.body.trip_id,
                                        is_trip_end: 1,
                                        payment_status:
                                            PAYMENT_STATUS.COMPLETED,
                                    }).then((trip_history) => {
                                        if (!trip) {
                                            trip = trip_history
                                        }
                                        if (trip) {
                                            trip.is_user_invoice_show = 1
                                            trip.save(function () {
                                                Provider.findOne({
                                                    _id: trip.provider_id,
                                                }).then((provider) => {
                                                    Trip_Service.findOne({
                                                        _id: trip.trip_service_city_type_id,
                                                    }).then((tripservice) => {
                                                        var email_notification =
                                                            setting_detail.email_notification
                                                        if (
                                                            email_notification ==
                                                            true
                                                        ) {
                                                            // console.log("mail sent user invoice");
                                                            allemails.sendUserInvoiceEmail(
                                                                req,
                                                                user,
                                                                provider,
                                                                trip,
                                                                tripservice
                                                            )
                                                        }
                                                    })
                                                })

                                                // user.current_trip_id = null;
                                                // user.save();

                                                Trip.findOneAndRemove({
                                                    _id: req.body.trip_id,
                                                }).then(
                                                    (deleted_trip) => {
                                                        if (deleted_trip) {
                                                            var trip_history_data =
                                                                new Trip_history(
                                                                    JSON.parse(
                                                                        JSON.stringify(
                                                                            deleted_trip
                                                                        )
                                                                    )
                                                                )
                                                            trip_history_data.split_payment_users =
                                                                deleted_trip.split_payment_users
                                                            trip_history_data
                                                                .save()
                                                                .then(
                                                                    () => {
                                                                        res.json(
                                                                            {
                                                                                success: true,
                                                                            }
                                                                        )
                                                                    },
                                                                    (error) => {
                                                                        console.log(
                                                                            error
                                                                        )
                                                                    }
                                                                )
                                                        } else {
                                                            res.json({
                                                                success: true,
                                                            })
                                                        }
                                                    },
                                                    (error) => {
                                                        console.log(error)
                                                    }
                                                )
                                            })
                                        } else {
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_YOUR_TRIP_IS_NOT_END,
                                            })
                                        }
                                    })
                                })
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

////////////// PROVIDER DESTINATION RATING SERVICE  //////////////////////////

exports.provider_destination_rating = async function (req, res) {
    try {
        let params_array = [
            { name: 'provider_id', type: 'string' },
            { name: 'trip_id', type: 'string' },
        ]
        let response = await utils.check_request_params_async(
            req.body,
            params_array
        )
        if (!response.success) {
            res.json(response)
            return
        }
        let provider = await Provider.findOne({ _id: req.body.provider_id })
        if (!provider) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
            })
            return
        }

        if (req.body.token != null && provider.token != req.body.token) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_INVALID_TOKEN,
            })
            return
        }

        let trip = await Trip.findOne({ _id: req.body.trip_id, is_trip_end: 1 })
        let Table = Trip
        if (!trip) {
            trip = await Trip_history.findOne({
                _id: req.body.trip_id,
                is_trip_end: 1,
            })
            Table = Trip_history
        }
        if (!trip) {
            return res.json({
                success: false,
                error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
            })
        }

        if (trip.is_trip_end == 0) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_YOUR_TRIP_IS_NOT_END,
            })
            return
        }

        let user = await User.findOne({ _id: trip.user_id })
        if (!user) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
            })
            return
        }

        var rating = req.body.rating
        var old_rate = user.rate
        var old_rate_count = user.rate_count
        var new_rate_counter = old_rate_count + 1
        var new_rate = (old_rate * old_rate_count + rating) / new_rate_counter
        user.rate = new_rate
        user.rate_count++
        await User.updateOne({ _id: user._id }, user.getChanges())
        let review = await Reviews.findOne({ trip_id: trip._id })
        if (!review) {
            var new_review = new Reviews({
                trip_id: trip._id,
                trip_unique_id: trip.unique_id,
                userRating: 0,
                userReview: '',
                userName: user.first_name + ' ' + user.last_name,
                providerRating: 0,
                providerReview: '',
                providerRatingDestination: rating,
                providerReviewDestination: req.body.review,
                provider_id: trip.confirmed_provider,
                user_id: trip.user_id,
            })
            await new_review.save()
        } else {
            review.providerRatingDestination = rating
            review.providerReviewDestination = req.body.review
            await Reviews.updateOne({ _id: review._id }, review.getChanges())
        }
        trip.is_user_destination_rated = 1
        await Table.updateOne({ _id: trip._id }, trip.getChanges())
        res.json({
            success: true,
            message:
                success_messages.MESSAGE_CODE_FOR_PROVIDER_GIVE_RATING_SUCCESSFULLY,
        })
    } catch (error) {
        utils.error_response(error, res)
    }
}

////////////// PROVIDER RATING SERVICE  //////////////////////////

exports.provider_rating = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    is_trip_end: 1,
                                }).then((trip) => {
                                    Trip_history.findOne({
                                        _id: req.body.trip_id,
                                        is_trip_end: 1,
                                    }).then((trip_history) => {
                                        if (!trip) {
                                            trip = trip_history
                                        }
                                        if (trip) {
                                            if (trip.is_trip_end == 1) {
                                                User.findOne({
                                                    _id: trip.user_id,
                                                }).then((user) => {
                                                    var rating = req.body.rating
                                                    var old_rate = user.rate
                                                    var old_rate_count =
                                                        user.rate_count
                                                    var new_rate_counter =
                                                        old_rate_count + 1
                                                    var new_rate =
                                                        (old_rate *
                                                            old_rate_count +
                                                            rating) /
                                                        new_rate_counter
                                                    user.rate = new_rate
                                                    user.rate_count++
                                                    user.save()
                                                    Reviews.findOne({
                                                        trip_id: trip._id,
                                                    }).then((review) => {
                                                        if (!review) {
                                                            var review =
                                                                new Reviews({
                                                                    trip_id:
                                                                        trip._id,
                                                                    trip_unique_id:
                                                                        trip.unique_id,
                                                                    userRating: 0,
                                                                    userReview:
                                                                        '',
                                                                    userName:
                                                                        user.first_name +
                                                                        ' ' +
                                                                        user.last_name,
                                                                    providerRating:
                                                                        rating,
                                                                    providerReview:
                                                                        req.body
                                                                            .review,
                                                                    provider_id:
                                                                        trip.confirmed_provider,
                                                                    user_id:
                                                                        trip.user_id,
                                                                })
                                                            review.save()
                                                        } else {
                                                            review.providerRating =
                                                                rating
                                                            review.providerReview =
                                                                req.body.review
                                                            review.save()
                                                        }
                                                    })
                                                    trip.is_user_rated = 1

                                                    trip.save().then(() => {
                                                        res.json({
                                                            success: true,
                                                            message:
                                                                success_messages.MESSAGE_CODE_FOR_PROVIDER_GIVE_RATING_SUCCESSFULLY,
                                                        })
                                                    })
                                                })
                                            } else {
                                                res.json({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_YOUR_TRIP_IS_NOT_END,
                                                })
                                            }
                                        } else {
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_TRIP_NOT_FOUND,
                                            })
                                        }
                                    })
                                })
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}
////////////////////// USER  RATING  SERVICE/////////////

exports.user_rating = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'user_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user) => {
                        if (user) {
                            if (
                                req.body.token != null &&
                                user.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOneAndUpdate(
                                    {
                                        _id: req.body.trip_id,
                                        is_trip_end: 1,
                                    },
                                    req.body,
                                    { new: true }
                                ).then(
                                    (trip) => {
                                        Trip_history.findOne({
                                            _id: req.body.trip_id,
                                            is_trip_end: 1,
                                        }).then((trip_history) => {
                                            if (!trip) {
                                                trip = trip_history
                                            }
                                            if (trip) {
                                                var is_trip_end =
                                                    trip.is_trip_end
                                                if (is_trip_end == 1) {
                                                    Provider.findOne({
                                                        _id: trip.confirmed_provider,
                                                    }).then((provider) => {
                                                        var rating =
                                                            req.body.rating
                                                        var old_rate =
                                                            provider.rate
                                                        var old_rate_count =
                                                            provider.rate_count
                                                        var new_rate_counter =
                                                            old_rate_count + 1
                                                        var new_rate =
                                                            (old_rate *
                                                                old_rate_count +
                                                                rating) /
                                                            new_rate_counter
                                                        var is_user_invoice_show =
                                                            trip.is_user_invoice_show
                                                        provider.rate = new_rate
                                                        provider.rate_count++
                                                        provider.save()
                                                        Reviews.findOne({
                                                            trip_id: trip._id,
                                                        }).then((review) => {
                                                            if (!review) {
                                                                var reviews =
                                                                    new Reviews(
                                                                        {
                                                                            trip_id:
                                                                                trip._id,
                                                                            trip_unique_id:
                                                                                trip.unique_id,
                                                                            userRating:
                                                                                rating,
                                                                            userReview:
                                                                                req
                                                                                    .body
                                                                                    .review,
                                                                            userName:
                                                                                user.first_name +
                                                                                ' ' +
                                                                                user.last_name,
                                                                            providerRating: 0,
                                                                            providerReview:
                                                                                '',
                                                                            provider_id:
                                                                                trip.confirmed_provider,
                                                                            user_id:
                                                                                trip.user_id,
                                                                        }
                                                                    )
                                                                reviews.save()
                                                            } else {
                                                                review.userRating =
                                                                    rating
                                                                review.userReview =
                                                                    req.body.review
                                                                review.save()
                                                            }
                                                        })

                                                        trip.is_provider_rated = 1
                                                        trip.is_user_invoice_show = 1
                                                        user.completed_request =
                                                            user.completed_request +
                                                            1
                                                        // user.current_trip_id = null;
                                                        user.save()
                                                        trip.save().then(() => {
                                                            if (
                                                                is_user_invoice_show ==
                                                                0
                                                            ) {
                                                                Trip.findOneAndRemove(
                                                                    {
                                                                        _id: req
                                                                            .body
                                                                            .trip_id,
                                                                    }
                                                                ).then(
                                                                    (
                                                                        deleted_trip
                                                                    ) => {
                                                                        if (
                                                                            deleted_trip
                                                                        ) {
                                                                            var trip_history_data =
                                                                                new Trip_history(
                                                                                    JSON.parse(
                                                                                        JSON.stringify(
                                                                                            deleted_trip
                                                                                        )
                                                                                    )
                                                                                )
                                                                            trip_history_data.split_payment_users =
                                                                                deleted_trip.split_payment_users
                                                                            trip_history_data
                                                                                .save()
                                                                                .then(
                                                                                    () => {
                                                                                        res.json(
                                                                                            {
                                                                                                success: true,
                                                                                                message:
                                                                                                    success_messages.MESSAGE_CODE_USER_GIVE_RATING_SUCCESSFULLY,
                                                                                            }
                                                                                        )
                                                                                    },
                                                                                    (
                                                                                        error
                                                                                    ) => {
                                                                                        console.log(
                                                                                            error
                                                                                        )
                                                                                    }
                                                                                )
                                                                        } else {
                                                                            res.json(
                                                                                {
                                                                                    success: true,
                                                                                    message:
                                                                                        success_messages.MESSAGE_CODE_USER_GIVE_RATING_SUCCESSFULLY,
                                                                                }
                                                                            )
                                                                        }
                                                                    },
                                                                    (error) => {
                                                                        console.log(
                                                                            error
                                                                        )
                                                                    }
                                                                )
                                                            } else {
                                                                res.json({
                                                                    success: true,
                                                                    message:
                                                                        success_messages.MESSAGE_CODE_USER_GIVE_RATING_SUCCESSFULLY,
                                                                })
                                                            }
                                                        })
                                                    })
                                                } else {
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_YOUR_TRIP_IS_NOT_END,
                                                    })
                                                }
                                            }
                                        })
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

/////////// USER TRIP DETAIL ///////////////////
exports.user_tripdetail = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'user_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (users) => {
                        if (users.token != req.body.token) {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_INVALID_TOKEN,
                            })
                        } else {
                            Trip.findOne({ _id: req.body.trip_id }).then(
                                (trip) => {
                                    Trip_history.findOne({
                                        _id: req.body.trip_id,
                                    }).then(
                                        (trip_history) => {
                                            if (!trip) {
                                                trip = trip_history
                                            }
                                            if (trip) {
                                                if (
                                                    trip.is_trip_cancelled ==
                                                        0 &&
                                                    trip.is_trip_cancelled_by_user ==
                                                        0 &&
                                                    trip.is_trip_cancelled_by_provider ==
                                                        0 &&
                                                    trip.is_trip_end == 1
                                                ) {
                                                    Trip_Service.findOne({
                                                        _id: trip.trip_service_city_type_id,
                                                    }).then((tripservice) => {
                                                        if (tripservice) {
                                                            TripLocation.findOne(
                                                                {
                                                                    tripID: trip._id,
                                                                }
                                                            ).then(
                                                                (
                                                                    tripLocation
                                                                ) => {
                                                                    Provider.findOne(
                                                                        {
                                                                            _id: trip.confirmed_provider,
                                                                        }
                                                                    ).then(
                                                                        async (
                                                                            provider
                                                                        ) => {
                                                                            let cedula =
                                                                                await Provider_Document.findOne(
                                                                                    {
                                                                                        provider_id:
                                                                                            provider._id,
                                                                                        name: 'Cédula',
                                                                                    }
                                                                                )
                                                                            cedula =
                                                                                cedula
                                                                                    ? cedula.unique_code
                                                                                    : ''
                                                                            res.json(
                                                                                {
                                                                                    success: true,
                                                                                    message:
                                                                                        success_messages.MESSAGE_CODE_HISTORY_DETAIL_GET_SUCCESSFULLY,
                                                                                    trip: trip,
                                                                                    tripservice:
                                                                                        tripservice,
                                                                                    provider:
                                                                                        provider,
                                                                                    startTripToEndTripLocations:
                                                                                        tripLocation.startTripToEndTripLocations,
                                                                                    cedula: cedula,
                                                                                }
                                                                            )
                                                                        }
                                                                    )
                                                                }
                                                            )
                                                        } else {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_TRIP_SERVICE_NOT_FOUND,
                                                            })
                                                        }
                                                    })
                                                } else {
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_TRIP_IS_ALREADY_CANCELLED,
                                                    })
                                                }
                                            } else {
                                                res.json({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_YOUR_TRIP_DETAIL_NOT_FOUND,
                                                })
                                            }
                                        },
                                        (err) => {
                                            console.log(err)
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                            })
                                        }
                                    )
                                }
                            )
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

///////// PROVIDER TRIP DETAIL  //////////////
exports.provider_tripdetail = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider.token != req.body.token) {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_INVALID_TOKEN,
                            })
                        } else {
                            Trip.findOne({ _id: req.body.trip_id }).then(
                                (trip) => {
                                    Trip_history.findOne({
                                        _id: req.body.trip_id,
                                    }).then(
                                        (trip_history) => {
                                            if (!trip) {
                                                trip = trip_history
                                            }
                                            if (trip) {
                                                if (
                                                    trip.is_trip_cancelled ==
                                                        0 &&
                                                    trip.is_trip_cancelled_by_user ==
                                                        0 &&
                                                    trip.is_trip_cancelled_by_provider ==
                                                        0 &&
                                                    trip.is_trip_end == 1
                                                ) {
                                                    Trip_Service.findOne({
                                                        _id: trip.trip_service_city_type_id,
                                                    }).then((tripservice) => {
                                                        if (tripservice) {
                                                            TripLocation.findOne(
                                                                {
                                                                    tripID: trip._id,
                                                                }
                                                            ).then(
                                                                (
                                                                    tripLocation
                                                                ) => {
                                                                    User.findOne(
                                                                        {
                                                                            _id: trip.user_id,
                                                                        }
                                                                    ).then(
                                                                        (
                                                                            user
                                                                        ) => {
                                                                            res.json(
                                                                                {
                                                                                    success: true,
                                                                                    message:
                                                                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_DETAIL_GET_SUCCESSFULLY,
                                                                                    trip: trip,
                                                                                    tripservice:
                                                                                        tripservice,
                                                                                    user: user,
                                                                                    startTripToEndTripLocations:
                                                                                        tripLocation.startTripToEndTripLocations,
                                                                                }
                                                                            )
                                                                        }
                                                                    )
                                                                }
                                                            )
                                                        } else {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_TRIP_SERVICE_NOT_FOUND,
                                                            })
                                                        }
                                                    })
                                                } else {
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_TRIP_IS_ALREADY_CANCELLED,
                                                    })
                                                }
                                            } else {
                                                res.json({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_YOUR_TRIP_DETAIL_NOT_FOUND,
                                                })
                                            }
                                        },
                                        (err) => {
                                            console.log(err)
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                            })
                                        }
                                    )
                                }
                            )
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

// user_invoice //
exports.user_invoice = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'user_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user) => {
                        if (user) {
                            if (
                                req.body.token != null &&
                                user.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({ _id: req.body.trip_id }).then(
                                    (trip) => {
                                        Trip_history.findOne({
                                            _id: req.body.trip_id,
                                        }).then((trip_history) => {
                                            if (!trip) {
                                                trip = trip_history
                                            }
                                            if (trip) {
                                                if (
                                                    trip.is_trip_cancelled ==
                                                        0 &&
                                                    trip.is_trip_cancelled_by_provider ==
                                                        0
                                                ) {
                                                    Provider.findOne({
                                                        _id: trip.provider_id,
                                                    }).then((provider) => {
                                                        Trip_Service.findOne({
                                                            _id: trip.trip_service_city_type_id,
                                                        }).then(
                                                            (tripservice) => {
                                                                if (
                                                                    !tripservice
                                                                ) {
                                                                    res.json({
                                                                        success: false,
                                                                        error_code:
                                                                            error_message.ERROR_CODE_TRIP_SERVICE_NOT_FOUND,
                                                                    })
                                                                } else {
                                                                    var email_notification =
                                                                        setting_detail.email_notification
                                                                    if (
                                                                        email_notification ==
                                                                        true
                                                                    ) {
                                                                    }

                                                                    res.json({
                                                                        success: true,
                                                                        message:
                                                                            success_messages.MESSAGE_CODE_GET_YOUR_INVOICE_SUCCESSFULLY,
                                                                        trip: trip,
                                                                        tripservice:
                                                                            tripservice,
                                                                        provider_detail:
                                                                            {
                                                                                first_name:
                                                                                    provider.first_name,
                                                                                last_name:
                                                                                    provider.last_name,
                                                                                picture:
                                                                                    provider.picture,
                                                                            },
                                                                    })
                                                                }
                                                            }
                                                        )
                                                    })
                                                } else {
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_TRIP_IS_ALREADY_CANCELLED,
                                                    })
                                                }
                                            } else {
                                                res.json({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_TRIP_NOT_FOUND,
                                                })
                                            }
                                        })
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

// provider_invoice //
exports.provider_invoice = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                Provider.findOne({ _id: req.body.provider_id }).then(
                    (provider) => {
                        if (provider) {
                            if (
                                req.body.token != null &&
                                provider.token != req.body.token
                            ) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({ _id: req.body.trip_id }).then(
                                    (trip) => {
                                        Trip_history.findOne({
                                            _id: req.body.trip_id,
                                        }).then((trip_history) => {
                                            if (!trip) {
                                                trip = trip_history
                                            }
                                            if (trip) {
                                                let is_truck_owner = 0
                                                let truck_index =
                                                    provider.partner_ids.findIndex(
                                                        (e) =>
                                                            e.partner_id.toString() ==
                                                                trip.provider_type_id?.toString() &&
                                                            e.truck_owner == 1
                                                    )
                                                if (truck_index != -1) {
                                                    is_truck_owner = 1
                                                }

                                                if (
                                                    trip.is_trip_cancelled ==
                                                        0 &&
                                                    trip.is_trip_cancelled_by_provider ==
                                                        0
                                                ) {
                                                    Trip_Service.findOne({
                                                        _id: trip.trip_service_city_type_id,
                                                    }).then((tripservice) => {
                                                        if (!tripservice) {
                                                            res.json({
                                                                success: false,
                                                                error_code:
                                                                    error_message.ERROR_CODE_TRIP_SERVICE_NOT_FOUND,
                                                            })
                                                        } else {
                                                            var email_notification =
                                                                setting_detail.email_notification
                                                            if (
                                                                email_notification ==
                                                                true
                                                            ) {
                                                            }

                                                            res.json({
                                                                success: true,
                                                                message:
                                                                    success_messages.MESSAGE_CODE_GET_INVOICE_SUCCESSFULLY,
                                                                trip: trip,
                                                                tripservice:
                                                                    tripservice,
                                                                is_truck_owner:
                                                                    is_truck_owner,
                                                            })
                                                        }
                                                    })
                                                } else {
                                                    res.json({
                                                        success: false,
                                                        error_code:
                                                            error_message.ERROR_CODE_TRIP_IS_ALREADY_CANCELLED,
                                                    })
                                                }
                                            } else {
                                                res.json({
                                                    success: false,
                                                    error_code:
                                                        error_message.ERROR_CODE_TRIP_NOT_FOUND,
                                                })
                                            }
                                        })
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}
////////////////////////////////////

////////////////////////// USER SET DESTINATION ///////////////////////////////////////
exports.user_setdestination = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'user_id', type: 'string' },
            {
                name: 'trip_id',
                type: 'string',
            },
        ],
        function (response) {
            if (response.success) {
                User.findOne({ _id: req.body.user_id }).then(
                    (user) => {
                        if (user) {
                            if (user.token != req.body.token) {
                                res.json({
                                    success: false,
                                    error_code:
                                        error_message.ERROR_CODE_INVALID_TOKEN,
                                })
                            } else {
                                Trip.findOne({
                                    _id: req.body.trip_id,
                                    is_trip_cancelled: 0,
                                    is_trip_cancelled_by_provider: 0,
                                    user_id: req.body.user_id,
                                    is_trip_end: 0,
                                }).then(
                                    (trip) => {
                                        if (trip) {
                                            Provider.findOne({
                                                _id: trip.confirmed_provider,
                                            }).then((providers) => {
                                                var device_token =
                                                    providers.device_token
                                                var device_type =
                                                    providers.device_type
                                                //////////////////////  PUSH NOTIFICATION ///////////
                                                utils.sendPushNotification(
                                                    constant_json.PROVIDER_UNIQUE_NUMBER,
                                                    device_type,
                                                    device_token,
                                                    push_messages.PUSH_CODE_FOR_SET_DESTINATION,
                                                    constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS
                                                )
                                            })
                                            trip.destination_address =
                                                req.body.destination_address
                                            trip.destinationLocation = [
                                                req.body.d_latitude,
                                                req.body.d_longitude,
                                            ]
                                            trip.save().then(() => {
                                                utils.update_request_status_socket(
                                                    trip._id
                                                )
                                                res.json({
                                                    success: true,
                                                    message:
                                                        success_messages.MESSAGE_CODE_SET_DESTINATION_SUCCESSFULLY,
                                                    destinationLocation:
                                                        trip.destinationLocation,
                                                })
                                            })
                                        } else {
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_DESTINATION_NOT_SET,
                                            })
                                        }
                                    },
                                    (err) => {
                                        console.log(err)
                                        res.json({
                                            success: false,
                                            error_code:
                                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                                        })
                                    }
                                )
                            }
                        } else {
                            res.json({
                                success: false,
                                error_code:
                                    error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
                            })
                        }
                    },
                    (err) => {
                        console.log(err)
                        res.json({
                            success: false,
                            error_code:
                                error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}
// getgooglemappath

exports.getgooglemappath = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'trip_id', type: 'string' }],
        function (response) {
            if (response.success) {
                TripLocation.findOne({ tripID: req.body.trip_id }).then(
                    (tripLocation) => {
                        if (tripLocation) {
                            res.json({
                                success: true,
                                triplocation: tripLocation,
                            })
                        } else {
                            res.json({ success: false })
                        }
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}
//setgooglemappath
// Función para optimizar rutas con origen, destino y paradas
// Función para obtener información de ruta optimizada
exports.get_optimized_route = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'trip_id', type: 'string' }],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }

            try {
                let trip = await Trip.findOne({ _id: req.body.trip_id })
                if (!trip) {
                    trip = await Trip_history.findOne({ _id: req.body.trip_id })
                }

                if (!trip) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
                    })
                }

                const routeInfo = {
                    origin: {
                        lat: trip.sourceLocation[0],
                        lng: trip.sourceLocation[1],
                        address: trip.source_address,
                    },
                    destination: {
                        lat: trip.destinationLocation[0],
                        lng: trip.destinationLocation[1],
                        address: trip.destination_address,
                    },
                    waypoints: trip.destination_addresses || [],
                    optimize_field: trip.optimize_field || null,
                    total_stops: (trip.destination_addresses || []).length,
                }

                res.json({
                    success: true,
                    route_info: routeInfo,
                })
            } catch (error) {
                console.log(error)
                res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                })
            }
        }
    )
}

const { optimizeWaypointOrder } = require('../../utils/routeOptimization')

exports.optimize_route = function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'trip_id', type: 'string' },
            { name: 'waypoints', type: 'object' },
        ],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }

            try {
                let trip = await Trip.findOne({ _id: req.body.trip_id })
                if (!trip) {
                    trip = await Trip_history.findOne({ _id: req.body.trip_id })
                }

                if (!trip) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
                    })
                }

                // Construir la ruta optimizada
                const origin = {
                    lat: trip.sourceLocation[0],
                    lng: trip.sourceLocation[1],
                    address: trip.source_address,
                }

                const destination = {
                    lat: trip.destinationLocation[0],
                    lng: trip.destinationLocation[1],
                    address: trip.destination_address,
                }

                // Combinar paradas de destination_addresses y waypoints del request
                let waypoints = []

                // Agregar paradas existentes del viaje
                if (
                    trip.destination_addresses &&
                    trip.destination_addresses.length > 0
                ) {
                    waypoints = trip.destination_addresses.map((stop) => ({
                        lat: stop.location[0],
                        lng: stop.location[1],
                        address: stop.address,
                        stops_inside: stop.stops_inside || [],
                        stop_username: stop.stop_username || '',
                        stop_user_phone: stop.stop_user_phone || '',
                    }))
                }

                // Agregar nuevas paradas del request
                if (req.body.waypoints && req.body.waypoints.length > 0) {
                    const newWaypoints = req.body.waypoints.map((wp) => ({
                        lat: wp.lat,
                        lng: wp.lng,
                        address: wp.address || '',
                        stops_inside: wp.stops_inside || [],
                        stop_username: wp.stop_username || '',
                        stop_user_phone: wp.stop_user_phone || '',
                    }))
                    waypoints = waypoints.concat(newWaypoints)
                }

                // Optimizar el orden de las paradas usando algoritmo de vecino más cercano
                if (waypoints.length > 1) {
                    waypoints = optimizeWaypointOrder(
                        origin,
                        destination,
                        waypoints
                    )
                }

                // Actualizar el campo optimize_field con la ruta optimizada
                const optimizedRoute = {
                    origin: origin,
                    destination: destination,
                    waypoints: waypoints,
                    optimized: true,
                    created_at: new Date(),
                }

                // Actualizar el trip con la ruta optimizada
                if (trip.constructor.modelName === 'Trip') {
                    await Trip.updateOne(
                        { _id: trip._id },
                        {
                            optimize_field: optimizedRoute,
                            destination_addresses: waypoints.map((wp) => ({
                                address: wp.address,
                                location: [wp.lat, wp.lng],
                                stops_inside: wp.stops_inside,
                                stop_username: wp.stop_username,
                                stop_user_phone: wp.stop_user_phone,
                            })),
                        }
                    )
                } else {
                    await Trip_history.updateOne(
                        { _id: trip._id },
                        {
                            optimize_field: optimizedRoute,
                            destination_addresses: waypoints.map((wp) => ({
                                address: wp.address,
                                location: [wp.lat, wp.lng],
                                stops_inside: wp.stops_inside,
                                stop_username: wp.stop_username,
                                stop_user_phone: wp.stop_user_phone,
                            })),
                        }
                    )
                }

                res.json({
                    success: true,
                    message: 'Ruta optimizada exitosamente',
                    optimized_route: optimizedRoute,
                    waypoints_count: waypoints.length,
                })
            } catch (error) {
                console.log(error)
                res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                })
            }
        }
    )
}

exports.setgooglemappath = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'trip_id', type: 'string' }],
        function (response) {
            if (response.success) {
                TripLocation.findOne({ tripID: req.body.trip_id }).then(
                    (tripLocation) => {
                        tripLocation.googlePickUpLocationToDestinationLocation =
                            req.body.googlePickUpLocationToDestinationLocation
                        tripLocation.googlePathStartLocationToPickUpLocation =
                            req.body.googlePathStartLocationToPickUpLocation
                        tripLocation.save().then(() => {
                            res.json({ success: true })
                        })
                    }
                )
            } else {
                res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
        }
    )
}

exports.check_trip_inside_zone_queue = function (
    city_id,
    latitude,
    longitude,
    res_data
) {
    CityZone.find({ cityid: city_id }, function (error, zone_queue_list) {
        if (zone_queue_list.length > 0) {
            var is_trip_inside_zone_queue = false
            zone_queue_list.forEach(function (zone_queue_data, index) {
                var geo = geolib.isPointInside(
                    { latitude: latitude, longitude: longitude },
                    zone_queue_data.kmlzone
                )
                if (geo) {
                    is_trip_inside_zone_queue = true
                }
                if (index == zone_queue_list.length - 1) {
                    res_data({
                        is_trip_inside_zone_queue: is_trip_inside_zone_queue,
                        zone_queue_id: zone_queue_data._id,
                    })
                }
            })
        } else {
            res_data({ is_trip_inside_zone_queue: false, zone_queue_id: null })
        }
    })
}

exports.twilio_voice_call = function (req, res) {
    var trip_id = req.body.trip_id
    // console.log("twilio_voice_call")
    // console.log(req.body)
    Trip.findOne({ _id: trip_id }, function (err, trip) {
        if (trip) {
            var user_id = trip.user_id
            var provider_id = trip.confirmed_provider

            var twilio_account_sid = setting_detail.twilio_account_sid
            var twilio_auth_token = setting_detail.twilio_auth_token
            var twilio_number = setting_detail.twilio_number
            var client = require('twilio')(
                twilio_account_sid,
                twilio_auth_token
            )
            var twiml_url = setting_detail.twiml_url

            if (req.body.type == 1) {
                Provider.findOne(
                    { _id: provider_id },
                    function (err, provider) {
                        User.findOne({ _id: user_id }, function (err, user) {
                            if (provider) {
                                var provider_number =
                                    provider.country_phone_code + provider.phone
                                var user_number =
                                    user.country_phone_code + user.phone

                                twiml_url = twiml_url + '?to=' + provider_number
                                client.calls.create(
                                    {
                                        url: twiml_url,
                                        to: user_number,
                                        from: twilio_number,
                                    },
                                    function (err) {
                                        if (err) {
                                            console.log(err)
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_TWILIO_SERVICE_NOT_AVAILABLE,
                                            })
                                        } else {
                                            res.json({ success: true })
                                        }
                                    }
                                )
                            }
                        })
                    }
                )
            } else {
                User.findOne({ _id: user_id }, function (err, user) {
                    Provider.findOne(
                        { _id: provider_id },
                        function (err, provider) {
                            if (user) {
                                var provider_number =
                                    provider.country_phone_code + provider.phone
                                var user_number =
                                    user.country_phone_code + user.phone
                                twiml_url = twiml_url + '?to=' + user_number

                                client.calls.create(
                                    {
                                        url: twiml_url,
                                        to: provider_number,
                                        from: twilio_number,
                                    },
                                    function (err) {
                                        if (err) {
                                            console.log(err)
                                            res.json({
                                                success: false,
                                                error_code:
                                                    error_message.ERROR_CODE_TWILIO_SERVICE_NOT_AVAILABLE,
                                            })
                                        } else {
                                            res.json({ success: true })
                                        }
                                    }
                                )
                            }
                        }
                    )
                })
            }
        } else {
            res.json({ success: false })
        }
    })
}

exports.refund_amount_in_wallet = function (req, res) {
    if (typeof req.session.userid == 'undefined') {
        return res.json({ success: false })
    }
    utils.check_request_params(
        req.body,
        [{ name: 'trip_id', type: 'string' }],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
            let trip = await Trip.findOne({ _id: req.body.trip_id })
            let amount = Number(req.body.amount)
            if (!trip) {
                trip = await Trip_history.findOne({ _id: req.body.trip_id })
            }
            if (!trip) {
                return res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_TRIP_NOT_FOUND,
                })
            }
            let user_data = await User.findById(trip.user_id)
            let status = constant_json.ADD_WALLET_AMOUNT
            let total_wallet_amount = utils.addWalletHistory(
                constant_json.USER_UNIQUE_NUMBER,
                user_data.unique_id,
                user_data._id,
                user_data.country_id,
                user_data.wallet_currency_code,
                user_data.wallet_currency_code,
                1,
                Math.abs(amount),
                user_data.wallet,
                status,
                constant_json.ADDED_BY_ADMIN,
                'Refund Of This Trip : ' + trip.unique_id
            )
            user_data.wallet = total_wallet_amount
            await user_data.save()

            trip.refund_amount += amount
            trip.is_amount_refund = true
            await trip.save()

            message = admin_messages.success_message_refund
            res.json({ success: true })
        }
    )
}

exports.refund_amount_in_card = function (req, res) {
    if (typeof req.session.userid == 'undefined') {
        return res.json({ success: false })
    }
    utils.check_request_params(
        req.body,
        [{ name: 'trip_id', type: 'string' }],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
            let trip = await Trip.findOne({ _id: req.body.trip_id })
            if (!trip) {
                trip = await Trip_history.findOne({ _id: req.body.trip_id })
            }
            if (!trip) {
                return res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_TRIP_NOT_FOUND,
                })
            }

            if (
                !trip.payment_gateway_type ||
                trip.payment_gateway_type == PAYMENT_GATEWAY.stripe
            ) {
                cards.refund_payment(
                    trip.payment_intent_id,
                    PAYMENT_GATEWAY.stripe
                )
            } else if (trip.payment_gateway_type == PAYMENT_GATEWAY.paystack) {
                cards.refund_payment(
                    trip.payment_intent_id,
                    PAYMENT_GATEWAY.paystack
                )
            } else if (trip.payment_gateway_type == PAYMENT_GATEWAY.payu) {
                cards.refund_payment(trip._id, PAYMENT_GATEWAY.payu)
            }
            trip.refund_amount += trip.card_payment
            trip.is_amount_refund = true
            await trip.save()

            message = admin_messages.success_message_refund
            res.json({ success: true })
        }
    )
}

exports.pay_by_other_payment_mode = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'trip_id', type: 'string' }],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
            let trip = await Trip.findOne({ _id: req.body.trip_id })

            if (!trip) {
                trip = await Trip_history.findOne({ _id: req.body.trip_id })
            }

            if (!trip) {
                return res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_TRIP_NOT_FOUND,
                })
            }

            let city = await City.findOne({ _id: trip.city_id })
            let provider = await Provider.findOne({
                _id: trip.confirmed_provider,
            })
            let user = await User.findOne({ _id: trip.user_id })
            let corporate = await Corporate.findOne({ _id: trip.user_type_id })

            let is_main_user = true
            let split_payment_index = null
            trip.split_payment_users.forEach(
                (split_payment_user_detail, index) => {
                    if (
                        split_payment_user_detail.user_id.toString() ==
                        req.body.user_id.toString()
                    ) {
                        is_main_user = false
                        split_payment_index = index
                    }
                }
            )

            if (city.is_payment_mode_cash == 1) {
                var wallet_payment = 0
                var remaining_payment = 0

                if (is_main_user) {
                    var total = trip.remaining_payment
                    var total_after_wallet_payment = trip.remaining_payment
                    total_after_wallet_payment = Number(
                        total_after_wallet_payment.toFixed(2)
                    )
                    wallet_payment = Number(wallet_payment.toFixed(2))
                    remaining_payment = total - wallet_payment
                    remaining_payment = Number(remaining_payment.toFixed(2))
                    trip.wallet_payment += wallet_payment
                    trip.total_after_wallet_payment = total_after_wallet_payment
                    trip.remaining_payment = remaining_payment
                    trip.payment_status = PAYMENT_STATUS.COMPLETED

                    trip.payment_mode = constant_json.PAYMENT_MODE_CASH
                    trip.provider_have_cash = remaining_payment
                    trip.pay_to_provider =
                        trip.provider_service_fees - trip.provider_have_cash

                    trip.is_paid = 1
                    trip.is_pending_payments = 0
                    trip.cash_payment = remaining_payment
                    trip.remaining_payment = 0
                    await trip.save()
                } else {
                    remaining_payment =
                        trip.split_payment_users[split_payment_index]
                            .remaining_payment
                    trip.split_payment_users[
                        split_payment_index
                    ].remaining_payment = 0
                    trip.split_payment_users[split_payment_index].cash_payment =
                        remaining_payment
                    trip.split_payment_users[
                        split_payment_index
                    ].payment_status = PAYMENT_STATUS.COMPLETED
                    trip.split_payment_users[split_payment_index].payment_mode =
                        constant_json.PAYMENT_MODE_CASH
                    trip.cash_payment = trip.cash_payment + remaining_payment
                    trip.provider_have_cash =
                        trip.provider_have_cash + remaining_payment
                    trip.markModified('split_payment_users')
                    trip.save()
                }
            } else {
                var wallet_payment = 0
                var remaining_payment = 0
                if (is_main_user) {
                    var total = trip.remaining_payment
                    var total_after_wallet_payment = trip.remaining_payment

                    wallet_payment = total_after_wallet_payment
                    if (
                        trip.trip_type == constant_json.TRIP_TYPE_CORPORATE &&
                        corporate
                    ) {
                        var total_wallet_amount = utils.addWalletHistory(
                            constant_json.USER_UNIQUE_NUMBER,
                            corporate.unique_id,
                            corporate._id,
                            null,
                            corporate.wallet_currency_code,
                            trip.currencycode,
                            trip.wallet_current_rate,
                            wallet_payment,
                            corporate.wallet,
                            constant_json.DEDUCT_WALLET_AMOUNT,
                            constant_json.PAID_TRIP_AMOUNT,
                            'Charge Of This Trip : ' + trip.unique_id
                        )
                        corporate.wallet = total_wallet_amount
                        await corporate.save()
                        user.corporate_wallet_limit =
                            user.corporate_wallet_limit - wallet_payment
                    } else {
                        var total_wallet_amount = utils.addWalletHistory(
                            constant_json.USER_UNIQUE_NUMBER,
                            user.unique_id,
                            user._id,
                            null,
                            user.wallet_currency_code,
                            trip.currencycode,
                            trip.wallet_current_rate,
                            wallet_payment,
                            user.wallet,
                            constant_json.DEDUCT_WALLET_AMOUNT,
                            constant_json.PAID_TRIP_AMOUNT,
                            'Charge Of This Trip : ' + trip.unique_id
                        )
                        user.wallet = total_wallet_amount
                    }
                    await user.save()

                    total_after_wallet_payment =
                        total_after_wallet_payment - wallet_payment

                    total_after_wallet_payment = Number(
                        total_after_wallet_payment.toFixed(2)
                    )
                    wallet_payment = Number(wallet_payment.toFixed(2))
                    remaining_payment = total - wallet_payment
                    remaining_payment = Number(remaining_payment.toFixed(2))
                    trip.wallet_payment += wallet_payment
                    trip.total_after_wallet_payment = total_after_wallet_payment
                    trip.remaining_payment = remaining_payment
                    trip.payment_status = PAYMENT_STATUS.COMPLETED

                    trip.is_paid = 1
                    trip.is_pending_payments = 0
                    trip.card_payment = 0
                    await trip.save()
                } else {
                    remaining_payment =
                        trip.split_payment_users[split_payment_index]
                            .remaining_payment
                    User.findOne({ _id: split_user.user_id }).then(
                        (split_user_detail) => {
                            var total_wallet_amount = utils.addWalletHistory(
                                constant_json.USER_UNIQUE_NUMBER,
                                split_user_detail.unique_id,
                                split_user_detail._id,
                                null,
                                split_user_detail.wallet_currency_code,
                                trip.currencycode,
                                trip.wallet_current_rate,
                                remaining_payment,
                                split_user_detail.wallet,
                                constant_json.DEDUCT_WALLET_AMOUNT,
                                constant_json.PAID_TRIP_AMOUNT,
                                'Charge Of This Trip : ' + trip.unique_id
                            )
                            split_user_detail.wallet = total_wallet_amount
                            split_user_detail.save()

                            trip.split_payment_users[
                                split_payment_index
                            ].remaining_payment = 0
                            trip.split_payment_users[
                                split_payment_index
                            ].wallet_payment = remaining_payment
                            trip.split_payment_users[
                                split_payment_index
                            ].payment_status = PAYMENT_STATUS.COMPLETED
                            trip.wallet_payment =
                                trip.wallet_payment + remaining_payment
                            trip.markModified('split_payment_users')
                            trip.save()
                        }
                    )
                }
            }

            await utils.trip_provider_profit_card_wallet_settlement(
                trip,
                city,
                provider
            )
            utils.update_request_status_socket(trip._id)
            if (trip.payment_status == PAYMENT_STATUS.COMPLETED) {
                Trip.findOneAndRemove({ _id: trip._id }).then(
                    (deleted_trip) => {
                        if (deleted_trip) {
                            var trip_history_data = new Trip_history(
                                JSON.parse(JSON.stringify(deleted_trip))
                            )
                            trip_history_data.split_payment_users =
                                deleted_trip.split_payment_users
                            trip_history_data.save(function () {
                                return res.json({
                                    success: true,
                                    message:
                                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                    payment_status: trip.payment_status,
                                })
                            })
                        } else {
                            return res.json({
                                success: true,
                                message:
                                    success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                                payment_status: trip.payment_status,
                            })
                        }
                    }
                )
            } else {
                return res.json({
                    success: true,
                    message:
                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOUR_TRIP_COMPLETED_SUCCESSFULLY,
                    payment_status: trip.payment_status,
                })
            }
        }
    )
}

exports.provider_set_trip_stop_status = function (req, res) {
    // console.log("Set Trip Stop")
    // console.log(req.body)

    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            { name: 'token', type: 'string' },
            { name: 'trip_id', type: 'string' },
            { name: 'address', type: 'string' },
            { name: 'latitude', type: 'number' },
            { name: 'longitude', type: 'number' },
        ],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }
            try {
                let provider = await Provider.findOne({
                    _id: req.body.provider_id,
                })
                if (!provider) {
                    return res.json({
                        success: false,
                        error_code:
                            error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                    })
                }
                if (
                    req.body.token != null &&
                    provider.token != req.body.token
                ) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_INVALID_TOKEN,
                    })
                }
                let trip = await Trip.findOne({
                    _id: req.body.trip_id,
                    confirmed_provider: req.body.provider_id,
                })
                if (!trip) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
                    })
                }
                if (
                    trip.is_trip_cancelled != 0 &&
                    trip.is_trip_cancelled_by_provider != 0
                ) {
                    return res.json({
                        success: false,
                        error_code:
                            error_message.ERROR_CODE_MISMATCH_PROVIDER_ID_OR_TRIP_ID,
                    })
                }
                let now = new Date()
                if (
                    req.body.is_destination_stop &&
                    req.body.is_destination_stop == 1
                ) {
                    trip.actual_destination_stops[
                        trip.actual_destination_stops.length - 1
                    ].address = req.body.address
                    trip.actual_destination_stops[
                        trip.actual_destination_stops.length - 1
                    ].location = [
                        Number(req.body.latitude),
                        Number(req.body.longitude),
                    ]
                    trip.actual_destination_stops[
                        trip.actual_destination_stops.length - 1
                    ].arrived_time = now
                    var time_diff = Math.abs(
                        utils.getTimeDifferenceInMinute(
                            now,
                            trip.actual_destination_stops[
                                trip.actual_destination_stops.length - 1
                            ].start_time
                        )
                    )
                    if (time_diff < 0) {
                        time_diff = 0
                    }
                    trip.actual_destination_stops[
                        trip.actual_destination_stops.length - 1
                    ].total_time = time_diff
                    trip.markModified('actual_destination_stops')
                } else {
                    let city_address =
                        trip.actual_destination_addresses[
                            Number(req.body.city_index) - 1
                        ]
                    if (
                        trip.destination_addresses[
                            Number(req.body.city_index) - 1
                        ].stops_inside.length > 0
                    ) {
                        city_address.stops_inside[
                            city_address.stops_inside.length - 1
                        ].address = req.body.address
                        city_address.stops_inside[
                            city_address.stops_inside.length - 1
                        ].location = [
                            Number(req.body.latitude),
                            Number(req.body.longitude),
                        ]
                        city_address.stops_inside[
                            city_address.stops_inside.length - 1
                        ].arrived_time = now
                        city_address.arrived_time = now
                        let time_diff = Math.abs(
                            utils.getTimeDifferenceInMinute(
                                now,
                                city_address.stops_inside[
                                    city_address.stops_inside.length - 1
                                ].start_time
                            )
                        )
                        if (time_diff < 0) {
                            time_diff = 0
                        }

                        city_address.stops_inside[
                            city_address.stops_inside.length - 1
                        ].total_time = time_diff
                        const stops = city_address.stops_inside
                        const total_waiting_time = stops.reduce(
                            (acc, stop) => acc + stop.waiting_time,
                            0
                        )
                        city_address.waiting_time = total_waiting_time
                        const total_city_time = stops.reduce(
                            (acc, stop) => acc + stop.total_time,
                            0
                        )
                        city_address.total_time = total_city_time
                    } else {
                        city_address.address = req.body.address
                        city_address.location = [
                            Number(req.body.latitude),
                            Number(req.body.longitude),
                        ]

                        city_address.arrived_time = now
                        let time_diff = Math.abs(
                            utils.getTimeDifferenceInMinute(
                                now,
                                city_address.start_time
                            )
                        )
                        if (time_diff < 0) {
                            time_diff = 0
                        }
                        city_address.total_time = time_diff
                    }
                    // trip.actual_destination_addresses[trip.actual_destination_addresses.length - 1].address = req.body.address;
                    // trip.actual_destination_addresses[trip.actual_destination_addresses.length - 1].location = [Number(req.body.latitude), Number(req.body.longitude)];
                    // trip.actual_destination_addresses[trip.actual_destination_addresses.length - 1].arrived_time = now;

                    trip.actual_destination_addresses[
                        Number(req.body.city_index) - 1
                    ] = city_address
                    trip.markModified('actual_destination_addresses')
                }
                await trip.save()

                utils.update_request_status_socket(trip._id)
                return res.json({
                    success: true,
                    message:
                        success_messages.MESSAGE_CODE_FOR_PROVIDER_YOU_SET_TRIP_STATUS_SUCCESSFULLY,
                    trip: trip,
                })
            } catch (e) {
                console.log(e)
                return res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
                })
            }
        }
    )
}

exports.get_provider_assigned_trips = function (req, res) {
    utils.check_request_params(
        req.body,
        [{ name: 'provider_id', type: 'string' }],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }

            let provider = await Provider.findOne({
                _id: Schema(req.body.provider_id),
            })
            if (!provider) {
                return res.json({
                    success: false,
                    error_code:
                        error_message.ERROR_CODE_PROVIDER_DETAIL_NOT_FOUND,
                })
            }

            if (provider.token != req.body.token) {
                return res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_INVALID_TOKEN,
                })
            }

            let lookup1 = {
                $lookup: {
                    from: 'users',
                    localField: 'user_id',
                    foreignField: '_id',
                    as: 'user_detail',
                },
            }
            let unwind1 = { $unwind: '$user_detail' }

            let condition = {
                $match: {
                    assigned_provider_id: { $eq: Schema(req.body.provider_id) },
                    is_trip_cancelled: 0,
                    is_trip_completed: 0,
                    provider_id: null,
                },
            }

            let group = {
                $project: {
                    trip_id: '$_id',
                    unique_id: 1,
                    invoice_number: 1,
                    current_provider: 1,
                    provider_service_fees: 1,
                    is_trip_cancelled_by_user: 1,
                    is_trip_cancelled: 1,
                    is_user_rated: 1,
                    is_trip_completed: 1,
                    is_provider_rated: 1,
                    is_trip_cancelled_by_provider: 1,
                    user_first_name: '$user_detail.first_name',
                    user_last_name: '$user_detail.last_name',
                    picture: '$user_detail.picture',
                    total: 1,
                    unit: 1,
                    currency: 1,
                    currencycode: 1,
                    total_time: 1,
                    user_create_time: 1,
                    total_distance: 1,
                    source_address: 1,
                    destination_address: 1,
                    destination_addresses: 1,
                    provider_trip_end_time: 1,
                    timezone: 1,
                    created_at: 1,
                    server_start_time_for_schedule: 1,
                    is_provider_confirm_trip: 1,
                    drop_trip_status: 1,
                },
            }

            let start_date = req.body.start_date
            let end_date = req.body.end_date
            if (end_date == '' || end_date == undefined) {
                end_date = new Date()
            } else {
                end_date = new Date(end_date)
                end_date = end_date.setHours(23, 59, 59, 999)
                end_date = new Date(end_date)
            }

            if (start_date == '' || start_date == undefined) {
                start_date = new Date(0)
                start_date = start_date.setHours(0, 0, 0, 0)
                start_date = new Date(start_date)
            } else {
                start_date = new Date(start_date)
                start_date = start_date.setHours(0, 0, 0, 0)
                start_date = new Date(start_date)
            }
            let query1 = {}
            query1['created_at'] = { $gte: start_date, $lt: end_date }
            let filter = { $match: query1 }

            let number_of_rec = 10
            let page = req.body.page || 1
            let skip = {}
            skip['$skip'] = (page - 1) * number_of_rec

            let limit = {}
            limit['$limit'] = number_of_rec
            let sort = { $sort: { created_at: -1 } }

            let trips = await Trip.aggregate([
                condition,
                lookup1,
                unwind1,
                filter,
                group,
                sort,
                skip,
                limit,
            ])
            return res.json({ success: true, trips: trips })
        }
    )
}

exports.provider_confirm_trip = async function (req, res) {
    utils.check_request_params(
        req.body,
        [
            { name: 'provider_id', type: 'string' },
            { name: 'trip_id', type: 'string' },
        ],
        async function (response) {
            if (!response.success) {
                return res.json({
                    success: false,
                    error_code: response.error_code,
                    error_description: response.error_description,
                })
            }

            let trip = await Trip.findOne({
                _id: Schema(req.body.trip_id),
                assigned_provider_id: Schema(req.body.provider_id),
                provider_id: null,
            })
            if (!trip) {
                return res.json({ success: false })
            }
            let select = { _id: 1, token: 1 }

            let provider = await Provider.findOne({ _id: req.body.provider_id })
                .select(select)
                .lean()
            if (!provider) {
                return res.json({ success: false })
            }

            if (provider.token != req.body.token) {
                return res.json({
                    success: false,
                    error_code: error_message.ERROR_CODE_INVALID_TOKEN,
                })
            }

            if (req.body.is_provider_available) {
                await Trip.updateOne(
                    { _id: trip._id },
                    { is_provider_confirm_trip: 1 }
                )
                return res.json({ success: true })
            } else {
                trip.assigned_provider_id = null
                trip.assigned_provider_details = null
                trip.assigned_vehicle_id = null
                trip.assigned_vehicle_details = null
                trip.provider_type_id = null
                trip.is_provider_confirm_trip = 0
                trip.assigned_partner_name = ''

                trip.save().then(async () => {
                    utils.remove_dates_driver_vehicle(trip._id, trip.model_type)
                    return res.json({ success: true })
                })
            }
        }
    )
}

exports.assigned_driver_accept_trip = function (trip, provider_id) {
    City.findOne({ _id: trip.city_id }).then(
        (city_detail) => {
            if (city_detail) {
                var city_timezone = city_detail.timezone
                var is_check_provider_wallet_amount_for_received_cash_request =
                    city_detail.is_check_provider_wallet_amount_for_received_cash_request
                var provider_min_wallet_amount_set_for_received_cash_request =
                    city_detail.provider_min_wallet_amount_set_for_received_cash_request

                // var distance = setting_detail.default_Search_radious / constant_json.DEGREE_TO_KM;

                var provider_query = {}
                // var vehicle_query = {"vehicle_detail": {$elemMatch: {"vehicle_book_dates.trip_date": {$nin: [trip.start_date_tag]},"state": 1}}}
                // var providers_id_that_rejected_trip = trip.providers_id_that_rejected_trip;

                // provider_query["_id"] = {$nin: providers_id_that_rejected_trip};

                // provider_query["service_type"] = trip.service_type_id;
                // provider_query["vehicle_detail.admin_type_id"] = trip.type_id;
                // provider_query["vehicle_detail.state"] = 1;
                // provider_query["vehicle_detail.vehicle_book_dates.trip_date"] = {$nin: [trip.start_date_tag]};
                // provider_query["provider_trip_dates"] = {
                // $not: {
                //     $elemMatch: {
                //         "trip_date": {
                //             $gte: check_trip_date_start,
                //             $lte: check_trip_date_end
                //         }
                //     }
                // }
                // };

                // provider_query["vehicle_detail"] = {$elemMatch: {"vehicle_book_dates.trip_date": {$nin: [trip.start_date_tag]}}};
                var is_trip_condition = []
                var is_available_condition = []

                is_trip_condition.push({ is_trip: [] })
                is_available_condition.push({ is_available: 1 })

                // if (setting_detail.is_receive_new_request_near_destination) {
                //     is_trip_condition.push({ "is_near_trip": [] })
                //     is_available_condition.push({ "is_near_available": 1 })
                // }

                // if (setting_detail.is_allow_ride_share && trip.is_ride_share) {
                //     is_trip_condition.push({ "is_ride_share": 1 })
                //     is_available_condition.push({ "is_ride_share": 1 })
                // }
                var is_trip = { $or: is_trip_condition }
                var is_available = { $or: is_available_condition }

                // provider_query["is_active"] = 1;

                // if (is_check_provider_wallet_amount_for_received_cash_request && trip.payment_mode == Number(constant_json.PAYMENT_MODE_CASH)) {
                //     wallet_query = {$gte: provider_min_wallet_amount_set_for_received_cash_request};
                //     provider_query["wallet"] = wallet_query;
                // }
                // provider_query["is_vehicle_document_uploaded"] = true;

                // provider_query["providerLocation"] = {$near: trip.sourceLocation, $maxDistance: distance};

                // provider_admin_type_query = {
                //     $and: [{
                //         "provider_type": Number(constant_json.PROVIDER_TYPE_NORMAL)
                //     }, {
                //         "is_approved": 1
                //     }
                //     ]
                // };
                // provider_partner_type_query = {
                //     $and: [{
                //         "provider_type": Number(constant_json.PROVIDER_TYPE_PARTNER)
                //     }, {
                //         "is_approved": 1
                //     }, {
                //         "is_partner_approved_by_admin": 1
                //     }
                //     ]
                // };
                // provider_type_query = {$or: [provider_admin_type_query, provider_partner_type_query]};
                // languages_exists_query = {$and: [{"languages": {$in: trip.provider_language}}]};

                // received_trip_from_gender_exists_query = {
                //     $and: [{
                //         "gender": {
                //             $exists: true,
                //             $all: trip.received_trip_from_gender
                //         }
                //     }]
                // }

                var provider_query_and = []
                provider_query_and.push(is_trip)
                provider_query_and.push(is_available)
                // provider_query_and.push(provider_admin_type_query);
                // provider_query_and.push(provider_type_query);
                if (provider_id != null) {
                    provider_query_and.push({
                        $and: [{ _id: { $eq: provider_id } }],
                    })
                }

                // var accessibility = trip.accessibility;
                // if (accessibility != undefined && accessibility.length > 0) {
                //     accessibility_query = {
                //         vehicle_detail: { $elemMatch: { is_selected: true, accessibility: { $exists: true, $ne: [], $all: accessibility } } }
                //     }
                //     provider_query_and.push(accessibility_query);
                // }

                // if (trip.provider_language.length > 0) {
                //     provider_query_and.push(languages_exists_query);
                // }
                // if (trip.received_trip_from_gender.length > 0 && trip.received_trip_from_gender.length != 2) {
                //     provider_query_and.push(received_trip_from_gender_exists_query);
                // }

                var limit = 1
                // if(setting_detail.find_nearest_driver_type == Number(constant_json.NEAREST_PROVIDER_TYPE_MULTIPLE)){
                //     limit = setting_detail.request_send_to_no_of_providers;
                // }
                provider_query['$and'] = provider_query_and

                var favourite_providers = []
                // if(user_favourite_providers){
                //     favourite_providers = user_favourite_providers;
                // }

                var query
                query = Provider.findOne(provider_query)

                query.exec(async function (err, provider) {
                    delete trip.provider_to_user_estimated_distance
                    delete trip.provider_to_user_estimated_time

                    if (provider) {
                        // console.log(provider)
                        // function onlyUnique(value, index, self) {
                        //     return self.indexOf(value) === index;
                        // }
                        // favourite_providers = favourite_providers.filter( onlyUnique )

                        var final_providers = []

                        if (
                            trip.is_trip_inside_zone_queue &&
                            trip.zone_queue_id
                        ) {
                            let zone = await CityZone.findById(
                                trip.zone_queue_id
                            )
                            let zone_providers =
                                zone.total_provider_in_zone_queue

                            zone_providers.forEach(function (zone_provider) {
                                var zone_provider_index = providers.findIndex(
                                    (x) =>
                                        x._id.toString() ==
                                        zone_provider.toString()
                                )
                                if (zone_provider_index !== -1) {
                                    if (
                                        Number(final_providers.length) <
                                        Number(limit)
                                    ) {
                                        final_providers.push(
                                            providers[zone_provider_index]
                                        )
                                    }
                                }
                            })

                            // favourite_providers.forEach(function (fav_provider) {
                            //     var dup_index = final_providers.findIndex((x) => (x._id).toString() == fav_provider.toString());
                            //     if (dup_index == -1) {
                            //         var fav_index = providers.findIndex((x) => (x._id).toString() == fav_provider.toString())
                            //         if (fav_index !== -1) {
                            //             if (Number(final_providers.length) < Number(limit)) {
                            //                 final_providers.push(providers[fav_index]);
                            //             }
                            //         }
                            //     }
                            // });

                            providers.forEach(function (provider_detail) {
                                var fav_index = final_providers.findIndex(
                                    (x) =>
                                        x._id.toString() ==
                                        provider_detail._id.toString()
                                )
                                if (fav_index == -1) {
                                    if (
                                        Number(final_providers.length) <
                                        Number(limit)
                                    ) {
                                        final_providers.push(provider_detail)
                                    }
                                }
                            })
                        } else {
                            // favourite_providers.forEach(function (fav_provider) {
                            //     var fav_index = providers.findIndex((x) => (x._id).toString() == fav_provider.toString())
                            //     if (fav_index !== -1) {
                            //         if (Number(final_providers.length) < Number(limit)) {
                            //             final_providers.push(providers[fav_index]);
                            //         }
                            //     }
                            // });
                            // providers.forEach(function (provider_detail) {
                            //     var fav_index = final_providers.findIndex((x) => (x._id).toString() == provider_detail._id.toString())
                            //     if (fav_index == -1) {
                            //         if (Number(final_providers.length) < Number(limit)) {
                            //             final_providers.push(provider_detail)
                            //         }
                            //     }
                            // })
                        }

                        // if (setting_detail.is_allow_ride_share && trip.is_ride_share) {
                        //     let final_providers_temp = []
                        //     final_providers.forEach(provider => {
                        //         if (provider.is_trip.length != 0) {
                        //             if (provider.is_trip.length < trip.ride_share_limit) {
                        //                 let pickup_diff_km = Math.abs(utils.getDistanceFromTwoLocation(trip.sourceLocation, provider.providerLocation));
                        //                 let destination_condition = false;
                        //                 if (!provider.destinationLocation) { provider.destinationLocation = [] }
                        //                 if (provider.destinationLocation.length != 0) {
                        //                     destination_condition = true;
                        //                     provider.destinationLocation.forEach(destinationLocation => {
                        //                         let destination_diff_km = Math.abs(utils.getDistanceFromTwoLocation(trip.destinationLocation, destinationLocation));
                        //                         if (destination_condition) {
                        //                             if (destination_diff_km <= setting_detail.ride_share_destination_radius) {
                        //                                 destination_condition = true;
                        //                             } else {
                        //                                 destination_condition = false;
                        //                             }
                        //                         }
                        //                     })
                        //                 }
                        //                 if (pickup_diff_km <= setting_detail.ride_share_pickup_radius &&
                        //                     destination_condition) {
                        //                     final_providers_temp.push(provider)
                        //                 }
                        //             }
                        //         } else {
                        //             final_providers_temp.push(provider)
                        //         }
                        //     })
                        //     final_providers = final_providers_temp;
                        // }

                        // if (setting_detail.is_driver_go_home) {
                        //     let final_providers_temp = []
                        //     final_providers.forEach(provider => {
                        //         if (!provider.address_location) { provider.address_location = [0, 0] }
                        //         if (provider.address_location.length == 0) { provider.address_location = [0, 0] }
                        //         if (provider.is_go_home && provider.address_location != [0, 0]) {
                        //             if (trip.destinationLocation.length != 0 && trip.destination_addresses.length == 0) {
                        //                 let destination_diff_km = Math.abs(utils.getDistanceFromTwoLocation(trip.destinationLocation, provider.address_location));
                        //                 let destination_diff_meter = destination_diff_km * 1000;
                        //                 if (destination_diff_meter <= setting_detail.driver_go_home_radius) {
                        //                     final_providers_temp.push(provider)
                        //                 }
                        //             }
                        //         } else {
                        //             final_providers_temp.push(provider)
                        //         }
                        //     })
                        //     final_providers = final_providers_temp;
                        // }

                        // if(setting_detail.find_nearest_driver_type == Number(constant_json.NEAREST_PROVIDER_TYPE_SINGLE)){
                        trip.current_provider = provider._id
                        trip.provider_type = Number(
                            constant_json.PROVIDER_TYPE_PARTNER
                        )
                        // trip.provider_type_id = final_providers[0].provider_type_id;
                        // }
                        // trip.no_of_time_send_request++;
                        trip.unit = city_detail.unit
                        trip.is_provider_accepted = 0

                        var current_providers = []

                        // if(setting_detail.find_nearest_driver_type == Number(constant_json.NEAREST_PROVIDER_TYPE_SINGLE)){
                        //     current_providers.push(final_providers[0]._id);
                        // } else {
                        //     final_providers.forEach(function(provider){
                        current_providers.push(provider._id)
                        //     });
                        // }

                        trip.find_nearest_provider_time = new Date()
                        trip.current_providers = current_providers
                        trip.save().then(
                            async () => {
                                var trips = []
                                trips.push(trip._id)

                                // for (const final_provider of final_providers) {
                                // let idx = current_providers.findIndex(i => String(i) == String(final_provider._id));
                                // if (idx != -1) {
                                let is_trip_condition = {
                                    _id: provider._id,
                                    is_trip: [],
                                }
                                let is_trip_update = {
                                    is_available: 0,
                                    is_trip: trips,
                                    is_near_available: 0,
                                    $inc: { total_request: 1 },
                                }

                                // if (trip.is_ride_share && setting_detail.is_allow_ride_share) {
                                //     is_trip_condition = { _id: final_provider._id };
                                //     is_trip_update = { is_available: 0, $push: { is_trip: trip._id }, is_ride_share: 1, is_near_available: 0, $inc: { total_request: 1 } };
                                // }
                                // if (setting_detail.is_receive_new_request_near_destination) {
                                //     if (final_provider.is_trip.length != 0
                                //         && final_provider.is_near_available == 1
                                //         && !trip.is_ride_share) {
                                //         is_trip_condition = { _id: final_provider._id, is_near_trip: [] };
                                //         is_trip_update = { is_near_available: 0, is_near_trip: trips, $inc: { total_request: 1 } };
                                //     }
                                // }

                                let updateCount = await Provider.updateOne(
                                    is_trip_condition,
                                    is_trip_update
                                )
                                if (updateCount.modifiedCount != 0) {
                                    let is_trip_condition = {
                                        _id: provider._id,
                                        is_trip: trip._id,
                                    }
                                    // if (setting_detail.is_receive_new_request_near_destination) {
                                    //     if (final_provider.is_trip.length != 0 && final_provider.is_near_available == 1) {
                                    //         is_trip_condition = { _id: final_provider._id, is_near_trip: trip._id };
                                    //     }
                                    // }
                                    let provider_detail =
                                        await Provider.findOne(
                                            is_trip_condition
                                        )
                                    if (provider_detail) {
                                        // if (trip.is_ride_share && final_provider.is_trip.length != 0) {
                                        //     utils.update_request_status_socket(final_provider.is_trip[0], trip._id);
                                        //     myAnalytics.insert_daily_provider_analytics(city_timezone, provider._id, TRIP_STATUS.WAITING_FOR_PROVIDER, null);
                                        //     utils.sendPushNotification(constant_json.PROVIDER_UNIQUE_NUMBER, provider.device_type, provider.device_token, push_messages.PUSH_CODE_FOR_NEW_NEAREST_TRIP, constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS);
                                        // } else if (final_provider.is_trip.length != 0 && final_provider.is_near_available == 1) {
                                        //     utils.update_request_status_socket(final_provider.is_trip[0], trip._id);
                                        //     myAnalytics.insert_daily_provider_analytics(city_timezone, provider._id, TRIP_STATUS.WAITING_FOR_PROVIDER, null);
                                        //     utils.sendPushNotification(constant_json.PROVIDER_UNIQUE_NUMBER, provider.device_type, provider.device_token, push_messages.PUSH_CODE_FOR_NEW_NEAREST_TRIP, constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS);
                                        // } else {
                                        utils.send_socket_request(
                                            trip._id,
                                            provider_detail._id
                                        )
                                        myAnalytics.insert_daily_provider_analytics(
                                            city_timezone,
                                            provider_detail._id,
                                            TRIP_STATUS.WAITING_FOR_PROVIDER,
                                            null
                                        )
                                        // utils.sendPushNotification(constant_json.PROVIDER_UNIQUE_NUMBER, provider.device_type, provider.device_token, push_messages.PUSH_CODE_FOR_NEW_TRIP, constant_json.PUSH_NOTIFICATION_SOUND_FILE_IN_IOS);
                                        // }
                                        User.findOne({
                                            _id: trip.user_id,
                                        }).then(
                                            (user) => {
                                                if (user) {
                                                    // user.current_trip_id = trip._id;
                                                    user.save().then(
                                                        () => {
                                                            let is_provider_accepted = 1

                                                            if (
                                                                trip.is_trip_cancelled ==
                                                                1
                                                            ) {
                                                            } else if (
                                                                trip.is_provider_accepted ==
                                                                1
                                                            ) {
                                                            } else {
                                                                if (
                                                                    is_provider_accepted ==
                                                                    1
                                                                ) {
                                                                    exports.accept_trip(
                                                                        provider_detail,
                                                                        trip,
                                                                        trip.provider_type_id
                                                                    )
                                                                }
                                                            }
                                                        },
                                                        (err) => {
                                                            console.log(err)
                                                        }
                                                    )
                                                }
                                            },
                                            (err) => {
                                                console.log(err)
                                            }
                                        )
                                    }
                                }
                                // }
                                // }
                            },
                            (err) => {
                                console.log(err)
                                trip.current_providers = []
                                trip.provider_first_name = ''
                                trip.provider_last_name = ''

                                if (
                                    trip.trip_type.toString() !==
                                        constant_json.TRIP_TYPE_DISPATCHER.toString() &&
                                    !trip.is_schedule_trip
                                ) {
                                    trip.provider_trip_end_time = new Date()
                                    trip.is_trip_cancelled = 1
                                    trip.is_provider_accepted = 0
                                    var complete_date_in_city_timezone =
                                        utils.get_date_now_at_city(
                                            new Date(),
                                            trip.timezone
                                        )
                                    var complete_date_tag = moment(
                                        moment(
                                            complete_date_in_city_timezone
                                        ).startOf('day')
                                    ).format(
                                        constant_json.DATE_FORMAT_MMM_D_YYYY
                                    )
                                    trip.complete_date_in_city_timezone =
                                        complete_date_in_city_timezone
                                    trip.complete_date_tag = complete_date_tag
                                } else {
                                    trip.is_provider_accepted = 3
                                }
                                if (trip.is_trip_cancelled == 0) {
                                    trip.save()
                                    // response({ success: false, error_code: error_message.ERROR_CODE_CREATE_TRIP_FAILED });
                                } else {
                                    trip.save().then(() => {
                                        utils.remove_dates_driver_vehicle(
                                            trip._id,
                                            trip.model_type
                                        )
                                        Trip.findOneAndRemove({
                                            _id: trip._id,
                                        }).then((deleted_trip) => {
                                            if (deleted_trip) {
                                                // var trip_history_data = new Trip_history(JSON.parse(JSON.stringify(deleted_trip)));
                                                // trip_history_data.save(function () {
                                                //     response({ success: false, error_code: error_message.ERROR_CODE_CREATE_TRIP_FAILED });
                                                // });
                                            } else {
                                                // response({ success: false, error_code: error_message.ERROR_CODE_CREATE_TRIP_FAILED });
                                            }
                                        })
                                    })
                                }
                            }
                        )
                    } else {
                        console.log('no provider foun')
                    }
                })
            } else {
                response({
                    success: false,
                    error_code: error_message.ERROR_CODE_CITY_TYPE_NOT_FOUND,
                })
            }
        },
        (err) => {
            console.log(err)
            response({
                success: false,
                error_code: error_message.ERROR_CODE_SOMETHING_WENT_WRONG,
            })
        }
    )
}

exports.w_fareestimate = async function (req, res) {
    let result = {}

    await utils.check_request_params(
        req.body,
        [
            { name: 'service_type_id', type: 'string' },
            { name: 'destination_latitude', type: 'number' },
            { name: 'destination_longitud', type: 'number' },
            { name: 'pickup_latitude', type: 'number' },
            { name: 'pickup_longitude', type: 'number' },
            // { name: 'country_id', type: 'string' },
        ],
        async function (response) {
            result = response
        }
    )

    if (!result.success) {
        return res.json({
            success: false,
            error_code: result.error_code,
            error_description: result.error_description,
        })
    }
    // const city_data = await City.findOne({ cityLatLong : { $near: [Number(lat), Number(lng)], $maxDistance: 1 }})
    let countryName = req.body?.country ?? 'Venezuela'
    const country = await Country.findOne({ countryname: countryName })
    const citytype = await Citytype.findOne({
        _id: Schema(req.body.service_type_id),
        countryid: Schema(country._id),
    })

    let cancellation_fees = 0

    if (!citytype) {
        return res.json({
            success: false,
            error_code: error_message.ERROR_CODE_NO_SERVICE_TYPE_FOUND,
        })
    }

    cancellation_fees = citytype.cancellation_fee
    const city_id = citytype.cityid

    const city = await City.findOne({ _id: city_id })
    if (!city) {
        return res.json({
            success: false,
            error_code: error_message.ERROR_CODE_NO_SERVICE_TYPE_FOUND,
        })
    }

    const time = req.body.time
    var timeMinutes
    timeMinutes = time * 0.0166667
    let body = req.body

    let originCoordinates = {
        latitude: body.pickup_latitude,
        longitude: body.pickup_longitude,
    }

    let destinationCoordinates = {
        latitude: body.destination_latitude,
        longitude: body.destination_longitud,
    }

    const settings = await Settings.findOne({})

    const response = await axios.get(
        `https://maps.googleapis.com/maps/api/directions/json?origin=${originCoordinates.latitude},${originCoordinates.longitude}&destination=${destinationCoordinates.latitude},${destinationCoordinates.longitude}&key=${settings.backend_google_key}`
    )

    const resultApi = response.data
    var distance = resultApi.routes[0].legs[0].distance.value
    var distanceKmMile = distance != 0 ? distance / 1000 : 0

    let model_pricing_type = null
    let model_service_condition = { _id: { $in: citytype.model_pricing_ids } }

    if (req.body.selected_model_id) {
        model_service_condition['modelid._id'] = Schema(
            req.body.selected_model_id
        )
    }

    if (req.body.selected_service_id) {
        model_service_condition['serviceid._id'] = Schema(
            req.body.selected_service_id
        )
    }

    if (req.body.selected_capacity_id) {
        model_service_condition['capacityid._id'] = Schema(
            req.body.selected_capacity_id
        )
    }

    if (
        req.body.selected_model_id ||
        req.body.selected_service_id ||
        req.body.selected_capacity_id
    ) {
        model_pricing_type = await Citytype.findOne(model_service_condition)
    }

    let helpers_price = 0
    const tax = citytype.tax
    var price_per_unit_distance1 =
        distanceKmMile * citytype.price_per_unit_distance
    var price_per_unit_distance = citytype.price_per_unit_distance
    let cost_travel_insurance = citytype.cost_travel_insurance || 0

    let free_stops = citytype.free_stops
    let total_stops_inside_city = 0
    let inside_stops_price = 0
    let outside_stops_price = 0

    let is_min_fare_used = 0
    if (model_pricing_type) {
        if (body.stops_address && body.stops_address.length > 0) {
            outside_stops_price =
                body.stops_address.length *
                model_pricing_type.cost_per_stop_outside_city

            body.stops_address.forEach((stop) => {
                if (
                    stop.stops_inside &&
                    stop.stops_inside.length > free_stops
                ) {
                    total_stops_inside_city =
                        total_stops_inside_city +
                        stop.stops_inside.length -
                        free_stops
                }
            })
        }

        let destination_stop = 0
        if (body.courier_flow_type != constant_json.COURIER_ESCOMBRO_FLOW) {
            destination_stop++
        }

        if (body.destination_stops && body.destination_stops.length) {
            destination_stop = destination_stop + body.destination_stops.length
        }

        destination_stop =
            destination_stop > free_stops ? destination_stop - free_stops : 0
        total_stops_inside_city = total_stops_inside_city + destination_stop

        inside_stops_price =
            total_stops_inside_city *
            model_pricing_type.cost_per_stop_inside_city

        if (body.number_of_helpers && body.number_of_helpers > 0) {
            helpers_price =
                body.number_of_helpers * model_pricing_type.cost_per_helper
        }

        if (req.body.number_of_helpers && req.body.number_of_helpers > 0) {
            helpers_price =
                req.body.number_of_helpers * model_pricing_type.cost_per_helper
        }

        if (
            req.body.courier_flow_type == constant_json.COURIER_CISTERNA_FLOW ||
            req.body.courier_flow_type == constant_json.COURIER_ESCOMBRO_FLOW
        ) {
            price_per_unit_distance1 = model_pricing_type.fixed_fees
        } else {
            const pricesResult = await tripService.calculateTariff(
                distanceKmMile,
                model_pricing_type
            )
            price_per_unit_distance = pricesResult.price_per_unit_distance
            price_per_unit_distance1 = price_per_unit_distance * distanceKmMile

            let recalculatePriceDistance = await tripService.recalculateTariff(
                price_per_unit_distance1,
                model_pricing_type,
                distanceKmMile,
                pricesResult.price_per_unit_distance
            )

            if (recalculatePriceDistance.fixed) {
                price_per_unit_distance = recalculatePriceDistance.pricePerUnit
                price_per_unit_distance1 = recalculatePriceDistance.price
            }

            if (distanceKmMile < 17) {
                is_min_fare_used = 1
            }
        }
    }

    let nightShift = 0
    let nightShiftCount = body.night_shift ? Number(body.night_shift) : 0
    let boat_ticket_check = body.boat_ticket_check
        ? Number(body.boat_ticket_check)
        : 0
    let is_margarita = false
    let boat_ticket = 0

    const validateOriginLocation = await tripService.validateLocation(
        originCoordinates,
        constant_json.STATES.NUEVA_ESPARTA
    )

    const validateDestinationLocation = await tripService.validateLocation(
        destinationCoordinates,
        constant_json.STATES.NUEVA_ESPARTA
    )

    if (validateOriginLocation && validateDestinationLocation) {
    } else if (validateOriginLocation || validateDestinationLocation) {
        nightShiftCount += 1
        is_margarita = true
        if (Number(boat_ticket_check) === 1) {
            boat_ticket = model_pricing_type.boat_ticket
                ? model_pricing_type.boat_ticket
                : 0
        }
    }

    let trip_type = constant_json.TRIP_TYPE_NORMAL
    price_per_unit_distance1 = price_per_unit_distance1.toFixed(2)
    nightShift =
        Number(
            model_pricing_type?.night_shift
                ? model_pricing_type?.night_shift
                : 0
        ) * nightShiftCount

    let total =
        Number(price_per_unit_distance1) +
        Number(inside_stops_price) +
        Number(outside_stops_price) +
        Number(nightShift) +
        Number(boat_ticket)

    total = total + total * 0.01 * tax
    let estimated_fare = Number(total)

    if (
        estimated_fare < model_pricing_type?.min_fare ||
        is_min_fare_used == 1
    ) {
        total =
            Number(model_pricing_type.min_fare) +
            Number(helpers_price) +
            Number(inside_stops_price) +
            Number(outside_stops_price) +
            Number(nightShift) +
            Number(boat_ticket)

        total = total + total * 0.01 * tax
        estimated_fare = total + Number(cost_travel_insurance)
        is_min_fare_used = 1
    } else {
        estimated_fare =
            Number(total) +
            Number(cost_travel_insurance) +
            Number(helpers_price)
    }

    res.json({
        success: true,
        trip_type: trip_type,
        message: success_messages.MESSAGE_CODE_YOU_GET_FARE_ESTIMATE,
        time: timeMinutes * 2,
        distance: distanceKmMile.toFixed(2),
        price_per_unit_distance: price_per_unit_distance,
        estimated_fare: estimated_fare.toFixed(2),
        unit_set: city.unit,
        cancellation_fees: citytype.cancellation_fee,
        is_margarita,
        boat_ticket,
        night_shift_count: nightShiftCount,
        boat_ticket_check,
    })
}

exports.edit_trip = async function (req, res) {
    if (typeof req.session.userid == 'undefined') {
        res.redirect('/admin')
        return
    }

    const { id, history } = req.query
    let trip = null

    trip = await Trip.findOne({
        unique_id: id,
    }).exec()

    if (!trip) {
        trip = await Trip_history.findOne({
            unique_id: id,
        }).exec()
    }

    if (!trip) {
        res.redirect('/running_requests')
        return
    }

    const server_date = new Date(Date.now())
    const types = await Type.find()

    const models = await Type_Models.find({
        state: { $eq: 1 },
    }).select(['_id', 'model_name', 'type_service_list'])

    const services = await Type_Services.find().select([
        '_id',
        'service_name',
        'specification_array',
    ])

    const capacities = await Type_Capacity.find({
        state: { $eq: 1 },
    }).select(['_id', 'value'])

    const country = await Country.findOne({ _id: trip.country_id })
        .select({ alpha2: 1 })
        .lean()
    res.render('admin/trip_edit/edit_trip', {
        server_date,
        moment: moment,
        scheduled_request_pre_start_minute:
            setting_detail.scheduled_request_pre_start_minute,
        map_key: setting_detail.web_app_google_key,
        trip,
        country,
        trip_id: trip._id,
        user_type_id: trip.user_type,
        services: JSON.stringify(services),
        models: JSON.stringify(models),
        capacities: JSON.stringify(capacities),
        types: JSON.stringify(types),
        tripData: JSON.stringify(trip),
        history,
        no_of_helpers: trip.pickup_details[0].user_details.no_of_helpers,
    })
}

exports.update_trip = async function (req, res) {
    let body = req.body
    let result = {}
    let Table

    try {
        await utils.check_request_params(
            body,
            [
                {
                    name: 'trip_id',
                    type: 'string',
                    name: 'dest_stops_lat_lng_div',
                    type: 'array',
                    name: 'user_type_id',
                    type: 'string',
                    name: 'server_date',
                    type: 'string',
                    name: 'type_service',
                    type: 'string',
                    name: 'fixed_price',
                    type: 'string',
                    name: 'loading_hour',
                    type: 'string',
                    name: 'loading_date',
                    type: 'string',
                },
            ],
            async function (response) {
                result = response
            }
        )

        if (!result.success) {
            return res.json({
                success: false,
                error_code: result.error_code,
                error_description: result.error_description,
            })
        }

        Table = Trip
        let trip = await Trip.findById(body.trip_id)

        if (!trip) {
            Table = Trip_history
            trip = await Table.findById(body.trip_id)
        }

        if (!trip) {
            return res.json({
                success: false,
                error_code: 'Trip not found',
                error_description: '',
            })
        }

        let model = null
        let capacity = null
        let service = null
        const settings = await Settings.findOne({})

        let {
            estimated_distance,
            source_address,
            destination_address,
            destination_addresses,
            destination_stops,
            helpers_num_download,
            helpers_num_load,
            dlat,
            dlng,
            longitude,
            latitude,
            provider_service_fees,
            loading_date,
            optimize_field,
        } = body

        const updateDate = new Date(body.server_date)
        const type = await Type.findById(body.type_service).select([
            '_id',
            'typename',
            'model_type',
        ])
        if (type.model_type) {
            trip.model_type = type.model_type
        } else {
            trip.model_type = 0
        }

        if (body.model_id) {
            model = await Type_Models.findById(body.model_id).select([
                '_id',
                'model_name',
            ])
        }

        if (body.capacity) {
            capacity = await Type_Capacity.findById(body.capacity).select([
                '_id',
                'capacity_name',
                'value',
                'unit',
            ])
        }

        if (body.service_id) {
            service = await Type_Services.findById(body.service_id).select([
                '_id',
                'service_name',
                'specification_array',
            ])
        }

        const cityType = await Citytype.find({
            typeid: Schema(body.type_service),
            cityid: trip.city_id,
        }).exec()

        if (
            helpers_num_download != '' &&
            Number(helpers_num_download) > 0 &&
            trip.pickup_details[0].user_details.number_of_helpers_download !=
                helpers_num_download
        ) {
            trip.pickup_details[0].user_details.number_of_helpers_download =
                Number(helpers_num_download)
        }

        if (
            helpers_num_load != '' &&
            Number(helpers_num_load) > 0 &&
            trip.pickup_details[0].user_details.number_of_helpers_load !=
                helpers_num_load
        ) {
            trip.pickup_details[0].user_details.number_of_helpers_load =
                Number(helpers_num_load)
        }

        trip.pickup_details[0].user_details.no_of_helpers =
            Number(trip.pickup_details[0].user_details.number_of_helpers_load) +
            Number(
                trip.pickup_details[0].user_details.number_of_helpers_download
            )

        if (
            latitude === trip.sourceLocation[0] ||
            longitude === trip.sourceLocation[1]
        ) {
            source_address = trip.source_address
            latitude = trip.sourceLocation[0]
            longitude = trip.sourceLocation[1]
        }

        if (
            dlat === trip.destinationLocation[0] ||
            dlng === trip.destinationLocation[1]
        ) {
            destination_addresses = trip.destination_addresses
            dlat = trip.destinationLocation[0]
            dlng = trip.destinationLocation[1]
        }

        if (
            estimated_distance < 0 &&
            trip.estimated_distance == estimated_distance
        ) {
            estimated_distance = trip.estimated_distance
        }

        /*  if(destination_addresses){
                destination_addresses = destination_addresses.map(stop => {
                    if (!stop.stops_inside) {
                        stop.stops_inside = []; 
                    }
                    return stop;
                });
            }*/

        if (destination_addresses) {
            // Mapeamos para asegurarnos de añadir los datos necesarios
            destination_addresses = destination_addresses.map((dest) => {
                if (!dest.stops_inside) {
                    dest.stops_inside = []
                }

                // Asegurarse de que cada elemento en stops_inside tenga su estructura adecuada
                dest.stops_inside = dest.stops_inside.map((innerStop) => {
                    return {
                        ...innerStop,
                        location: [
                            Number(innerStop.location?.[0] || 0),
                            Number(innerStop.location?.[1] || 0),
                        ],
                    }
                })

                return dest
            })
        } else {
            // Inicializa destination_addresses si no existe
            destination_addresses = []
        }

        /* if(destination_addresses){
                destination_addresses.forEach((dest) => {
                    dest.stops_inside.forEach((stop) => {
                        stop.location = [ Number(stop.location[0]), Number(stop.location[1])]
                        
                    })
                })        
            }else{
                destination_addresses = []
            } */

        let steps = ''

        destination_stops = []
        if (destination_addresses?.length > 0) {
            const steps_aux = destination_addresses.map(
                (dest) => `|${dest.location[0]},${dest.location[1]}|`
            )
            steps += steps_aux.join('')
        }

        const response = await axios.get(
            `https://maps.googleapis.com/maps/api/directions/json?origin=${latitude},${longitude}&destination=${dlat},${dlng}&waypoints=${steps}&key=${settings.backend_google_key}`
        )

        const resultApi = response.data
        var distance = 0

        if (resultApi.routes[0].legs.length > 1) {
            for (
                let index = 0;
                index < resultApi.routes[0].legs.length;
                index++
            ) {
                distance += resultApi.routes[0].legs[index].distance.value
            }
        } else {
            var distance = resultApi.routes[0].legs[0].distance.value
        }

        var distanceKmMile = distance != 0 ? distance / 1000 : 0
        estimated_distance = distanceKmMile
        let set = {
            estimated_distance: Math.round(Number(estimated_distance)),
            service_type_name: type.typename,
            type_id: type._id,
            capacity_details: capacity,
            model_details: model,
            service_details: service,
            source_address,
            destination_address,
            destination_addresses,
            initial_destination_address: destination_address,
            fixed_price: Number(body.fixed_price),
            sourceLocation: [latitude, longitude],
            destinationLocation: [dlat, dlng],
            pickup_details: trip.pickup_details,
            destination_stops,
            service_type_id: cityType[0]._id,
            updated_at: updateDate.toUTCString(),
            night_shift: body.night_shift,
            provider_service_fees,
            optimize_field: optimize_field ?? false,
            model_type: trip.model_type,
        }

        if (trip.server_start_time_for_schedule != loading_date) {
            set.server_start_time_for_schedule = loading_date
        } else {
            set.created_at = loading_date
        }
        set.start_date_tag = loading_date
        let updatecount = await Table.updateOne(
            { _id: body.trip_id },
            {
                $set: set,
            }
        )
        let trip_data = await Table.findOne({ _id: body.trip_id })
        sendTrackingLinkSms(trip_data, true)
        await Provider.updateOne(
            {
                'provider_trip_dates.trip_id': trip_data._id,
            },
            {
                $set: {
                    'provider_trip_dates.$.trip_date': new Date(loading_date),
                },
            }
        )

        let date_tag = {
            trip_id: trip_data._id,
            trip_date: new Date(loading_date),
        }
        if (trip_data.assigned_vehicle_id) {
            await Partner.updateOne(
                { 'vehicle_detail._id': Schema(trip_data.assigned_vehicle_id) },
                {
                    $pull: {
                        'vehicle_detail.$.vehicle_book_dates': {
                            trip_id: trip_data._id,
                        },
                    },
                }
            )

            await Partner.updateOne(
                { 'vehicle_detail._id': trip_data.assigned_vehicle_id },
                { $push: { 'vehicle_detail.$.vehicle_book_dates': date_tag } }
            )
        }

        if (trip_data.assigned_vehicle_id_2) {
            await Partner.updateOne(
                {
                    'vehicle_detail._id': Schema(
                        trip_data.assigned_vehicle_id_2
                    ),
                },
                {
                    $pull: {
                        'vehicle_detail.$.vehicle_book_dates': {
                            trip_id: trip_data._id,
                        },
                    },
                }
            )
            await Partner.updateOne(
                { 'vehicle_detail._id': trip_data.assigned_vehicle_id_2 },
                { $push: { 'vehicle_detail.$.vehicle_book_dates': date_tag } }
            )
        }

        return res.json({
            success: true,
            body: 'Ok',
        })
    } catch (error) {
        console.log(error)
        return res.json({
            success: false,
            body: `${error}`,
        })
    }
}

exports.upload_chat_images = async function (req, res) {
    try {
        // console.log(req.body)
        // console.log(req.files)
        utils.check_request_params(
            req.body,
            [
                { name: 'trip_id', type: 'string' },
                { name: 'user_type', type: 'string' },
            ],
            async function (response) {
                if (!response.success) {
                    return res.json({
                        success: false,
                        error_code: response.error_code,
                        error_description: response.error_description,
                    })
                }
                if (
                    req.body?.user_type == constant_json.PARTNER_UNIQUE_NUMBER
                ) {
                    if (typeof req.session.partner == 'undefined') {
                        return
                    }
                } else if (
                    req.body?.user_type == constant_json.CORPORATE_UNIQUE_NUMBER
                ) {
                    if (typeof req.session.corporate == 'undefined') {
                        return
                    }
                } else if (
                    req.body?.user_type == constant_json.ADMIN_UNIQUE_NUMBER
                ) {
                    if (typeof req.session.userid == 'undefined') {
                        return
                    }
                } else if (
                    req.body?.user_type == constant_json.PROVIDER_UNIQUE_NUMBER
                ) {
                    const provider = await Provider.findOne({
                        _id: Schema(req.body.user_id),
                        token: req.body.token,
                    })
                    if (!provider) {
                        return res.json({
                            success: false,
                            error_code: error_message.ERROR_CODE_INVALID_TOKEN,
                        })
                    }
                } else {
                    return
                }
                let trip = await Trip.findOne({ _id: Schema(req.body.trip_id) })
                let Table = Trip
                if (!trip) {
                    trip = await Trip_history.findOne({
                        _id: Schema(req.body.trip_id),
                    })
                    Table = Trip_history
                }
                if (!trip) {
                    return res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
                    })
                }

                const image_file = req.files
                let file_list_size = 0
                //console.log('---------courier images------------')
                let image_url = []
                if (image_file != undefined && image_file.length > 0) {
                    file_list_size = image_file.length
                    for (i = 0; i < file_list_size; i++) {
                        let mime_type = image_file[i].mimetype.split('/')[1]

                        var image_name = trip._id + utils.tokenGenerator(5)
                        var url =
                            utils.getImageFolderPath(req, 16) +
                            image_name +
                            '.' +
                            mime_type
                        utils.saveImageFromBrowser(
                            req.files[i].path,
                            image_name + '.' + mime_type,
                            16
                        )
                        image_url.push(url)
                    }
                }

                return res.json({ success: true, image_url })
            }
        )
    } catch (e) {
        console.log(e)
    }
}

exports.complete_card_payment_trip = async function (req, res) {
    let body = req.body
    try {
        await utils.check_request_params(
            body,
            [
                {
                    name: 'trip_id',
                    type: 'string',
                },
            ],
            async function (response) {
                result = response
            }
        )

        if (!result.success) {
            return res.json({
                success: false,
                error_code: result.error_code,
                error_description: result.error_description,
            })
        }

        let trip = await Trip.findOne({
            _id: body.trip_id,
            is_provider_status: PROVIDER_STATUS.TRIP_COMPLETED,
        })
        if (!trip) {
            return res.json({
                success: false,
                error_code: error_message.ERROR_CODE_YOUR_TRIP_DETAIL_NOT_FOUND,
            })
        }
        trip.payment_status = 1
        trip.is_paid = 1
        trip.total = trip.fixed_price
        trip.is_trip_end = 1
        trip.is_trip_completed = 1
        trip.card_payment = trip.fixed_price
        trip.is_pending_payments = 0
        trip.remaining_payment = 0

        await Provider.updateOne(
            { _id: trip.provider_id },
            { is_trip: [], is_available: 1 }
        )
        await Trip.updateOne({ _id: trip._id }, trip.getChanges())
        let updateCount = await Trip.updateOne(
            { _id: trip._id },
            trip.getChanges()
        )
        if (updateCount.modifiedCount == 0) {
            return res.json({
                success: false,
            })
        }
        utils.update_request_status_socket(trip._id)
        let deleted_trip = await Trip.findOneAndRemove({ _id: trip._id })
        if (deleted_trip) {
            const trip_history_data = new Trip_history(
                JSON.parse(JSON.stringify(deleted_trip))
            )
            await trip_history_data.save()
            return res.json({
                success: true,
            })
        } else {
            return res.json({
                success: false,
            })
        }
    } catch (e) {
        console.log(e)
        return res.json({
            success: true,
        })
    }
}

exports.upload_pod_per_stop = async function (req, res) {
    // proof of delivery for each stop
    // console.log(req.body)
    // console.log(req.files)
    try {
        let params_array = [
            { name: 'provider_id', type: 'string' },
            { name: 'trip_id', type: 'string' },
        ]
        let response = await utils.check_request_params_async(
            req.body,
            params_array
        )
        if (!response.success) {
            res.json(response)
            return
        }
        const provider_id = req.body.provider_id
        const trip_id = req.body.trip_id
        const stop_num = req.body.stop_num
        const token = req.body.token
        let provider = await Provider.findOne({ _id: provider_id })
        if (!provider) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
            })
            return
        }

        if (token != null && provider.token != token) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_INVALID_TOKEN,
            })
            return
        }

        let trip = await Trip.findOne({ _id: trip_id })
        let Table = Trip
        if (!trip) {
            trip = await Trip_history.findOne({ _id: trip_id })
            Table = Trip_history
        }
        if (!trip) {
            return res.json({
                success: false,
                error_code: error_message.ERROR_CODE_NO_TRIP_FOUND,
            })
        }
        let image_file = req.files
        let file_list_size = 0
        let pod_image_url = []
        if (
            image_file != undefined &&
            image_file.length > 0 &&
            trip.actual_destination_addresses[stop_num - 1]
        ) {
            file_list_size = image_file.length
            for (i = 0; i < file_list_size; i++) {
                var image_name = trip._id + utils.tokenGenerator(4)
                var url =
                    utils.getImageFolderPath(req, 12) + image_name + '.jpg'
                utils.saveImageFromBrowser(
                    req.files[i].path,
                    image_name + '.jpg',
                    12
                )
                pod_image_url.push(url)
            }
            trip.actual_destination_addresses[stop_num - 1].pod_image_url =
                pod_image_url
            trip.markModified('actual_destination_addresses')
            let is_trip_condition = { _id: trip._id, provider_id: provider_id }
            await Table.updateOne(is_trip_condition, trip.getChanges())
            return res.json({ success: true })
        } else {
            return res.json({ success: false })
        }
    } catch (error) {
        utils.error_response(error, res)
    }
}

async function sendTrackingLinkSms(trip, is_edit_trip = null) {
    if (setting_detail.tracking_link_sms) {
        let user_name = trip.user_first_name + ' ' + trip.user_last_name
        let truck_model =
            trip.assigned_vehicle_details?.vehicle_model_details[0]
                ?.vehicle_model_name || ''
        let country_phone_code = ''
        if (truck_model == '') {
            let truck_type = await Type.findOne({ _id: trip.type_id })
                .select({ typename: 1 })
                .lean()
            truck_model = truck_type ? truck_type.typename : truck_model
        }
        if (trip.user_type_id) {
            let corporate_data = await Corporate.findOne({
                _id: trip.user_type_id,
            })
                .select({ company_name: 1, name: 1, country_phone_code: 1 })
                .lean()
            if (corporate_data) {
                country_phone_code = corporate_data.country_phone_code
            }
            user_name = corporate_data
                ? corporate_data?.company_name != ''
                    ? corporate_data.company_name
                    : corporate_data.name
                : user_name
        } else {
            let user = await User.findOne({ _id: trip.user_id })
                .select({ country_phone_code: 1 })
                .lean()
            if (user) {
                country_phone_code = user.country_phone_code
            }
        }
        let phone_list = []

        if (!is_edit_trip) {
            phone_list = [
                trip?.pickup_details?.[0]?.user_details?.phone != ''
                    ? trip?.pickup_details?.[0]?.user_details
                          ?.country_phone_code +
                      trip?.pickup_details?.[0]?.user_details?.phone
                    : '',
                trip?.delivery_details?.[0]?.user_details?.phone != ''
                    ? trip?.delivery_details?.[0]?.user_details
                          ?.country_phone_code +
                      trip?.delivery_details?.[0]?.user_details?.phone
                    : '',
            ].filter((phone) => phone && phone !== '')
        }

        if (trip?.destination_addresses?.length) {
            trip.destination_addresses.forEach((stop) => {
                if (stop?.stop_user_phone?.length && stop?.smsDelivered != 1) {
                    let phone_array = stop.stop_user_phone
                    phone_array.forEach((phone) => {
                        let smsSent = '0'
                        if (phone != '') {
                            smsSent = '1'
                            phone_list.push(country_phone_code + phone)
                        }
                        stop.smsDelivered = smsSent
                    })
                }
            })
        }

        trip.markModified('destination_addresses')
        let updateCount = await Trip.updateOne(
            { _id: trip._id },
            trip.getChanges()
        )
        if (updateCount.modifiedCount == 0) {
            await Trip_history.updateOne({ _id: trip._id }, trip.getChanges())
        }
        utils.sendSmsForTrackingLink(phone_list, 9, [
            user_name,
            truck_model,
            trip._id,
        ])
    }
}

async function getCorporateStaticPartnerProfit(
    citytype,
    trip_data = null,
    city = null
) {
    let cityzone = [],
        zone1,
        zone2,
        k = 0
    if (city?.zone_business == 1) {
        cityzone = await CityZone.find({ cityid: city._id })
    }
    if (
        citytype.is_zone == 1 &&
        cityzone !== null &&
        cityzone.length > 0 &&
        trip_data?.sourceLocation?.length &&
        trip_data?.destinationLocation?.length
    ) {
        let zone_count = cityzone.length
        cityzone.forEach(async function (cityzoneDetail) {
            geo = geolib.isPointInside(
                {
                    latitude: Number(trip_data.sourceLocation[0]),
                    longitude: Number(trip_data.sourceLocation[1]),
                },
                cityzoneDetail.kmlzone
            )
            geo2 = geolib.isPointInside(
                {
                    latitude: Number(trip_data.destinationLocation[0]),
                    longitude: Number(trip_data.destinationLocation[1]),
                },
                cityzoneDetail.kmlzone
            )
            if (geo) {
                zone1 = cityzoneDetail.id
            }
            if (geo2) {
                zone2 = cityzoneDetail.id
            }
            k++
        })
        if (k == zone_count) {
            let zonevalue = await ZoneValue.findOne({
                service_type_id: citytype._id,
                $or: [
                    {
                        from: zone1,
                        to: zone2,
                    },
                    {
                        from: zone2,
                        to: zone1,
                    },
                ],
            })
            if (zonevalue) {
                let partner_profit =
                    zonevalue?.partner_profit_fees || trip_data.provider_profit
                return Number(
                    (
                        (trip_data.fixed_price -
                            trip_data.insurance_fee -
                            trip_data.ferry_ticket_price) *
                        partner_profit *
                        0.01
                    ).toFixed(3)
                )
            } else {
                return trip_data.provider_service_fees
            }
        }
    } else {
        let model_service_condition = {
            _id: { $in: citytype.model_pricing_ids },
        }
        if (trip_data?.selected_model_id) {
            model_service_condition['modelid._id'] = Schema(
                trip_data.selected_model_id
            )
        }

        if (trip_data?.selected_service_id) {
            model_service_condition['serviceid._id'] = Schema(
                trip_data.selected_service_id
            )
        }

        if (trip_data?.selected_capacity_id) {
            model_service_condition['capacityid._id'] = Schema(
                trip_data.selected_capacity_id
            )
        }

        if (
            trip_data?.selected_model_id ||
            trip_data?.selected_service_id ||
            trip_data?.selected_capacity_id
        ) {
            model_pricing_type = await Citytype.findOne(model_service_condition)
        }
        if (
            model_pricing_type?.corporate_partner_profit_fees &&
            model_pricing_type?.corporate_partner_profit_fees > 0
        ) {
            return model_pricing_type.corporate_partner_profit_fees
        } else {
            return trip_data.provider_service_fees
        }
    }
}

exports.providerDropTrip = function (req, res) {
    try {
        utils.check_request_params(
            req.body,
            [{ name: 'provider_id', type: 'string' }],
            async function (response) {
                if (!response.success) {
                    res.json({
                        success: false,
                        error_code: response.error_code,
                        error_description: response.error_description,
                    })
                }

                let provider = await Provider.findOne({
                    _id: req.body.provider_id,
                })
                if (!provider) {
                    res.json({
                        success: false,
                        error_code:
                            error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
                    })
                    return
                }

                if (
                    req.body.token != null &&
                    provider.token != req.body.token
                ) {
                    res.json({
                        success: false,
                        error_code: error_message.ERROR_CODE_INVALID_TOKEN,
                    })
                    return
                }
                let trip_id = req.body.trip_id
                let trip = await Trip.findOne({
                    _id: trip_id,
                    provider_id: req.body.provider_id,
                    is_trip_cancelled: 0,
                    is_trip_completed: 0,
                    is_provider_status: { $lte: 9 },
                })
                if (!trip) {
                    return res.json({ success: false })
                }
                let corporate = null
                if (trip.user_type_id) {
                    corporate = await Corporate.findOne(
                        { _id: trip.user_type_id },
                        { name: 1, company_name: 1 }
                    ).lean()
                }
                const user = await User.findOne(
                    { _id: trip.user_id },
                    { first_name: 1, last_name: 1, email: 1 }
                ).lean()

                trip.provider_first_name = ''
                trip.provider_last_name = ''
                trip.provider_id = null
                trip.confirmed_provider = null
                trip.current_provider = null
                trip.assigned_provider_id = null
                trip.assigned_provider_details = null
                trip.assigned_vehicle_id = null
                trip.assigned_vehicle_id_2 = null
                trip.assigned_vehicle_details = null
                trip.assigned_vehicle_details_2 = null
                trip.is_provider_confirm_trip = 0
                trip.assigned_partner_name = ''
                trip.helpers_list = []
                trip.drop_trip_status = CONTAINER_DROP_STATUS.DROPPED
                let updateCount = await Trip.updateOne(
                    { _id: trip._id },
                    trip.getChanges()
                )
                if (updateCount.modifiedCount != 0) {
                    const extraParam = {
                        email: corporate ? corporate.email : user.email,
                        user_name: corporate
                            ? corporate.name
                            : user.first_name + user.last_name,
                        name: corporate
                            ? corporate.name
                            : user.first_name + user.last_name,
                    }

                    allemails.sendEmailPartnerCorporate(req, extraParam, 29)
                    utils.remove_dates_driver_vehicle(trip._id, trip.model_type)
                }
                return res.json({ success: true })
            }
        )
    } catch (e) {
        console.log({ e })
    }
}

exports.userPendingTrips = async function (req, res, next) {
    try {
        let user_id = Schema(req.body.user_id)
        const user = await User.findOne({ _id: user_id, token: req.body.token })
        if (!user) {
            return res.json({
                success: false,
                error_code: error_message.ERROR_CODE_INVALID_TOKEN,
            })
        }

        let condition = { $match: {} }
        condition['$match']['user_id'] = { $eq: user_id }
        condition['$match']['is_trip_cancelled'] = { $eq: 0 }
        condition['$match']['is_trip_completed'] = { $eq: 0 }
        condition['$match']['is_provider_status'] = { $lte: 9 }
        condition['$match']['drop_trip_status'] = {
            $eq: CONTAINER_DROP_STATUS.DROPPED,
        }

        let trips = await Trip.aggregate([condition])
        res.json({ success: true, trips })
        return
    } catch (e) {
        console.log({ e })
        res.json({ success: false, trips: [] })
        return
    }
}

exports.userNotifyUnload = async function (req, res, next) {
    try {
        const user = await User.findOne({
            _id: Schema(req.body.user_id),
            token: req.body.token,
        })
        if (!user) {
            return res.json({
                success: false,
                error_code: error_message.ERROR_CODE_INVALID_TOKEN,
            })
        }
        const trip_id = req.body.trip_id
        const user_id = req.body.user_id
        let partner = null
        let trip = await Trip.findOne({
            _id: trip_id,
            is_trip_cancelled: 0,
            is_trip_completed: 0,
            user_id: user_id,
            drop_trip_status: 1,
        })
        let user_name = ''
        if (trip.user_type_id) {
            let corporate = await Corporate.findOne(
                { _id: trip.user_type_id },
                { company_name: 1, name: 1 }
            ).lean()
            user_name =
                corporate?.company_name != ''
                    ? corporate?.company_name
                    : corporate.name
        } else {
            user_name = trip.user_first_name + ' ' + trip.user_last_name
        }
        if (trip.provider_type_id) {
            partner = await Partner.findOne(
                { _id: trip.provider_type_id },
                { first_name: 1, last_name: 1, email: 1 }
            ).lean()
        }
        trip.unload_notification_sent = 1
        let updateCount = await Trip.updateOne(
            { _id: trip._id },
            trip.getChanges()
        )
        if (updateCount.modifiedCount != 0 && partner) {
            let extraParam = {
                email: partner?.email || '',
                partner_name: partner
                    ? partner.first_name + partner.last_name
                    : '',
                name: partner ? partner.first_name + partner.last_name : '',
                trip_id: trip.unique_id,
            }
            allemails.sendEmailPartnerCorporate(req, extraParam, 30)
        }
        res.json({ success: true })
        return
    } catch (error) {
        res.json({ success: false, trips: [] })
        return
    }
}

exports.provider_change_drop_trip_status = async function (req, res, next) {
    try {
        let params_array = [
            { name: 'provider_id', type: 'string' },
            { name: 'trip_id', type: 'string' },
        ]
        let response = await utils.check_request_params_async(
            req.body,
            params_array
        )
        if (!response.success) {
            res.json(response)
            return
        }
        const trip_id = req.body.trip_id
        const provider_id = req.body.provider_id
        const token = req.body?.token || null
        const validStatuses = [
            CONTAINER_DROP_STATUS.PICKED_UP,
            CONTAINER_DROP_STATUS.STARTED,
        ]
        const status = validStatuses.includes(req.body.status)
            ? Number(req.body.status)
            : null
        if (!status) {
            res.json({ success: false })
            return
        }
        let provider = await Provider.findOne({ _id: provider_id })
        if (!provider) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
            })
            return
        }

        if (token != null && provider.token != token) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_INVALID_TOKEN,
            })
            return
        }

        let trip = await Trip.findOne({
            _id: trip_id,
            is_provider_status: PROVIDER_STATUS.ARRIVED_AT_DESTINATION,
            assigned_provider_id: provider_id,
            drop_trip_status: { $gte: CONTAINER_DROP_STATUS.DROPPED },
        })
        if (!trip) {
            return res.json({ success: false })
        }
        let updateCount = await Trip.updateOne(
            { _id: trip._id },
            { drop_trip_status: status }
        )
        if (updateCount.modifiedCount != 0) {
            utils.update_request_status_socket(trip._id)
        }
        res.json({ success: true })
        return
    } catch (error) {
        res.json({ success: false, trips: [] })
        return
    }
}

exports.user_get_trip_vehicle_docs = async function (req, res, next) {
    try {
        let params_array = [
            { name: 'user_id', type: 'string' },
        ]
        let response = await utils.check_request_params_async(
            req.body,
            params_array
        )
        if (!response.success) {
            res.json(response)
            return
        }
        const vehicles = req.body.vehicles
        const user_id = req.body.user_id
        const token = req.body?.token || null
      
        let user = await User.findOne({ _id: user_id })
        if (!user) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_USER_DETAIL_NOT_FOUND,
            })
            return
        }

        if (token != null && user.token != token) {
            res.json({
                success: false,
                error_code: error_message.ERROR_CODE_INVALID_TOKEN,
            })
            return
        }

        let docs = []
        docs = await Partner_Vehicle_Document.find({vehicle_id: {$in: vehicles}})
        res.json({ success: true, docs })
        return
    } catch (error) {
        console.log({error})
        res.json({ success: false})
        return
    }
}
